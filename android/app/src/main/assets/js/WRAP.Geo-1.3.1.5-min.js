var WRAP;"undefined"==typeof WRAP&&(WRAP={}),WRAP.Geo={version:"1.3",setLayer:function(t){this.container={interactive_layers:t.interactive_layers,plot_layers:t.plot_layers,upper_layers:t.upper_layers,lower_layers:t.lower_layers},this.container.upper_layers||(this.container.container.upper_layers=[]),this.container.plot_layers&&(this.container.upper_layers=this.container.upper_layers.concat(this.container.plot_layers)),this.container.interactive_layers&&(this.container.upper_layers=this.container.upper_layers.concat(this.container.interactive_layers))},getSize:function(){return this.map.getSize()},setView:function(t,e){this.map.setView&&this.map.setView(t,e)},getScreenPoint:function(t){return this.map.getScreenPoint(t)},getScreenRotation:function(t,e){return this.map.getScreenRotation(t,e)},getScreenLine:function(t){var e,i,r,a,n=[];if(t&&t.length>0){var o=t[0][1],s=t[0][0];e=i=o,r=a=s;var l=[o,s];n.push(l);for(var h=1;h<t.length;h++){var f=t[h][1],c=t[h][0],u=c-s;u<-180?c+=360:u>=180&&(c-=360),e<f&&(e=f),i>f&&(i=f),a>c&&(a=c),r<c&&(r=c);var l=[f,c];n.push(l),o=f,s=c}}if(a<-180){a+=360,r+=360;for(var h=0;h<n.length;h++)n[h][1]+=360}return this.map.getScreenLine(n,e,i,a,r)},getPoint:function(t){return this.map.getPoint(t)},getCenterPoint:function(){return this.map.getCenterPoint()},setCenterPoint:function(t){this.map.setCenterPoint(t)},getZoom:function(){return this.map.getZoom()},setZoom:function(t){this.map.setZoom(t)},getPerspective:function(t,e){return this.map.getPerspective(t,e)},getDistance:function(t,e){return this.map&&this.map.getDistance?this.map.getDistance(t,e):this.distance(t.lonDegree(),t.latDegree(),e.lonDegree(),e.latDegree())},getGCPoint:function(t,e,i){if(e<=0)return t;i<0&&(i+=360),e/=1851.8518518518517;var r=WRAP.Geo.gcPos(t.latDegree(),t.lonDegree(),i,e);return new WRAP.Geo.Point(60*r.lat,60*r.lon)},addEventHandler:function(t,e){var i=this.Interaction[t];i&&i.indexOf(e)<0&&i.push(e)},removeEventHandler:function(t,e){var i=this.Interaction[t];if(i){var r=i.indexOf(e);r>=0&&i.splice(r,1)}},switchMap:function(t){var e,i;WRAP.Geo.map&&(e=WRAP.Geo.map.getZoom(),i=WRAP.Geo.map.getCenterPoint()),WRAP.Geo.map.context&&(t.context.revision=WRAP.Geo.map.context.revision),t.context.revision++,WRAP.Geo.map=t,!isNaN(e)&&e>=0&&i&&(WRAP.Geo.map.setZoom(e),WRAP.Geo.map.setCenterPoint(i)),WRAP.Geo.map.refresh&&WRAP.Geo.map.refresh()},setInteraction:function(t,e){var i=this;WRAP.Geo.Interaction.init(e,t),i.lastHit=null,i.lastClick=null,i.lastX=0,i.lastY=0,i.currentDiv=t,t.addEventListener("mousemove",function(e){function r(t,e){for(var i=0;i<t.length;i++)if(t[i].feature==e)return!0;return!1}if(this==i.currentDiv&&!e._prevent){for(var a=WRAP.Geo.Interaction.mousemove,n=0;n<a.length;n++)a[n](e);var o=t.getBoundingClientRect(),s=e.clientX-o.left,l=e.clientY-o.top;i.lastX=s,i.lastY=l;var h=e.which;if(h)return void(i.lastClick&&i.lastClick.feature.draggable&&(i.lastClick.feature.drag(s,l),i.invalidate()));i.lastClick&&(WRAP.Geo.enableScroll(!0),i.lastClick=null);var f=new WRAP.Geo.ScreenPoint(s,l),c=i.hit(f);if(i.lastHit)for(var n=0;n<i.lastHit.length;n++){var u=i.lastHit[n];r(c,u.feature)||u.feature&&u.feature.mouseout&&u.feature.mouseout(s,l)}WRAP.Geo.Interaction&&WRAP.Geo.Interaction.getTooltip()||(i.currentFeature=null);for(var d=null,v=!1,n=0;n<c.length;n++){var g=c[n];if(v|=g.pixel,!g.pixel&&i.lastHit&&r(i.lastHit,g.feature)||g.feature&&(g.feature.draggable&&WRAP.Geo.enableScroll(!1),g.feature.mouseover&&g.feature.mouseover(s,l)),!d)if(i.currentFeature==g.feature)d=g;else{var p=g.layer,_=p._tooltip_handler&&p._tooltip_handler(g.feature.geo,g.feature.data);_&&_.length&&(d=g)}}if(d&&d.feature){if(v||i.currentFeature!=d.feature){var m=d.layer,x=[];if(i._tooltipGroup)for(var n=0;n<i._tooltipGroup.length;n++){var A=i._tooltipGroup[n];if(A.indexOf(m)>=0){for(var P=0;P<A.length;P++){var p=A[P];if(p.visible())for(var y=p._dl.length-1;y>=0;y--){var w=p._dl[y],b=w.hit(f.x,f.y);if(b){x.push({layer:p,feature:w,x:b.x,y:b.y});break}}}break}}x.length||x.push(d);for(var R=null,n=0;n<x.length;n++){var p=x[n].layer;if(p._tooltip_handler){R&&R.length?R+="<br/>":R="";var W=p._tooltip_handler(x[n].feature.geo,x[n].feature.data);W&&(R+=W)}}R&&R.length?(WRAP.Geo.currentFeature=d.feature,WRAP.Geo.Interaction.setTooltip(R),WRAP.Geo.Interaction.showTooltip(d.x,d.y)):(WRAP.Geo.currentFeature=null,WRAP.Geo.Interaction.clearTooltip())}}else WRAP.Geo.currentFeature&&(WRAP.Geo.currentFeature=null,WRAP.Geo.Interaction.clearTooltip());i.lastHit=c}});var r,a;t.addEventListener("mousedown",function(e){if(this==i.currentDiv){r=e.clientX,a=e.clientY;for(var n=t.getBoundingClientRect(),o=e.clientX-n.left,s=e.clientY-n.top,l=i.hit(new WRAP.Geo.ScreenPoint(o,s)),h=0;h<l.length;h++){var f=l[h];f&&f.feature&&f.feature.touch&&f.feature.touch(o,s)}for(var h=0;h<l.length;h++){var f=l[h];if(f&&f.feature){i.lastClick=f,i.lastClick.feature.draggable&&i.lastClick.feature.dragStart(o,s);break}}}}),t.addEventListener("mouseup",function(t){if(this==i.currentDiv)if(i.lastClick)i.lastClick.feature.draggable&&i.lastClick.feature.dragEnd(),WRAP.Geo.enableScroll(!0),i.lastClick=null;else if(r==t.clientX&&a==t.clientY)for(var e=t.target.getBoundingClientRect(),n=t.clientX-e.left,o=t.clientY-e.top,s=WRAP.Geo.Interaction.touch,l=new WRAP.Geo.ScreenPoint(n,o),h=0;h<s.length;h++)s[h](null,null,l)}),t.addEventListener("mouseout",function(){this==i.currentDiv&&(WRAP.Geo.enableScroll(!0),WRAP.Geo.currentFeature=null,WRAP.Geo.Interaction.clearTooltip())})},currentTooltip:function(){var t=WRAP.Geo.Interaction.getTooltip();if(t&&WRAP.Geo.currentFeature)return{geo:WRAP.Geo.currentFeature.geo,data:WRAP.Geo.currentFeature.data,content:t}},addTooltipGroup:function(t){if(t&&t.length){this._tooltipGroup||(this._tooltipGroup=[]);for(var e=0;e<this._tooltipGroup;e++){var i=this._tooltipGroup[e];if(t.length==i.length){for(var r=0;r<t.length&&!(i.indexOf(t[r++])<0););if(r>=t.length)return}}this._tooltipGroup.push(t)}},removeTooltipGroup:function(t){if(t&&t.length&&this._tooltipGroup)for(var e=0;e<this._tooltipGroup;e++){var i=this._tooltipGroup[e];if(t.length==i.length){for(var r=0;r<t.length&&!(i.indexOf(t[r++])<0););if(r>=t.length)return void this._tooltipGroup.splice(e,1)}}},waitLayerDraw:function(t,e,i){this._wait_layer_func=t;var r=(new Date).getTime()/1e3;this._wait_layer_start=r+e,this._wait_layer_end=r+i},Point:function(t,e){this.set=function(t,e){this.lat=parseFloat(t),this.lon=parseFloat(e),this.lon<-10800?this.lon+=21600:this.lon>=10800&&(this.lon-=21600)},this.setDegree=function(t,e){set(parseFloat(t)*60..parseFloat(e)*60)},this.latDegree=function(){return this.lat/60},this.lonDegree=function(){return this.lon/60},this.set(t,e)},Bounds:function(t,e,i,r){this.contains=function(t){if(t.lat>this.north||t.lat<this.south)return!1;if(this.west<this.east){if(t.lon>this.east||t.lon<this.west)return!1}else if(t.lon>this.east&&t.lon<this.west)return!1;return!0},this.north=t,this.south=e,this.east=i,this.west=r},ScreenPoint:function(t,e){this.x=t,this.y=e},ScreenBounds:function(t,e,i,r){this.x=t,this.y=e,this.width=i,this.height=r},Layer:function(t){var e=this;this._name=t,this._visible=!0,this._style=null,this._content=null,this._attr=null,this._data=null,this._conf=null,this._dl=[],this._revision={data:0,conf:0,context:0,content:0,style:0},this.configure=function(t,i){this._data=t,this._conf=i,this._revision.conf++;var r=i.Renderer;r&&WRAP.Geo.Renderer[r]?this._renderer=new WRAP.Geo.Renderer[r]:e._error("Implementation WRAP.Geo.Renderer."+r+" not found."),this._data?this._data.inspect(function(){e._revision.data++,e.render()},!0):e.render()},this.show=function(){this.setVisible(!0)},this.hide=function(){this.setVisible(!1)},this.visible=function(){return this._visible},this.setVisible=function(t){if(this._visible!=t){if(this._visible=t,this.blended)for(var e=0;e<this.blended.length;e++)this.blended[e].invalidate();var i=WRAP.Geo.isBlended(this);i&&i.invalidate();var r=WRAP.Geo.Interaction.visibilityChange;if(r)for(var e=0;e<r.length;e++)r[e](this);this.render(),WRAP.Geo.invalidate()}},this.setRespondable=function(t){this._respondable!=t&&(this._respondable=t)&&WRAP.Geo.invalidate()},this.addFeature=function(t){t.layer=this,this._dl.push(t)},this.removeFeature=function(t){var e=this._dl.indexOf(t);e>=0&&this._dl.splice(e,1)},this.clear=function(){WRAP.Geo.map.clearDisplayCache&&WRAP.Geo.map.clearDisplayCache(this._dc),this._dc={},this._dl=[],WRAP.Geo.invalidate()},this.set=function(t){var i=JSON.parse(JSON.stringify(t));return this._timeController&&this._data&&!this._timeController.validate(this,i)?(this._content=i,void e.clear()):void(JSON.stringify(this._content)!=JSON.stringify(i)&&(this._content=i,e._revision.content++,e.render()))},this.get=function(){return this._content},this.setAttributes=function(t){this._content&&t&&JSON.stringify(this._content)==JSON.stringify(t)||(e._revision.conf++,this._attr=t,this.render())},this.name=function(){return this._name},this.setStyle=function(t){this._style!=t&&(e._revision.style++,this._style=t,this.render())},this.setTooltip=function(t){this._tooltip_handler=t},this.invalidate=function(){this._revision.conf++,this._revision.content++,this._revision.data++,this._dl=[],this.render()},this.merge=function(t){this.merged!=t&&(this.merged&&t&&this.merged.toString()==t.toString()||(this.merged=t,this.invalidate()))},this.blend=function(t){this.blended!=t&&(this.blended&&t&&this.blended.toString()==t.toString()||(this.blended=t,this._dl=[],this.invalidate()))},this.getBlendLayer=function(){return this.blended},this.getValue=function(t){if(this._renderer&&this._renderer.getValue){var e=this._content,i=WRAP.Geo.map.context,r=this._data;return this._renderer.getValue(e,i,r,t)}return null},this.setStatus=function(t){this._render_status=t},this.getStatus=function(){return this._render_status},this._currentConfiguration=function(){function t(e,i){for(var r in i)Array.isArray(i[r])?e[r]=i[r]:"object"==typeof i[r]?t(e[r]={},i[r]):e[r]=i[r]}function e(t,i){if(i)for(var r in i)t[r]&&!Array.isArray(t[r])&&"object"==typeof i[r]?e(t[r],i[r]):t[r]=i[r]}var i={};return t(i,this._conf),i.Attributes||(i.Attributes={}),e(i.Attributes,this._attr),i},this.render=function(){if(WRAP.Geo.map.context&&this._visible&&this._renderer&&this._renderer.draw){var t=this._data;if(t&&!t._handler())return;if(WRAP.Geo.isBlended(this))return this._revision.data++,this._revision.conf++,void(this._dl=[]);var e=this._content,i=this._currentConfiguration(),r=WRAP.Geo.map.context,a=this._style,n=this._revision,o=this._dl;n.context=r.revision,this._renderer.draw(this,e,i,r,a,t,n,o);for(var s=0;s<o.length;s++)o[s].layer=this}},this.renderMerge=function(t){var e=[];if(this._visible)if(this.merged&&this._renderer&&this._renderer.merge){var i=this._currentConfiguration(),r=this._style;this._renderer.merge(e,this._dl,i,r),this._merged_revision=t;for(var a=0;a<this.merged.length;a++){var n=this.merged[a];n._visible&&n._renderer&&n._renderer.merge&&(i=n._currentConfiguration(),r=n._style,n._renderer.merge(e,n._dl,i,r),n._merged_revision=t)}}else e=this._dl;return e},this.setTimeController=function(t){this._timeController=t},this._error=function(t){this._error_text=t,console.warn(this.name()+":"+t)}},Feature:{Point:function(t){this.draw=function(e){e.layer=this.layer,e.drawPoint(t.point,t.pointSize,t.lineWidth,t.strokeStyle,t.fillStyle,t.blink)},this.hit=function(e,i){var r=t.pointSize;t.sensorSize&&(r=t.sensorSize);var a=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0])),n=a.x-r/2,o=n+r;if(e<n||o<e)return null;var s=a.y-r/2,l=s+r;return i<s||l<i?null:{x:a.x,y:a.y}},this.setDraggable=function(t,e){this.draggable=t,this.dragHandler=e},this.style=function(){return t},this.mouseover=function(){for(var e=WRAP.Geo.Interaction.mouseover,i=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0])),r=0;r<e.length;r++)e[r](this.layer,this,i)},this.mouseout=function(){for(var e=WRAP.Geo.Interaction.mouseout,i=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0])),r=0;r<e.length;r++)e[r](this.layer,this,i)},this.touch=function(){for(var e=WRAP.Geo.Interaction.touch,i=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0])),r=0;r<e.length;r++)e[r](this.layer,this,i)},this.dragStart=function(e,i){var r=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0]));this.anchor={lon:t.point[0],lat:t.point[1],ox:e,oy:i,x:r.x,y:r.y}},this.drag=function(e,i){if(this.anchor){var r=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(this.anchor.x+(e-this.anchor.ox),this.anchor.y+(i-this.anchor.oy)));t.point[0]=r.lonDegree(),t.point[1]=r.latDegree(),this.dragHandler&&this.dragHandler(this,t.point)}},this.dragEnd=function(){this.anchor=null}},Text:function(t){this.draw=function(e){e.layer=this.layer,e.drawText(t.point,t.text,t.fontSize,t.fillStyle,t.strokeStyle,t.offsetX,t.offsetY,t.align,t.rotation)},this.hit=function(e,i){var r=WRAP.Geo._internal_context;if(!r){var a=WRAP.Geo._internal_canvas=document.createElement("canvas");r=WRAP.Geo._internal_context=a.getContext("2d")}var n=t.fontSize;if(t.fontSize)r.font=t.fontSize+"px Arial";else{var o=r.measureText("W");n=1.5*o.width}var s=parseFloat(t.offsetX)||0,l=parseFloat(t.offsetY)||0,h=r.measureText(t.text);"left"==t.align?s+=0:s-="right"==t.align?h.width:.5*h.width;var f=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0])),c=f.x+s,u=f.y+l-n,d=c+h.width,v=u+n;return c<=e&&e<=d&&u<=i&&i<=v?{x:f.x,y:f.y}:null},this.mouseover=function(){for(var e=WRAP.Geo.Interaction.mouseover,i=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0])),r=0;r<e.length;r++)e[r](this.layer,this,i)},this.mouseout=function(){for(var e=WRAP.Geo.Interaction.mouseout,i=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0])),r=0;r<e.length;r++)e[r](this.layer,this,i)},this.touch=function(){for(var e=WRAP.Geo.Interaction.touch,i=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0])),r=0;r<e.length;r++)e[r](this.layer,this,i)},this.style=function(){return t}},Line:function(t){this.draw=function(e){e.layer=this.layer,e.hitctx=this.layer._respondable?this.layer.hitctx:e.hitctx_base,e.drawLine(t.point,t.line,t.lineWidth,t.lineDash,t.strokeStyle,t.fillStyle,t.fillImage,t.option,t.rotation,this.id)},this.hit=function(t,e,i){return i.hitctx=this.layer._respondable?this.layer.hitctx:i.hitctx_base,i.hit(t,e,this.id)?{x:t,y:e}:null},this.mouseover=function(t,e){for(var i=WRAP.Geo.Interaction.mouseover,r=new WRAP.Geo.ScreenPoint(t,e),a=0;a<i.length;a++)i[a](this.layer,this,r)},this.mouseout=function(t,e){for(var i=WRAP.Geo.Interaction.mouseout,r=new WRAP.Geo.ScreenPoint(t,e),a=0;a<i.length;a++)i[a](this.layer,this,r)},this.touch=function(t,e){for(var i=WRAP.Geo.Interaction.touch,r=new WRAP.Geo.ScreenPoint(t,e),a=0;a<i.length;a++)i[a](this.layer,this,r)},this.style=function(){return t},this.image=t.fillImage},Image:function(t){this.draw=function(e){e.layer=this.layer,t.image.data?(e.layer=this.layer,e.drawImageData(t.point,t.image,t.width,t.height,t.offsetX,t.offsetY,t.rotation)):e.drawImage(t.point,t.image,t.width,t.height,t.offsetX,t.offsetY,t.rotation)},this.hit=function(e,i){var r=t.width,a=t.height,n=t.offsetX||0,o=t.offsetY||0,s=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0])),l=s.x+n,h=l+r;if(e<l||h<e)return null;var f=s.y+o,c=f+a;return i<f||c<i?null:{x:s.x,y:s.y}},this.style=function(){return t},t.image.data||(this.image=t.image),this.mouseover=function(){for(var e=WRAP.Geo.Interaction.mouseover,i=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0])),r=0;r<e.length;r++)e[r](this.layer,this,i)},this.mouseout=function(){for(var e=WRAP.Geo.Interaction.mouseout,i=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0])),r=0;r<e.length;r++)e[r](this.layer,this,i)},this.touch=function(){for(var e=WRAP.Geo.Interaction.touch,i=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0])),r=0;r<e.length;r++)e[r](this.layer,this,i)},this.set=function(e,i){this.layer=e,this.reference=i,this.mouseover=function(){for(var e=WRAP.Geo.Interaction.mouseover,i=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0])),r=0;r<e.length;r++)e[r](this.layer,this.reference,i)},this.mouseout=function(){for(var e=WRAP.Geo.Interaction.mouseout,i=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0])),r=0;r<e.length;r++)e[r](this.layer,this.reference,i)},this.touch=function(){for(var e=WRAP.Geo.Interaction.touch,i=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*t.point[1],60*t.point[0])),r=0;r<e.length;r++)e[r](this.layer,this.reference,i)}}},GeoLine:function(t){this.draw=function(e){e.layer=this.layer,e.hitctx=this.layer._respondable?this.layer.hitctx:e.hitctx_base,e.drawPath(t.path,t.lineWidth,t.lineDash,t.strokeStyle,t.fillStyle,t.fillImage,t.option,void 0===t.geodesic||t.geodesic,this.id)},this.hit=function(t,e,i){return i.hitctx=this.layer._respondable?this.layer.hitctx:i.hitctx_base,i.hit(t,e,this.id)?{x:t,y:e}:null},this.mouseover=function(t,e){for(var i=WRAP.Geo.Interaction.mouseover,r=new WRAP.Geo.ScreenPoint(t,e),a=0;a<i.length;a++)i[a](this.layer,this,r)},this.mouseout=function(t,e){for(var i=WRAP.Geo.Interaction.mouseout,r=new WRAP.Geo.ScreenPoint(t,e),a=0;a<i.length;a++)i[a](this.layer,this,r)},this.touch=function(t,e){for(var i=WRAP.Geo.Interaction.touch,r=new WRAP.Geo.ScreenPoint(t,e),a=0;a<i.length;a++)i[a](this.layer,this,r)},this.style=function(){return t},this.image=t.fillImage},GeoArc:function(t){this.draw=function(e){e.layer=this.layer,e.hitctx=this.layer._respondable?this.layer.hitctx:e.hitctx_base,e.drawArc(t.point,t.radius,t.start,t.end,t.lineWidth,t.lineDash,t.strokeStyle,t.fillStyle,t.fillImage,this.id)},this.hit=function(t,e,i){return i.hitctx=this.layer._respondable?this.layer.hitctx:i.hitctx_base,i.hit(t,e,this.id)?{x:t,y:e}:null},this.mouseover=function(t,e){for(var i=WRAP.Geo.Interaction.mouseover,r=new WRAP.Geo.ScreenPoint(t,e),a=0;a<i.length;a++)i[a](this.layer,this,r)},this.mouseout=function(t,e){for(var i=WRAP.Geo.Interaction.mouseout,r=new WRAP.Geo.ScreenPoint(t,e),a=0;a<i.length;a++)i[a](this.layer,this,r)},this.touch=function(t,e){for(var i=WRAP.Geo.Interaction.touch,r=new WRAP.Geo.ScreenPoint(t,e),a=0;a<i.length;a++)i[a](this.layer,this,r)},this.style=function(){return t},this.image=t.fillImage},Tile:function(t){this.draw=function(e){e.layer=this.layer,e.drawTile(t.tile,t.imageData,t.elevationData)},this.hit=function(t,e){if(t<0||e<0)return null;var i,r=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(t,e));return this.layer&&(i=this.layer.getValue(r)),this.geo={geometry:{type:"Point",coordinates:[r.lonDegree(),r.latDegree()]},properties:i},{x:t,y:e,pixel:!0}},this.style=function(){return t}},Model:function(t){this.draw=function(e){e.drawModel&&(e.layer=this.layer,e.drawModel(t.point,t.model,t.texture,t.scale,t.offset,t.rotation))},this.hit=function(){return null},this.style=function(){return t}}},Animation:function(){this.setTimeRange=function(t,e){this._frame=t,this._interval=parseFloat(e),this._last_time=0,this._next_time=0,this._current=-1,this._time=0,this._setFrame(0),this._running=null,this._cb=null},this.setValidTimeRange=function(t,e,i,r){for(var a=[{validtime:t}],n=WRAP.DH._time(t),o=WRAP.DH._time(e),s=WRAP.DH._setTime(n,i);s<o;)a.push({validtime:WRAP.DH._timeString(s)}),s=WRAP.DH._setTime(s,i);return n<o&&a.push({validtime:e}),this._frame=a,this._interval=parseFloat(r),this._last_time=0,this._next_time=0,this._current=-1,this._time=0,this._setFrame(0),this._running=null,this._cb=null,a},this.setLayer=function(t){this._layer=t},this.setTimeController=function(t){this._controller=t},this.setTime=function(t){this._running=!1;for(var e=0;e<this._frame.length&&(t.basetime&&t.basetime!=this._frame[e].basetime||!(t.validtime<=this._frame[e].validtime));)e++;this._setFrame(e)},this.start=function(t){this._cb=t,this._running||(this._running=!0,this._current_time=WRAP.Geo.addAnimation(this),this._next_time=this._current_time+this._interval)},this.stop=function(){this._running=!1,WRAP.Geo.removeAnimation(this)},this.time=function(){return this._time},this._setFrame=function(t){if(!this._frame||!this._frame.length)return this._time=void 0,this._current=-1,!1;if(t<0&&(t=0),t>=this._frame.length&&(t=this._frame.length-1),this._current!=t){if(this._current=t,this._time=this._frame[t],this._layer)for(var e=0;e<this._layer.length;e++)this._layer[e].set(this._frame[t]);return this._controller&&this._controller.setDisplayTime(this._frame[t].validtime),!0}return!1},this._go=function(t){if(this._running&&this._next_time<=t){if(WRAP.Geo.upper_layers_updating)return void WRAP.Geo.drawTiles();this._next_time=t+this._interval,this._setFrame(this._current+1)&&this._cb&&this._cb(this._time),this._current>=this._frame.length-1&&this.stop()}}},Context:function(t){this.revision=0,this.tiles=[],this.setTileBand=function(e,i,r,a,n){if(WRAP.Geo.map==t&&(this.zoom!=e||this.min_tile_x!=i||this.max_tile_x!=r||this.min_tile_y!=a||this.max_tile_y!=n)){if(this.blinked&&this.revision++,this.zoom=e,this.tile_band=Math.pow(2,e),this.canvas_band=256*this.tile_band,this.min_tile_x=i,this.max_tile_x=r,this.min_tile_y=a,this.max_tile_y=n,this.tiles.length){var o={};o.n=this.tiles[0].bounds.north/60,o.s=this.tiles[0].bounds.south/60;for(var s=1;s<this.tiles.length;s++)o.n<this.tiles[s].bounds.north/60&&(o.n=this.tiles[s].bounds.north/60),o.s>this.tiles[s].bounds.south/60&&(o.s=this.tiles[s].bounds.south/60)}o.w=(this.min_tile_x-this.tile_band/2)/this.tile_band*360,o.e=(this.max_tile_x+1-this.tile_band/2)/this.tile_band*360,this.bounds=o;var l=Math.pow(2,Math.floor(e));this.tile_racio=this.tile_band/l,this.offset_x=Math.floor(256*(this.min_tile_x-l/2)*this.tile_racio),this.offset_y=Math.floor(256*(l/2-1-this.max_tile_y)*this.tile_racio),this.canvas||(this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.secondary_canvas=document.createElement("canvas"),this.secondary_ctx=this.secondary_canvas.getContext("2d"));var h=this.max_tile_y-this.min_tile_y+1,f=this.max_tile_x-this.min_tile_x+1;this.max_tile_x<this.min_tile_x&&(f=l-this.min_tile_x+this.max_tile_x+1);var c=Math.floor(256*f*this.tile_racio),u=Math.floor(256*h*this.tile_racio);this.canvas.width=c,this.canvas.height=u,this.secondary_canvas.width=c,this.secondary_canvas.height=u;for(var d=Math.floor(e),v=0;v<h;v++)for(var g=this.max_tile_y-v,p=0;p<f;p++){var _=(this.min_tile_x+p)%l,m=this.findTile(d,g,_);m&&(m.canvas=this.canvas,m.secondary_canvas=this.secondary_canvas,m.ctx=this.ctx,m.offset_x=Math.floor(256*p),m.offset_y=Math.floor(256*v),m.width=256,m.height=256)}}},this.lockTile=function(){for(var t=0;t<this.tiles.length;t++)this.tiles[t].locked=!0},this.clearLockedTile=function(){for(var t=this.tiles.length-1;t>=0;t--)this.tiles[t].locked&&this.tiles.splice(t,1)},this.findTile=function(t,e,i){for(var r=0;r<this.tiles.length;r++){var a=this.tiles[r];if(a.z==t&&a.y==e&&a.x==i)return a}return null},this.addTile=function(t,e,i,r,a,n){this.revision++,this.tiles.push({id:t+"/"+e+"/"+i+"/"+r,type:t,z:e,y:i,x:r,cood:a,bounds:n})},this.tile=function(t){for(var e=0;e<this.tiles.length;e++){var i=this.tiles[e];i.valid||t(i)}},this.drawImageData=function(e,i,r,a,n,o,s){function l(t,e,i,r,a,l){s?(t.save(),t.translate(i,r),t.rotate(s/180*Math.PI),t.drawImage(e,n,o,a,l),t.restore()):t.drawImage(e,i+n,r+o,a,l)}function h(t){var e=document.createElement("canvas");e.width=t.width,e.height=t.height;var i=e.getContext("2d");return i.putImageData(t,0,0),e}var f=this.ctx,c=t.getScreenPoint(new WRAP.Geo.Point(0,0)),u=this.offset_x+c.x,d=this.offset_y+c.y,v=t.getScreenPoint(new WRAP.Geo.Point(60*e[1],60*e[0])),g=v.x-u,p=v.y-d,_=1.5*(r>a?r:a),m=-_,x=this.canvas.width+_,A=-_,P=this.canvas.height+_;if(!(p<A||P<p)){var y=null;m<=g&&g<=x&&(y||(y=h(i)),l(f,y,g,p,r,a));var w=g-this.canvas_band;m<=w&&w<=x&&(y||(y=h(i)),l(f,y,w,p,r,a));var b=g+this.canvas_band;m<=b&&b<=x&&(y||(y=h(i)),l(f,y,b,p,r,a))}},this.drawImage=function(e,i,r,a,n,o,s){function l(t,e,i,r,a){s?(t.save(),t.translate(e,i),t.rotate(s/180*Math.PI),t.drawImage(f,n,o,r,a),t.restore()):t.drawImage(f,e+n,i+o,r,a)}if(!WRAP.Geo.imageError[i]){var h=WRAP.Geo.imageCache[i];if(void 0==h)return h=WRAP.Geo.imageCache[i]={loaded:!1,image:new Image,url:i},h.image.onload=function(){h.loaded=!0,WRAP.Geo.invalidate()},h.image.onerror=function(){WRAP.Geo.imageError[h.url]=!0,WRAP.Geo.updateLayerStatus()},void(h.image.src=i);if(h.loaded){var f=h.image;0==r&&(r=f.width),0==a&&(a=f.height);var c=this.ctx,u=t.getScreenPoint(new WRAP.Geo.Point(0,0)),d=this.offset_x+u.x,v=this.offset_y+u.y,g=t.getScreenPoint(new WRAP.Geo.Point(60*e[1],60*e[0])),p=g.x-d,_=g.y-v,m=1.5*(r>a?r:a),x=-m,A=this.canvas.width+m,P=-m,y=this.canvas.height+m;if(_<P||y<_)return;x<=p&&p<=A&&l(c,p,_,r,a);var w=p-this.canvas_band;x<=w&&w<=A&&l(c,w,_,r,a);var b=p+this.canvas_band;x<=b&&b<=A&&l(c,b,_,r,a)}}},this.hit=function(t,e,i){if(!i)return!1;for(var r=WRAP.Geo.getScreenPoint(this.hitctx.anchor);r.x>=this.canvas_band;)r.x-=this.canvas_band;for(;r.x<0;)r.x+=this.canvas_band;t-=r.x,e-=r.y;var a=this.hitctx.getImageData(t,e,1,1);if(a&&a.data){var n=(a.data[0]<<16)+(a.data[1]<<8)+a.data[2];if(n){var o=0,s=0,l=0,h=0,f=this.hitctx.getImageData(t-1,e,1,1);f&&f.data&&(o=(f.data[0]<<16)+(f.data[1]<<8)+f.data[2]);var c=this.hitctx.getImageData(t+1,e,1,1);c&&c.data&&(s=(c.data[0]<<16)+(c.data[1]<<8)+c.data[2]);var u=this.hitctx.getImageData(t,e-1,1,1);u&&u.data&&(l=(u.data[0]<<16)+(u.data[1]<<8)+u.data[2]);var d=this.hitctx.getImageData(t,e+1,1,1);return d&&d.data&&(h=(d.data[0]<<16)+(d.data[1]<<8)+d.data[2]),(n==o||n==s||n==l||n==h)&&i==n}}return!1},this._drawLines=function(e,i,r,a,n,o,s,l){if(this.primary_surface){if(l&&(n||o)){l=parseInt(l);var h=(16711680&l)>>16,f=(65280&l)>>8,c=255&l;this.hitctx.fillStyle="rgb("+h+","+f+","+c+")",this.hitctx.beginPath();for(var u=0;u<e.length;u++){var d=e[u],v=d[0].x,g=d[0].y,p=0;for(this.hitctx.moveTo(v,g);++p<e[u].length;)v=d[p].x,g=d[p].y,this.hitctx.lineTo(v,g)}this.hitctx.closePath(),this.hitctx.fill("evenodd")}if(l){var _=i||0;l=parseInt(l);var h=(16711680&l)>>16,f=(65280&l)>>8,c=255&l;this.hitctx.lineWidth=_+4,this.hitctx.strokeStyle="rgb("+h+","+f+","+c+")";for(var u=0;u<e.length;u++){this.hitctx.beginPath();var d=e[u],v=d[0].x,g=d[0].y,p=0;for(this.hitctx.moveTo(v,g);++p<e[u].length;)v=d[p].x,g=d[p].y,this.hitctx.lineTo(v,g);(n||o||d[0].x==d[d.length-1].x&&d[0].y==d[d.length-1].y)&&this.hitctx.closePath(),this.hitctx.lineJoin="round",this.hitctx.stroke()}}}for(var m=this.ctx,x=t.getScreenPoint(new WRAP.Geo.Point(0,0)),A=t.getSize().width/2;x.x-A>=this.canvas_band/2;)x.x-=this.canvas_band;for(;x.x-A<-this.canvas_band/2;)x.x+=this.canvas_band;var P=this.offset_x+x.x,y=this.offset_y+x.y,w=0,b=this.canvas.height,R=0,W=this.canvas.width;"cloud"==s&&(w-=10,b+=10,R-=10,W+=10);var G=[];if(n)G=e;else for(var u=0;u<e.length;u++){for(var S=!1,M=15,p=-1;++p<e[u].length;){var L=0,v=e[u][p].x-P;v<R?L|=1:v>W&&(L|=2);var g=e[u][p].y-y;if(g<w?L|=4:g>b&&(L|=8),!(M|L&&M&L)){S=!0;break}M=L}S&&G.push(e[u])}if(G.length){m.beginPath();for(var u=0;u<G.length;u++){var d=G[u];if("cloud"==s||"counter_cloud"==s){var T=Math.PI/3;"counter_cloud"==s&&(T=-T);var F=Math.cos(T),I=Math.sin(T),k=10,v=d[0].x-P,g=d[0].y-y,p=0;m.moveTo(v,g);for(var z=v,D=g,E=k;++p<d.length;){for(var W=d[p].x-P,b=d[p].y-y,C=W-v,B=b-g,N=Math.sqrt(C*C+B*B),U=N,j=0;U>=E;){j+=E;var h=j/N,V=v+C*h,O=g+B*h,X=V-z,Y=O-D,A=F*X-I*Y+z,H=I*X+F*Y+D;m.quadraticCurveTo(A,H,V,O),z=V,D=O,U-=E,E=k}E-=U,v=W,g=b}v=d[d.length-1].x-P,g=d[d.length-1].y-y,m.lineTo(v,g)}else{var v=d[0].x-P,g=d[0].y-y,p=0;for(m.moveTo(v,g);++p<G[u].length;)v=d[p].x-P,g=d[p].y-y,m.lineTo(v,g)}}if(n&&(m.closePath(),m.fillStyle=n,m.fill("evenodd")),o){m.closePath();var q=m.createPattern(o,"");m.fillStyle=q,m.fill("evenodd")}if(a){if(m.lineWidth=i||1,r&&m.setLineDash(r),m.strokeStyle=a,m.stroke(),"outset"==s||"inset"==s){m.beginPath();for(var u=0;u<G.length;u++){var d=G[u],T=Math.PI/3;"inset"==s&&(T=-T);for(var F=Math.cos(T),I=Math.sin(T),k=10,v=d[0].x-P,g=d[0].y-y,p=0,z=v,D=g,E=k;++p<d.length;){for(var W=d[p].x-P,b=d[p].y-y,C=W-v,B=b-g,N=Math.sqrt(C*C+B*B),U=N,j=0;U>=E;){j+=E;var h=j/N,V=v+C*h,O=g+B*h,X=V-z,Y=O-D,Z=z+.5*(V-z),J=D+.5*(O-D),A=F*X-I*Y+z,H=I*X+F*Y+D;m.moveTo(A,H),m.lineTo(Z,J),z=V,D=O,U-=E,E=k}E-=U,v=W,g=b}}m.stroke()}r&&m.setLineDash([])}}},this._fragmentPath=function(t){for(var e=[],i=0;i<t.length;i++){var r=t[i][1],a=t[i][0];if(i>0){var n=t[i-1][1],o=t[i-1][0],s=a-o;s<-180?(s+=360,a+=360):s>=180&&(s-=360,o+=360);var l=Math.abs(s);if(l>1){var h=new WRAP.Geo.GreatCircle(n,o,r,a),f=n,c=o;e.push([c,f]);for(var u=0;u+1<l;){u+=1;var d=u/l,v=h.getPosition(d);e.push([v.lon,v.lat]),f=v.lat,c=v.lon}}else e.push([o,n])}e.push([a,r])}return e},this._addFragments=function(t,e){for(var i=WRAP.Geo.getScreenLine(e),r=0;r<i.length;r++)t.push(i[r])},this.drawPath=function(t,e,i,r,a,n,o,s,l){if(t&&t.length){var h={};if(n){var f=n;if(WRAP.Geo.imageError[f])return;var h=WRAP.Geo.imageCache[f];if(void 0==h)return h=WRAP.Geo.imageCache[f]={loaded:!1,image:new Image,url:f},h.image.onload=function(){h.loaded=!0,WRAP.Geo.invalidate()},h.image.onerror=function(){WRAP.Geo.imageError[h.url]=!0,WRAP.Geo.updateLayerStatus()},void(h.image.src=f)}if(!n||h.loaded){var c=[];if(Array.isArray(t[0][0])){for(var u=0;u<t.length;u++)if(!(t[u].length<2)){var d=t[u];s&&(d=this._fragmentPath(t[u])),this._addFragments(c,d)}if(!c.length)return}else{if(t.length<2)return;var d=t;s&&(d=this._fragmentPath(t)),this._addFragments(c,d)}this._drawLines(c,e,i,r,a,h.image,o,l)}}},this.drawArc=function(t,e,i,r,a,n,o,s,l,h){var f={};if(l){var c=l;if(WRAP.Geo.imageError[c])return;var f=WRAP.Geo.imageCache[c];if(void 0==f)return f=WRAP.Geo.imageCache[c]={loaded:!1,image:new Image,url:c},f.image.onload=function(){f.loaded=!0,WRAP.Geo.invalidate()},f.image.onerror=function(){WRAP.Geo.imageError[f.url]=!0,WRAP.Geo.updateLayerStatus()},void(f.image.src=c)}if(!l||f.loaded){var u=[],d=!1;if(i==r||Math.abs(r-i)>360){var d=!0;i=0,r=360}var v=1;e<5e5?v=5:e<1e5&&(v=2),e/=1851.8518518518517;for(var g=i;g<r;g+=v){var p=WRAP.Geo.gcPos(t[1],t[0],g,e);u.push([p.lon,p.lat])}var p=WRAP.Geo.gcPos(t[1],t[0],r,e);if(u.push([p.lon,p.lat]),u.length<2)return;var _=[],m=this._fragmentPath(u);if(this._addFragments(_,m),d)this._drawLines(_,a,n,o,s,f.image,null,h);else{if(s||f.image){var x=[];u.push(t),u.unshift(t);var m=this._fragmentPath(u);this._addFragments(x,m),this._drawLines(x,a,null,null,s,f.image,null,h)}this._drawLines(_,a,n,o,null,null,null,h)}}},this.drawPoint=function(e,i,r,a,n,o){function s(t,e,o){n&&(t.fillStyle=n,t.beginPath(),t.arc(e,o,i/2-1,0,2*Math.PI,!0),t.closePath(),t.fill()),a&&(t.strokeStyle=a,t.lineWidth=r||1,t.beginPath(),t.arc(e,o,i/2-1,0,2*Math.PI,!0),t.closePath(),t.stroke())}if(o&&this.primary_surface)return void(this.blinked=!0);var l=t.getScreenPoint(new WRAP.Geo.Point(60*e[1],60*e[0])),h=this.ctx,f=t.getScreenPoint(new WRAP.Geo.Point(0,0)),c=this.offset_x+f.x,u=this.offset_y+f.y,d=l.x-c,v=l.y-u,g=-i,p=this.canvas.width+i,_=-i,m=this.canvas.height+i;if(!(v<_||m<v)){g<=d&&d<=p&&s(h,d,v);var x=d-this.canvas_band;g<=x&&x<=p&&s(h,x,v);var A=d+this.canvas_band;g<=A&&A<=p&&s(h,A,v)}},this.drawLine=function(e,i,r,a,n,o,s,l,h,f){function c(t,e,i){if(!(e.length<2)){for(var r,a,n=[],o=0;o<e.length;o++){var s=e[o][0],l=e[o][1];if(h){var f=s*p-l*_,c=s*_+l*p;s=f,l=c}s+=x.x,l+=x.y,0==o?r=a=s:(r>s&&(r=s),a<s&&(a=s)),n.push(new WRAP.Geo.ScreenPoint(s,l))}if(t.push(n),r-m>=3*i){for(var u=[],o=0;o<n.length;o++)u.push(new WRAP.Geo.ScreenPoint(n[o].x-3*i,n[o].y));t.push(u)}else if(r-m>=2*i){for(var u=[],o=0;o<n.length;o++)u.push(new WRAP.Geo.ScreenPoint(n[o].x-2*i,n[o].y));t.push(u)}else if(r-m>=i){for(var u=[],o=0;o<n.length;o++)u.push(new WRAP.Geo.ScreenPoint(n[o].x-i,n[o].y));t.push(u)}if(r-m<2*-i){for(var u=[],o=0;o<n.length;o++)u.push(new WRAP.Geo.ScreenPoint(n[o].x+3*i,n[o].y));t.push(u)}else if(r-m<-i){for(var u=[],o=0;o<n.length;o++)u.push(new WRAP.Geo.ScreenPoint(n[o].x+2*i,n[o].y));
t.push(u)}else if(r-m<0){for(var u=[],o=0;o<n.length;o++)u.push(new WRAP.Geo.ScreenPoint(n[o].x+i,n[o].y));t.push(u)}}}var u={};if(s){var d=s;if(WRAP.Geo.imageError[d])return;var u=WRAP.Geo.imageCache[d];if(void 0==u)return u=WRAP.Geo.imageCache[d]={loaded:!1,image:new Image,url:d},u.image.onload=function(){u.loaded=!0,WRAP.Geo.invalidate()},u.image.onerror=function(){WRAP.Geo.imageError[u.url]=!0,WRAP.Geo.updateLayerStatus()},void(u.image.src=d)}if(!s||u.loaded){for(var v=t.getScreenPoint(new WRAP.Geo.Point(0,0)),g=t.getSize().width/2;v.x-g>=this.canvas_band/2;)v.x-=this.canvas_band;for(;v.x-g<-this.canvas_band/2;)v.x+=this.canvas_band;var p,_,m=this.offset_x+v.x,x=t.getScreenPoint(new WRAP.Geo.Point(60*e[1],60*e[0]));h&&(p=Math.cos(Math.PI*h/180),_=Math.sin(Math.PI*h/180));var A=[];if(Array.isArray(i[0][0]))for(var P=0;P<i.length;P++)c(A,i[P],this.canvas_band);else c(A,i,this.canvas_band);if(!A.length)return;this._drawLines(A,r,a,n,o,u.image,l,f)}},this.drawText=function(e,i,r,a,n,o,s,l,h){function f(t,e,r,a,o){h?(t.save(),t.translate(e,r),t.rotate(h/180*Math.PI),t.translate(a,o),n&&(t.lineWidth=2,t.strokeStyle=n,t.strokeText(i,0,0)),t.fillText(i,0,0),t.restore()):(n&&(t.lineWidth=2,t.strokeStyle=n,t.strokeText(i,e+a,r+o)),t.fillText(i,e+a,r+o))}var c=this.ctx;r&&(c.font=r+"px Arial"),a&&(c.fillStyle=a);var u=parseFloat(o)||0,d=parseFloat(s)||0,v=c.measureText(i);"left"==l?u+=0:u-="right"==l?v.width:.5*v.width;var g=t.getScreenPoint(new WRAP.Geo.Point(0,0)),p=this.offset_x+g.x,_=this.offset_y+g.y,m=t.getScreenPoint(new WRAP.Geo.Point(60*e[1],60*e[0])),x=m.x-p,A=m.y-_,P=v.width,y=-P,w=this.canvas.width+P,b=-P,R=this.canvas.height+P;if(!(A<b||R<=A)){y<=x&&x<=w&&f(c,x,A,u,d);var W=x-this.canvas_band;y<=W&&W<=w&&f(c,W,A,u,d);var G=x+this.canvas_band;y<=G&&G<=w&&f(c,G,A,u,d)}},this.drawTile=function(t,e){var i=this.tile_racio;this.tile(function(r){if(r.id==t.id){var a=document.createElement("canvas");a.width=256,a.height=256;var n=a.getContext("2d");if(n.putImageData(e,0,0,0,0,256,256),n.fillStyle="rgba(0,0,0,0.0)",n.fillRect(0,0,1,1),r.ctx){var o=r.offset_x*i,s=r.offset_y*i,l=r.width*i,h=r.height*i;r.ctx.drawImage(a,o,s,l,h)}}})},this.begin=function(e){this.blinked=!1,this.hitcvs||(this.hitcvs=document.createElement("canvas"),this.hitctx_base=this.hitcvs.getContext("2d")),this.hitctx=this.hitctx_base;var i=t.getSize();if(this.hitcvs.width==i.width&&this.hitcvs.height==i.height||(this.hitcvs.width=i.width,this.hitcvs.height=i.height),this.hitctx.anchor=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(0,0)),this.hitctx.clearRect(0,0,i.width,i.height),this.ctx){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.secondary_ctx.clearRect(0,0,this.canvas.width,this.canvas.height);for(var r=0;r<this.tiles.length;r++){var a=this.tiles[r];a.revision!=e&&(a.valid=!1)}}},this.end=function(e){t.initRender(this.blinked),this.rev++;for(var i=0;i<this.tiles.length;i++){var r=this.tiles[i];r.context_rev=this.rev,r.revision!=e&&(r.revision=e,r.valid=!0),this.blinked&&(r.valid=!1),t.setTile(r,e)}t.update()},this.rev=0},GreatCircle:function(t,e,i,r){if(this.p1=[],this.p2=[],this.omeda=0,this.heading=0,this.neg=!1,r<e){this.neg=!0;var a;a=e,e=r,r=a,a=t,t=i,i=a}this.offset=e,e=0,r-=this.offset,t*=Math.PI/180,e*=Math.PI/180,i*=Math.PI/180,r*=Math.PI/180,this.p1[0]=Math.cos(t)*Math.cos(e),this.p1[1]=Math.cos(t)*Math.sin(e),this.p1[2]=Math.sin(t),this.p2[0]=Math.cos(i)*Math.cos(r),this.p2[1]=Math.cos(i)*Math.sin(r),this.p2[2]=Math.sin(i),this.omega=Math.acos(this.p1[0]*this.p2[0]+this.p1[1]*this.p2[1]+this.p1[2]*this.p2[2]),this.sinomega=Math.sin(this.omega);var n=Math.cos(t)*this.simomega;if(Math.abs(n)>.001){var o=(Math.sin(i)-Math.sin(t)*Math.cos(this.omega))/n;o<-1&&(o=-1),o>1&&(o=1),this.heading=Math.acos(o);for(var s=r-e;s<-Math.PI;)s+=2*Math.PI;for(;s>Math.PI;)s-=2*Math.PI;s<0&&(this.heading=2*Math.PI-this.heading)}else this.heading=0;this.getDistance=function(){var t=3443.96;return this.omega*t},this.getPosition=function(t){this.neg&&(t=1-t);var e=Math.sin((1-t)*this.omega)/this.sinomega,i=Math.sin(t*this.omega)/this.sinomega,r=[];r[0]=this.p1[0]*e+this.p2[0]*i,r[1]=this.p1[1]*e+this.p2[1]*i,r[2]=this.p1[2]*e+this.p2[2]*i;var a=Math.atan2(r[1],r[0])*(180/Math.PI),n=Math.asin(r[2])*(180/Math.PI);return a+=this.offset,{lat:n,lon:a}}},Bridge:{},Renderer:{},Interaction:{mouseover:[],mouseout:[],mousemove:[],touch:[],boundsChange:[],visibilityChange:[]},timer:null,rendering:!1,redrawQueue:[],valid:!0,redraw:function(t){this.redrawQueue.indexOf(t)<0&&this.redrawQueue.push(t)},dl:[],renderContext:function(t,e){var i=this,r=i.map.context,a=i.dl;if(a&&r){t&&i.revision++,r.begin(i.revision),r.primary_surface=!0;for(var n=0;n<e.length;n++){var o=e[n];o.hitcvs||(o.hitcvs=document.createElement("canvas"),o.hitctx=o.hitcvs.getContext("2d")),r.hitcvs.width==o.hitcvs.width&&r.hitcvs.height==o.hitcvs.height||(o.hitcvs.width=r.hitcvs.width,o.hitcvs.height=r.hitcvs.height),o.hitctx.anchor=r.hitctx.anchor,o.hitctx.clearRect(0,0,o.hitcvs.width,o.hitcvs.height)}for(var s=1e3,n=0;n<a.length;n++)for(var l=a[n],h=l.length,f=0;f<h;f++)l[f].id=s++,l[f].draw(r);if(r.blinked){r.primary_surface=!1;var c=r.ctx;r.ctx=r.secondary_ctx;for(var n=0;n<a.length;n++)for(var l=a[n],h=l.length,f=0;f<h;f++)l[f].draw(r);r.ctx=c}i.valid=!0,r.end(i.revision)}},render:function(){var t=this;t.valid=!1,this.timer||(this.timer=setInterval(function(){if(t.redrawQueue.length)for(var e;e=t.redrawQueue.shift();)e.visible()&&e.render();else if(!t.valid){var i=t.map.context;if(!i||!i.tiles.length)return;var r=t.container.upper_layers;if(!r||!r.length)return;if(t.rendering)return;t.rendering=!0;for(var a=r.length-1;a>=0;a--){var e=r[a];e.visible()&&e.merged&&e.merged.length&&(e._merged_dl=e.renderMerge(t.revision))}for(var n=[],a=r.length-1;a>=0;a--){var e=r[a];e.visible()&&(e._merged_dl?n.push(e._merged_dl):e._merged_revision!=t.revision&&n.push(e._dl))}for(var a=r.length-1;a>=0;a--){var e=r[a];e._merged_dl=null}for(var o=[],a=r.length-1;a>=0;a--){var e=r[a];e.visible()&&e._respondable&&o.push(e)}if(t.dl=n,t.renderContext(!1,o),t.rendering=!1,void 0!==t.lastX){for(var s=t.hit(new WRAP.Geo.ScreenPoint(t.lastX,t.lastY)),l=0;l<s.length;l++){var h=s[l];if(h.feature&&h.feature.draggable){WRAP.Geo.enableScroll(!1);break}}t.lastHit=s}}WRAP.Geo._wait_layer_func&&WRAP.Geo._wait_layer_start&&WRAP.Geo._wait_layer_end&&WRAP.Geo.updateLayerStatus()},20))},invalidate:function(){this.revision++,this.render()},updateLayerStatus:function(){var t=this,e=(new Date).getTime()/1e3;if(e>=WRAP.Geo._wait_layer_start){var i={completed:[],incompleted:[],error:[]},r=t.container.upper_layers;if(r)for(var a=0;a<r.length;a++){var n=r[a];if(n.visible()){for(var o=!1,s=!1,l=0,h=0;h<n._dl.length;h++){var f=n._dl[h],c=f.image;c&&(l++,WRAP.Geo.imageError[c]?s=!0:WRAP.Geo.imageCache[c]&&WRAP.Geo.imageCache[c].loaded||(o=!0))}n._render_status||(n._render_status={status:"valid"}),n._error_text?n._render_status={status:"error",reason:n._error_text}:s?n._render_status={status:"error",reason:"image load error."}:o?n._render_status={status:"invalid",reason:"image load waiting."}:l&&(n._render_status={status:"valid"});var u=n._render_status.status;"valid"==u?i.completed.push(n):"error"==u?i.error.push(n):i.incompleted.push(n)}}var d=e-WRAP.Geo._wait_layer_end;if(!i.incompleted.length&&!i.error.length||d>=0){var v=WRAP.Geo._wait_layer_func;WRAP.Geo._wait_layer_func=null,WRAP.Geo._wait_layer_start=WRAP.Geo._wait_layer_end=0,v(i)}}},lastZoom:-1,lastContext:-1,updateBounds:function(t){var e=this.map.getSize();if(!this._last_size||e.width!=this._last_size.width||e.height!=this._last_size.height){for(var i=this.map.context.tiles,r=0;r<i.length;r++)i[r].valid=!1;this._last_size=e,this.lastContext=-1}WRAP.Geo.Interaction&&(WRAP.Geo.lastHit=null,WRAP.Geo.Interaction.clearTooltip());var a=WRAP.Geo.Interaction.boundsChange;if(a)for(var r=0;r<a.length;r++)a[r](t);var n=this.lastContext!=this.map.context.revision;this.lastContext=this.map.context.revision;var o=WRAP.Geo.container.upper_layers;if(o&&o.length){for(var s=o.length-1;s>=0;s--)o[s].render();n&&this.render()}},isBlended:function(t){var e=WRAP.Geo.container.upper_layers;if(!e)return!1;for(var i=0;i<e.length;i++)if(e[i].visible()&&e[i].blended&&e[i].blended.indexOf(t)>=0)return e[i];return!1},hit:function(t){var e=[],i=this.map.getSize(),r=this.map.context;if(!r)return e;for(var a=r.canvas_band,n=t.x,o=t.y,s=[0],l=1;n-a*l>-a;l++)s.push(-a*l);for(var l=1;n+a*l<i.width+a;l++)s.push(a*l);if(this.container&&this.container.upper_layers)for(var h=0;h<this.container.upper_layers.length;h++){var f=this.container.upper_layers[h];if(f.visible()&&(!e.length||f._respondable))for(var c=0;c<s.length;c++){var u=s[c];n=t.x+u;for(var d=f._dl.length-1;d>=0;d--){var v=f._dl[d],g=v.hit(n,o,r);if(g){e.push({layer:f,feature:v,x:g.x-u,y:g.y,pixel:g.pixel});break}}}}return e},addAnimation:function(t){var e=this;this.animations.push(t);var i=new Date;return this.animation_timer||(this.animation_start=i,this.animation_timer=setInterval(function(){for(var t=new Date,i=(t-e.animation_start)/1e3,r=0;r<e.animations.length;r++)e.animations[r]._go(i)},15)),(i-this.animation_start)/1e3},removeAnimation:function(t){var e=this.animations.indexOf(t);e>=0&&this.animations.splice(e,1),!this.animations.length&&this.animation_timer&&(clearInterval(this.animation_timer),this.animation_timer=null,this.animation_start=null)},TimeController:function(){this._layers=[];var t=this;this.setDisplayTime=function(e){t._current_time=e;for(var i=0;i<t._layers.length;i++){var r=t._layers[i],a=r.get();a&&r.set(a)}},this.displayTime=function(){return t._current_time},this.addLayer=function(e){t._layers.indexOf(e)<0&&(e.setTimeController(this),t._layers.push(e)),this.setDisplayTime(t._current_time)},this.removeLayer=function(e){var i=t._layers.indexOf(e);indexOf>=0&&(t._layers[i].setTimeController(null),t._layers.splice(i,1))},this.validate=function(e,i){if(!i)return!1;if(t._current_time&&e._data){if(e._data.validator)return e._data.validator(t._current_time,e._data,i);var r,a=e._data.query("timelist").value();if(a&&i.basetime){for(var n=0;n<a.length;n++)if(a[n].basetime==i.basetime){r=a[n].validtime;break}}else r=e._data.query("validtime").value();if(r){r=r.concat(),r.sort(function(t,e){return t<e?-1:t>e?1:0});for(var o=WRAP.DH._time(t._current_time),s=86400,n=0;n<r.length;n++){var l=WRAP.DH._time(r[n]),h=n<r.length-1?WRAP.DH._time(r[n+1]):WRAP.DH._setTime(l,s);if(l<=o&&o<h)return i.validtime=WRAP.DH._timeString(l),!0;s=WRAP.DH._elapsed(l,h)}}}return i.validtime=null,!1}},parseColor:function(t){var e=document.createElement("canvas");e.width=1,e.height=1;var i=e.getContext("2d");return i.fillStyle=t,i.fillRect(0,0,1,1),i.getImageData(0,0,1,1).data},enableScroll:function(t){this.map.enableScroll&&this.map.enableScroll(t)},gcPos:function(t,e,i,r){function a(t){return t*Math.PI*h}function n(t){return t*l*c}i<0&&(i+=360),i>=360&&(i-=360);var o,s=r,l=10800,h=9259259e-11,f=Math.PI/2,c=1/Math.PI,u=60*t,d=60*e,v=180-i,g=i/180*Math.PI,p=Math.cos(g),_=a(s),m=(.5-u*h)*Math.PI,x=Math.cos(_),A=Math.cos(m),P=Math.sin(_),y=Math.sin(m),w=x*A+P*y*p;o=w>1?0:w<-1?Math.PI:Math.acos(w);var b=f-o;b=n(b);var R,W=Math.sin(o),G=(x*y-P*A*p)/W;R=G>1?0:G<-1?Math.PI:Math.acos(G);var S;return S=v>0?a(d)+R:a(d)-R,S=n(S),S>l?S=2*-l+S:S<-l&&(S=2*l+S),{lat:b/60,lon:S/60}},formatTime:function(t,e,i,r,a,n,o){function s(t){return("00"+t).slice(-2)}var l=parseInt(e||0),h=parseInt(i||0),f=parseInt(r||0),c=parseInt(a||0),u=parseInt(n||0),d=parseInt(o||0),v=new Date(Date.UTC(l,h-1,f,c,u,d)),g=v.getFullYear(),p=v.getMonth()+1,_=v.getDate(),m=v.getHours(),x=v.getMinutes(),A=v.getSeconds(),P=t;return P=P.replace("%year%",l),P=P.replace("%month%",h),P=P.replace("%day%",f),P=P.replace("%hour%",c),P=P.replace("%min%",u),P=P.replace("%sec%",d),P=P.replace("%0month%",s(h)),P=P.replace("%0day%",s(f)),P=P.replace("%0hour%",s(c)),P=P.replace("%0min%",s(u)),P=P.replace("%0sec%",s(d)),P=P.replace("%local_year%",g),P=P.replace("%local_month%",p),P=P.replace("%local_day%",_),P=P.replace("%local_hour%",m),P=P.replace("%local_min%",x),P=P.replace("%local_sec%",A),P=P.replace("%0local_month%",s(p)),P=P.replace("%0local_day%",s(_)),P=P.replace("%0local_hour%",s(m)),P=P.replace("%0local_min%",s(x)),P=P.replace("%0local_sec%",s(A))},_tileCheck:function(t,e){for(var i=0;i<t.tiles.length;i++){var r,a=t.tiles[i],n=65792,o=a.cood[n],s=a.cood[n+1];r=new WRAP.Geo.Feature.Text({point:[s,o],text:a.id,fontSize:14,fillStyle:"rgb(255,0,0)",offsetX:0,offsetY:0,align:"center"}),e.addFeature(r),r=new WRAP.Geo.Feature.Text({point:[s,o],text:"lat="+o,fontSize:14,fillStyle:"rgb(0,0,200)",offsetX:-50,offsetY:-40,align:"left"}),e.addFeature(r),r=new WRAP.Geo.Feature.Text({point:[s,o],text:"lon="+s,fontSize:14,fillStyle:"rgb(0,0,200)",offsetX:-50,offsetY:-20,align:"left"}),e.addFeature(r);var l=a.cood,h=[l[1],l[0]],f=[l[511],l[510]],c=[l[130561],l[130560]],u=[l[131071],l[131070]];r=new WRAP.Geo.Feature.GeoLine({path:[h,f,u,c],lineWidth:1,strokeStyle:"rgb(40,40,200)"}),e.addFeature(r)}},container:{},timer:null,animation_timer:null,animation_start:null,animations:[],revision:1,tiles:[],imageCache:{},imageError:{},modelCache:{},modelError:{},distance:function(t,e,i,r){var a=6378137,n=6356752.314245,o=Math.sqrt((a*a-n*n)/(a*a)),s=a*(1-o*o);t=t*Math.PI/180,e=e*Math.PI/180,i=i*Math.PI/180,r=r*Math.PI/180;var l=i-t;l>Math.PI&&(l-=2*Math.PI),l<-Math.PI&&(l+=2*Math.PI);var h=r-e,f=(r+e)/2,c=Math.sqrt(1-o*o*Math.sin(f)*Math.sin(f)),u=s/c/c/c,d=a/c,v=h*u*(h*u)+l*d*Math.cos(f)*(l*d*Math.cos(f));return Math.sqrt(v)},setViewPerspective:function(t,e,i){this.map.setViewPerspective&&this.map.setViewPerspective(t,e,i)},setViewOption:function(t){this.map.setViewOption&&this.map.setViewOption(t)},setViewController:function(t){this.map.setViewController&&this.map.setViewController(t)},check:function(){}},WRAP.Geo.View=function(t){this.projection=null,this.origin,this.size,this.zoom,this.context=new WRAP.Geo.ViewContext(this,t),this.setProjection=function(t,e){return WRAP.Geo.Projection[t]?(this.projection=new WRAP.Geo.Projection[t](e),this.context):(console.error("Map Projection["+t+"] undefined."),null)},this.updateContext=function(){for(var e=[],i=[],r=Math.floor(this.zoom),a=Math.pow(2,r),n=360/a,o=t.getSize(),s=16,l=9999,h=9999,f=-9999,c=-9999,u=-s;u<this.size[1]+s;u+=s)for(var d=-s;d<this.size[0]+s;d+=s){var v=this.point([d,u]),g=t.getScreenPoint(new WRAP.Geo.Point(60*v[1],60*v[0]));if(!(g.x<0||g.x>o.width||g.y<0||g.y>o.height)){l>v[1]&&(l=v[1]),h>v[0]&&(h=v[0]),f<v[1]&&(f=v[1]),c<v[0]&&(c=v[0]);var p=Math.floor((v[0]+180)/n);p<0&&(p+=a),p>=a&&(p-=a);var _=Math.floor((90-v[1])/n);if(_<0&&(_+=a/2),_>=a/2&&(_-=a/2),i[_]){if(i[_][p])continue}else i[_]=[];var m={x:p,y:_};i[_][p]=m,e.push(m)}}c-h>324&&(h=-180,c=180),this.context.setBounds({n:f,s:l,w:h,e:c},this.zoom,this.size,e,this.band)},this.updateBounds=function(t,e,i,r){i=[Math.round(i[0]),Math.round(i[1])];var a=[(e[0]+e[2])/2,(e[1]+e[3])/2];this.zoom=t,this.origin=a,this.size=i,this.band=r,this.centerPosition=[i[0]/2,i[1]/2],this.projection&&(this.scale=this.projection.pixelScale(t))},this.setOffset=function(t){this.offset=t},this.canvasPoint=function(t){var e=this.projection.forward(t),i=[e[0]-this.origin[0],e[1]-this.origin[1]],r=i[0]/this.scale,a=i[1]/this.scale;return[this.centerPosition[0]+r,this.centerPosition[1]-a]},this.canvasLine=function(t){for(var e=[],i=[],r=0;r<t.length;r++){var a=this.canvasPoint([t[r][0],t[r][1]]);i.push(new WRAP.Geo.ScreenPoint(a[0],a[1]))}return e.push(i),e},this.rotation=function(t,e){return this.projection.rotation(t,e)},this.point=function(t){var e=t[0]-this.centerPosition[0],i=t[1]-this.centerPosition[1],r=e*this.scale,a=i*this.scale,n=[this.origin[0]+r,this.origin[1]-a];return this.projection.inverse(n)},this.getPerspective=function(e,i){if(!this.origin)return null;for(var r=this.canvasPoint([e[0].lonDegree(),e[0].latDegree()]),a=r[0],n=r[1],o=a,s=a,l=n,h=n,f=1;f<e.length;f++){var r=this.canvasPoint([e[f].lonDegree(),e[f].latDegree()]),a=r[0],n=r[1];o>a&&(o=a),s<a&&(s=a),l>n&&(l=n),h<n&&(h=n)}var c=h-l,u=s-o,d=h-c/2,v=s-u/2,g=this.point([v,d]),p=t.getSize(),_=p.width-2*i,m=p.height-2*i,x=c>0?this.projection.zoom(this.scale*c/m):19,A=u>0?this.projection.zoom(this.scale*u/_):19,P=x<A?x:A,y=Math.floor(P);return P>19&&(y=P=19),{center:new WRAP.Geo.Point(60*g[1],60*g[0]),zoom:y,fractional_zoom:P}}},WRAP.Geo.ViewContext=function(t,e){this.revision=0,this.tiles=[],this.setBounds=function(t,e,i,r,a){this.revision++,this.bounds=t,this.zoom=e,this.size=i,this.band=a,this.canvas||(this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.secondary_canvas=document.createElement("canvas"),this.secondary_ctx=this.secondary_canvas.getContext("2d"));var n=Math.floor(i[0]),o=Math.floor(i[1]);this.canvas.width=n,this.canvas.height=o,this.secondary_canvas.width=n,this.secondary_canvas.height=o;var s=Math.floor(e),l=Math.pow(2,s),h=1/(256*l),f="E";this.tiles=[];for(var c=0;c<r.length;c++){for(var u=r[c],d=u.x,v=u.y,g=new Float32Array(131072),p=parseFloat(v)/l,_=parseFloat(d)/l,m={x:[257],y:[257]},x=0;x<257;x++){var A=_+h*x,P=p+h*x;m.x[x]=-180+360*A,m.y[x]=90-360*P}for(var x=0,y=0;y<256;y++)for(var w=0;w<256;w++)g[x++]=m.y[y],g[x++]=m.x[w];var b=new WRAP.Geo.Bounds(60*m.y[0],60*m.y[256],60*m.x[256],60*m.x[0]);this.tiles.push({id:f+"/"+s+"/"+v+"/"+d,type:f,z:s,y:v,x:d,ctx:this.ctx,cood:g,bounds:b})}},this.tile=function(t){for(var e=0;e<this.tiles.length;e++){var i=this.tiles[e];i.valid||t(i)}},this.drawImageData=function(e,i,r,a,n,o,s){function l(t,e,i,r,a,l){s?(t.save(),t.translate(i,r),t.rotate(s/180*Math.PI),t.drawImage(e,n,o,a,l),t.restore()):t.drawImage(e,i+n,r+o,a,l)}function h(t){var e=document.createElement("canvas");e.width=t.width,e.height=t.height;var i=e.getContext("2d");return i.putImageData(t,0,0),e}var f=this.ctx,c=t.canvasPoint(e),u=c[0],d=c[1],v=1.5*(r>a?r:a),g=-v,p=this.canvas.width+v,_=-v,m=this.canvas.height+v;if(!(d<_||m<d)){var x=null;g<=u&&u<=p&&(x||(x=h(i)),l(f,x,u,d,r,a));var A=u-this.canvas_band;g<=A&&A<=p&&(x||(x=h(i)),l(f,x,A,d,r,a));var P=u+this.canvas_band;g<=P&&P<=p&&(x||(x=h(i)),l(f,x,P,d,r,a))}},this.drawImage=function(e,i,r,a,n,o,s){function l(t,e,i,r,a){s?(t.save(),t.translate(e,i),t.rotate(s/180*Math.PI),t.drawImage(f,n,o,r,a),t.restore()):t.drawImage(f,e+n,i+o,r,a)}if(!WRAP.Geo.imageError[i]){var h=WRAP.Geo.imageCache[i];if(void 0==h)return h=WRAP.Geo.imageCache[i]={loaded:!1,image:new Image,url:i},h.image.onload=function(){h.loaded=!0,WRAP.Geo.invalidate()},h.image.onerror=function(){WRAP.Geo.imageError[h.url]=!0,WRAP.Geo.updateLayerStatus()},void(h.image.src=i);if(h.loaded){var f=h.image;0==r&&(r=f.width),0==a&&(a=f.height);var c=this.ctx,u=t.canvasPoint(e),d=u[0],v=u[1],g=1.5*(r>a?r:a),p=-g,_=this.canvas.width+g,m=-g,x=this.canvas.height+g;if(v<m||x<v)return;p<=d&&d<=_&&l(c,d,v,r,a);var A=d-this.canvas_band;p<=A&&A<=_&&l(c,A,v,r,a);var P=d+this.canvas_band;p<=P&&P<=_&&l(c,P,v,r,a)}}},this.hit=function(e,i,r){if(!r)return!1;t.offset&&(e-=t.offset[0],i-=t.offset[1]);var a=this.hitctx.getImageData(e,i,1,1);if(a&&a.data){var n=(a.data[0]<<16)+(a.data[1]<<8)+a.data[2],o=0,s=0,l=0,h=0,f=this.hitctx.getImageData(e-1,i,1,1);f&&f.data&&(o=(f.data[0]<<16)+(f.data[1]<<8)+f.data[2]);var c=this.hitctx.getImageData(e+1,i,1,1);c&&c.data&&(s=(c.data[0]<<16)+(c.data[1]<<8)+c.data[2]);var u=this.hitctx.getImageData(e,i-1,1,1);u&&u.data&&(l=(u.data[0]<<16)+(u.data[1]<<8)+u.data[2]);var d=this.hitctx.getImageData(e,i+1,1,1);return d&&d.data&&(h=(d.data[0]<<16)+(d.data[1]<<8)+d.data[2]),(n==o||n==s||n==l||n==h)&&r==n}return!1},this._drawLines=function(t,e,i,r,a,n,o,s){if(this.primary_surface){if(s&&(a||n)){s=parseInt(s);var l=(16711680&s)>>16,h=(65280&s)>>8,f=255&s;this.hitctx.fillStyle="rgb("+l+","+h+","+f+")",this.hitctx.beginPath();for(var c=0;c<t.length;c++){var u=t[c],d=u[0].x,v=u[0].y,g=0;for(this.hitctx.moveTo(d,v);++g<t[c].length;)d=u[g].x,v=u[g].y,this.hitctx.lineTo(d,v)}this.hitctx.closePath(),this.hitctx.fill("evenodd")}if(s&&r){s=parseInt(s);var l=(16711680&s)>>16,h=(65280&s)>>8,f=255&s;this.hitctx.lineWidth=e+4,this.hitctx.strokeStyle="rgb("+l+","+h+","+f+")",this.hitctx.beginPath();for(var c=0;c<t.length;c++){var u=t[c],d=u[0].x,v=u[0].y,g=0;for(this.hitctx.moveTo(d,v);++g<t[c].length;)d=u[g].x,v=u[g].y,this.hitctx.lineTo(d,v)}this.hitctx.stroke()}}var p=this.ctx,_=0,m=0,x=0,A=this.canvas.height,P=0,y=this.canvas.width;"cloud"==o&&(x-=10,A+=10,P-=10,y+=10);var w=[];if(a)w=t;else for(var c=0;c<t.length;c++){for(var b=!1,R=15,g=-1;++g<t[c].length;){var W=0,d=t[c][g].x-_;d<P?W|=1:d>y&&(W|=2);var v=t[c][g].y-m;if(v<x?W|=4:v>A&&(W|=8),!(R|W&&R&W)){b=!0;break}R=W}b&&w.push(t[c])}if(w.length){p.beginPath();for(var c=0;c<w.length;c++){var u=w[c];if("cloud"==o||"counter_cloud"==o){var G=-10,S=this.canvas.width+10,M=-10,L=this.canvas.height+10,T=2048,F=Math.PI/3;"counter_cloud"==o&&(F=-F);var I=Math.cos(F),k=Math.sin(F),z=10,d=u[0].x-_,v=u[0].y-m,g=0;p.moveTo(d,v);for(var D=d,E=v,C=z;++g<u.length;){var y=u[g].x-_,A=u[g].y-m;if(d>=G&&d<S&&v>=M&&v<L||y>=G&&y<S&&A>=M&&A<L){var B=y-d,N=A-v,U=Math.sqrt(B*B+N*N);if(U<T){for(var j=U,V=0;j>=C;){V+=C;var l=V/U,O=d+B*l,X=v+N*l,Y=O-D,H=X-E,q=I*Y-k*H+D,Z=k*Y+I*H+E,J=(O-q)*(O-q)+(X-Z)*(X-Z);J<z*z*2&&p.quadraticCurveTo(q,Z,O,X),D=O,E=X,j-=C,C=z}C-=j}}d=y,v=A}d=u[u.length-1].x-_,v=u[u.length-1].y-m,p.lineTo(d,v)}else{var d=u[0].x-_,v=u[0].y-m,g=0;for(p.moveTo(d,v);++g<w[c].length;)d=u[g].x-_,v=u[g].y-m,p.lineTo(d,v)}}if(a&&(p.closePath(),p.fillStyle=a,p.fill("evenodd")),n){p.closePath();var Q=p.createPattern(n,"");p.fillStyle=Q,p.fill("evenodd")}if(r){if(p.lineWidth=e||1,i&&p.setLineDash(i),p.strokeStyle=r,p.stroke(),"outset"==o||"inset"==o){var G=-10,S=this.canvas.width+10,M=-10,L=this.canvas.height+10,T=2048;p.beginPath();for(var c=0;c<w.length;c++){var u=w[c],F=Math.PI/3;"inset"==o&&(F=-F);for(var I=Math.cos(F),k=Math.sin(F),z=10,d=u[0].x-_,v=u[0].y-m,g=0,D=d,E=v,C=z;++g<u.length;){var y=u[g].x-_,A=u[g].y-m;if(d>=G&&d<S&&v>=M&&v<L||y>=G&&y<S&&A>=M&&A<L){var B=y-d,N=A-v,U=Math.sqrt(B*B+N*N);if(U<T){for(var j=U,V=0;j>=C;){V+=C;var l=V/U,O=d+B*l,X=v+N*l,Y=O-D,H=X-E,K=D+.5*(O-D),$=E+.5*(X-E),q=I*Y-k*H+D,Z=k*Y+I*H+E,J=(K-q)*(K-q)+($-Z)*($-Z);J<z*z*2&&(p.moveTo(q,Z),p.lineTo(K,$)),D=O,E=X,j-=C,C=z}C-=j}}d=y,v=A}}p.closePath(),p.stroke()}i&&p.setLineDash([])}}},this._fragmentPath=function(t){for(var e=[],i=0;i<t.length;i++){var r=t[i][1],a=t[i][0];if(i>0){var n=t[i-1][1],o=t[i-1][0],s=a-o;s<-180?(s+=360,a+=360):s>=180&&(s-=360,o+=360);var l=Math.abs(s);if(l>1){var h=new WRAP.Geo.GreatCircle(n,o,r,a),f=n,c=o;e.push([c,f]);for(var u=0;u+1<l;){u+=1;var d=u/l,v=h.getPosition(d);e.push([v.lon,v.lat]),f=v.lat,c=v.lon}}else e.push([o,n])}e.push([a,r])}return e},this._addFragments=function(e,i){for(var r=t.canvasLine(i),a=0;a<r.length;a++)e.push(r[a])},this.drawPath=function(t,e,i,r,a,n,o,s,l){if(t&&t.length){var h={};if(n){var f=n;if(WRAP.Geo.imageError[f])return;var h=WRAP.Geo.imageCache[f];if(void 0==h)return h=WRAP.Geo.imageCache[f]={loaded:!1,image:new Image,url:f},h.image.onload=function(){h.loaded=!0,WRAP.Geo.invalidate()},h.image.onerror=function(){WRAP.Geo.imageError[h.url]=!0,WRAP.Geo.updateLayerStatus()},void(h.image.src=f)}if(!n||h.loaded){var c=[];if(Array.isArray(t[0][0])){for(var u=0;u<t.length;u++)if(!(t[u].length<2)){var d=t[u];s&&(d=this._fragmentPath(t[u])),this._addFragments(c,d)}if(!c.length)return}else{if(t.length<2)return;var d=t;s&&(d=this._fragmentPath(t)),this._addFragments(c,d)}this._drawLines(c,e,i,r,a,h.image,o,l)}}},this.drawArc=function(t,e,i,r,a,n,o,s,l,h){var f={};if(l){var c=l;if(WRAP.Geo.imageError[c])return;var f=WRAP.Geo.imageCache[c];if(void 0==f)return f=WRAP.Geo.imageCache[c]={loaded:!1,image:new Image,url:c},f.image.onload=function(){f.loaded=!0,WRAP.Geo.invalidate()},f.image.onerror=function(){WRAP.Geo.imageError[f.url]=!0,WRAP.Geo.updateLayerStatus()},void(f.image.src=c)}if(!l||f.loaded){var u=[],d=!1;if(i==r||Math.abs(r-i)>360){var d=!0;i=0,r=360}var v=1;e<5e5?v=5:e<1e5&&(v=2),e/=1851.8518518518517;for(var g=i;g<r;g+=v){var p=WRAP.Geo.gcPos(t[1],t[0],g,e);u.push([p.lon,p.lat])}var p=WRAP.Geo.gcPos(t[1],t[0],r,e);if(u.push([p.lon,p.lat]),u.length<2)return;var _=[],m=this._fragmentPath(u);if(this._addFragments(_,m),d)this._drawLines(_,a,n,o,s,f.image,null,h);else{if(s||f.image){var x=[];u.push(t),u.unshift(t);var m=this._fragmentPath(u);this._addFragments(x,m),this._drawLines(x,a,null,null,s,f.image,null,h)}this._drawLines(_,a,n,o,null,null,null,h)}}},this.drawPoint=function(e,i,r,a,n,o){function s(t,e,o){n&&(t.fillStyle=n,t.beginPath(),t.arc(e,o,i/2-1,0,2*Math.PI,!0),t.closePath(),t.fill()),a&&(t.strokeStyle=a,t.lineWidth=r||1,t.beginPath(),t.arc(e,o,i/2-1,0,2*Math.PI,!0),t.closePath(),t.stroke())}if(o&&this.primary_surface)return void(this.blinked=!0);var l=this.ctx,h=t.canvasPoint(e),f=h[0],c=h[1],u=-i,d=this.canvas.width+i,v=-i,g=this.canvas.height+i;if(!(c<v||g<c)){u<=f&&f<=d&&s(l,f,c);var p=f-this.canvas_band;u<=p&&p<=d&&s(l,p,c);var _=f+this.canvas_band;u<=_&&_<=d&&s(l,_,c)}},this.drawLine=function(e,i,r,a,n,o,s,l,h,f){function c(t,e,i){if(!(e.length<2)){for(var r,a,n=[],o=0;o<e.length;o++){var s=e[o][0],l=e[o][1];if(h){var f=s*v-l*g,c=s*g+l*v;s=f,l=c}s+=p[0],l+=p[1],0==o?r=a=s:(r>s&&(r=s),a<s&&(a=s)),n.push(new WRAP.Geo.ScreenPoint(s,l))}t.push(n);var d=u.x-i/2,_=d-i,m=u.x+i/2,x=m+i;if(r<d&&a>_){for(var A=[],o=0;o<n.length;o++)A.push(new WRAP.Geo.ScreenPoint(n[o].x+i,n[o].y));t.push(A)}if(r<x&&a>m){for(var A=[],o=0;o<n.length;o++)A.push(new WRAP.Geo.ScreenPoint(n[o].x-i,n[o].y));t.push(A)}}}var u={};if(s){var d=s;if(WRAP.Geo.imageError[d])return;var u=WRAP.Geo.imageCache[d];if(void 0==u)return u=WRAP.Geo.imageCache[d]={loaded:!1,image:new Image,url:d},u.image.onload=function(){u.loaded=!0,WRAP.Geo.invalidate()},u.image.onerror=function(){WRAP.Geo.imageError[u.url]=!0,WRAP.Geo.updateLayerStatus()},void(u.image.src=d)}if(!s||u.loaded){var v,g,p=t.canvasPoint(e);h&&(v=Math.cos(Math.PI*h/180),g=Math.sin(Math.PI*h/180));var _=[];if(Array.isArray(i[0][0]))for(var m=0;m<i.length;m++)c(_,i[m],this.canvas_band);else c(_,i,this.canvas_band);if(!_.length)return;this._drawLines(_,r,a,n,o,u.image,l,f)}},this.drawText=function(e,i,r,a,n,o,s,l,h){function f(t,e,r,a,o){h?(t.save(),t.translate(e,r),t.rotate(h/180*Math.PI),t.translate(a,o),n&&(t.lineWidth=2,t.strokeStyle=n,t.strokeText(i,0,0)),t.fillText(i,0,0),t.restore()):(n&&(t.lineWidth=2,t.strokeStyle=n,t.strokeText(i,e+a,r+o)),t.fillText(i,e+a,r+o))}var c=this.ctx;r&&(c.font=r+"px Arial"),a&&(c.fillStyle=a);var u=parseFloat(o)||0,d=parseFloat(s)||0,v=c.measureText(i);"left"==l?u+=0:u-="right"==l?v.width:.5*v.width;var g=t.canvasPoint(e),p=g[0],_=g[1],m=v.width,x=-m,A=this.canvas.width+m,P=-m,y=this.canvas.height+m;if(!(_<P||y<=_)){x<=p&&p<=A&&f(c,p,_,u,d);var w=p-this.canvas_band;x<=w&&w<=A&&f(c,w,_,u,d);var b=p+this.canvas_band;x<=b&&b<=A&&f(c,b,_,u,d)}},this.drawTile=function(e,i){function r(){this._11=1,this._12=0,this._21=0,this._22=1}function a(t,e,i,a){if((i[0]!=i[1]||i[2]!=i[3])&&!(i[0]==i[1]&&i[4]==i[5]||i[2]==i[3]&&i[4]==i[5])){var n=.1,o=(i[0]+i[2]+i[4])/3,s=(i[1]+i[3]+i[5])/3,l=i[0]-o,h=i[1]-s,f=i[2]-o,c=i[3]-s,u=i[4]-o,d=i[5]-s,v=Math.sqrt(l*l+h*h),g=Math.sqrt(f*f+c*c),p=Math.sqrt(u*u+d*d),_=(v+n)/v,m=(g+n)/g,x=(p+n)/p;i[0]=o+l*_,i[1]=s+h*_,i[2]=o+f*m,i[3]=s+c*m,i[4]=o+u*x,i[5]=s+d*x;var A=i[2]-i[0],P=i[3]-i[1],y=i[4]-i[0],w=i[5]-i[1],b=256*(a[2]-a[0]),R=256*(a[3]-a[1]),W=256*(a[4]-a[0]),G=256*(a[5]-a[1]),S=new r;S._11=b,S._12=R,S._21=W,S._22=G;var M=S.getInvert();if(M){var L,T,F,I;L=M._11*A+M._12*y,F=M._21*A+M._22*y,T=M._11*P+M._12*w,I=M._21*P+M._22*w,t.save(),t.beginPath(),t.moveTo(i[0],i[1]),t.lineTo(i[2],i[3]),t.lineTo(i[4],i[5]),t.closePath(),t.clip(),t.transform(L,T,F,I,i[0]-(L*a[0]*e.width+F*a[1]*e.height),i[1]-(T*a[0]*e.width+I*a[1]*e.height)),t.drawImage(e,0,0),t.restore()}}}r.prototype.getInvert=function(){var t=new r,e=this._11*this._22-this._12*this._21;return e>-1e-4&&e<1e-4?null:(t._11=this._22/e,t._22=this._11/e,t._12=-this._12/e,t._21=-this._21/e,t)},this.tile(function(r){if(r.id==e.id){var n=document.createElement("canvas");n.width=256,n.height=256;var o=n.getContext("2d");o.putImageData(i,0,0,0,0,256,256),o.fillStyle="rgba(0,0,0,0.0)",o.fillRect(0,0,1,1);for(var s=4,l=1/256,h=1/s*255/256,f=0;f<s;f++){var c=r.bounds.north/60+(r.bounds.south/60-r.bounds.north/60)*(f/s),u=r.bounds.north/60+(r.bounds.south/60-r.bounds.north/60)*((f+1)/s),d=f*h,v=(f+1)*h;d+=l;for(var g=0;g<s;g++){var p=r.bounds.west/60+(r.bounds.east/60-r.bounds.west/60)*(g/s),_=r.bounds.west/60+(r.bounds.east/60-r.bounds.west/60)*((g+1)/s),m=g*h,x=(g+1)*h;m+=l;var A=t.canvasPoint([p,c]),P=t.canvasPoint([_,c]),y=t.canvasPoint([p,u]),w=t.canvasPoint([_,u]);if(Math.abs(A[0])>1e5||Math.abs(A[1])>1e5)return;if(Math.abs(w[0])>1e5||Math.abs(w[1])>1e5)return;a(r.ctx,n,[A[0],A[1],P[0],P[1],w[0],w[1]],[m,d,x,d,x,v]),a(r.ctx,n,[w[0],w[1],A[0],A[1],y[0],y[1]],[x,v,m,d,m,v])}}}})},this.begin=function(t){this.blinked=!1,this.hitcvs||(this.hitcvs=document.createElement("canvas"),this.hitctx_base=this.hitcvs.getContext("2d")),this.hitctx=this.hitctx_base;var e={width:this.size[0],height:this.size[1]};if(this.hitcvs.width==e.width&&this.hitcvs.height==e.height||(this.hitcvs.width=e.width,this.hitcvs.height=e.height),this.hitctx.clearRect(0,0,e.width,e.height),this.ctx){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.secondary_ctx.clearRect(0,0,this.canvas.width,this.canvas.height);for(var i=0;i<this.tiles.length;i++){var r=this.tiles[i];r.revision!=t&&(r.valid=!1)}}},this.end=function(){e.initRender(this.blinked),this.rev++,e.setRegion({canvas:this.canvas,secondary_canvas:this.canvas,width:this.size[0],height:this.size[1]}),e.update()},this.rev=0},WRAP.Geo.Projection={},WRAP.Geo.Projection.PolarStereographics=function(t){function e(t){return t*Math.PI/180}function i(t){return 180*t/Math.PI}function r(t,e,i){return e*=i,Math.tan(.5*(f-t))/Math.pow((1-e)/(1+e),.5*i)}this.opt=t;var a,n=1e-10,o=8,s=1e-10,l=0,h=1,f=1.5707963267948966,c=6378137,u=.08181919084262149,d=0,v=1,g=t.base_lon,p=t.lat_ts;p>=0?(this.orientation="North",a=h):(this.orientation="South",a=l,p=-p,g+=180,g>=180&&(g-=360));var _=p*Math.PI/180;if(Math.abs(_-f)<n)d=2*v/Math.sqrt(Math.pow(1+u,1+u)*Math.pow(1-u,1-u));else{var m=Math.sin(_);d=Math.cos(_)/r(_,m,u),m*=u,d/=Math.sqrt(1-m*m)}this.forward=function(t){var i=t[0],n=t[1];a==l&&(n=-n,i+=2*(180-g),i>=180&&(i-=360),i=-i);var o,s,h=e(i-g),f=e(n),v=Math.cos(h),p=Math.sin(h),_=Math.sin(f);return o=d*r(f,_,u),s=-o*v,o*=p,o*=c,s*=c,[o,s]},this.inverse=function(t){var e,r,n,h,v,p=t[0],_=t[1],m=0,x=0,A=0,P=0,y=0;p/=c,_/=c,v=Math.hypot(p,_),_=-_,A=f-2*Math.atan(x=-v/d),y=-f,P=-.5*u;for(var w=o;w--;A=m)if(h=u*Math.sin(A),m=2*Math.atan(x*Math.pow((1+h)/(1-h),P))-y,Math.abs(A-m)<s){n=0==p&&0==_?0:Math.atan2(p,_);break}return e=i(m),r=i(n)+g,a==l&&(e=-e,r=-r,r-=2*(180-g),r<-180&&(r+=360)),[r,e]},this.akm1=function(){return d};var x=111319.49079327333;this.pixelScale=function(t){var e=256*Math.pow(2,t)/360;e/=x;var i=1/e;return i},this.zoom=function(t){if(t<=0)return-1;var e=1/t;e*=x;var i=360*e/256,r=Math.log(2),a=Math.log(i)/r;return a},this.rotation=function(t,e){var i=e-(t[0]-g);return a==l&&(i=e+(t[0]-g)+180),i<-180&&(i+=360),i>=180&&(i-=360),i}},WRAP.Geo.Interaction=function(){function t(t,e,i){if(t&&e&&e.value){var e=e&&e.value();if(e){var r;if(0==t.name().indexOf("LiveCamera")){var a;if((a=u(e.area_name))||(a=new v(e,t._conf)),d(a),_!=a){var n=_;_&&_.tooltip&&_.hide(),_=a,n&&n.set(),_.visible||(_.tooltip=!0,a.show(e.lat,e.lon)),_.set()}}else t._tooltip_handler&&(r=t._tooltip_handler(e));if(r&&r.length)return s(r),void f(i.x,i.y)}l()}}function e(t){if(t&&(l(),0==t.name().indexOf("LiveCamera"))){_&&_.tooltip&&_.hide();var e=_;_=null,e&&e.set()}}function i(t,e){t&&(l(),0==t.name().indexOf("LiveCamera")&&_&&_.tooltip&&(e.query("image").load(function(){}),_.tooltip=!1,_.set()))}function r(){for(var t=0;t<S.length;t++){var e=S[t];if(e.pinned){var i=WRAP.Geo.getScreenPoint(e.window.point);
i.x+=M,i.y+=M,e.window.style.left=i.x+"px",e.window.style.top=i.y+"px"}}}function a(t){if(0==t.name().indexOf("LiveCamera")){for(var e=0;e<S.length;e++){var i=S[e];t.visible()?i.window.style.display=i.visible?"block":"none":(i.window.style.display="none",i.setImage(0)),i.animating=!1}WRAP.Geo.Interaction.live_camera._data.handler&&(WRAP.Geo.Interaction.live_camera._data.handler.auto_update=t.visible())&&WRAP.Geo.Interaction.live_camera.load()}}function n(t){var e=document.createElement("style"),i=document.createTextNode(t);e.media="screen",e.type="text/css",e.styleSheet?e.styleSheet.cssText=i.nodeValue:e.appendChild(i),document.getElementsByTagName("head")[0].appendChild(e)}function o(){if(!p){p=document.createElement("div"),p.style.display="block",p.style.top="-1000px",p.style.left="-1000px";var t=".tooltip {position: absolute;background: "+b+";color: "+R+";border: 1px solid "+W+";padding: 10px;    border-radius: 6px;    z-index: "+w+";    pointer-events: none;}.lt-arrow:after, .lt-arrow:before {right: 100%;top: "+G+"px;border: solid transparent;content: ' ';height: 0;width: 0;position: absolute;}.lt-arrow:after {    border-right-color: "+b+";    border-width: 8px;    margin-top: -8px;}.lt-arrow:before {    border-right-color: "+W+";    border-width: 9px;    margin-top: -9px;}.lb-arrow:after, .lb-arrow:before {right: 100%;bottom: "+G+"px;border: solid transparent;content: ' ';height: 0;width: 0;position: absolute;}.lb-arrow:after {    border-right-color: "+b+";    border-width: 8px;    margin-top: -8px;}.lb-arrow:before {    border-right-color: "+W+";    border-width: 9px;    margin-top: -9px;}.rt-arrow:after, .rt-arrow:before {left: 100%;top: "+G+"px;border: solid transparent;content: ' ';height: 0;width: 0;position: absolute;}.rt-arrow:after {    border-left-color: "+b+";    border-width: 8px;    margin-top: -8px;}.rt-arrow:before {    border-left-color: "+W+";    border-width: 9px;    margin-top: -9px;}.rb-arrow:after, .rb-arrow:before {left: 100%;bottom: "+G+"px;border: solid transparent;content: ' ';height: 0;width: 0;position: absolute;}.rb-arrow:after {    border-left-color: "+b+";    border-width: 8px;    margin-top: -8px;}.rb-arrow:before {    border-left-color: "+W+";    border-width: 9px;    margin-top: -9px;}";n(t)}l(),g.appendChild(p)}function s(t){p&&(p.innerHTML=t)}function l(){p&&(p.style.display="none",p.innerHTML="")}function h(){return"block"==p.style.display?p.innerHTML:null}function f(t,e){if(p&&p.innerHTML){var i=p.parentNode.clientWidth,r=p.parentNode.clientHeight;if(t<0||t>=i||e<0||e>=r)return void(p.style.display="none");p.style.display="block";var a=p.clientWidth,n=p.clientHeight;a>=i&&(a=0);var o,s,l=26,h=14,f=h+G;t+a+2*l>=i?(t-=a+l,o=" r"):(t+=l,o=" l"),e<f?e=h:e>=r-h-G?e=r-h-n:e+n-G>=r-f?(e-=n-G-2,e>h?s="b-arrow":e=h):(e-=G,e>h?s="t-arrow":e=h);var c="tooltip";o&&s&&(c+=o+s),p.style.top=""+e+"px",p.style.left=""+t+"px",p.setAttribute("class",c)}}function c(t){if(S=[],t){WRAP.Geo.Interaction.live_camera=t;var e=".smooth_tran {-webkit-transition-duration : 0.2s;-moz-transition-duration : 0.2s;-o-transition-duration : 0.2s;-ms-transition-duration : 0.2s;}.current_window {box-shadow : 0px 0px 50px #fff;border: 1px solid #fff;}.live_camera {position: absolute;background-color: "+C+";border: 1px solid "+B+";user-select: none;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;}.small_window {width: "+N+"px;height: "+(U+D)+"px;}.middle_window {width: "+j+"px;height: "+(V+D+E)+"px;}.image_s {position: absolute;width: 100%;height: "+U+"px;top: "+D+"px;background-color: #bbb;}.image_m {position: absolute;width: 100%;height: "+V+"px;top: "+D+"px;background-color: #bbb;}.camera_button {position: absolute;width:20px;height:20px;padding:0;border:solid 1px rgba(0,0,0,0);border-radius:4px;cursor:pointer;user-select: none;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;}.camera_button:hover {border:solid 1px rgba(150,150,150,0.8);}.camera_zoomin {top:3px; right:28px;background:url(img/bt_zoomIn.png) no-repeat left top;}.camera_zoomout {top:3px; right:28px;background:url(img/bt_zoomOut.png) no-repeat left top;}.camera_close {top:3px; right:4px;background:url(img/closebtn.png) no-repeat left top;}.camera_text {user-select: none;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;cursor:default;position: absolute;font-size:11px;color:black;width:100px;height:10px;}.camera_name {top:0px; left:4px;}.camera_time {top:13px; left:4px; width:180px;}.camera_time_button {font-size:10px;color:black;position: absolute;bottom:1px;width:32px;height:18px;padding:0;vertical-align:middle;border:solid 1px rgba(120,120,120,1.0);border-radius:4px;background-color: "+C+";cursor:pointer;}.camera_time_button:hover {background: #fefeff;}.camera_time_button:disabled {color:#999;border:solid 1px rgba(170,170,170,0.8);pointer-events: none;cursor:default;}";n(e),t.inspect(function(){for(var t=0;t<S.length;t++){var e=S[t];e.visible&&!e.animating&&0==e.index&&e.setImage(e.index)}})}}function u(t){for(var e=0;e<S.length;e++)if(S[e].camera.area_name==t)return S[e];return null}function d(t){for(var e=T,i=0;i<S.length;){var r=S[i];if(r==t){for(var a=i+1;a<S.length;)r=S[a-1]=S[a],r.window.style["z-index"]=e++,a++;S[a-1]=t;break}r.window.style["z-index"]=e++,i++}i==S.length&&S.push(t),t.window.style["z-index"]=e}function v(t,e){var i=this;this.camera=t,this.conf=e,this.visible=!1,this.small=!0,this.pinned=!0,this.tooltip=!0,this.animating=!1,this.smooth=!1;var r=this.window=document.createElement("div");r.controller=this,r.style.display="none",r.setAttribute("class","live_camera small_window");var a=this.canvas=document.createElement("div");a.width=F,a.height=I,a.setAttribute("class","image_s"),r.appendChild(this.name=document.createElement("div")),this.name.setAttribute("class","camera_text camera_name"),r.appendChild(this.time=document.createElement("div")),this.time.setAttribute("class","camera_text camera_time"),r.appendChild(this.zoom=document.createElement("button")),this.zoom.setAttribute("class","camera_button camera_zoomin"),r.appendChild(this.close=document.createElement("button")),this.close.setAttribute("class","camera_button camera_close");var n;r.appendChild(n=this.time_frst=document.createElement("button")),n.setAttribute("class","camera_time_button"),n.innerHTML="|",n.style.left="100px",n.style.display="none",r.appendChild(n=this.time_prev=document.createElement("button")),n.setAttribute("class","camera_time_button"),n.innerHTML="",n.style.left="140px",n.style.display="none",r.appendChild(n=this.time_play=document.createElement("button")),n.setAttribute("class","camera_time_button"),n.innerHTML="",n.style.left="180px",n.style.display="none",r.appendChild(n=this.time_next=document.createElement("button")),n.setAttribute("class","camera_time_button"),n.innerHTML="",n.style.left="220px",n.style.display="none",r.appendChild(n=this.time_last=document.createElement("button")),n.setAttribute("class","camera_time_button"),n.innerHTML="|",n.style.left="260px",n.style.display="none",r.appendChild(a),this.setImage=function(e){if(a=this.canvas,a.innerHTML="",this.index=e,this.name.innerHTML=t.l_name,this.time.innerHTML="--",t.image&&t.image.length){e<0&&(e=0),e>=t.image.length&&(e=t.image.length-1);var r=t.image[e];if(r.image&&(a.width=r.image.width||600,a.height=r.image.height||480,r.image.style.width="100%",r.image.style.height="100%",r.image.style["pointer-events"]="none",a.appendChild(r.image)),i.conf&&i.conf.Attributes&&i.conf.Attributes.date_format){var n=0,o=0,s=0,l=0,h=0,f=0;r.time&&r.time.length>=11&&(n=parseInt(r.time.substr(0,4)),o=parseInt(r.time.substr(4,2)),s=parseInt(r.time.substr(6,2)),l=parseInt(r.time.substr(9,2)),h=parseInt(r.time.substr(11,2))),r.time.length>=13&&(f=parseInt(r.time.substr(13,2)));var c=WRAP.Geo.formatTime(i.conf.Attributes.date_format,n,o,s,l,h,f);this.time.innerHTML=c}else{var u=WRAP.DH._timeString(WRAP.DH._setTime(WRAP.DH._time(r.time),32400)),d=Number(u.substr(6,2)),v=Number(u.substr(9,2)),g=Number(u.substr(11,2));this.time.innerHTML=""+d+" "+v+" "+g+""}i.time_frst.disabled=e==t.image.length-1,i.time_prev.disabled=e==t.image.length-1,i.time_play.disabled=t.image.length<=1,i.time_next.disabled=0==e,i.time_last.disabled=0==e}else i.time_frst.disabled=!0,i.time_prev.disabled=!0,i.time_play.disabled=!0,i.time_next.disabled=!0,i.time_last.disabled=!0;this.index=e},this.close.onclick=function(){i.hide()},this.zoom.onclick=function(){i.smooth=!0,i.small?(i.small=!1,i.set()):(i.small=!0,i.set())},this.animate=function(){if(!i.animating)return void(i.time_play.innerHTML="");i.time_play.innerHTML="";var t=i.index-1;t<0&&(t=i.camera.image.length-1),i.setImage(t),setTimeout(function(){i.animate()},500)},this.time_frst.onclick=function(){i.setImage(i.camera.image.length-1)},this.time_prev.onclick=function(){i.setImage(i.index+1)},this.time_play.onclick=function(){(i.animating=!i.animating)&&i.animate()},this.time_next.onclick=function(){i.setImage(i.index-1)},this.time_last.onclick=function(){i.setImage(0)},r.onmousedown=function(t){m=this,x=r.style.left.replace(/px/,""),A=r.style.top.replace(/px/,""),P=t.clientX-x,y=t.clientY-A,d(m.controller)},r.onmouseup=function(){m=!1},WRAP.Geo.addEventHandler("mousemove",function(t){if(m){var e=t.clientX-P,i=t.clientY-y;m.controller.pinned=!0,m.point=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(e-M,i-L)),m.style.left=e+"px",m.style.top=i+"px"}t._prevent=!0,t.preventDefault()}),this.set=function(){var t=i.smooth?"smooth_tran ":"";t+="live_camera",t+=i.small?" small_window":" middle_window",this.tooltip||this!=_||(t+=" current_window"),i.window.setAttribute("class",t),t=i.smooth?"smooth_tran ":"",t+=i.small?" image_s":" image_m",i.canvas.setAttribute("class",t),i.zoom.setAttribute("class",i.small?"camera_button camera_zoomin":"camera_button camera_zoomout"),i.time_frst.style.display=i.small?"none":"block",i.time_prev.style.display=i.small?"none":"block",i.time_play.style.display=i.small?"none":"block",i.time_next.style.display=i.small?"none":"block",i.time_last.style.display=i.small?"none":"block",i.zoom.style.display=i.tooltip?"none":"block",i.close.style.display=i.tooltip?"none":"block",!i.small&&i.visible||(i.animating=!1),i.small&&i.setImage(0),i.smooth&&setTimeout(function(){i.smooth=!1,i.set()},250)},this.show=function(t,e){i.set(),i.visible=!0,this.window.point=new WRAP.Geo.Point(t,e);var r=WRAP.Geo.getScreenPoint(this.window.point);r.x+=M,r.y+=M,this.window.style.top=""+r.y+"px",this.window.style.left=""+r.x+"px",this.window.style.display="block"},this.hide=function(){this.window.style.display="none",i.visible=!1,i.small=!0,i.animating=!1,i.setImage(0)},g.appendChild(r),this.setImage(0)}var g,p,_,m,x,A,P,y,w=1e4,b="#2e3a54",R="#ffffff",W="#ffffff",G=20,S=[],M=10,L=10,T=2e4,F=640,I=480,k=.3,z=.6,D=26,E=20,C="#f2f2f2",B="rgba(150,150,150,0.6)",N=Math.floor(F*k),U=Math.floor(I*k),j=Math.floor(F*z),V=Math.floor(I*z);return{init:function(n,s){g=s,o(),c(n),WRAP.Geo.addEventHandler("mouseover",t),WRAP.Geo.addEventHandler("mouseout",e),WRAP.Geo.addEventHandler("touch",i),WRAP.Geo.addEventHandler("boundsChange",r),WRAP.Geo.addEventHandler("visibilityChange",a)},setTooltip:function(t){s(t)},showTooltip:function(t,e){f(t,e)},clearTooltip:function(t,e){l(t,e)},getTooltip:function(){return h()},alignLiveCamera:function(){for(var t=0;t<S.length;t++){var e=S[t];e.pinned=!0}for(var i=g.clientLeft,r=g.clientTop,a=i+g.clientWidth,n=r+g.clientHeight,o=10,s=N+o,l=U+D+o,h=o;h+s<a;h+=s)for(var f=o;f+l<n;f+=l){for(var c=99999999,u=null,t=0;t<S.length;t++){var e=S[t];if(e.pinned&&e.visible){var d=e.window.style.left.replace(/px/,""),v=e.window.style.top.replace(/px/,""),p=d-h,_=v-f,m=p*p+_*_;c>m&&(c=m,u=e)}}u&&(u.smooth=!0,u.small=!0,u.pinned=!1,u.window.point=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(h,f)),u.window.style.left=h+"px",u.window.style.top=f+"px",u.set())}},mouseover:[],mouseout:[],mousemove:[],touch:[],boundsChange:[],visibilityChange:[]}}(),WRAP.Geo.setOpenLayers=function(t){return t.getInteractions().forEach(function(t){t instanceof ol.interaction.DragRotate&&t.setActive(!1),t instanceof ol.interaction.PinchRotate&&t.setActive(!1)},this),WRAP.Geo.map=new WRAP.Geo.Bridge.OpenLayers(t),WRAP.Geo.render(),WRAP.Geo.map},WRAP.Geo.Bridge.OpenLayers=function(t){var e=this;this.map=t,this.pixelRatio=window.devicePixelRatio;var i=t.getView(),r=i.getProjection();this.context=new WRAP.Geo.Context(this),this.canvas,this.zoom=i.getZoom(),this.center=i.getCenter(),this.bounds=0,this.setView=function(t,e){r=i.getProjection(),this.view||(this.view=new WRAP.Geo.View(this)),this.context=this.view.setProjection(t,e)},this.tileID=function(t,e,i){return"M/"+t+"/"+e+"/"+i},this.refresh=function(){t.updateSize(),this.refresh_timer&&clearInterval(this.refresh_timer),this.refresh_timer=setInterval(function(){var r=i.getProjection();r&&(clearInterval(e.refresh_timer),e.zoom=i.getZoom(),e.center=i.getCenter(),i.setZoom(e.zoom),i.setCenter(e.center),t.updateSize())},1)},this.updateBounds=function(t){function a(t,e,i,a){var n=t.findTile(e,i,a);if(n)return void(n.locked=!1);var o=new Float32Array(131072),s=Math.pow(2,parseInt(e)),l=parseFloat(a)/s,h=(parseFloat(i)+1)/s;l=l*(_[2]-_[0])+_[0],h=h*(_[3]-_[1])+_[1];for(var f=(_[2]-_[0])/s/256,c=(_[3]-_[1])/s/256,u={x:[257],y:[257]},d=0;d<257;d++){var v=l+f*parseFloat(d),g=h-c*parseFloat(d),p=ol.proj.transform([v,h],r,"EPSG:4326");u.x[d]=p[0],u.x[d]<-180?u.x[d]+=360:u.x[d]>=180&&(u.x[d]-=360),d>0&&u.x[d-1]>u.x[d]&&(u.x[d]+=360);var m=ol.proj.transform([l,g],r,"EPSG:4326");u.y[d]=m[1]}for(var d=0,x=0;x<256;x++)for(var A=0;A<256;A++)o[d++]=u.y[x],o[d++]=u.x[A];t.addTile("M",e,i,a,o,new WRAP.Geo.Bounds(60*u.y[0],60*u.y[256],60*u.x[256],60*u.x[0]))}var n=i.getCenter(),o=ol.proj.transform(n,r,"EPSG:4326");if(o[0]<-180)for(;o[0]<-180;)o[0]+=360,i.setCenter(ol.proj.transform(o,"EPSG:4326",r));if(o[0]>=180)for(;o[0]>=180;)o[0]-=360,i.setCenter(ol.proj.transform(o,"EPSG:4326",r));e.zoom=i.getZoom(),e.center=i.getCenter();var s=e.map.getSize(),l=e.map.getCoordinateFromPixel([0,0]),h=e.map.getCoordinateFromPixel(s),f=ol.proj.transform(l,r,"EPSG:4326"),c=ol.proj.transform(h,r,"EPSG:4326");if(e.bounds=new WRAP.Geo.Bounds(60*f[1],60*c[1],60*c[0],60*f[0]),e.view){var u=e.map.getPixelFromCoordinate(e.center),o=ol.proj.transform(e.center,r,"EPSG:4326"),d=e.view.canvasPoint(o);return e.view.setOffset([u[0]-d[0],u[1]-d[1]]),e.view.updateContext(),e.last_rate=-1,void WRAP.Geo.updateBounds(e.bounds,t)}var v=256*Math.pow(2,e.zoom);s[0]>=v&&(e.bounds=new WRAP.Geo.Bounds(60*f[1],60*c[1],10800,-10800));var g=Math.floor(e.zoom),p=Math.pow(2,g),_=ol.proj.get("EPSG:3857").getExtent();l[0]-=_[0],h[0]-=_[0],l[1]-=_[1],h[1]-=_[1];var m=_[2]-_[0],x=_[3]-_[1];l[0]=l[0]/m,h[0]=h[0]/m,l[1]=l[1]/x,h[1]=h[1]/x;var A=Math.floor(l[0]*p),P=Math.floor((256==h[0]?255:h[0])*p),y=Math.floor(h[1]*p),w=Math.floor(l[1]*p);for(w>=p&&(w=p-1),y<0&&(y=0),P-A>=p-1&&(A=0,P=p-1),A%=p,P%=p;A<0;)A+=p;for(;P<0;)P+=p;if(!t){this.context.lockTile();for(var b=Math.pow(2,g),R=y;R<=w;R++)if(A<=P)for(var W=A;W<=P;W++)a(this.context,g,R,W);else{for(var W=A;W<b;W++)a(this.context,g,R,W);for(var W=0;W<=P;W++)a(this.context,g,R,W)}this.context.clearLockedTile(),e.context.setTileBand(e.zoom,A,P,y,w)}e.last_rate=-1,WRAP.Geo.updateBounds(e.bounds,t)},window.setTimeout(function(){e.updateBounds()},1e3),this.setTile=function(t){function i(t,i,r,a){var n=parseFloat(t)/r,o=parseFloat(i+1)/r;n=n*(a[2]-a[0])+a[0],o=o*(a[3]-a[1])+a[1];var s=e.map.getPixelFromCoordinate([e.canvas.extent[0],e.canvas.extent[3]]),l=e.map.getPixelFromCoordinate([n,o]);if(!s||!l)return null;var h=Math.round(l[0])-Math.floor(s[0]),f=Math.round(l[1])-Math.floor(s[1]);return{x:h,y:f}}if(e.canvas){var r=ol.proj.get("EPSG:3857").getExtent(),a=Math.pow(2,parseInt(t.z)),n=Math.floor(this.context.canvas_band),o=i(t.x,t.y,a,r),s=i(t.x+1,t.y-1,a,r);if(o&&s){var l=o.x,h=o.y,f=e.pixelRatio,c=s.x-l,u=s.y-h,d=Math.floor(t.offset_x*this.context.tile_racio),v=Math.floor(t.offset_y*this.context.tile_racio),g=Math.floor(t.width*this.context.tile_racio),p=Math.floor(t.height*this.context.tile_racio);e.regions.push({src1:t.canvas,src2:t.secondary_canvas,sx:d,sy:v,sw:g,sh:p,dx:l*f,dy:h*f,dw:c*f,dh:u*f});for(var _,m=1;(_=l-n*m)>-256;)e.regions.push({src1:t.canvas,src2:t.secondary_canvas,sx:d,sy:v,sw:g,sh:p,dx:_*f,dy:h*f,dw:c*f,dh:u*f}),m++;for(m=1;(_=l+n*m)<e.canvas.width;)e.regions.push({src1:t.canvas,src2:t.secondary_canvas,sx:d,sy:v,sw:g,sh:p,dx:_*f,dy:h*f,dw:c*f,dh:u*f}),m++}}},this.setRegion=function(t){var i=e.pixelRatio;e.regions.push({src1:t.canvas,src2:t.secondary_canvas,sx:0,sy:0,sw:t.width,sh:t.height,dx:t.width/i-t.width,dy:t.height/i-t.height,dw:t.width*i,dh:t.height*i})},this.map.on("moveend",function(){e.updateBounds()}),this.map.on("pointermove",function(t){var i=e.map.getPixelFromCoordinate(t.coordinate),a=ol.proj.transform(t.coordinate,r,"EPSG:4326");e.mouse_point=new WRAP.Geo.Point(60*a[1],60*a[0]),e.mouse_screenpoint=new WRAP.Geo.ScreenPoint(i[0],i[1])});var a=function(t,r,a,n,o){r=null,a=null,o=null;var s=e.canvas,l=window.devicePixelRatio;e.last_rate=-1,e.regions=[],e.canvas=document.createElement("canvas"),e.canvas.ctx=e.canvas.getContext("2d"),e.canvas.extent=t;var h=n[0],f=n[1];if(e.canvas.setAttribute("width",h),e.canvas.setAttribute("height",f),s){var c=e.map.getPixelFromCoordinate([s.extent[0],s.extent[3]]),u=e.map.getPixelFromCoordinate([t[0],t[3]]),d=s.extent[2]-s.extent[0],v=t[2]-t[0],g=c[0]-u[0],p=c[1]-u[1],_=d/v,m=s.width,x=s.height,A=e.canvas.width*_,P=e.canvas.height*_;e.zoom=i.getZoom();var y=[g];if(!e.view){for(var w=256*Math.pow(2,e.zoom),b=w;g+b<e.canvas.width;)y.push(g+b),b+=w;for(b=-w;g+b+A>0;)y.push(g+b),b+=-w}for(var R=0;R<y.length;R++)e.canvas.ctx.clearRect(y[R],p,A,P),1==l&&e.canvas.ctx.drawImage(s,0,0,m,x,y[R],p,A,P)}return e.view&&(e.zoom=i.getZoom(),e.view.updateBounds(e.zoom,t,n)),WRAP.Geo.invalidate(),e.canvas},n=new ol.layer.Image({source:new ol.source.ImageCanvas({canvasFunction:a,projection:r})});this.map.addLayer(n),this.getSize=function(){var t=e.map.getSize();return{width:t[0],height:t[1]}},this.getScreenPoint=function(t){function i(t,e){var i=20037508.34*t/180,r=Math.log(Math.tan((90+e)*Math.PI/360))/(Math.PI/180);return r=20037508.34*r/180,[i,r]}if(!t)return new WRAP.Geo.ScreenPoint(0,0);var a=t.lonDegree(),n=t.latDegree(),o=ol.proj.transform([a,n],"EPSG:4326",r);if(!this.view&&Math.abs(n)>=85){var s=i(a,n);o[1]=s[1]}if(!o)return new WRAP.Geo.ScreenPoint(0,0);var l=e.map.getPixelFromCoordinate(o);if(!l)return new WRAP.Geo.ScreenPoint(0,0);if(!this.view){var h=this.map.getView(),f=ol.extent.getWidth(h.getProjection().getExtent())/h.getResolution();l[0]=(l[0]%f+f)%f}return new WRAP.Geo.ScreenPoint(l[0],l[1])},this.getScreenRotation=function(t,i){return e.view?e.view.rotation([t.lonDegree(),t.latDegree()],i):i},this.getScreenLine=function(t,i,a){function n(t,e,i,r,a){for(var n=-p;i+n>r;)r<i+n&&e+n<a&&t.indexOf(n)<0&&t.push(n),n-=p;for(n=p;e+n<a;)r<i+n&&e+n<a&&t.indexOf(n)<0&&t.push(n),n+=p}var o=[];if(!e.view){var s=e.bounds.north/60,l=e.bounds.south/60;if(a>=s||i<=l)return o}for(var h=999999,f=-999999,c=[],u=0;u<t.length;u++){var d=ol.proj.transform([t[u][1],t[u][0]],"EPSG:4326",r),v=e.map.getPixelFromCoordinate(d),g=v[0];h>g&&(h=g),f<g&&(f=g),c.push(new WRAP.Geo.ScreenPoint(v[0],v[1]))}var p=e.context.canvas_band;if(p){for(var _=e.getScreenPoint(new WRAP.Geo.Point(0,0)),m=e.map.getSize()[0]/2;_.x-m>=p/2;)_.x-=p;for(;_.x-m<-p/2;)_.x+=p;var x=_.x+e.context.offset_x,A=x+p;o.push(c);var P=[];n(P,h,f,x,A),A>0&&n(P,h,f,x-p,A-p),x<0&&n(P,h,f,x+p,A+p);for(var a=0;a<P.length;a++){for(var y=P[a],w=[],u=0;u<c.length;u++)w.push(new WRAP.Geo.ScreenPoint(c[u].x+y,c[u].y));o.push(w)}}else o.push(c);return o},this.getPoint=function(t){if(!t)return new WRAP.Geo.Point(0,0);var i=e.map.getCoordinateFromPixel([t.x,t.y]);if(!i)return new WRAP.Geo.Point(0,0);var a=ol.proj.transform(i,r,"EPSG:4326");return new WRAP.Geo.Point(60*a[1],60*a[0])},this.getCenterPoint=function(){if(!i.getProjection())return null;var t=i.getCenter(),e=ol.proj.transform(t,r,"EPSG:4326");return new WRAP.Geo.Point(60*e[1],60*e[0])},this.setCenterPoint=function(t){i.setCenter(ol.proj.transform([t.lonDegree(),t.latDegree()],"EPSG:4326",r))},this.getZoom=function(){return this.zoom},this.setZoom=function(t){i.setZoom(t);var e=i.getZoom();isNaN(e)&&(t=t.Floor(t)),i.setZoom(this.zoom=t)},this.getPerspective=function(i,a){if(!i||!i.length)return{center:this.getCenterPoint(),zoom:Math.floor(this.getZoom()),fractional_zoom:this.getZoom()};if(void 0===a&&(a=0),e.view)return e.view.getPerspective(i,a);for(var n=i[0].lat,o=i[0].lon,s=n,l=n,h=o,f=o,c=1;c<i.length;c++){var n=i[c].lat,u=i[c].lon-o;o=u>=10800?i[c].lon-21600:u<-10800?i[c].lon+21600:i[c].lon,h>o&&(h=o),f<o&&(f=o),s>n&&(s=n),l<n&&(l=n)}o<-10800?o+=21600:o>=10800&&(o-=21600);var d=ol.proj.transform([h/60,s/60],"EPSG:4326",r),v=ol.proj.transform([f/60,l/60],"EPSG:4326",r),g=(d[1]+v[1])/2,p=(v[0]+d[0])/2,_=ol.proj.transform([p,g],r,"EPSG:4326");n=_[1],o=_[0];var m=6388019798183263e-21;d=[d[0]*m,d[1]*m],v=[v[0]*m,v[1]*m];var x=Math.abs(d[1]-v[1]),A=Math.abs(v[0]-d[0]),P=t.getSize(),y=P[0]-2*a,w=P[1]-2*a,b=Math.log(2),R=x>0?Math.log(w/x)/b:19,W=A>0?Math.log(y/A)/b:19,G=R<W?R:W,S=Math.floor(G);return G>19&&(S=G=19),{center:new WRAP.Geo.Point(60*n,60*o),zoom:S,fractional_zoom:G}},this.initRender=function(t){this.regions=[],this.last_rate=-1,this.animation=t},this.update=function(t){if(t&&this.updateBounds(),this.animation){if(!this.animation_timer){var i=new Date;this.animation_timer=setInterval(function(){var t=new Date,r=(t.getTime()-i.getTime())/1e3,a=1,n=.5,o=.5,s=a+n+2*o,l=r-Math.floor(r/s)*s,h=0;if(l<=a)h=1;else if(l<=a+o){var f=(l-a)/o;h=1-f,h*=h}else if(l<=a+o+n)h=0;else{var f=(s-l)/o;h=1-f,h*=h}if(e.last_rate!=h){e.last_rate=h;for(var c=0;c<e.regions.length;c++){var u=e.regions[c];e.canvas.ctx.clearRect(u.dx,u.dy,u.dw,u.dh),h<=0&&e.canvas.ctx.drawImage(u.src1,u.sx,u.sy,u.sw,u.sh,u.dx,u.dy,u.dw,u.dh)}if(h>0){e.canvas.ctx.save(),e.canvas.ctx.globalAlpha=Math.sqrt(2*h);for(var c=0;c<e.regions.length;c++){var u=e.regions[c];e.canvas.ctx.drawImage(u.src2,u.sx,u.sy,u.sw,u.sh,u.dx,u.dy,u.dw,u.dh)}e.canvas.ctx.globalAlpha=1-h;for(var c=0;c<e.regions.length;c++){var u=e.regions[c];e.canvas.ctx.drawImage(u.src1,u.sx,u.sy,u.sw,u.sh,u.dx,u.dy,u.dw,u.dh)}e.canvas.ctx.restore()}e.map.render()}},100)}}else{this.animation_timer&&(clearInterval(this.animation_timer),this.animation_timer=null);for(var r=0;r<e.regions.length;r++){var a=e.regions[r];if(e.canvas.ctx.clearRect(a.dx,a.dy,a.dw,a.dh),!a.src1)return;e.canvas.ctx.drawImage(a.src1,a.sx,a.sy,a.sw,a.sh,a.dx,a.dy,a.dw,a.dh)}this.last_rate=-1,this.map.render()}},this.enableScroll=function(t){this.map.getInteractions().forEach(function(e){e instanceof ol.interaction.DragPan&&e.setActive(t)},this)}},WRAP.Geo.setGoogleMaps=function(t){function e(t){this.tileSize=t}WRAP.Geo.map=new WRAP.Geo.Bridge.GoogleMaps(t);var i=WRAP.Geo.map.map;return e.prototype.getTile=function(t,e,i){var r=Math.pow(2,e),a=t.x,n=r-t.y-1,o=WRAP.Geo.map.tileID(e,n,a),s=document.getElementById(o);return s?s:(s=i.createElement("canvas"),s.id=o,s.width=256,s.height=256,s.ctx=s.getContext("2d"),setTimeout(function(){WRAP.Geo.invalidate()},10),s)},WRAP.Geo.map.overland_layer=new e(new google.maps.Size(256,256)),WRAP.Geo.map.overland_layer_index=i.overlayMapTypes.length,i.overlayMapTypes.push(null),WRAP.Geo.map.setOverLandLayer(!0),WRAP.Geo.map},WRAP.Geo.Bridge.GoogleMaps=function(t){var e=this;this.map=t,this.context=new WRAP.Geo.Context(this),this.zoom=t.getZoom(),this.center=t.getCenter(),this.projection=t.getProjection(),this.bounds=t.getBounds(),this.tileID=function(t,e,i){return"M/"+t+"/"+e+"/"+i},this.refresh=function(){WRAP.Geo.invalidate(),setTimeout(function(){google.maps.event.trigger(t,"resize");var i=setInterval(function(){t.getProjection()&&(t.setCenter(e.center),t.setZoom(e.zoom),clearInterval(i))},10)},1)},this.updateBounds=function(i){this.updateTimer&&clearTimeout(this.updateTimer),this.updateTimer=setTimeout(function(){function r(t,i,r,a){var n=t.findTile(i,r,a);if(n)return void(n.locked=!1);for(var o=new Float32Array(131072),s=Math.pow(2,parseInt(i)),l=256*parseFloat(a)/s,h=256*(s-parseFloat(r)-1)/s,f=1/s,c={x:[257],y:[257]},u=0;u<257;u++){var d=l+f*parseFloat(u),v=h+f*parseFloat(u),g=e.projection.fromPointToLatLng(new google.maps.Point(d,h));c.x[u]=g.lng(),c.x[u]<-180?c.x[u]+=360:c.x[u]>=180&&(c.x[u]-=360),u>0&&c.x[u-1]>c.x[u]&&(c.x[u]+=360);var p=e.projection.fromPointToLatLng(new google.maps.Point(l,v));c.y[u]=p.lat()}for(var u=0,_=0;_<256;_++)for(var m=0;m<256;m++)o[u++]=c.y[_],o[u++]=c.x[m];t.addTile("M",i,r,a,o,new WRAP.Geo.Bounds(60*c.y[0],60*c.y[256],60*c.x[256],60*c.x[0]))}if(e.projection=t.getProjection(),e.projection&&(e.center=t.getCenter(),e.zoom=t.getZoom(),e.bounds=t.getBounds(),e.bounds&&e.projection)){var a=e.bounds,n=a.getNorthEast(),o=a.getSouthWest(),s=e.projection.fromLatLngToPoint(n),l=e.projection.fromLatLngToPoint(o);if(!isNaN(s.x)&&!isNaN(l.x)){var h=Math.pow(2,e.zoom),f=Math.floor(l.x*h/256),c=Math.floor((256==s.x?255:s.x)*h/256),u=h-Math.floor(l.y*h/256)-1,d=h-Math.floor(s.y*h/256)-1;if(d>=h&&(d=h-1),u<0&&(u=0),c-f>=h-1&&(f=0,c=h-1),!i){e.context.lockTile();for(var v=Math.pow(2,e.zoom),g=u;g<=d;g++)if(f<=c)for(var p=f;p<=c;p++)r(e.context,e.zoom,g,p);else{for(var p=f;p<v;p++)r(e.context,e.zoom,g,p);for(var p=0;p<=c;p++)r(e.context,e.zoom,g,p)}e.context.clearLockedTile(),e.context.setTileBand(e.zoom,f,c,u,d)}WRAP.Geo.updateBounds(new WRAP.Geo.Bounds(60*n.lat(),60*o.lat(),60*n.lng(),60*o.lng()),i)}}},10)},window.setTimeout(function(){e.updateBounds()},1e3),google.maps.event.addListener(t,"zoom_changed",function(){e.updateBounds()}),google.maps.event.addListener(t,"bounds_changed",function(){e.updateBounds()}),google.maps.event.addListener(t,"idle",function(){e.updateBounds()}),this.setOverLandLayer=function(t){this.map.overlayMapTypes.setAt(WRAP.Geo.map.overland_layer_index,t?WRAP.Geo.map.overland_layer:null)},this.setTile=function(t,i){function r(r,a,n){var o=e.tileID(r,a,n),s=document.getElementById(o);return!!s&&(e.regions.push({cvs:s,revision:i,src1:t.canvas,src2:t.secondary_canvas,x:t.offset_x,y:t.offset_y}),!0)}var a=Math.pow(2,t.z);r(t.z,t.y,t.x);for(var n=parseInt(t.x),o=1;o<24;)r(t.z,t.y,n+o*a)?(n+=o*a,o=1):o++;for(n=parseInt(t.x),o=1;o<24;)r(t.z,t.y,n-o*a)?(n-=o*a,o=1):o++},this.getSize=function(){return{width:t.getDiv().offsetWidth,height:t.getDiv().offsetHeight}},this.getScreenPoint=function(e){if(this.projection){for(var i=this.projection.fromLatLngToPoint(new google.maps.LatLng(e.latDegree(),e.lonDegree())),r=this.projection.fromLatLngToPoint(this.center),a=i.x-r.x,n=i.y-r.y;a<-128;)a+=256;for(;a>=128;)a-=256;var o=Math.pow(2,this.zoom),s=.5*t.getDiv().offsetWidth+a*o,l=.5*t.getDiv().offsetHeight+n*o;return new WRAP.Geo.ScreenPoint(Math.floor(s),Math.floor(l))}return new WRAP.Geo.ScreenPoint(0,0)},this.getScreenRotation=function(t,e){return t=null,e},this.getScreenLine=function(e,i,r){function a(t){G.indexOf(t)<0&&G.push(t)}var n=[];if(!this.projection)return n;var o=Math.pow(2,this.zoom),s=256*o,l=.5*t.getDiv().offsetWidth,h=.5*t.getDiv().offsetHeight,f=this.context.offset_x,c=f+this.context.canvas.width,u=this.context.bounds.n,d=this.context.bounds.s;if(r>=u||i<=d)return n;for(var v=this.projection.fromLatLngToPoint(this.center);v.x>256;)v.x-=256;for(;v.x<0;)v.x+=256;for(var g=(v.x-128)*o,p=(v.y-128)*o,_=0;g<f;)g+=s,_+=s;for(;g>=c;)g-=s,_-=s;for(var m=[],x=256*s,A=-x,P=0;P<e.length;P++){var y=e[P][0],w=e[P][1],b=this.projection.fromLatLngToPoint(new google.maps.LatLng(y,w));b.y-=128,b.x=128*w/180;var R=b.x*o,W=b.y*o;x>R&&(x=R),A<R&&(A=R),m.push([R+l-g,W+h-p])}var G=[];f<A&&x<c&&(a(0),a(0+_)),f<A-s&&x-s<c&&(a(-s),a(-s+_)),f<A+s&&x+s<c&&(a(s),a(s+_));for(var S=0;S<G.length;S++){for(var r=G[S],M=[],P=0;P<m.length;P++){var L=m[P],R=L[0]+r,W=L[1];M.push(new WRAP.Geo.ScreenPoint(R,W))}n.push(M)}return n},this.getPoint=function(e){if(this.projection){var i=e.x-.5*t.getDiv().offsetWidth,r=e.y-.5*t.getDiv().offsetHeight,a=this.projection.fromLatLngToPoint(this.center),n=Math.pow(2,this.zoom),o=a.x+i/n,s=a.y+r/n,l=this.projection.fromPointToLatLng(new google.maps.Point(o,s));return new WRAP.Geo.Point(60*l.lat(),60*l.lng())}return new WRAP.Geo.Point(0,0)},this.getCenterPoint=function(){return t.getProjection()?new WRAP.Geo.Point(60*e.center.lat(),60*e.center.lng()):null},this.setCenterPoint=function(e){t.setCenter(this.center=new google.maps.LatLng(e.latDegree(),e.lonDegree()))},this.getZoom=function(){return this.zoom},this.setZoom=function(e){e=Math.floor(e),t.setZoom(this.zoom=e)},this.getPerspective=function(e,i){if(!this.projection||!e||!e.length)return{center:this.getCenterPoint(),zoom:this.zoom,fractional_zoom:this.zoom};void 0===i&&(i=0);for(var r=e[0].lat,a=e[0].lon,n=r,o=r,s=a,l=a,h=1;h<e.length;h++){var r=e[h].lat,f=e[h].lon-a;a=f>=10800?e[h].lon-21600:f<-10800?e[h].lon+21600:e[h].lon,s>a&&(s=a),l<a&&(l=a),n>r&&(n=r),o<r&&(o=r)}a<-10800?a+=21600:a>=10800&&(a-=21600);var c=this.projection.fromLatLngToPoint(new google.maps.LatLng(n/60,s/60)),u=this.projection.fromLatLngToPoint(new google.maps.LatLng(o/60,l/60)),d=(c.y+u.y)/2;u.x<c.x&&(u.x+=256);var v=(u.x+c.x)/2;v>=128&&(v-=256);var g=this.projection.fromPointToLatLng(new google.maps.Point(v,d));r=g.lat(),a=g.lng();var p=c.y-u.y,_=Math.abs(u.x-c.x),m=t.getDiv().offsetWidth-2*i,x=t.getDiv().offsetHeight-2*i,A=Math.log(2),P=p>0?Math.log(x/p)/A:19,y=_>0?Math.log(m/_)/A:19,w=P<y?P:y,b=Math.floor(w);return w>19&&(b=w=19),{center:new WRAP.Geo.Point(60*r,60*a),zoom:b,fractional_zoom:w}},this.getDistance=function(t,e){var i=new google.maps.LatLng(t.latDegree(),t.lonDegree()),r=new google.maps.LatLng(e.latDegree(),e.lonDegree());return google.maps.geometry.spherical.computeDistanceBetween(i,r)},this.initRender=function(t){this.last_rate=-1,this.regions=[],this.animation=t},this.update=function(){if(this.animation){if(!this.animation_timer){var t=new Date;this.animation_timer=setInterval(function(){var i=new Date,r=(i.getTime()-t.getTime())/1e3,a=1,n=.5,o=.5,s=a+n+2*o,l=r-Math.floor(r/s)*s,h=0;if(l<=a)h=1;else if(l<=a+o){var f=(l-a)/o;h=1-f,h*=h}else if(l<=a+o+n)h=0;else{var f=(s-l)/o;h=1-f,h*=h}for(var c=0;c<e.regions.length;c++){var u=e.regions[c];e.last_rate==h&&u.cvs.revision==u.revision||(u.cvs.revision=u.revision,u.cvs.ctx.clearRect(0,0,256,256),h<=0?u.cvs.ctx.drawImage(u.src1,u.x,u.y,256,256,0,0,256,256):(u.cvs.ctx.save(),u.cvs.ctx.globalAlpha=Math.sqrt(2*h),u.cvs.ctx.drawImage(u.src2,u.x,u.y,256,256,0,0,256,256),u.cvs.ctx.globalAlpha=1-h,u.cvs.ctx.drawImage(u.src1,u.x,u.y,256,256,0,0,256,256),u.cvs.ctx.restore()))}e.last_rate=h},100)}}else{this.animation_timer&&(clearInterval(this.animation_timer),this.animation_timer=null);for(var i=0;i<e.regions.length;i++){var r=e.regions[i];if(r.cvs.revision!=r.revision){if(!r.cvs.ctx||!r.src1)continue;r.cvs.revision=r.revision,r.cvs.ctx.clearRect(0,0,256,256),r.cvs.ctx.drawImage(r.src1,r.x,r.y,256,256,0,0,256,256)}}}},this.enableScroll=function(t){this.map.setOptions({draggable:t})}},WRAP.Geo.View3D=function(t){this.projection=null,this.origin,this.size,this.zoom,this.bounds=new WRAP.Geo.Bounds(5400,-5400,10800,-10800),this.context=new WRAP.Geo.ViewContext3D(this,t),this.setProjection=function(t,e){return WRAP.Geo.Projection[t]?(this.projection=new WRAP.Geo.Projection[t](e),this.context):(console.error("Map Projection["+t+"] undefined."),null)},this.setViewPerspective=function(t,e,i){this.eye=t,this.lookat=e,this.lens=i},this.setViewOption=function(t){if(t.z_scale){var e=parseFloat(t.z_scale);isNaN(e)&&(e=1),this.context&&(this.context.z_scale=9e-6*e)}},this.updateBounds=function(t,e,i){function r(t,e,i){for(var r=0;r<c.length;r++){var a=c[r];if(a.x==t&&a.y==e&&a.z==i)return}c.push({x:t,y:e,z:i})}i=[Math.round(i[0]),Math.round(i[1])],this.zoom=t,this.ppd=256*Math.pow(2,t)/360,this.dpp=1/this.ppd,this.origin=e,this.size=i,this.band=360,this.centerPosition=[i[0]/2,i[1]/2],this.context.setBounds(this.bounds,this.zoom,this.origin,this.size,this.band);
var a=0,n=0,o=Math.floor(t);o<2&&(o=2);var s=Math.pow(2,o),l=360/s,h=e[0],f=e[1];h<-180?h+=360:h>=180&&(h-=360),a=Math.floor((180+h)/l),n=s/2-1-Math.floor((90-f)/l);var c=[],u=2;0<=n&&n<s/2&&r(a,n,o);for(var d=-u;d<=u;d++){var v=n+d;if(!(v<0||v>=s/2))for(var g=-u;g<=u;g++){var p=a+g;p<0?p+=s:p>=s&&(p-=s),r(p,v,o)}}var _=!0;if(this.context.tileNum()==c.length){for(var m=c.length,x=0;x<c.length;x++)this.context.findTile(c[x].z,c[x].y,c[x].x)&&m--;m||(_=!1)}if(_){this.context.clear();for(var A=0;A<c.length;A++){for(var P=c[A].z,v=c[A].y,p=c[A].x,y=new Float32Array(131072),w=p/s,b=(s/2-1-v)/s,R=1/(256*s),W={x:[257],y:[257]},x=0;x<257;x++){var G=w+R*x,S=b+R*x,h=-180+360*G,f=90-360*S;W.x[x]=h,W.y[x]=f}for(var x=0,M=0;M<256;M++)for(var L=0;L<256;L++)y[x++]=W.y[M],y[x++]=W.x[L];this.context.addTile("S",P,v,p,y,new WRAP.Geo.Bounds(60*W.y[0],60*W.y[256],60*W.x[256],60*W.x[0]))}WRAP.Geo.updateBounds(this.bounds)}WRAP.Geo.render()},this.point=function(t){return[this.origin[0]+t[0]*this.dpp,this.origin[1]-t[1]*this.dpp]},this.screenPoint=function(t){return[(t[0]-this.origin[0])*this.ppd,(this.orogin[1]-t[1])*this.ppd]}},WRAP.Geo.ViewContext3D=function(t,e){var i=WRAP.Geo.WebGL.gl;this.revision=0,this.tiles=[],this.z_scale=9e-6,this.clear=function(){this.revision++,this.tiles=[]},this.setBounds=function(t,e,i,r,a){this.revision++,this.bounds=t,this.zoom=e,this.ppd=256*Math.pow(2,e)/360,this.center=i,this.size=r,this.band=a},this.tileNum=function(){return this.tiles.length},this.findTile=function(t,e,i){for(var r=0;r<this.tiles.length;r++){var a=this.tiles[r];if(a.z==t&&a.y==e&&a.x==i)return a}return null},this.addTile=function(t,e,i,r,a,n){this.revision++,this.tiles.push({id:t+"/"+e+"/"+i+"/"+r,type:t,z:e,y:i,x:r,cood:a,bounds:n})},this.tile=function(t){for(var e=0;e<this.tiles.length;e++){var i=this.tiles[e];i.valid||t(i)}},this.drawImageData=function(t,i,r,a,n,o,s){function l(t,e,i,r,a,l){s?(t.save(),t.translate(i,r),t.rotate(s/180*Math.PI),t.drawImage(e,n,o,a,l),t.restore()):t.drawImage(e,i+n,r+o,a,l)}function h(t){var e=document.createElement("canvas");e.width=t.width,e.height=t.height;var i=e.getContext("2d");return i.putImageData(t,0,0),e}var f=this.ctx,c=e.getScreenPoint(new WRAP.Geo.Point(0,0)),u=this.offset_x+c.x,d=this.offset_y+c.y,v=e.getScreenPoint(new WRAP.Geo.Point(60*t[1],60*t[0])),g=v.x-u,p=v.y-d,_=1.5*(r>a?r:a),m=-_,x=this.canvas.width+_,A=-_,P=this.canvas.height+_;if(!(p<A||P<p)){var y=null;m<=g&&g<=x&&(y||(y=h(i)),l(f,y,g,p,r,a));var w=g-this.canvas_band;m<=w&&w<=x&&(y||(y=h(i)),l(f,y,w,p,r,a));var b=g+this.canvas_band;m<=b&&b<=x&&(y||(y=h(i)),l(f,y,b,p,r,a))}},this.drawImage=function(t,e,i,r,a,n,o){var s=this.layer;if(s){this.setLayer();var l=s._dc;if(l&&!l.cached&&!WRAP.Geo.imageError[e]){var h=WRAP.Geo.imageCache[e];if(void 0==h)return h=WRAP.Geo.imageCache[e]={loaded:!1,image:new Image,url:e},h.image.onload=function(){h.loaded=!0,WRAP.Geo.invalidate()},h.image.onerror=function(){WRAP.Geo.imageError[h.url]=!0,WRAP.Geo.updateLayerStatus()},void(h.image.src=e);if(h.loaded){var f=WRAP.Geo.WebGL,c=f.getTexture(h.image),u=c.vertices(i,r),d=this.textureShader;l.list||(l.list=[]);var v=l.list,g=v.length?v[v.length-1]:null;g&&g.shader==d&&"triangleStrip"==g.method||(g={shader:d,method:"triangleStrip",vertices:[],elements:[]},v.push(g));var p=g.vertices;g.elements.push({texture:c.id,index:p.length/12,num:u.length}),o||(o=0),o=Math.PI*o/180;for(var _=0;_<u.length;_++){var m=u[_];p.push(t[0]),p.push(t[1]),p.push(t[2]||0),p.push(m[0]+a),p.push(m[1]-n),p.push(m[2]),p.push(m[3]),p.push(1),p.push(1),p.push(1),p.push(1),p.push(o)}if(this.band){var p=g.vertices;g.elements.push({texture:c.id,index:p.length/12,num:u.length});for(var _=0;_<u.length;_++){var m=u[_];p.push(t[0]-360),p.push(t[1]),p.push(t[2]||0),p.push(m[0]+a),p.push(m[1]-n),p.push(m[2]),p.push(m[3]),p.push(1),p.push(1),p.push(1),p.push(1),p.push(o)}p=g.vertices,g.elements.push({texture:c.id,index:p.length/12,num:u.length});for(var _=0;_<u.length;_++){var m=u[_];p.push(t[0]+360),p.push(t[1]),p.push(t[2]||0),p.push(m[0]+a),p.push(m[1]-n),p.push(m[2]),p.push(m[3]),p.push(1),p.push(1),p.push(1),p.push(1),p.push(o)}}}}}},this.hit=function(t,e,i){if(!i)return!1;var r=WRAP.Geo.getScreenPoint(this.hitctx.anchor);t-=r.x,e-=r.y;var a=this.hitctx.getImageData(t,e,1,1);if(a&&a.data){var n=(a.data[0]<<16)+(a.data[1]<<8)+a.data[2];return i==n}return!1},this._drawLines=function(t,e,i,r,a,n,o,s,l){function h(t,e){var i=t.length,r=[],a=d(t[0],t[1],e);r.push(a[0]),r.push(a[1]);for(var n=0;n<i-2;n++)for(var o=v(t[n],t[n+1],t[n+2],e),s=0;s<o.length;s++)r.push(o[s]);var l=d(t[i-1],t[i-2],e);return r.push(l[1]),r.push(l[0]),r}function f(t,e){var i=[];for(i.push(t[0]);;){if(t.length<2)return i;var r=t[0],a=t[1],n=Math.sqrt((r[0]-a[0])*(r[0]-a[0])+(r[1]-a[1])*(r[1]-a[1]));if(!(n<e)){if(n==e)return i.push(a),t.shift(),i;var o=r[0]+(a[0]-r[0])*e/n,s=r[1]+(a[1]-r[1])*e/n;return t.shift(),t.unshift([o,s,r[2]]),i.push([o,s,r[2]]),i}i.push(a),t.shift(),e-=n}return i}function c(t,e,i){var r=u(t);if(!i.safe())return h(r,e);for(var a=[];;){var n=i.get(),o=f(r,n);if(i.active()&&a.push(o),r.length<=1)break}for(var s=[],l=0;l<a.length;l++){var o=h(a[l],e);l>0&&s.push(o[0]);for(var c=0;c<o.length;c++)s.push(o[c]);l<a.length-1&&s.push(o[o.length-1])}return s}function u(t){for(var e=[t[0]],i=0;i<t.length-1;i++)(t[i][0]-t[i+1][0])*(t[i][0]-t[i+1][0])+(t[i][1]-t[i+1][1])*(t[i][1]-t[i+1][1])>P*P&&e.push(t[i+1]);return e}function d(t,e,i){var r=e[0]-t[0],a=e[1]-t[1],n=Math.sqrt(r*r+a*a),o=-a*i/n,s=r*i/n,l=t[0]+o,h=t[1]+s,f=t[0]-o,c=t[1]-s;return[[l,h,t[2]],[f,c,t[2]]]}function v(t,e,i,r){var a=e[0]-t[0],n=e[1]-t[1],o=i[0]-e[0],s=i[1]-e[1],l=Math.sqrt(a*a+n*n),h=Math.sqrt(o*o+s*s),f=-n*r/l,c=a*r/l,u=-s*r/h,d=o*r/h,v=a*s-n*o;if(v<-P){var g=(-h*r-f*s+c*o)/v,p=e[0]-f-g*a,_=e[1]-c-g*n,m=Math.sqrt(r*r+g*g*l*l),x=e[0]+(f+g*a)*r/m,A=e[1]+(c+g*n)*r/m,y=e[0]+f,w=e[1]+c,b=e[0]+u,R=e[1]+d;return(p-t[0])*a+(_-t[1])*n<0||(p-i[0])*o+(_-i[1])*s>0?[[y,w,e[2]],[e[0]-f,e[1]-c,e[2]],[x,A,e[2]],e,[b,R,e[2]],[e[0]-u,e[1]-d,e[2]]]:[[y,w,e[2]],[p,_,e[2]],[x,A,e[2]],[p,_,e[2]],[b,R,e[2]],[p,_,e[2]]]}if(v>P){var g=(-h*r-f*s+c*o)/v,W=e[0]+f+g*a,G=e[1]+c+g*n,S=Math.sqrt(r*r+g*g*l*l),M=e[0]-(f+g*a)*r/S,L=e[1]-(c+g*n)*r/S,T=e[0]-f,F=e[1]-c,I=e[0]-u,k=e[1]-d;return(W-t[0])*a+(G-t[1])*n<0||(W-i[0])*o+(G-i[1])*s>0?[[e[0]+f,e[1]+c,e[2]],[T,F,e[2]],e,[M,L,e[2]],[e[0]+u,e[1]+d,e[2]],[I,k,e[2]]]:[[W,G,e[2]],[T,F,e[2]],[W,G,e[2]],[M,L,e[2]],[W,G,e[2]],[I,k,e[2]]]}if(a*o+n*s<0){var z=[e[0]+f,e[1]+c,e[2]],D=[e[0]+u,e[1]+d,e[2]],E=[e[0]+(c-d)/2,e[1]+(-f+u)/2,e[2]];return[z,D,E,e,D,z]}var C=[e[0]+(f+u)/2,e[1]+(c+d)/2,e[2]],B=[e[0]-(f+u)/2,e[1]-(c+d)/2,e[2]];return[C,B]}function g(t,e){return[(t[0]+e[0])/2,(t[1]+e[1])/2]}function p(t,e,i){var r=g(t,e),a=g(i,e);return g(r,a)}WRAP.Geo.check(l);var _=WRAP.Geo.WebGL,m=this.layer;if(m){this.setLayer();var x=m._dc;if(x&&!x.cached){var A=function(t){this.array=t,this.index=0,this.count=0,this.safe=function(){if(!this.array||0==this.array.length)return!1;for(var t=0;t<this.array.length;t++)if(this.array[t]<=0)return!1;return!0},this.get=function(){var t=this.array[this.index++];return this.index>=this.array.length&&(this.index=0),this.count++,t},this.active=function(){return 1==(1&this.count)}},P=1e-5;if("cloud"==s||"counter_cloud"==s){var y=Math.PI/3;"counter_cloud"==s&&(y=-y);for(var w=Math.cos(y),b=Math.sin(y),R=10,W=[],G=0;G<e.length;G++){for(var S=e[G],M=[],L=0;L<S.length;L++){var T=S[L],F=t.screenPoint(T);M.push(F)}var I=[],T=M[0],k=T[0],z=T[1],L=0;I.push(T);for(var D=k,E=z,C=R;++L<M.length;){for(var B=M[L][0],N=M[L][1],U=B-k,j=N-z,V=Math.sqrt(U*U+j*j),O=V,X=0;O>=C;){X+=C;var Y=X/V,H=k+U*Y,q=z+j*Y,Z=H-D,J=q-E,Q=w*Z-b*J+D,K=b*Z+w*J+E,$=p([D,E],[Q,K],[H,q]),tt=g([D,E],[Q,K]),et=g([H,q],[Q,K]),it=p([D,E],tt,$),rt=p([H,q],et,$);I.push(it),I.push($),I.push(rt),I.push([H,q]),D=H,E=q,O-=C,C=R}C-=O,k=B,z=N}I.push(M[M.length-1]);for(var at=[],L=0;L<I.length;L++){var T=I[L],nt=t.point(T);at.push(nt)}W.push(at)}e=W}var ot=[];if("outset"==s||"inset"==s){var y=Math.PI/3;"inset"==s&&(y=-y);for(var w=Math.cos(y),b=Math.sin(y),R=10,G=0;G<e.length;G++){for(var S=e[G],M=[],L=0;L<S.length;L++){var T=S[L],F=t.screenPoint(T);M.push(F)}for(var T=M[0],k=T[0],z=T[1],L=0,D=k,E=z,C=R;++L<M.length;){for(var B=M[L][0],N=M[L][1],U=B-k,j=N-z,V=Math.sqrt(U*U+j*j),O=V,X=0;O>=C;){X+=C;var Y=X/V,H=k+U*Y,q=z+j*Y,Z=H-D,J=q-E,Q=w*Z-b*J+D,K=b*Z+w*J+E,$=g([D,E],[H,q]),st=t.point($),lt=t.point([Q,K]);ot.push(st),ot.push(lt),D=H,E=q,O-=C,C=R}C-=O,k=B,z=N}}}if(a){var ht=0,ft=0;if(s&&s.indexOf("depth")>=0){var ct=s.split(",");ct&&3==ct.length&&(ft=parseFloat(ct[1]),ht=parseFloat(ct[2]))}if("flow"==a){var ut=this.flowShader;x.list||(x.list=[]);var X=x.list,dt=X.length?X[X.length-1]:null;if(i<=1&&(!r||!r.length)){dt&&dt.shader==ut&&"lineStrip"==dt.method||(dt={shader:ut,method:"lineStrip",vertices:[],elements:[]},X.push(dt));for(var vt=dt.vertices,G=0;G<e.length;G++){var S=e[G];dt.elements.push({index:vt.length/10,num:S.length,ft1:ft,ft0:ht});for(var L=0;L<S.length;L++){var T=S[L];vt.push(T[0]),vt.push(T[1]),vt.push(T[2]||0),vt.push(T[4]),vt.push(T[5]),vt.push(T[6]),vt.push(T[7]),vt.push(T[3]),vt.push(0),vt.push(0)}}}}else{var gt=this.getColor(a),ut=this.colorShader;x.list||(x.list=[]);var X=x.list,dt=X.length?X[X.length-1]:null;if(!(i<=1)||r&&r.length)for(var G=0;G<e.length;G++){for(var S=e[G],pt=[],L=0;L<S.length;L++){var T=S[L],_t=t.screenPoint(T);pt.push([_t[0],_t[1],L])}for(var mt=new A(r),xt=c(pt,.5*i,mt),At=[],L=0;L<xt.length;L++){var vt=xt[L],Pt=vt[2],yt=S[Pt],wt=pt[Pt];At.push([yt[0],yt[1],vt[0]-wt[0],-vt[1]+wt[1]])}dt&&dt.shader==ut&&"triangleStrip"==dt.method||(dt={shader:ut,method:"triangleStrip",vertices:[],elements:[]},X.push(dt));var vt=dt.vertices,S=e[G];dt.elements.push({index:vt.length/10,num:At.length});for(var L=0;L<At.length;L++){var T=At[L];vt.push(T[0]),vt.push(T[1]),vt.push(T[2]||0),vt.push(gt[0]),vt.push(gt[1]),vt.push(gt[2]),vt.push(gt[3]),vt.push(0),vt.push(T[2]),vt.push(T[3])}}else{dt&&dt.shader==ut&&"lineStrip"==dt.method||(dt={shader:ut,method:"lineStrip",vertices:[],elements:[]},X.push(dt));for(var vt=dt.vertices,G=0;G<e.length;G++){var S=e[G];dt.elements.push({index:vt.length/10,num:S.length,ft1:ft,ft0:ht});for(var L=0;L<S.length;L++){var T=S[L];vt.push(T[0]),vt.push(T[1]),vt.push(T[2]||0),vt.push(gt[0]),vt.push(gt[1]),vt.push(gt[2]),vt.push(gt[3]),vt.push(0),vt.push(0),vt.push(0)}}}if(ot.length){var At=ot[G];dt&&dt.shader==ut&&"lines"==dt.method||(dt={shader:ut,method:"lines",vertices:[],elements:[]},X.push(dt));var vt=dt.vertices,S=e[G];dt.elements.push({index:vt.length/10,num:ot.length});for(var G=0;G<ot.length;G++){var T=ot[G];vt.push(T[0]),vt.push(T[1]),vt.push(T[2]||0),vt.push(gt[0]),vt.push(gt[1]),vt.push(gt[2]),vt.push(gt[3]),vt.push(0),vt.push(0),vt.push(0)}}}}if(o){var ut=this.textureShader;x.list||(x.list=[]);var X=x.list,dt=X.length?X[X.length-1]:null;dt&&dt.shader==ut&&"triangles"==dt.method||(dt={shader:ut,method:"triangles",vertices:[],elements:[]},X.push(dt));for(var bt=[],vt=dt.vertices,G=0;G<e.length;G++){for(var S=e[G],Rt=new Float32Array(2*S.length),L=0;L<S.length;L++)Rt[2*L]=S[L][0],Rt[2*L+1]=S[L][1];bt.push(Rt)}var Wt=_.tessellate(bt);if(Wt&&Wt.triangles.length){dt.elements.push({texture:o.id,index:vt.length/12,num:Wt.triangles.length});for(var L=0;L<Wt.triangles.length;L++){var Pt=2*Wt.triangles[L],k=Wt.vertices[Pt],z=Wt.vertices[Pt+1],Gt=e[0][0][2]||0,F=t.screenPoint([k,z]);vt.push(k),vt.push(z),vt.push(Gt),vt.push(0),vt.push(0),vt.push(F[0]/o.width),vt.push(F[1]/o.height),vt.push(1),vt.push(1),vt.push(1),vt.push(1),vt.push(0)}}}else if(n){var ht=0,ft=0;if(s&&s.indexOf("depth")>=0){var ct=s.split(",");ct&&3==ct.length&&(ft=parseFloat(ct[1]),ht=parseFloat(ct[2]))}var gt=this.getColor(n),ut=this.colorShader;x.list||(x.list=[]);var X=x.list,dt=X.length?X[X.length-1]:null;dt&&dt.shader==ut&&"lineStrip"==dt.method||(dt={shader:ut,method:"lineStrip",vertices:[],elements:[]},X.push(dt));for(var vt=dt.vertices,G=0;G<e.length;G++){var S=e[G];dt.elements.push({index:vt.length/10,num:S.length,ft1:ft,ft0:ht});for(var L=0;L<S.length;L++){var T=S[L];vt.push(T[0]),vt.push(T[1]),vt.push(T[2]||2e4),vt.push(gt[0]),vt.push(gt[1]),vt.push(gt[2]),vt.push(gt[3]),vt.push(0),vt.push(0),vt.push(0)}}}}}},this._fragmentPath=function(t){for(var e=[],i=0;i<t.length;i++){var r=t[i][1],a=t[i][0],n=t[i][2];if(i>0){var o=t[i-1][1],s=t[i-1][0],l=t[i-1][2],h=a-s;h<-180?(h+=360,a+=360):h>=180&&(h-=360,s+=360);var f=Math.abs(h);if(f>1){var c=new WRAP.Geo.GreatCircle(o,s,r,a),u=o,d=s,v=l;e.push([d,u,v]);for(var g=0;g+1<f;){g+=1;var p=g/f,_=c.getPosition(p),m=l+(n-l)*p;e.push([_.lon,_.lat,m]),u=_.lat,d=_.lon}}else e.push([s,o,l])}e.push([a,r,n])}return e},this._normalizePath=function(t){for(var e=[],i=0;i<t.length;i++){var r=t[i][1],a=t[i][0],n=t[i][2],o=t[i][3]||0,s=t[i][4]||0,l=t[i][5]||0,h=t[i][6]||0,f=t[i][7]||0;if(i>0){var c=t[i-1][1],u=t[i-1][0],d=t[i-1][2],v=t[i-1][3]||0,g=t[i-1][4]||0,p=t[i-1][5]||0,_=t[i-1][6]||0,m=t[i-1][7]||0,x=a-u;x<-180?(x+=360,a+=360):x>=180&&(x-=360,u+=360);var A=Math.abs(x);if(0==A)e.push([u,c,d,v,g,p,_,m]);else{(u<-180||a<-180)&&(u+=360,a+=360);var P=(r-c)/(a-u);if(u<180&&180<a){var A=180-u,y=c+A*P,w=d+(n-d)*P,b=v+(o-v)*P,R=g+(s-g)*P,W=p+(l-p)*P,G=_+(h-_)*P,S=m+(f-m)*P;e.push([u,c,d,v,g,p,_,m]),e.push([180,y,w,b,R,W,G,S]),e.push([180,y,w,b,R,W,G,S])}else e.push([u,c,d,v,g,p,_,m])}}e.push([a,r,n,o,s,l,h,f])}return e},this._normalizeLon=function(t){var e,i,r,a,n=[];if(t&&t.length>0){var o=t[0][1],s=t[0][0],l=t[0][2],h=t[0][3],f=t[0][4],c=t[0][5],u=t[0][6],d=t[0][6];e=i=o,a=r=s;var v=[s,o,l,h,f,c,u,d];n.push(v);for(var g=1;g<t.length;g++){var p=t[g][1],_=t[g][0],m=t[g][2],x=t[g][3],A=t[g][4],P=t[g][5],y=t[g][6],w=t[g][7],b=_-s;b<-180?_+=360:b>=180&&(_-=360),e<p&&(e=p),i>p&&(i=p),r>_&&(r=_),a<_&&(a=_);var v=[_,p,m,x,A,P,y,w];n.push(v),o=p,s=_}}if(r<-180){r+=360,a+=360;for(var g=0;g<n.length;g++)n[g][0]+=360}return n},this._addFragments=function(t,e){e=this._normalizeLon(e),t.push(e);for(var i=9999,r=-9999,a=0;a<e.length;a++){var n=e[a][0];i>n&&(i=n),r<n&&(r=n)}if(i<-180){for(var o=[],a=0;a<e.length;a++){var s=[e[a][0]+360,e[a][1],e[a][2],e[a][3],e[a][4],e[a][5],e[a][6],e[a][7]];o.push(s)}t.push(o)}if(r>180){for(var o=[],a=0;a<e.length;a++){var s=[e[a][0]-360,e[a][1],e[a][2],e[a][3],e[a][4],e[a][5],e[a][6],e[a][7]];o.push(s)}t.push(o)}},this._gcPos=function(t,e,i,r){function a(t){return t*Math.PI*h}function n(t){return t*l*c}var o,s=r,l=10800,h=9259259e-11,f=Math.PI/2,c=1/Math.PI,u=60*t,d=60*e,v=180-i,g=i/180*Math.PI,p=Math.cos(g),_=a(s),m=(.5-u*h)*Math.PI,x=Math.cos(_),A=Math.cos(m),P=Math.sin(_),y=Math.sin(m),w=x*A+P*y*p;o=w>1?0:w<-1?Math.PI:Math.acos(w);var b=f-o;b=n(b);var R,W=Math.sin(o),G=(x*y-P*A*p)/W;R=G>1?0:G<-1?Math.PI:Math.acos(G);var S;return S=v>0?a(d)+R:a(d)-R,S=n(S),S>l?S=2*-l+S:S<-l&&(S=2*l+S),{lat:b/60,lon:S/60}},this.drawPath=function(t,e,i,r,a,n,o,s,l){var h=this.layer;if(h){this.setLayer();var f=h._dc;if(f&&!f.cached){var c={};if(n){var u=n;if(WRAP.Geo.imageError[u])return;var c=WRAP.Geo.imageCache[u];if(void 0==c)return c=WRAP.Geo.imageCache[u]={loaded:!1,image:new Image,url:u},c.image.onload=function(){c.loaded=!0,WRAP.Geo.invalidate()},c.image.onerror=function(){WRAP.Geo.imageError[c.url]=!0,WRAP.Geo.updateLayerStatus()},void(c.image.src=u)}if(!n||c.loaded){var d,v=WRAP.Geo.WebGL;c.image&&(d=v.getTexture(c.image));var g=[];if(Array.isArray(t[0][0])){for(var p=0;p<t.length;p++)if(!(t[p].length<2)){var _=t[p];_=s?this._fragmentPath(t[p]):this._normalizePath(t[p]),this._addFragments(g,_)}if(!g.length)return}else{if(t.length<2)return;var _=t;_=s?this._fragmentPath(t):this._normalizePath(t),this._addFragments(g,_)}this._drawLines(this.projection,g,e,i,r,a,d,o,l)}}}},this.drawArc=function(t,e,i,r,a,n,o,s,l,h){var f=this.layer;if(f){this.setLayer();var c=f._dc;if(c&&!c.cached){var u={};if(l){var d=l;if(WRAP.Geo.imageError[d])return;var u=WRAP.Geo.imageCache[d];if(void 0==u)return u=WRAP.Geo.imageCache[d]={loaded:!1,image:new Image,url:d},u.image.onload=function(){u.loaded=!0,WRAP.Geo.invalidate()},u.image.onerror=function(){WRAP.Geo.imageError[u.url]=!0,WRAP.Geo.updateLayerStatus()},void(u.image.src=d)}if(!l||u.loaded){var v,g=WRAP.Geo.WebGL;u.image&&(v=g.getTexture(u.image));var p=[];(i==r||Math.abs(r-i)>360)&&(i=0,r=360);var _=1;e<5e5?_=5:e<1e5&&(_=2),e/=1851.8518518518517;for(var m=i;m<r;m+=_){var x=this._gcPos(t[1],t[0],m,e);p.push([x.lon,x.lat,t[2]])}var x=this._gcPos(t[1],t[0],r,e);p.push([x.lon,x.lat,t[2]]);var A=[];if(p.length<2)return;var P=this._normalizePath(p);this._addFragments(A,P),this._drawLines(this.projection,A,a,n,o,s,v,null,h)}}}},this.drawPoint=function(t,e,i,r,a){var n=this.layer;if(n){this.setLayer();var o=n._dc;if(o&&!o.cached){var s=this.pointShader;o.list||(o.list=[]);var l=o.list,h=l.length?l[l.length-1]:null;h&&h.shader==s&&"points"==h.method||(h={shader:s,method:"points",vertices:[],elements:[{index:0,num:0}]},l.push(h));var f=h.elements[0],c=t[0],u=t[1],d=t[2]||0;c>=180&&(c-=360),c<-180&&(c+=360);var v=h.vertices;if(r){i||(i=1);var g=this.getColor(r);v.push(c),v.push(u),v.push(d),v.push(g[0]),v.push(g[1]),v.push(g[2]),v.push(g[3]),v.push(e+i),f.num++}if(a){var g=this.getColor(a);v.push(c),v.push(u),v.push(d),v.push(g[0]),v.push(g[1]),v.push(g[2]),v.push(g[3]),v.push(e-1),f.num++}}}},this.drawLine=function(t,i,r,a,n,o,s,l,h,f){function c(t,e,i){if(!(e.length<2)){for(var r,a,n=[],o=0;o<e.length;o++){var s=e[o][0],l=e[o][1];if(h){var f=s*A-l*P,c=s*P+l*A;s=f,l=c}s+=x.x,l+=x.y,0==o?r=a=s:(r>s&&(r=s),a<s&&(a=s)),n.push(new WRAP.Geo.ScreenPoint(s,l))}t.push(n);var u=v.x-i/2,d=u-i,g=v.x+i/2,p=g+i;if(r<u&&a>d){for(var _=[],o=0;o<n.length;o++)_.push(new WRAP.Geo.ScreenPoint(n[o].x+i,n[o].y));t.push(_)}if(r<p&&a>g){for(var _=[],o=0;o<n.length;o++)_.push(new WRAP.Geo.ScreenPoint(n[o].x-i,n[o].y));t.push(_)}}}var u=this.layer;if(u){this.setLayer();var d=u._dc;if(d&&!d.cached){var v={};if(s){var g=s;if(WRAP.Geo.imageError[g])return;var v=WRAP.Geo.imageCache[g];if(void 0==v)return v=WRAP.Geo.imageCache[g]={loaded:!1,image:new Image,url:g},v.image.onload=function(){v.loaded=!0,WRAP.Geo.invalidate()},v.image.onerror=function(){WRAP.Geo.imageError[v.url]=!0,WRAP.Geo.updateLayerStatus()},void(v.image.src=g)}if(!s||v.loaded){var p,_=WRAP.Geo.WebGL;v.image&&(p=_.getTexture(v.image));for(var v=e.getScreenPoint(new WRAP.Geo.Point(0,0)),m=e.getSize().width/2;v.x-m>=this.canvas_band/2;)v.x-=this.canvas_band;for(;v.x-m<-this.canvas_band/2;)v.x+=this.canvas_band;for(var x=e.getScreenPoint(new WRAP.Geo.Point(60*t[1],60*t[0]));x.x-v.x>this.offset_x+this.canvas_band;)x.x-=this.canvas_band;for(;x.x-v.x<this.offset_x;)x.x+=this.canvas_band;var A,P;h&&(A=Math.cos(Math.PI*h/180),P=Math.sin(Math.PI*h/180));var y=[];if(Array.isArray(i[0][0]))for(var w=0;w<i.length;w++)c(y,i[w],this.canvas_band);else c(y,i,this.canvas_band);if(!y.length)return;this._drawLines(projection,y,r,a,n,o,p,l,f)}}}},this.drawText=function(t,e,i,r,a,n,o,s,l){var h=this.layer;if(h){this.setLayer();var f=h._dc;if(f&&!f.cached){for(var c=WRAP.Geo.WebGL,u=parseFloat(n)||0,d=parseFloat(o)||0,v=0,g=[],p=0;p<e.length;p++){var _=e.charAt(p),m=c.getFontTexture(_,i,r,a);v+=m.width,g.push(m)}"left"==s?u+=0:u-="right"==s?v:.5*v;var x=this.textureShader;f.list||(f.list=[]);var A=f.list,P=A.length?A[A.length-1]:null;P&&P.shader==x&&"triangleStrip"==P.method||(P={shader:x,method:"triangleStrip",vertices:[],elements:[]},A.push(P)),l||(l=0),l=Math.PI*l/180;for(var y=0,p=0;p<g.length;p++){var m=g[p],w=m.vertices(m.width,m.height),b=P.vertices;P.elements.push({texture:m.id,index:b.length/12,num:w.length});for(var R=t[0],W=t[1],G=t[2]||0,S=0;S<w.length;S++){var M=w[S];b.push(R),b.push(W),b.push(G),b.push(M[0]+u+y),b.push(M[1]+d),b.push(M[2]),b.push(M[3]),b.push(1),b.push(1),b.push(1),b.push(1),b.push(l)}y+=m.width}if(this.band)for(var y=0,p=0;p<g.length;p++){var m=g[p],w=m.vertices(m.width,m.height),b=P.vertices;P.elements.push({texture:m.id,index:b.length/12,num:w.length});for(var R=t[0],W=t[1],G=t[2]||0,S=0;S<w.length;S++){var M=w[S];b.push(R+360),b.push(W),b.push(G),b.push(M[0]+u+y),b.push(M[1]+d),b.push(M[2]),b.push(M[3]),b.push(1),b.push(1),b.push(1),b.push(1),b.push(l)}y+=m.width}}}},this.drawTile=function(t,e,i){var r=this.layer;if(r){this.setLayer();var a=r._dc;if(a&&!a.cached){var n=null,o=WRAP.Geo.WebGL,s=[],l=i,h=null,f=null,c=null;l&&l.around&&(h=l.around[3],f=l.around[4],c=l.around[5]);for(var u,d,v=64,g=Math.floor(256/v),p=0;p<v;p++){s.push([0,p/v,l,256*(255-p*g)]);for(var _=0;_<v;_++){var m=_*g;d=256*(255-p*g)+m,s.push([_/v,p/v,l,d]),u=(p+1)*g,u>=256?(u=65280+m,s.push([_/v,(p+1)/v,c,u])):(u=256*(255-u)+m,s.push([_/v,(p+1)/v,l,u]))}d=256*(255-p*g),s.push([_/v,p/v,h,d]),u=(p+1)*g,u>=256?(u=65280,s.push([_/v,(p+1)/v,f,u]),s.push([_/v,(p+1)/v,f,u])):(u=256*(255-u),s.push([_/v,(p+1)/v,h,u]),s.push([_/v,(p+1)/v,h,u]))}for(var x=[1e4,1e4/255,1e4/65025,1e4/160581375],A=0;A<s.length;A++){var P=s[A],y=P[2]&&P[2].data;if(y){var w=4*P[3],b=y[w],R=y[w+1],W=y[w+2],G=b*x[0]+R*x[1]+W*x[2];P[2]=G}else P[2]=0}var _=t.bounds.west/60,p=t.bounds.south/60,S=t.bounds.east/60-_,M=t.bounds.north/60-p;S*=1.003,M*=1.003;var o=WRAP.Geo.WebGL,L=o.getTileTexture(e),T=this.tileShader;a.list||(a.list=[]);var F=a.list,I=F.length?F[F.length-1]:null;I&&I.shader==T&&"triangleStrip"==I.method||(I={shader:T,method:"triangleStrip",vertices:[],elements:[]},F.push(I));var k=I.vertices;I.elements.push({texture:L.id,index:k.length/5,num:s.length});for(var z=0;z<s.length;z++){var P=s[z],D=.5/256+P[0]*(255/256),E=.5/256+P[1]*(255/256),C=P[2];k.push(_+P[0]*S),k.push(p+P[1]*M),k.push(C),k.push(D),k.push(1-E)}if(this.band){var k=I.vertices;I.elements.push({texture:L.id,index:k.length/5,num:s.length});for(var z=0;z<s.length;z++){var P=s[z],D=.5/256+P[0]*(255/256),E=.5/256+P[1]*(255/256),C=P[2];k.push(_-360+D*S),k.push(p+E*M),k.push(C),k.push(D),k.push(1-E)}k=I.vertices,I.elements.push({texture:L.id,index:k.length/5,num:s.length});for(var z=0;z<s.length;z++){var P=s[z],D=.5/256+P[0]*(255/256),E=.5/256+P[1]*(255/256),C=P[2];k.push(_+360+D*S),k.push(p+E*M),k.push(C),k.push(D),k.push(1-E)}}if(n){var B=this.getColor(n),T=this.colorShader;a.list||(a.list=[]);var F=a.list,I=F.length?F[F.length-1]:null;I&&I.shader==T&&"lineStrip"==I.method||(I={shader:T,method:"lineStrip",vertices:[],elements:[]},F.push(I));var k=I.vertices;I.elements.push({index:k.length/10,num:s.length});for(var z=0;z<s.length;z++){var P=s[z],C=P[2];k.push(_+P[0]*S),k.push(p+P[1]*M),k.push(C),k.push(B[0]),k.push(B[1]),k.push(B[2]),k.push(B[3]),k.push(0),k.push(0),k.push(0)}if(this.band){var k=I.vertices;I.elements.push({index:k.length/10,num:s.length});for(var z=0;z<s.length;z++){var P=s[z],C=P[2];k.push(_+360+P[0]*S),k.push(p+P[1]*M),k.push(C),k.push(B[0]),k.push(B[1]),k.push(B[2]),k.push(B[3]),k.push(0),k.push(0),k.push(0)}var k=I.vertices;I.elements.push({index:k.length/10,num:s.length});for(var z=0;z<s.length;z++){var P=s[z],C=P[2];k.push(_-360+P[0]*S),k.push(p+P[1]*M),k.push(C),k.push(B[0]),k.push(B[1]),k.push(B[2]),k.push(B[3]),k.push(0),k.push(0),k.push(0)}}}}}},this.drawModel=function(t,e,i,r,a,n){var o=this.layer;if(o){this.setLayer();var s=o._dc;if(s&&!s.cached&&!WRAP.Geo.imageError[i]){var l=WRAP.Geo.imageCache[i];if(void 0==l)return l=WRAP.Geo.imageCache[i]={loaded:!1,image:new Image,url:i},l.image.onload=function(){l.loaded=!0,WRAP.Geo.invalidate()},l.image.onerror=function(){},void(l.image.src=i);if(!WRAP.Geo.modelError[e]){var h=WRAP.Geo.modelCache[e];if(void 0==h){h=WRAP.Geo.modelCache[e]={loaded:!1,model:{},url:e};var f=new XMLHttpRequest;f&&(f.onreadystatechange=function(){4===f.readyState&&(200===f.status||0===f.status?(h.model=JSON.parse(f.responseText),h.loaded=!0,WRAP.Geo.invalidate()):(WRAP.Geo.modelError[h.url]=!0,WRAP.Geo.updateLayerStatus()))});var c=e.indexOf("?")>=0?"&":"?";return c+="t="+(new Date).getTime(),f.open("GET",e+c,!0),void f.send(null)}if(l.loaded&&h.loaded){var u=WRAP.Geo.WebGL,i=u.getTexture(l.image),e=u.getModel(h.model),d=this.modelShader;s.list||(s.list=[]);var v=s.list,g=v.length?v[v.length-1]:null;g&&g.shader==d&&"triangles"==g.method||(g={shader:d,method:"triangles",elements:[]},v.push(g)),g.elements.push({texture:i.id,model:e,point:t,scale:r||1,offset:a||[0,0,0],rotation:n||0})}}}}},this.begin=function(t){this.layers=[],this.hitcvs||(this.hitcvs=document.createElement("canvas"),this.hitctx_base=this.hitcvs.getContext("2d")),this.hitctx=this.hitctx_base;var e=WRAP.Geo.getSize();if(this.hitcvs.width==e.width&&this.hitcvs.width==e.width||(this.hitcvs.width=e.width,this.hitcvs.height=e.height),this.hitctx.anchor=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(0,0)),this.hitctx.clearRect(0,0,e.width,e.height),this.ctx){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);for(var i=0;i<this.tiles.length;i++){var r=this.tiles[i];r.revision!=t&&(r.valid=!1)}}},this.setLayer=function(){this.layers.length&&this.layers[this.layers.length-1]==this.layer||this.layers.push(this.layer)},this.getColor=function(t){this.color_cache||(this.color_cache={});var e=this.color_cache[t];if(!e){var i=WRAP.Geo.parseColor(t);e=[],e[0]=parseFloat(i[0])/255,e[1]=parseFloat(i[1])/255,e[2]=parseFloat(i[2])/255,e[3]=parseFloat(i[3])/255,this.color_cache[t]=e}return e},this.end=function(){function e(t,e){return[t[0]-e[0],t[1]-e[1],t[2]-e[2]]}function r(t){var e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);return e>1e-5?[t[0]/e,t[1]/e,t[2]/e]:[0,0,0]}function a(t,e){return[t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0]]}function n(t,i,n){var o=r(e(t,i)),s=a(n,o),l=a(o,s);return[s[0],s[1],s[2],0,l[0],l[1],l[2],0,o[0],o[1],o[2],0,t[0],t[1],t[2],1]}function o(t,e,i,r){var a=Math.tan(.5*Math.PI-.5*t),n=1/(i-r);return[a/e,0,0,0,0,a,0,0,0,0,(i+r)*n,-1,0,0,i*r*n*2,0]}function s(t,e){var i=t[0],r=t[1],a=t[2],n=t[3],o=t[4],s=t[5],l=t[6],h=t[7],f=t[8],c=t[9],u=t[10],d=t[11],v=t[12],g=t[13],p=t[14],_=t[15],m=e[0],x=e[1],A=e[2],P=e[3],y=e[4],w=e[5],b=e[6],R=e[7],W=e[8],G=e[9],S=e[10],M=e[11],L=e[12],T=e[13],F=e[14],I=e[15];return[m*i+x*o+A*f+P*v,m*r+x*s+A*c+P*g,m*a+x*l+A*u+P*p,m*n+x*h+A*d+P*_,y*i+w*o+b*f+R*v,y*r+w*s+b*c+R*g,y*a+w*l+b*u+R*p,y*n+w*h+b*d+R*_,W*i+G*o+S*f+M*v,W*r+G*s+S*c+M*g,W*a+G*l+S*u+M*p,W*n+G*h+S*d+M*_,L*i+T*o+F*f+I*v,L*r+T*s+F*c+I*g,L*a+T*l+F*u+I*p,L*n+T*h+F*d+I*_]}function l(t){var e=t[0],i=t[1],r=t[2],a=t[3],n=t[4],o=t[5],s=t[6],l=t[7],h=t[8],f=t[9],c=t[10],u=t[11],d=t[12],v=t[13],g=t[14],p=t[15],_=c*p,m=g*u,x=s*p,A=g*l,P=s*u,y=c*l,w=r*p,b=g*a,R=r*u,W=c*a,G=r*l,S=s*a,M=h*v,L=d*f,T=n*v,F=d*o,I=n*f,k=h*o,z=e*v,D=d*i,E=e*f,C=h*i,B=e*o,N=n*i,U=_*o+A*f+P*v-(m*o+x*f+y*v),j=m*i+w*f+W*v-(_*i+b*f+R*v),V=x*i+b*o+G*v-(A*i+w*o+S*v),O=y*i+R*o+S*f-(P*i+W*o+G*f),X=1/(e*U+n*j+h*V+d*O);return[X*U,X*j,X*V,X*O,X*(m*n+x*h+y*d-(_*n+A*h+P*d)),X*(_*e+b*h+R*d-(m*e+w*h+W*d)),X*(A*e+w*n+S*d-(x*e+b*n+G*d)),X*(P*e+W*n+G*h-(y*e+R*n+S*h)),X*(M*l+F*u+I*p-(L*l+T*u+k*p)),X*(L*a+z*u+C*p-(M*a+D*u+E*p)),X*(T*a+D*l+B*p-(F*a+z*l+N*p)),X*(k*a+E*l+N*u-(I*a+C*l+B*u)),X*(T*c+k*g+L*s-(I*g+M*s+F*c)),X*(E*g+M*r+D*c-(z*c+C*g+L*r)),X*(z*s+N*g+F*r-(B*g+T*r+D*s)),X*(B*c+I*r+C*s-(E*s+N*c+k*r))]}i.clearColor(.2,.3,.5,1),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),i.enable(i.BLEND),i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA),i.enable(i.DEPTH_TEST);for(var h=this.center[0],f=this.ppd,c=360*f,u=this.size[0],d=this.size[1],v=u/2,g=v-(h+180)*f,p=v+(180-h)*f,_=[0],m=0;0<g+m;)m-=c,_.push(m);for(m=0;p+m<u;)m+=c,_.push(m);if(t.eye&&t.lookat&&t.lens){var x=o(t.lens,u/d,1,1e6),A=[0,0,1],P=n(t.eye,t.lookat,A),y=l(P),w=s(x,y);i.viewport(0,0,u,d);for(var b=0;b<this.layers.length;b++){var R=this.layers[b];if(R._dc&&R._dc.list){for(var W=R._dc.list,G=0;G<W.length;G++){var S=W[G];S.vbo||S.vertices&&(S.vbo=S.shader.createBuffer(),S.shader.set(S.vbo,S.vertices),S.vertices=null),S.shader[S.method](w,S.vbo,S.elements)}R._dc.cached=!0}}i.flush()}},this.ColorShader=function(t){var e=WRAP.Geo.WebGL;this.pg=e.setup(i,"attribute vec4 position;attribute vec2 offset;attribute vec4 color;uniform float scale;uniform float z_scale;uniform float center_lat;uniform float center_lon;uniform float ft1;uniform float ft0;uniform mat4 projection;varying vec4 v_color;void main(){    float lon_d = position.x-center_lon;    float lat_d = position.y-center_lat;    float d = sqrt(lon_d*lon_d+lat_d*lat_d);    float a = 1.0;    if ( d > ft0 ) {        a = 0.0;    }    else if ( d > ft1 ) {        a = (ft0-d)/(ft0-ft1);    }    float y = lat_d*scale;    float x = lon_d*scale;    float z = position.z*z_scale*scale;    vec4 p = vec4(x+offset.x, y+offset.y, z, 1.0);    gl_Position = projection * p;    v_color = vec4(color.r, color.g, color.b, color.a*a);}","precision mediump float;\nvarying vec4 v_color;void main(){    if ( v_color.a < 0.01 ) {       discard;    }    gl_FragColor = v_color;}"),i.useProgram(this.pg);var r=i.getAttribLocation(this.pg,"offset"),a=i.getAttribLocation(this.pg,"position"),n=i.getAttribLocation(this.pg,"color"),o=i.getUniformLocation(this.pg,"projection"),s=i.getUniformLocation(this.pg,"center_lat"),l=i.getUniformLocation(this.pg,"center_lon"),h=i.getUniformLocation(this.pg,"ft1"),f=i.getUniformLocation(this.pg,"ft0"),c=i.getUniformLocation(this.pg,"scale"),u=i.getUniformLocation(this.pg,"z_scale");this.createBuffer=function(){return i.createBuffer()},this.deleteBuffer=function(t){i.deleteBuffer(t)},this.set=function(t,e){i.bindBuffer(i.ARRAY_BUFFER,t),i.bufferData(i.ARRAY_BUFFER,new Float32Array(e),i.DYNAMIC_DRAW)},this.draw=function(e,d,v,g){i.useProgram(this.pg),i.uniformMatrix4fv(o,!1,d),i.uniform1f(s,t.center[1]),i.uniform1f(l,t.center[0]),i.uniform1f(c,t.ppd),i.uniform1f(u,t.z_scale);var p=4,_=10*p;i.bindBuffer(i.ARRAY_BUFFER,v),i.vertexAttribPointer(a,3,i.FLOAT,!1,_,0),i.enableVertexAttribArray(a),i.vertexAttribPointer(n,4,i.FLOAT,!1,_,3*p),i.enableVertexAttribArray(n),i.vertexAttribPointer(r,2,i.FLOAT,!1,_,8*p),i.enableVertexAttribArray(r);for(var m=0;m<g.length;m++){var x=g[m];x.ft0&&x.ft1?(i.uniform1f(h,x.ft1),i.uniform1f(f,x.ft0)):(i.uniform1f(h,0),i.uniform1f(f,360)),i.drawArrays(e,x.index,x.num)}i.disableVertexAttribArray(a),i.disableVertexAttribArray(r),i.disableVertexAttribArray(n)},this.triangleStrip=function(t,e,r){this.draw(i.TRIANGLE_STRIP,t,e,r)},this.triangles=function(t,e,r){this.draw(i.TRIANGLES,t,e,r)},this.lineStrip=function(t,e,r){this.draw(i.LINE_STRIP,t,e,r)},this.lines=function(t,e,r){this.draw(i.LINES,t,e,r)}},this.TextureShader=function(t){var e=WRAP.Geo.WebGL;this.pg=e.setup(i,"attribute vec4 position;attribute vec2 coordinate;attribute vec2 offset;attribute vec4 color;attribute float rotation;uniform float scale;uniform float z_scale;uniform float center_lat;uniform float center_lon;uniform mat4 projection;varying vec4 v_color;varying vec2 v_coordinate;void main(){    float cosr = cos(-rotation);    float sinr = sin(-rotation);    float ox = offset.x*cosr - offset.y*sinr;    float oy = offset.x*sinr + offset.y*cosr;    float y = (position.y-center_lat)*scale+oy;    float x = (position.x-center_lon)*scale+ox;    float z = position.z*z_scale*scale;    vec4 p = vec4(x, y, z, 1.0);    gl_Position = projection * p;    v_color = color;    v_coordinate = coordinate;}","precision mediump float;\nuniform sampler2D texture;varying vec4 v_color;varying vec2 v_coordinate;void main(){    vec4 color = texture2D(texture, v_coordinate);    gl_FragColor = v_color * color;}"),i.useProgram(this.pg);var r=i.getAttribLocation(this.pg,"coordinate"),a=i.getAttribLocation(this.pg,"offset"),n=i.getAttribLocation(this.pg,"position"),o=i.getAttribLocation(this.pg,"color"),s=i.getAttribLocation(this.pg,"rotation"),l=i.getUniformLocation(this.pg,"projection"),h=i.getUniformLocation(this.pg,"center_lat"),f=i.getUniformLocation(this.pg,"center_lon"),c=i.getUniformLocation(this.pg,"scale"),u=i.getUniformLocation(this.pg,"z_scale"),d=i.getUniformLocation(this.pg,"texture");this.createBuffer=function(){return i.createBuffer()},this.deleteBuffer=function(t){i.deleteBuffer(t)},this.set=function(t,e){i.bindBuffer(i.ARRAY_BUFFER,t),i.bufferData(i.ARRAY_BUFFER,new Float32Array(e),i.DYNAMIC_DRAW)},this.draw=function(e,v,g,p){
i.useProgram(this.pg),i.uniformMatrix4fv(l,!1,v),i.uniform1f(h,t.center[1]),i.uniform1f(f,t.center[0]),i.uniform1f(c,t.ppd),i.uniform1f(u,t.z_scale),i.uniform1i(d,0);var _=4,m=12*_;i.bindBuffer(i.ARRAY_BUFFER,g),i.vertexAttribPointer(n,3,i.FLOAT,!1,m,0),i.enableVertexAttribArray(n),i.vertexAttribPointer(a,2,i.FLOAT,!1,m,3*_),i.enableVertexAttribArray(a),i.vertexAttribPointer(r,2,i.FLOAT,!1,m,5*_),i.enableVertexAttribArray(r),i.vertexAttribPointer(o,4,i.FLOAT,!1,m,7*_),i.enableVertexAttribArray(o),i.vertexAttribPointer(s,1,i.FLOAT,!1,m,11*_),i.enableVertexAttribArray(s);for(var x=0;x<p.length;x++){var A=p[x];A.texture&&(i.bindTexture(i.TEXTURE_2D,A.texture),i.drawArrays(e,A.index,A.num))}i.bindTexture(i.TEXTURE_2D,null),i.disableVertexAttribArray(n),i.disableVertexAttribArray(a),i.disableVertexAttribArray(r),i.disableVertexAttribArray(o),i.disableVertexAttribArray(s)},this.triangleStrip=function(t,e,r){this.draw(i.TRIANGLE_STRIP,t,e,r)},this.triangles=function(t,e,r){this.draw(i.TRIANGLES,t,e,r)}},this.TileShader=function(t){var e=WRAP.Geo.WebGL;this.pg=e.setup(i,"attribute vec4 position;attribute vec2 coordinate;uniform float scale;uniform float z_scale;uniform float center_lat;uniform float center_lon;uniform mat4 projection;varying vec2 v_coordinate;varying vec4 v_color;void main(){    const float ft1 = 20.0;    const float ft0 = ft1*3.0;    float lon_d = position.x-center_lon;    float lat_d = position.y-center_lat;    float d = sqrt(lon_d*lon_d+lat_d*lat_d);    float a = 1.0;    if ( d > ft0 ) {        a = 0.0;    }    else if ( d > ft1 ) {        a = (ft0-d)/(ft0-ft1);    }    float y = lat_d*scale;    float x = lon_d*scale;    float z = position.z*z_scale*scale;    vec4 p = vec4(x, y, z, 1.0);    gl_Position = projection * p;    v_color = vec4(1.0,1.0,1.0,a);    v_coordinate = coordinate;}","precision mediump float;\nuniform sampler2D texture;varying vec2 v_coordinate;varying vec4 v_color;void main(){    vec4 color = texture2D(texture, v_coordinate);    gl_FragColor = v_color * color;}"),i.useProgram(this.pg);var r=i.getAttribLocation(this.pg,"coordinate"),a=i.getAttribLocation(this.pg,"position"),n=i.getUniformLocation(this.pg,"projection"),o=i.getUniformLocation(this.pg,"center_lat"),s=i.getUniformLocation(this.pg,"center_lon"),l=i.getUniformLocation(this.pg,"scale"),h=i.getUniformLocation(this.pg,"z_scale"),f=i.getUniformLocation(this.pg,"texture");this.createBuffer=function(){return i.createBuffer()},this.deleteBuffer=function(t){i.deleteBuffer(t)},this.set=function(t,e){i.bindBuffer(i.ARRAY_BUFFER,t),i.bufferData(i.ARRAY_BUFFER,new Float32Array(e),i.DYNAMIC_DRAW)},this.draw=function(e,c,u,d){i.useProgram(this.pg),i.uniformMatrix4fv(n,!1,c),i.uniform1f(o,t.center[1]),i.uniform1f(s,t.center[0]),i.uniform1f(l,t.ppd),i.uniform1f(h,t.z_scale),i.uniform1i(f,0);var v=4,g=5*v;i.bindBuffer(i.ARRAY_BUFFER,u),i.vertexAttribPointer(a,3,i.FLOAT,!1,g,0),i.enableVertexAttribArray(a),i.vertexAttribPointer(r,2,i.FLOAT,!1,g,3*v),i.enableVertexAttribArray(r);for(var p=0;p<d.length;p++){var _=d[p];_.texture&&(i.bindTexture(i.TEXTURE_2D,_.texture),i.drawArrays(e,_.index,_.num))}i.bindTexture(i.TEXTURE_2D,null),i.disableVertexAttribArray(a),i.disableVertexAttribArray(r)},this.triangleStrip=function(t,e,r){this.draw(i.TRIANGLE_STRIP,t,e,r)},this.triangles=function(t,e,r){this.draw(i.TRIANGLES,t,e,r)}},this.PointShader=function(t){var e=WRAP.Geo.WebGL;this.pg=e.setup(i,"attribute vec4 position;attribute vec4 color;attribute float value;uniform float scale;uniform float z_scale;uniform float center_lat;uniform float center_lon;uniform mat4 projection;varying vec4 v_color;void main(){    float y = (position.y-center_lat)*scale;    float x = (position.x-center_lon)*scale;    float z = position.z*z_scale*scale;    vec4 p = vec4(x, y, z, 1.0);    gl_Position = projection * p;    gl_PointSize = value;    v_color = color;}","precision mediump float;\nvarying vec4 v_color;void main(){    float dist = distance(gl_PointCoord, vec2(0.5, 0.5));    if ( dist < 0.5 ) {        gl_FragColor = v_color;    } else {        discard;    }}"),i.useProgram(this.pg);var r=i.getAttribLocation(this.pg,"position"),a=i.getAttribLocation(this.pg,"color"),n=i.getAttribLocation(this.pg,"value"),o=i.getUniformLocation(this.pg,"projection"),s=i.getUniformLocation(this.pg,"center_lat"),l=i.getUniformLocation(this.pg,"center_lon"),h=i.getUniformLocation(this.pg,"scale"),f=i.getUniformLocation(this.pg,"z_scale");this.createBuffer=function(){return i.createBuffer()},this.deleteBuffer=function(t){i.deleteBuffer(t)},this.set=function(t,e){i.bindBuffer(i.ARRAY_BUFFER,t),i.bufferData(i.ARRAY_BUFFER,new Float32Array(e),i.DYNAMIC_DRAW)},this.draw=function(e,c,u,d){i.useProgram(this.pg),i.uniformMatrix4fv(o,!1,c),i.uniform1f(s,t.center[1]),i.uniform1f(l,t.center[0]),i.uniform1f(h,t.ppd),i.uniform1f(f,t.z_scale);var v=4,g=8*v;i.bindBuffer(i.ARRAY_BUFFER,u),i.vertexAttribPointer(r,3,i.FLOAT,!1,g,0),i.enableVertexAttribArray(r),i.vertexAttribPointer(a,4,i.FLOAT,!1,g,3*v),i.enableVertexAttribArray(a),i.vertexAttribPointer(n,1,i.FLOAT,!1,g,7*v),i.enableVertexAttribArray(n);for(var p=0;p<d.length;p++){var _=d[p];i.drawArrays(e,_.index,_.num)}i.disableVertexAttribArray(r),i.disableVertexAttribArray(n),i.disableVertexAttribArray(a)},this.points=function(t,e,r){this.draw(i.POINTS,t,e,r)}},this.FlowShader=function(t){var e=WRAP.Geo.WebGL;this.pg=e.setup(i,"attribute vec4 position;attribute float value;attribute vec4 color;uniform float current;uniform float scale;uniform float z_scale;uniform float center_lat;uniform float center_lon;uniform float ft1;uniform float ft0;uniform mat4 projection;varying vec4 v_color;void main(){    float lon_d = position.x-center_lon;    float lat_d = position.y-center_lat;    float d = sqrt(lon_d*lon_d+lat_d*lat_d);    float a = 1.0;    if ( d > ft0 ) {        a = 0.0;    }    else if ( d > ft1 ) {        a = (ft0-d)/(ft0-ft1);    }    float v = current-value;    if ( v < 0.0 )        v += 5.0;    v = (3.0-v)/3.0;    if ( v < 0.0 )        v = 0.0;    if ( v > 1.0 )        v = 0.0;    a = a*v;    if ( a <= 0.0 ) {        a = 0.0;    }    float y = lat_d*scale;    float x = lon_d*scale;    float z = position.z*z_scale*scale;    vec4 p = vec4(x, y, z, 1.0);    gl_Position = projection * p;    v_color = vec4(color.r, color.g, color.b, color.a*a);}","precision mediump float;\nvarying vec4 v_color;void main(){    if ( v_color.a < 0.01 ) {       discard;    }    gl_FragColor = v_color;}"),i.useProgram(this.pg);var r=i.getAttribLocation(this.pg,"value"),a=i.getAttribLocation(this.pg,"position"),n=i.getAttribLocation(this.pg,"color"),o=i.getUniformLocation(this.pg,"projection"),s=i.getUniformLocation(this.pg,"center_lat"),l=i.getUniformLocation(this.pg,"center_lon"),h=i.getUniformLocation(this.pg,"current"),f=i.getUniformLocation(this.pg,"ft1"),c=i.getUniformLocation(this.pg,"ft0"),u=i.getUniformLocation(this.pg,"scale"),d=i.getUniformLocation(this.pg,"z_scale");this.createBuffer=function(){return i.createBuffer()},this.deleteBuffer=function(t){i.deleteBuffer(t)},this.set=function(t,e){i.bindBuffer(i.ARRAY_BUFFER,t),i.bufferData(i.ARRAY_BUFFER,new Float32Array(e),i.DYNAMIC_DRAW)},this.draw=function(e,v,g,p){i.useProgram(this.pg),i.uniformMatrix4fv(o,!1,v),i.uniform1f(s,t.center[1]),i.uniform1f(l,t.center[0]),i.uniform1f(u,t.ppd),i.uniform1f(d,t.z_scale);var _=5,m=(new Date).getTime()/1e3,x=Math.floor(m/_);x=m-x*_,i.uniform1f(h,x);var A=4,P=10*A;i.bindBuffer(i.ARRAY_BUFFER,g),i.vertexAttribPointer(a,3,i.FLOAT,!1,P,0),i.enableVertexAttribArray(a),i.vertexAttribPointer(n,4,i.FLOAT,!1,P,3*A),i.enableVertexAttribArray(n),i.vertexAttribPointer(r,1,i.FLOAT,!1,P,7*A),i.enableVertexAttribArray(r);for(var y=0;y<p.length;y++){var w=p[y];w.ft0&&w.ft1?(i.uniform1f(f,w.ft1),i.uniform1f(c,w.ft0)):(i.uniform1f(f,0),i.uniform1f(c,360)),i.drawArrays(e,w.index,w.num)}i.disableVertexAttribArray(a),i.disableVertexAttribArray(n)},this.triangleStrip=function(t,e,r){this.draw(i.TRIANGLE_STRIP,t,e,r)},this.triangles=function(t,e,r){this.draw(i.TRIANGLES,t,e,r)},this.lineStrip=function(t,e,r){this.draw(i.LINE_STRIP,t,e,r)},this.lines=function(t,e,r){this.draw(i.LINES,t,e,r)}},this.ModelShader=function(t){var e=WRAP.Geo.WebGL;this.pg=e.setup(i,"attribute vec4 position;attribute vec2 coordinate;uniform float center_lat;uniform float center_lon;uniform float scale;uniform float z_scale;uniform float lon;uniform float lat;uniform float alt;uniform float size;uniform float offset_x;uniform float offset_y;uniform float offset_z;uniform float cos_r;uniform float sin_r;uniform mat4 projection;varying vec4 v_color;varying vec2 v_coordinate;void main(){    float ax = -(position.x+offset_x)*size;    float ay = (position.z+offset_z)*size;    float az = (position.y+offset_y)*size;    float x = (lon-center_lon)*scale;    float y = (lat-center_lat)*scale;    float z = alt*z_scale*scale;    float rx = ax*cos_r - ay*sin_r;    float ry = ax*sin_r + ay*cos_r;    vec4 p = vec4(x+rx, y+ry, z+az, 1.0);    gl_Position = projection * p;    v_color = vec4(1.0,1.0,1.0,1.0);    v_coordinate = vec2(coordinate.x,1.0-coordinate.y);}","precision mediump float;\nuniform sampler2D texture;varying vec4 v_color;varying vec2 v_coordinate;void main(){    vec4 color = texture2D(texture, v_coordinate);    gl_FragColor = v_color * color;}"),i.useProgram(this.pg);var r=i.getAttribLocation(this.pg,"position"),a=i.getAttribLocation(this.pg,"coordinate"),n=i.getUniformLocation(this.pg,"projection"),o=i.getUniformLocation(this.pg,"center_lat"),s=i.getUniformLocation(this.pg,"center_lon"),l=i.getUniformLocation(this.pg,"scale"),h=i.getUniformLocation(this.pg,"z_scale"),f=i.getUniformLocation(this.pg,"lat"),c=i.getUniformLocation(this.pg,"lon"),u=i.getUniformLocation(this.pg,"alt"),d=i.getUniformLocation(this.pg,"size"),v=i.getUniformLocation(this.pg,"offset_x"),g=i.getUniformLocation(this.pg,"offset_y"),p=i.getUniformLocation(this.pg,"offset_z"),_=i.getUniformLocation(this.pg,"cos_r"),m=i.getUniformLocation(this.pg,"sin_r"),x=i.getUniformLocation(this.pg,"texture");this.draw=function(e,A,P,y){WRAP.Geo.check(P),i.useProgram(this.pg),i.uniformMatrix4fv(n,!1,A),i.uniform1f(o,t.center[1]),i.uniform1f(s,t.center[0]),i.uniform1f(l,t.ppd),i.uniform1f(h,t.z_scale),i.uniform1i(x,0);for(var w=0;w<y.length;w++){var b=y[w];if(b.texture&&b.model){var R=(b.rotation||0)/180*Math.PI;i.uniform1f(c,b.point[0]),i.uniform1f(f,b.point[1]),i.uniform1f(u,b.point[2]),i.uniform1f(d,b.scale),i.uniform1f(v,b.offset[0]),i.uniform1f(g,b.offset[1]),i.uniform1f(p,b.offset[2]),i.uniform1f(_,Math.cos(R)),i.uniform1f(m,Math.sin(R)),i.bindBuffer(i.ARRAY_BUFFER,b.model.position),i.enableVertexAttribArray(r),i.vertexAttribPointer(r,3,i.FLOAT,!1,0,0),i.bindBuffer(i.ARRAY_BUFFER,b.model.uv),i.enableVertexAttribArray(a),i.vertexAttribPointer(a,2,i.FLOAT,!1,0,0),i.bindTexture(i.TEXTURE_2D,b.texture),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,b.model.index),i.drawElements(e,b.model.length,i.UNSIGNED_SHORT,0)}}i.bindTexture(i.TEXTURE_2D,null),i.disableVertexAttribArray(r),i.disableVertexAttribArray(a)},this.triangleStrip=function(t,e,r){this.draw(i.TRIANGLE_STRIP,t,e,r)},this.triangles=function(t,e,r){this.draw(i.TRIANGLES,t,e,r)}},this.colorShader=new this.ColorShader(this),this.pointShader=new this.PointShader(this),this.textureShader=new this.TextureShader(this),this.tileShader=new this.TileShader(this),this.flowShader=new this.FlowShader(this),this.modelShader=new this.ModelShader(this),this.rev=0},"undefined"==typeof WRAP.Geo.Projection&&(WRAP.Geo.Projection={}),WRAP.Geo.Projection.Perspective=function(t){this.opt=t,this.forward=function(t){return t},this.inverse=function(t){return t},this.rotation=function(t,e){return WRAP.Geo.check(t),e}},WRAP.Geo.setWebGLMap=function(t){return WRAP.Geo.map=new WRAP.Geo.Bridge.WebGLMap(t),WRAP.Geo.map},WRAP.Geo.Bridge.WebGLMap=function(t){var e=this,i=null;for(this.map=t,this.canvas=document.createElement("canvas");t.firstChild;)t.removeChild(t.firstChild);t.appendChild(this.canvas),this.canvas.style.width="100%",this.canvas.style.height="100%",this.zoom=5,this.center={lat:0,lon:0};try{i=this.canvas.getContext("webgl")||this.canvas.getContext("experimental-webgl")}catch(t){}return i?(this.setView=function(t,e){if("Perspective"==t)return this.view=new WRAP.Geo.View3D(this),void(this.context=this.view.setProjection(t,e));this.view=null;var r=e&&e.lat_ts,a=e&&e.base_lon;this.projection=new WRAP.Geo.WebGL.Projection[t](i,r,a),this.projection.setZoom(this.zoom),this.projection.setCenter(this.center),this.context=new this.projection.Context(this.projection,i)},this.clearDisplayCache=function(t){if(t){if(t.list){for(var e=0;e<t.list.length;e++){var i=t.list[e];i.shader&&i.vbo&&i.shader.deleteBuffer(i.vbo)}t.list=[]}t.cached=!1}},this.tileID=function(t,e,i){return"W/"+t+"/"+e+"/"+i},this.refresh=function(){setTimeout(function(){e.updateBounds()},1)},this.updateBounds=function(){return this.canvas.width=this.map.clientWidth,this.canvas.height=this.map.clientHeight,e.view?void e.view.updateBounds(this.zoom,[this.center.lon,this.center.lat],[this.canvas.width,this.canvas.height]):(this.projection.setSize(this.canvas.width,this.canvas.height),this.updateTimer&&clearTimeout(this.updateTimer),void(this.updateTimer=setTimeout(function(){function t(t,e,i,r){var a=t.findTile(e,i,r);if(a)return void(a.locked=!1);var n=new Float32Array(131072);e=Math.floor(parseFloat(e));for(var o=Math.pow(2,e),s=parseFloat(r)/o,l=parseFloat(i)/o,h=1/(256*o),f={x:[257],y:[257]},c=0;c<257;c++){var u=s+h*c,d=l+h*c;f.x[c]=-180+360*u,f.y[257-c-1]=-90+360*d}for(var c=0,v=0;v<256;v++)for(var g=0;g<256;g++)n[c++]=f.y[v],n[c++]=f.x[g];t.addTile("W",e,i,r,n,new WRAP.Geo.Bounds(60*f.y[0],60*f.y[256],60*f.x[256],60*f.x[0]))}var i=e.canvas.width/2,r=e.canvas.height/2,a=Math.pow(2,Math.floor(e.zoom)),n=a/2,o=360/a,s=e.projection.point([-i,-r]),l=e.projection.point([i,r]),h=Math.floor((s[0]+180)/o),f=Math.floor((l[0]+180)/o);f-h>=a&&(h=0,f=a-1);var c=0,u=0;n>=1&&(c=n-Math.floor((90-l[1])/o)-1,u=n-Math.floor((90-s[1])/o)-1),e.projection&&"PolarStereographics"==e.projection.name&&e.zoom<=5&&(h=0,f=a-1,"North"==e.projection.orientation?(c=0,u=a/2-1):(c=a/2,u=a-1)),c<0&&(c=0),u<0&&(u=0),c>=n&&(c=n-1),u>=n&&(u=n-1),f-h>a?(h=0,f=a-1):(h%=a,f%=a),h<0&&(h+=a),f<0&&(f+=a),e.context.lockTile();for(var d=Math.floor(parseFloat(e.zoom)),v=Math.pow(2,d),g=c;g<=u;g++)if(h<=f)for(var p=h;p<=f;p++){var _=p%v;t(e.context,d,g,_)}else{for(var p=h;p<v;p++){var _=p%v;t(e.context,d,g,_)}for(var p=0;p<=f;p++){var _=p%v;t(e.context,d,g,_)}}e.context.clearLockedTile(),e.context.setTileBand(e.zoom,h,f,c,u),WRAP.Geo.updateBounds(new WRAP.Geo.Bounds(60*s[1],60*l[1],60*l[0],60*s[0])),WRAP.Geo.render()},1)))},window.setTimeout(function(){e.updateBounds()},1e3),this.adjustXY=function(t){var e=t.target.getBoundingClientRect();this._mx=t.clientX-e.left,this._my=t.clientY-e.top},this.canvas.onmousemove=function(t){if(!e.view_controller&&(e.adjustXY(t),e._drag)){var i=e._mx-e._drag_x,r=e._my-e._drag_y,a=this.width/2,n=this.height/2,o=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(a-i,n-r));WRAP.Geo.setCenterPoint(o),e._drag_x=e._mx,e._drag_y=e._my}},this.canvas.onmousedown=function(t){e.view_controller||(e.adjustXY(t),e._drag=!0,e._drag_offset=e._content_offset,e._drag_x=e._mx,e._drag_y=e._my)},this.canvas.onmouseup=function(t){e.view_controller||(e.adjustXY(t),e._drag=!1)},this.canvas.onmouseout=function(){e.view_controller||(e._drag=!1)},this.canvas.onmousewheel=function(t){if(!e.view_controller){e.adjustXY(t);var i=t.wheelDelta/400,r=WRAP.Geo.getZoom();r+=i,r<0&&(r=0),r>10&&(r=10),WRAP.Geo.setZoom(r),t.preventDefault()}},window.addEventListener("resize",function(){e.updateBounds()}),this.getSize=function(){return{width:this.canvas.width,height:this.canvas.height}},this.getScreenPoint=function(t){var e=this.view||this.projection;if(e){var i=this.canvas.width/2,r=this.canvas.height/2,a=e.screenPoint([t.lonDegree(),t.latDegree()]);return new WRAP.Geo.ScreenPoint(parseInt(i+a[0]),parseInt(r+a[1]))}return new WRAP.Geo.ScreenPoint(0,0)},this.getScreenRotation=function(t,e){var i=this.view||this.projection;return i?i.screenRotation([t.lonDegree(),t.latDegree()],e):e},this.getScreenLine=function(t){for(var i=[],r=this.canvas.width/2,a=this.canvas.height/2,n=999999,o=-999999,s=[],l=0;l<t.length;l++){var h=e.projection.screenPoint([t[l][1],t[l][0]]),f=h[0]+r,c=h[1]+a;n>f&&(n=f),o<f&&(o=f),s.push(new WRAP.Geo.ScreenPoint(f,c))}i.push(s);var u=e.context.projection.round_wrap&&e.context.canvas_band;if(u)for(var d=[u,-u],v=0;v<d.length;v++){for(var g=d[v],p=[],l=0;l<s.length;l++)p.push(new WRAP.Geo.ScreenPoint(s[l].x+g,s[l].y));i.push(p)}return i},this.getPoint=function(t){var e=this.view||this.projection;if(e){var i=this.canvas.width/2,r=this.canvas.height/2,a=e.point([t.x-i,t.y-r]);return new WRAP.Geo.Point(60*a[1],60*a[0])}return new WRAP.Geo.Point(0,0)},this.getCenterPoint=function(){return new WRAP.Geo.Point(60*this.center.lat,60*this.center.lon)},this.setCenterPoint=function(t){this.center.lat=t.latDegree(),this.center.lon=t.lonDegree(),this.projection&&this.projection.setCenter(this.center),this.updateBounds()},this.getZoom=function(){return this.zoom},this.setZoom=function(t){this.zoom=t,this.projection&&(t<2&&(t=2),t>8&&(t=8),this.zoom=t,this.projection.setZoom(this.zoom)),this.updateBounds()},this.getPerspective=function(){},this.update=function(){},this.enableScroll=function(){},this.normalizeLon=function(t){for(;t<-180;)t+=360;for(;t>=180;)t-=360},this.setViewPerspective=function(t,e,i){this.view&&this.view.setViewPerspective(t,e,i)},this.setViewOption=function(t){this.view&&this.view.setViewOption(t)},this.setViewController=function(t){(this.view_controller=t)&&this.view_controller.init&&this.view_controller.init(this.canvas)},void this.setView("EQR")):void alert("WebGL not supported.")},WRAP.Geo.WebGL={gl:null,orthogonalMatrix:function(t,e,i,r,a,n){var o=new Float32Array(16),s=e-t,l=r-i,h=n-a;return o[0]=2/s,o[5]=2/l,o[10]=-2/h,o[12]=-(e+t)/s,o[13]=-(r+i)/l,o[14]=-(n+a)/h,o[15]=1,o[1]=o[2]=o[3]=o[4]=o[6]=o[7]=o[8]=o[9]=o[11]=0,o},setup:function(t,e,i){this.gl=t;var r=t.createShader(t.VERTEX_SHADER);t.shaderSource(r,e),t.compileShader(r),t.getShaderParameter(r,t.COMPILE_STATUS)||console.error("Vertex Shader Error : "+t.getShaderInfoLog(r));var a=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(a,i),t.compileShader(a),t.getShaderParameter(a,t.COMPILE_STATUS)||console.error("Fragment Shader Error : "+t.getShaderInfoLog(a));var n=t.createProgram();return t.attachShader(n,r),t.attachShader(n,a),t.linkProgram(n),t.getProgramParameter(n,t.LINK_STATUS)||console.error(t.getProgramInfoLog(n)),n},Texture:function(t){for(var e=this.width=t.width,i=this.height=t.height,r=e>i?e:i,a=16;a<r;)a*=2;var n=e/a,o=i/a,s=document.createElement("canvas"),l=s.getContext("2d");s.width=s.height=a,t.data?(l.putImageData(t,0,0),l.fillStyle="rgba(0,0,0,0.0)",l.fillRect(0,0,1,1)):l.drawImage(t,0,0,e,i);var h=WRAP.Geo.WebGL.gl;this.id=h.createTexture(),this.id&&(h.bindTexture(h.TEXTURE_2D,this.id),h.texImage2D(h.TEXTURE_2D,0,h.RGBA,h.RGBA,h.UNSIGNED_BYTE,s),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MAG_FILTER,h.LINEAR),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MIN_FILTER,h.LINEAR_MIPMAP_NEAREST),h.generateMipmap(h.TEXTURE_2D),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_S,h.REPEAT),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_T,h.REPEAT),h.bindTexture(h.TEXTURE_2D,null)),this.vertices=function(t,e){var i=[];return i.push([0,0,0,0]),i.push([t,0,n,0]),i.push([0,-e,0,o]),i.push([t,-e,n,o]),i}},textureCache:[],getTexture:function(t){for(var e=0;e<this.textureCache.length;e++){var i=this.textureCache[e];if(i.img==t)return i.texture}var r=new this.Texture(t);return this.textureCache.push({img:t,texture:r}),r},modelCache:[],getModel:function(t){function e(t){var e=n.createBuffer();return n.bindBuffer(n.ARRAY_BUFFER,e),n.bufferData(n.ARRAY_BUFFER,new Float32Array(t),n.STATIC_DRAW),n.bindBuffer(n.ARRAY_BUFFER,null),e}function i(t){var e=n.createBuffer();return n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,e),n.bufferData(n.ELEMENT_ARRAY_BUFFER,new Int16Array(t),n.STATIC_DRAW),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e}for(var r=0;r<this.modelCache.length;r++){var a=this.modelCache[r];if(a.data==t)return a}var n=WRAP.Geo.WebGL.gl,o={data:t,length:t.data.index.array.length,position:e(t.data.attributes.position.array),normal:e(t.data.attributes.normal.array),uv:e(t.data.attributes.uv.array),index:i(t.data.index.array)};return this.modelCache.push(o),o},fontCache:[],getFontTexture:function(t,e,i,r){for(var a=0;a<this.fontCache.length;a++){var n=this.fontCache[a];if(n.text==t&&n.fontSize==e&&n.fillStyle==i&&n.strokeStyle==r)return n.texture}var o=document.createElement("canvas"),s=o.getContext("2d");e&&(s.font=e+"px Arial");var l=s.measureText(t),h=l.width;o.width=Math.ceil(h)+3,o.height=e+2,s.font=e+"px Arial",r&&(s.lineWidth=2,s.strokeStyle=r,s.strokeText(t,2,e-1)),i&&(s.fillStyle="rgba(0,0,0,0)",s.fillRect(0,0,o.width,o.height),s.fillStyle=i,s.fillText(t,2,e-1),s.fillText(t,2.3,e-1));var f=new this.Texture(o);return f.content_width=h+1,this.fontCache.push({text:t,fontSize:e,fillStyle:i,strokeStyle:r,texture:f}),f},TileTexture:function(t){for(var e=this.width=t.width,i=this.height=t.height,r=e>i?e:i,a=16;a<r;)a*=2;var n;if(t.image)n=t.image;else{var o=document.createElement("canvas"),s=o.getContext("2d");o.width=o.height=a;for(var l=s.getImageData(0,0,e,i),h=0;h<l.data.length;h++)l.data[h]=t.data[h];s.putImageData(l,0,0),s.fillStyle="rgba(0,0,0,0.0)",s.fillRect(0,0,1,1),n=o}var f=WRAP.Geo.WebGL.gl;this.id=f.createTexture(),this.id&&(f.bindTexture(f.TEXTURE_2D,this.id),f.texImage2D(f.TEXTURE_2D,0,f.RGBA,f.RGBA,f.UNSIGNED_BYTE,n),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.LINEAR),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.LINEAR_MIPMAP_NEAREST),f.generateMipmap(f.TEXTURE_2D),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE),f.bindTexture(f.TEXTURE_2D,null))},tileCache:[],tileCacheMax:128,getTileTexture:function(t){for(var e=0;e<this.tileCache.length;e++){var i=this.tileCache[e];if(i.img==t)return this.tileCache.splice(e,1),this.tileCache.unshift(i),i.texture}var r=WRAP.Geo.WebGL.gl;if(this.tileCache.length==this.tileCacheMax){var a=this.tileCache.pop();a&&r.deleteTexture(a.id)}var n=new this.TileTexture(t);return this.tileCache.unshift({img:t,texture:n}),n},Projection:{Common:{setTileBand:function(t,e,i,r,a){if(this.zoom!=t||this.min_tile_x!=e||this.max_tile_x!=i||this.min_tile_y!=r||this.max_tile_y!=a){if(this.zoom=t,this.tile_band=Math.pow(2,t),this.canvas_band=256*this.tile_band,this.min_tile_x=e,this.max_tile_x=i,this.min_tile_y=r,this.max_tile_y=a,this.offset_x=256*(this.min_tile_x-this.tile_band/2),this.offset_y=256*(this.tile_band/2-1-this.max_tile_y),this.tiles.length){var n={};n.n=this.tiles[0].bounds.north/60,n.s=this.tiles[0].bounds.south/60;for(var o=1;o<this.tiles.length;o++)n.n<this.tiles[o].bounds.north/60&&(n.n=this.tiles[o].bounds.north/60),n.s>this.tiles[o].bounds.south/60&&(n.s=this.tiles[o].bounds.south/60);n.w=(this.min_tile_x-this.tile_band/2)/this.tile_band*360,n.e=(this.max_tile_x+1-this.tile_band/2)/this.tile_band*360}this.bounds=n,this.canvas||(this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"));var s=this.max_tile_y-this.min_tile_y+1,l=this.max_tile_x-this.min_tile_x+1;this.max_tile_x<this.min_tile_x&&(l=this.tile_band-this.min_tile_x+this.max_tile_x+1),this.canvas.width=256*l,this.canvas.height=256*s;for(var h=Math.floor(t),f=0;f<s;f++)for(var c=this.max_tile_y-f,u=0;u<l;u++){var d=(this.min_tile_x+u)%this.tile_band,v=this.findTile(h,c,d);v&&(v.canvas=this.canvas,v.ctx=this.ctx,v.offset_x=256*u,v.offset_y=256*f)}}},lockTile:function(){for(var t=0;t<this.tiles.length;t++)this.tiles[t].locked=!0},clearLockedTile:function(){for(var t=this.tiles.length-1;t>=0;t--)this.tiles[t].locked&&this.tiles.splice(t,1)},findTile:function(t,e,i){for(var r=0;r<this.tiles.length;r++){var a=this.tiles[r];if(a.z==t&&a.y==e&&a.x==i)return a}return null},addTile:function(t,e,i,r,a,n){this.revision++,this.tiles.push({id:t+"/"+e+"/"+i+"/"+r,type:t,z:e,y:i,x:r,cood:a,bounds:n,canvas:this.canvas,ctx:this.ctx,offset_x:256*r,offset_y:256*i})},tile:function(t){for(var e=0;e<this.tiles.length;e++){var i=this.tiles[e];i.valid||t(i)}},drawImageData:function(t,e,i,r,a,n,o){var s=this.layer;if(s){this.setLayer();var l=s._dc;if(l&&!l.cached){var h=WRAP.Geo.WebGL,f=h.getTexture(e),c=f.vertices(i,r),u=this.projection.textureShader;l.list||(l.list=[]);var d=l.list,v=d.length?d[d.length-1]:null;v&&v.shader==u&&"triangleStrip"==v.method||(v={shader:u,method:"triangleStrip",vertices:[],elements:[]},d.push(v));var g=v.vertices;v.elements.push({texture:f.id,index:g.length/11,num:c.length}),o||(o=0),o=Math.PI*o/180;for(var p=0;p<c.length;p++){var _=c[p];g.push(t[0]),g.push(t[1]),g.push(_[0]+a),g.push(_[1]-n),g.push(_[2]),g.push(_[3]),g.push(1),g.push(1),g.push(1),g.push(1),g.push(o)}if("EQR"==this.projection.name){var g=v.vertices;v.elements.push({texture:f.id,index:g.length/11,num:c.length});for(var p=0;p<c.length;p++){var _=c[p];g.push(t[0]-360),g.push(t[1]),g.push(_[0]+a),g.push(_[1]-n),g.push(_[2]),g.push(_[3]),g.push(1),g.push(1),g.push(1),g.push(1),g.push(o)}g=v.vertices,v.elements.push({texture:f.id,index:g.length/11,num:c.length});for(var p=0;p<c.length;p++){var _=c[p];g.push(t[0]+360),g.push(t[1]),g.push(_[0]+a),g.push(_[1]-n),g.push(_[2]),g.push(_[3]),g.push(1),g.push(1),g.push(1),g.push(1),g.push(o)}}}}},drawImage:function(t,e,i,r,a,n,o){var s=this.layer;if(s){this.setLayer();var l=s._dc;if(l&&!l.cached&&!WRAP.Geo.imageError[e]){var h=WRAP.Geo.imageCache[e];if(void 0==h)return h=WRAP.Geo.imageCache[e]={loaded:!1,image:new Image,url:e},h.image.onload=function(){h.loaded=!0,s._dc={},WRAP.Geo.invalidate()},h.image.onerror=function(){WRAP.Geo.imageError[h.url]=!0,WRAP.Geo.updateLayerStatus()},void(h.image.src=e);if(h.loaded){var f=WRAP.Geo.WebGL,c=f.getTexture(h.image),u=c.vertices(i,r),d=this.projection.textureShader;l.list||(l.list=[]);var v=l.list,g=v.length?v[v.length-1]:null;g&&g.shader==d&&"triangleStrip"==g.method||(g={shader:d,method:"triangleStrip",vertices:[],elements:[]},v.push(g));var p=g.vertices;g.elements.push({texture:c.id,index:p.length/11,num:u.length}),o||(o=0),o=Math.PI*o/180;for(var _=0;_<u.length;_++){var m=u[_];p.push(t[0]),p.push(t[1]),p.push(m[0]+a),p.push(m[1]-n),p.push(m[2]),p.push(m[3]),p.push(1),p.push(1),p.push(1),p.push(1),p.push(o)}if("EQR"==this.projection.name){var p=g.vertices;g.elements.push({texture:c.id,index:p.length/11,num:u.length});for(var _=0;_<u.length;_++){var m=u[_];p.push(t[0]-360),p.push(t[1]),p.push(m[0]+a),p.push(m[1]-n),p.push(m[2]),p.push(m[3]),p.push(1),p.push(1),p.push(1),p.push(1),p.push(o)}p=g.vertices,g.elements.push({texture:c.id,index:p.length/11,num:u.length});for(var _=0;_<u.length;_++){var m=u[_];p.push(t[0]+360),p.push(t[1]),p.push(m[0]+a),p.push(m[1]-n),p.push(m[2]),p.push(m[3]),p.push(1),p.push(1),p.push(1),p.push(1),p.push(o)}}}}}},hit:function(t,e,i){if(!i)return!1;var r=this.hitctx.getImageData(t,e,1,1);if(r&&r.data){var a=(r.data[0]<<16)+(r.data[1]<<8)+r.data[2];if(a){var n=0,o=0,s=0,l=0,h=this.hitctx.getImageData(t-1,e,1,1);h&&h.data&&(n=(h.data[0]<<16)+(h.data[1]<<8)+h.data[2]);var f=this.hitctx.getImageData(t+1,e,1,1);f&&f.data&&(o=(f.data[0]<<16)+(f.data[1]<<8)+f.data[2]);var c=this.hitctx.getImageData(t,e-1,1,1);c&&c.data&&(s=(c.data[0]<<16)+(c.data[1]<<8)+c.data[2]);var u=this.hitctx.getImageData(t,e+1,1,1);return u&&u.data&&(l=(u.data[0]<<16)+(u.data[1]<<8)+u.data[2]),(a==n||a==o||a==s||a==l)&&i==a}}return!1},_drawLines:function(t,e,i,r,a,n,o,s,l){function h(t,e){var i=t.length,r=[],a=d(t[0],t[1],e);r.push(a[0]),r.push(a[1]);for(var n=0;n<i-2;n++)for(var o=v(t[n],t[n+1],t[n+2],e),s=0;s<o.length;s++)r.push(o[s]);var l=d(t[i-1],t[i-2],e);return r.push(l[1]),r.push(l[0]),r}function f(t,e){var i=[];for(i.push(t[0]);;){if(t.length<2)return i;var r=t[0],a=t[1],n=Math.sqrt((r[0]-a[0])*(r[0]-a[0])+(r[1]-a[1])*(r[1]-a[1]));if(!(n<e)){if(n==e)return i.push(a),t.shift(),i;var o=r[0]+(a[0]-r[0])*e/n,s=r[1]+(a[1]-r[1])*e/n;return t.shift(),t.unshift([o,s,r[2]]),i.push([o,s,r[2]]),i}i.push(a),t.shift(),e-=n}return i}function c(t,e,i){var r=u(t);if(r.length<2)return[];if(!i.safe())return h(r,e);for(var a=[];;){var n=i.get(),o=f(r,n);if(i.active()&&a.push(o),r.length<=1)break}for(var s=[],l=0;l<a.length;l++){var o=h(a[l],e);l>0&&s.push(o[0]);for(var c=0;c<o.length;c++)s.push(o[c]);l<a.length-1&&s.push(o[o.length-1])}return s}function u(t){for(var e=[t[0]],i=0;i<t.length-1;i++)(t[i][0]-t[i+1][0])*(t[i][0]-t[i+1][0])+(t[i][1]-t[i+1][1])*(t[i][1]-t[i+1][1])>P*P&&e.push(t[i+1]);return e}function d(t,e,i){var r=e[0]-t[0],a=e[1]-t[1],n=Math.sqrt(r*r+a*a),o=-a*i/n,s=r*i/n,l=t[0]+o,h=t[1]+s,f=t[0]-o,c=t[1]-s;return[[l,h,t[2]],[f,c,t[2]]]}function v(t,e,i,r){var a=e[0]-t[0],n=e[1]-t[1],o=i[0]-e[0],s=i[1]-e[1],l=Math.sqrt(a*a+n*n),h=Math.sqrt(o*o+s*s),f=-n*r/l,c=a*r/l,u=-s*r/h,d=o*r/h,v=a*s-n*o;if(v<-P){var g=(-h*r-f*s+c*o)/v,p=e[0]-f-g*a,_=e[1]-c-g*n,m=Math.sqrt(r*r+g*g*l*l),x=e[0]+(f+g*a)*r/m,A=e[1]+(c+g*n)*r/m,y=e[0]+f,w=e[1]+c,b=e[0]+u,R=e[1]+d;return(p-t[0])*a+(_-t[1])*n<0||(p-i[0])*o+(_-i[1])*s>0?[[y,w,e[2]],[e[0]-f,e[1]-c,e[2]],[x,A,e[2]],e,[b,R,e[2]],[e[0]-u,e[1]-d,e[2]]]:[[y,w,e[2]],[p,_,e[2]],[x,A,e[2]],[p,_,e[2]],[b,R,e[2]],[p,_,e[2]]]}if(v>P){var g=(-h*r-f*s+c*o)/v,W=e[0]+f+g*a,G=e[1]+c+g*n,S=Math.sqrt(r*r+g*g*l*l),M=e[0]-(f+g*a)*r/S,L=e[1]-(c+g*n)*r/S,T=e[0]-f,F=e[1]-c,I=e[0]-u,k=e[1]-d;return(W-t[0])*a+(G-t[1])*n<0||(W-i[0])*o+(G-i[1])*s>0?[[e[0]+f,e[1]+c,e[2]],[T,F,e[2]],e,[M,L,e[2]],[e[0]+u,e[1]+d,e[2]],[I,k,e[2]]]:[[W,G,e[2]],[T,F,e[2]],[W,G,e[2]],[M,L,e[2]],[W,G,e[2]],[I,k,e[2]]]}if(a*o+n*s<0){var z=[e[0]+f,e[1]+c,e[2]],D=[e[0]+u,e[1]+d,e[2]],E=[e[0]+(c-d)/2,e[1]+(-f+u)/2,e[2]];return[z,D,E,e,D,z]}var C=[e[0]+(f+u)/2,e[1]+(c+d)/2,e[2]],B=[e[0]-(f+u)/2,e[1]-(c+d)/2,e[2]];return[C,B]}function g(t,e){return[(t[0]+e[0])/2,(t[1]+e[1])/2]}function p(t,e,i){var r=g(t,e),a=g(i,e);return g(r,a)}var _=WRAP.Geo.WebGL,m=this.layer;if(m){this.setLayer();var x=m._dc;if(x&&!x.cached){var A=function(t){this.array=t,this.index=0,this.count=0,this.safe=function(){if(!this.array||0==this.array.length)return!1;for(var t=0;t<this.array.length;t++)if(this.array[t]<=0)return!1;return!0},this.get=function(){var t=this.array[this.index++];return this.index>=this.array.length&&(this.index=0),this.count++,t},this.active=function(){return 1==(1&this.count)}},P=1e-5;if("cloud"==s||"counter_cloud"==s){var y=Math.PI/3;"counter_cloud"==s&&(y=-y);for(var w=Math.cos(y),b=Math.sin(y),R=10,W=[],G=0;G<e.length;G++){for(var S=e[G],M=[],L=0;L<S.length;L++){var T=S[L],F=t.screenPoint(T);M.push(F)}var I=[],T=M[0],k=T[0],z=T[1],L=0;I.push(T);for(var D=k,E=z,C=R;++L<M.length;){for(var B=M[L][0],N=M[L][1],U=B-k,j=N-z,V=Math.sqrt(U*U+j*j),O=V,X=0;O>=C;){X+=C;var Y=X/V,H=k+U*Y,q=z+j*Y,Z=H-D,J=q-E,Q=w*Z-b*J+D,K=b*Z+w*J+E,$=p([D,E],[Q,K],[H,q]),tt=g([D,E],[Q,K]),et=g([H,q],[Q,K]),it=p([D,E],tt,$),rt=p([H,q],et,$);I.push(it),I.push($),I.push(rt),I.push([H,q]),D=H,E=q,O-=C,C=R}C-=O,k=B,z=N}I.push(M[M.length-1]);for(var at=[],L=0;L<I.length;L++){var T=I[L],nt=t.point(T);at.push(nt)}W.push(at)}e=W}var ot=[];if("outset"==s||"inset"==s){var y=Math.PI/3;"inset"==s&&(y=-y);for(var w=Math.cos(y),b=Math.sin(y),R=10,G=0;G<e.length;G++){for(var S=e[G],M=[],L=0;L<S.length;L++){var T=S[L],F=t.screenPoint(T);M.push(F)}for(var T=M[0],k=T[0],z=T[1],L=0,D=k,E=z,C=R;++L<M.length;){for(var B=M[L][0],N=M[L][1],U=B-k,j=N-z,V=Math.sqrt(U*U+j*j),O=V,X=0;O>=C;){X+=C;var Y=X/V,H=k+U*Y,q=z+j*Y,Z=H-D,J=q-E,Q=w*Z-b*J+D,K=b*Z+w*J+E,$=g([D,E],[H,q]),st=t.point($),lt=t.point([Q,K]);ot.push(st),ot.push(lt),D=H,E=q,O-=C,C=R}C-=O,k=B,z=N}}}if(a){i||(i=1);var ht=this.getColor(a),ft=t.colorShader;x.list||(x.list=[]);var X=x.list,ct=X.length?X[X.length-1]:null;if(!(i<=1)||r&&r.length)for(var G=0;G<e.length;G++){for(var S=e[G],ut=[],L=0;L<S.length;L++){
var T=S[L],dt=t.screenPoint([T[0],T[1]]);ut.push([dt[0],dt[1],L])}for(var vt=new A(r),gt=c(ut,.5*i,vt),pt=[],L=0;L<gt.length;L++){var _t=gt[L],mt=_t[2],xt=S[mt],At=ut[mt];pt.push([xt[0],xt[1],_t[0]-At[0],-_t[1]+At[1]])}ct&&ct.shader==ft&&"triangleStrip"==ct.method||(ct={shader:ft,method:"triangleStrip",vertices:[],elements:[]},X.push(ct));var _t=ct.vertices,S=e[G];ct.elements.push({index:_t.length/9,num:pt.length});for(var L=0;L<pt.length;L++){var T=pt[L];_t.push(T[0]),_t.push(T[1]),_t.push(ht[0]),_t.push(ht[1]),_t.push(ht[2]),_t.push(ht[3]),_t.push(0),_t.push(T[2]),_t.push(T[3])}}else{ct&&ct.shader==ft&&"lineStrip"==ct.method||(ct={shader:ft,method:"lineStrip",vertices:[],elements:[]},X.push(ct));for(var _t=ct.vertices,G=0;G<e.length;G++){var S=e[G];ct.elements.push({index:_t.length/9,num:S.length});for(var L=0;L<S.length;L++){var T=S[L];_t.push(T[0]),_t.push(T[1]),_t.push(ht[0]),_t.push(ht[1]),_t.push(ht[2]),_t.push(ht[3]),_t.push(0),_t.push(0),_t.push(0)}}}if(ot.length){var pt=ot[G];ct&&ct.shader==ft&&"lines"==ct.method||(ct={shader:ft,method:"lines",vertices:[],elements:[]},X.push(ct));var _t=ct.vertices,S=e[G];ct.elements.push({index:_t.length/9,num:ot.length});for(var G=0;G<ot.length;G++){var T=ot[G];_t.push(T[0]),_t.push(T[1]),_t.push(ht[0]),_t.push(ht[1]),_t.push(ht[2]),_t.push(ht[3]),_t.push(0),_t.push(0),_t.push(0)}}}if(l){var Q=0,K=0;l=parseInt(l);var Y=(16711680&l)>>16,Pt=(65280&l)>>8,yt=255&l;if(n||o){this.hitctx.fillStyle="rgb("+Y+","+Pt+","+yt+")",this.hitctx.beginPath();for(var L=0;L<e.length;L++)for(var S=e[L],M=WRAP.Geo.getScreenLine(S),wt=0;wt<M.length;wt++){var V=M[wt];if(V.length){var G=0,k=V[G].x+Q,z=V[G].y+K;for(this.hitctx.moveTo(k,z);++G<V.length;)k=V[G].x+Q,z=V[G].y+K,this.hitctx.lineTo(k,z)}}this.hitctx.fill("evenodd")}var bt=i||0;this.hitctx.lineWidth=bt+4,this.hitctx.strokeStyle="rgb("+Y+","+Pt+","+yt+")";for(var L=0;L<e.length;L++)for(var S=e[L],M=WRAP.Geo.getScreenLine(S),wt=0;wt<M.length;wt++){var V=M[wt];if(V.length){this.hitctx.beginPath();var G=0,k=V[G].x+Q,z=V[G].y+K;for(this.hitctx.moveTo(k,z);++G<V.length;){var k=V[G].x+Q,z=V[G].y+K;this.hitctx.lineTo(k,z)}(n||o||V[0].x==V[V.length-1].x&&V[0].y==V[V.length-1].y)&&this.hitctx.closePath(),this.hitctx.lineJoin="round",this.hitctx.stroke()}}}if(o){var ft=t.textureShader;x.list||(x.list=[]);var X=x.list,ct=X.length?X[X.length-1]:null;ct&&ct.shader==ft&&"triangles"==ct.method||(ct={shader:ft,method:"triangles",vertices:[],elements:[]},X.push(ct));for(var Rt=[],_t=ct.vertices,G=0;G<e.length;G++){for(var S=e[G],Wt=new Float32Array(2*S.length),L=0;L<S.length;L++)Wt[2*L]=S[L][0],Wt[2*L+1]=S[L][1];Rt.push(Wt)}var Gt=_.tessellate(Rt);if(Gt&&Gt.triangles.length){ct.elements.push({texture:o.id,index:_t.length/11,num:Gt.triangles.length});for(var L=0;L<Gt.triangles.length;L++){var mt=2*Gt.triangles[L],k=Gt.vertices[mt],z=Gt.vertices[mt+1],F=t.screenPoint([k,z]);_t.push(k),_t.push(z),_t.push(0),_t.push(0),_t.push(F[0]/o.width),_t.push(F[1]/o.height),_t.push(1),_t.push(1),_t.push(1),_t.push(1),_t.push(0)}}}else if(n){var ht=this.getColor(n),ft=t.colorShader;x.list||(x.list=[]);var X=x.list,ct=X.length?X[X.length-1]:null;ct&&ct.shader==ft&&"triangles"==ct.method||(ct={shader:ft,method:"triangles",vertices:[],elements:[]},X.push(ct));for(var Rt=[],_t=ct.vertices,G=0;G<e.length;G++){for(var S=e[G],Wt=new Float32Array(2*S.length),L=0;L<S.length;L++)Wt[2*L]=S[L][0],Wt[2*L+1]=S[L][1];Rt.push(Wt)}var Gt=_.tessellate(Rt);if(Gt&&Gt.triangles.length){ct.elements.push({index:_t.length/9,num:Gt.triangles.length});for(var L=0;L<Gt.triangles.length;L++){var mt=2*Gt.triangles[L];_t.push(Gt.vertices[mt]),_t.push(Gt.vertices[mt+1]),_t.push(ht[0]),_t.push(ht[1]),_t.push(ht[2]),_t.push(ht[3]),_t.push(0),_t.push(0),_t.push(0)}}}}}},_fragmentPath:function(t){for(var e=[],i=0;i<t.length;i++){var r=t[i][1],a=t[i][0];if(i>0){var n=t[i-1][1],o=t[i-1][0],s=a-o;s<-180?(s+=360,a+=360):s>=180&&(s-=360,o+=360);var l=Math.abs(s);if(l>1){var h=new WRAP.Geo.GreatCircle(n,o,r,a),f=n,c=o;e.push([c,f]);for(var u=0;u+1<l;){u+=1;var d=u/l,v=h.getPosition(d);e.push([v.lon,v.lat]),f=v.lat,c=v.lon}}else e.push([o,n])}e.push([a,r])}return e},_normalizePath:function(t){for(var e=[],i=0;i<t.length;i++){var r=t[i][1],a=t[i][0];if(i>0){var n=t[i-1][1],o=t[i-1][0],s=a-o;s<-180?(s+=360,a+=360):s>=180&&(s-=360,o+=360);var l=Math.abs(s);if(0==l)e.push([o,n]);else{(o<-180||a<-180)&&(o+=360,a+=360);var h=(r-n)/(a-o);if(o<180&&180<a){var l=180-o,f=n+l*h;e.push([o,n]),e.push([180,f]),e.push([180,f])}else e.push([o,n])}}e.push([a,r])}return e},_normalizeLon:function(t){var e,i,r,a,n=[];if(t&&t.length>0){var o=t[0][1],s=t[0][0];e=i=o,a=r=s;var l=[s,o];n.push(l);for(var h=1;h<t.length;h++){var f=t[h][1],c=t[h][0],u=c-s;u<-180?c+=360:u>=180&&(c-=360),e<f&&(e=f),i>f&&(i=f),r>c&&(r=c),a<c&&(a=c);var l=[c,f];n.push(l),o=f,s=c}}if(r<-180){r+=360,a+=360;for(var h=0;h<n.length;h++)n[h][0]+=360}return n},_addFragments:function(t,e){e=this._normalizeLon(e),t.push(e);for(var i=9999,r=-9999,a=0;a<e.length;a++){var n=e[a][0];i>n&&(i=n),r<n&&(r=n)}if(i<-180){for(var o=[],a=0;a<e.length;a++){var s=[e[a][0]+360,e[a][1]];o.push(s)}t.push(o)}if(r>180){for(var o=[],a=0;a<e.length;a++){var s=[e[a][0]-360,e[a][1]];o.push(s)}t.push(o)}},_gcPos:function(t,e,i,r){function a(t){return t*Math.PI*h}function n(t){return t*l*c}var o,s=r,l=10800,h=9259259e-11,f=Math.PI/2,c=1/Math.PI,u=60*t,d=60*e,v=180-i,g=i/180*Math.PI,p=Math.cos(g),_=a(s),m=(.5-u*h)*Math.PI,x=Math.cos(_),A=Math.cos(m),P=Math.sin(_),y=Math.sin(m),w=x*A+P*y*p;o=w>1?0:w<-1?Math.PI:Math.acos(w);var b=f-o;b=n(b);var R,W=Math.sin(o),G=(x*y-P*A*p)/W;R=G>1?0:G<-1?Math.PI:Math.acos(G);var S;return S=v>0?a(d)+R:a(d)-R,S=n(S),S>l?S=2*-l+S:S<-l&&(S=2*l+S),{lat:b/60,lon:S/60}},drawPath:function(t,e,i,r,a,n,o,s,l){var h=this.layer;if(h){this.setLayer();var f=h._dc;if(f&&!f.cached){var c={};if(n){var u=n;if(WRAP.Geo.imageError[u])return;var c=WRAP.Geo.imageCache[u];if(void 0==c)return c=WRAP.Geo.imageCache[u]={loaded:!1,image:new Image,url:u},c.image.onload=function(){c.loaded=!0,h._dc={},WRAP.Geo.invalidate()},c.image.onerror=function(){WRAP.Geo.imageError[c.url]=!0,WRAP.Geo.updateLayerStatus()},void(c.image.src=u)}if(!n||c.loaded){var d,v=WRAP.Geo.WebGL;c.image&&(d=v.getTexture(c.image));var g=[];if(Array.isArray(t[0][0])){for(var p=0;p<t.length;p++)if(!(t[p].length<2)){var _=t[p];_=s?this._fragmentPath(t[p]):this._normalizePath(t[p]),this._addFragments(g,_)}if(!g.length)return}else{if(t.length<2)return;var _=t;_=s?this._fragmentPath(t):this._normalizePath(t),this._addFragments(g,_)}this._drawLines(this.projection,g,e,i,r,a,d,o,l)}}}},drawArc:function(t,e,i,r,a,n,o,s,l){var h=this.layer;if(h){this.setLayer();var f=h._dc;if(f&&!f.cached){var c={};if(s){var u=s;if(WRAP.Geo.imageError[u])return;var c=WRAP.Geo.imageCache[u];if(void 0==c)return c=WRAP.Geo.imageCache[u]={loaded:!1,image:new Image,url:u},c.image.onload=function(){c.loaded=!0,h._dc={},WRAP.Geo.invalidate()},c.image.onerror=function(){WRAP.Geo.imageError[c.url]=!0,WRAP.Geo.updateLayerStatus()},void(c.image.src=u)}if(!s||c.loaded){var d,v=WRAP.Geo.WebGL;c.image&&(d=v.getTexture(c.image));var g=[];(i==r||Math.abs(r-i)>360)&&(i=0,r=360);var p=1;e<5e5?p=5:e<1e5&&(p=2),e/=1851.8518518518517;for(var _=i;_<r;_+=p){var m=this._gcPos(t[1],t[0],_,e);g.push([m.lon,m.lat])}var m=this._gcPos(t[1],t[0],r,e);g.push([m.lon,m.lat]);var x=[];if(g.length<2)return;var A=this._fragmentPath(g);this._addFragments(x,A),this._drawLines(this.projection,x,a,null,n,o,d,null,l)}}}},drawPoint:function(t,e,i,r,a){var n=this.layer;if(n){this.setLayer();var o=n._dc;if(o&&!o.cached){var s=this.projection.pointShader;o.list||(o.list=[]);var l=o.list,h=l.length?l[l.length-1]:null;h&&h.shader==s&&"points"==h.method||(h={shader:s,method:"points",vertices:[],elements:[{index:0,num:0}]},l.push(h));var f=h.elements[0],c=t[0],u=t[1];c>=180&&(c-=360),c<-180&&(c+=360);var d=h.vertices;if(r){void 0===i&&(i=1);var v=this.getColor(r);d.push(c),d.push(u),d.push(v[0]),d.push(v[1]),d.push(v[2]),d.push(v[3]),d.push(e+i),f.num++}if(a){var v=this.getColor(a);d.push(c),d.push(u),d.push(v[0]),d.push(v[1]),d.push(v[2]),d.push(v[3]),d.push(e-1),f.num++}}}},drawLine:function(t,e,i,r,a,n,o,s,l,h){function f(t,e,i,r){if(!(i.length<2)){for(var a,n,o=[],s=0;s<i.length;s++){var h=i[s][0],f=i[s][1];if(l){var c=h*_-f*m,u=h*m+f*_;h=c,f=u}h+=x[0],f+=x[1],0==s?a=n=h:(a>h&&(a=h),n<h&&(n=h));var d=t.point([h,f]);o.push(d)}if(e.push(o),r){for(var v=[],s=0;s<o.length;s++)v.push([o[s][0]+r,o[s][1]]);e.push(v);for(var v=[],s=0;s<o.length;s++)v.push([o[s][0]-r,o[s][1]]);e.push(v)}}}var c=this.layer;if(c){this.setLayer();var u=c._dc;if(u&&!u.cached){var d={};if(o){var v=o;if(WRAP.Geo.imageError[v])return;var d=WRAP.Geo.imageCache[v];if(void 0==d)return d=WRAP.Geo.imageCache[v]={loaded:!1,image:new Image,url:v},d.image.onload=function(){d.loaded=!0,c._dc={},WRAP.Geo.invalidate()},d.image.onerror=function(){WRAP.Geo.imageError[d.url]=!0,WRAP.Geo.updateLayerStatus()},void(d.image.src=v)}if(!o||d.loaded){var g,p=WRAP.Geo.WebGL;d.image&&(g=p.getTexture(d.image));var _,m,x=this.projection.screenPoint(t);l&&(_=Math.cos(Math.PI*l/180),m=Math.sin(Math.PI*l/180));var A=[],P=this.projection.round_wrap&&this.canvas_band?360:0;if(Array.isArray(e[0][0]))for(var y=0;y<e.length;y++)f(this.projection,A,e[y],P);else f(this.projection,A,e,P);if(!A.length)return;this._drawLines(this.projection,A,i,r,a,n,g,s,h)}}}},drawText:function(t,e,i,r,a,n,o,s,l){var h=this.layer;if(h){this.setLayer();var f=h._dc;if(f&&!f.cached){var c=WRAP.Geo.WebGL,u=parseFloat(n)||0,d=parseFloat(o)||0;d-=i;for(var v=0,g=[],p=0;p<e.length;p++){var _=e.charAt(p),m=c.getFontTexture(_,i,r,a);v+=m.content_width,g.push(m)}"left"==s?u+=0:u-="right"==s?v:.5*v,u-=2;var x=this.projection.textureShader;f.list||(f.list=[]);var A=f.list,P=A.length?A[A.length-1]:null;P&&P.shader==x&&"triangleStrip"==P.method||(P={shader:x,method:"triangleStrip",vertices:[],elements:[]},A.push(P)),l||(l=0),l=Math.PI*l/180;for(var y=0,p=0;p<g.length;p++){var m=g[p],w=m.vertices(m.width,m.height),b=P.vertices;P.elements.push({texture:m.id,index:b.length/11,num:w.length});for(var R=t[0],W=t[1],G=0;G<w.length;G++){var S=w[G];b.push(R),b.push(W),b.push(S[0]+u+y),b.push(S[1]-d),b.push(S[2]),b.push(S[3]),b.push(1),b.push(1),b.push(1),b.push(1),b.push(l)}y+=m.content_width}if("EQR"==this.projection.name){for(var y=0,p=0;p<g.length;p++){var m=g[p],w=m.vertices(m.width,m.height),b=P.vertices;P.elements.push({texture:m.id,index:b.length/11,num:w.length});for(var R=t[0],W=t[1],G=0;G<w.length;G++){var S=w[G];b.push(R+360),b.push(W),b.push(S[0]+u+y),b.push(S[1]-d),b.push(S[2]),b.push(S[3]),b.push(1),b.push(1),b.push(1),b.push(1),b.push(l)}y+=m.content_width}for(var y=0,p=0;p<g.length;p++){var m=g[p],w=m.vertices(m.width,m.height),b=P.vertices;P.elements.push({texture:m.id,index:b.length/11,num:w.length});for(var R=t[0],W=t[1],G=0;G<w.length;G++){var S=w[G];b.push(R-360),b.push(W),b.push(S[0]+u+y),b.push(S[1]-d),b.push(S[2]),b.push(S[3]),b.push(1),b.push(1),b.push(1),b.push(1),b.push(l)}y+=m.content_width}}}}},drawTile:function(t,e){var i=this.layer;if(i){this.setLayer();var r=i._dc;if(r&&!r.cached){for(var a=null,n=WRAP.Geo.WebGL,o=[],s=16,l=0;l<s;l++){o.push([0,l/s]);for(var h=0;h<s;h++)o.push([h/s,l/s]),o.push([h/s,(l+1)/s]);o.push([h/s,l/s]),o.push([h/s,(l+1)/s]),o.push([h/s,(l+1)/s])}var h=t.bounds.west/60,l=t.bounds.south/60,f=t.bounds.east/60-h,c=t.bounds.north/60-l,n=WRAP.Geo.WebGL,u=n.getTileTexture(e),d=this.projection.tileShader;r.list||(r.list=[]);var v=r.list,g=v.length?v[v.length-1]:null;g&&g.shader==d&&"triangleStrip"==g.method||(g={shader:d,method:"triangleStrip",vertices:[],elements:[]},v.push(g));var p=g.vertices;g.elements.push({texture:u.id,index:p.length/5,num:o.length});for(var _=0;_<o.length;_++){var m=o[_],x=m[2];p.push(h+m[0]*f),p.push(l+m[1]*c),p.push(x),p.push(m[0]),p.push(1-m[1])}if(a){var A=this.getColor(a),d=this.projection.colorShader;r.list||(r.list=[]);var v=r.list,g=v.length?v[v.length-1]:null;g&&g.shader==d&&"lineStrip"==g.method||(g={shader:d,method:"lineStrip",vertices:[],elements:[]},v.push(g));var p=g.vertices;g.elements.push({index:p.length/9,num:o.length});for(var _=0;_<o.length;_++){var m=o[_];p.push(h+m[0]*f),p.push(l+m[1]*c),p.push(A[0]),p.push(A[1]),p.push(A[2]),p.push(A[3]),p.push(0),p.push(0),p.push(0)}}}}},begin:function(t){this.layers=[],this.hitcvs||(this.hitcvs=document.createElement("canvas"),this.hitctx_base=this.hitcvs.getContext("2d")),this.hitctx=this.hitctx_base;var e=WRAP.Geo.getSize();if(this.hitcvs.width==e.width&&this.hitcvs.width==e.width||(this.hitcvs.width=e.width,this.hitcvs.height=e.height),this.hitctx.anchor=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(0,0)),this.hitctx.clearRect(0,0,e.width,e.height),this.ctx){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);for(var i=0;i<this.tiles.length;i++){var r=this.tiles[i];r.revision!=t&&(r.valid=!1)}}},setLayer:function(){this.layers.length&&this.layers[this.layers.length-1]==this.layer||this.layers.push(this.layer)},getColor:function(t){this.color_cache||(this.color_cache={});var e=this.color_cache[t];if(!e){var i=WRAP.Geo.parseColor(t);e=[],e[0]=parseFloat(i[0])/255,e[1]=parseFloat(i[1])/255,e[2]=parseFloat(i[2])/255,e[3]=parseFloat(i[3])/255,this.color_cache[t]=e}return e}},EQR:function(t){this.name="EQR",this.round_wrap=!0;var e=WRAP.Geo.WebGL.Projection.Common,i=this;this.setSize=function(t,e){this.width=t,this.height=e},this.setZoom=function(t){t<2&&(t=2),t>8&&(t=8),this.zoom=t,this.ppd=256*Math.pow(2,t)/360,this.dpp=1/this.ppd},this.setCenter=function(t){this.center=t},this.point=function(t){return[this.center.lon+t[0]*this.dpp,this.center.lat-t[1]*this.dpp]},this.screenPoint=function(t){return[(t[0]-this.center.lon)*this.ppd,(this.center.lat-t[1])*this.ppd]},this.screenRotation=function(t,e){return t=null,e},this.Context=function(t,i){this.projection=t,this.revision=0,this.tiles=[],this.setTileBand=e.setTileBand,this.lockTile=e.lockTile,this.clearLockedTile=e.clearLockedTile,this.findTile=e.findTile,this.addTile=e.addTile,this.tile=e.tile,this.drawImageData=e.drawImageData,this.drawImage=e.drawImage,this.hit=e.hit,this._drawLines=e._drawLines,this._addFragments=e._addFragments,this._fragmentPath=e._fragmentPath,this._normalizePath=e._normalizePath,this._normalizeLon=e._normalizeLon,this._gcPos=e._gcPos,this.drawPath=e.drawPath,this.drawArc=e.drawArc,this.drawPoint=e.drawPoint,this.drawLine=e.drawLine,this.drawText=e.drawText,this.drawTile=e.drawTile,this.begin=e.begin,this.setLayer=e.setLayer,this.end=function(){var e=WRAP.Geo.WebGL;i.clearColor(.8,.8,.9,1),i.clear(i.COLOR_BUFFER_BIT),i.enable(i.BLEND),i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA);for(var r=t.ppd,a=360*r,n=t.width,o=t.height,s=n/2,l=o/2,h=l+(90-t.center.lat)*r,f=l-(t.center.lat+90)*r,c=s-(t.center.lon+180)*r,u=s+(180-t.center.lon)*r,d=[0],v=0;0<c+v;)v-=a,d.push(v);for(v=0;u+v<n;)v+=a,d.push(v);h>o&&(h=o),f<0&&(f=0);for(var g=h-f,p=c,_=u,m=0;m<d.length;m++){v=d[m],c=p+v,u=_+v,c<0&&(c=0),u>n&&(u=n);var x=u-c,A=e.orthogonalMatrix(-x/2,x/2,-g/2,g/2,-100,100),P=(n-x)/2,y=(o-g)/2;A[3]=(-c+v+P)/(x/2),A[7]=(-f+y)/(g/2),i.viewport(c,f,x,g);for(var w=0;w<this.layers.length;w++){var b=this.layers[w];if(b._dc&&b._dc.list){for(var R=b._dc.list,W=0;W<R.length;W++){var G=R[W];G.vbo||(G.vbo=G.shader.createBuffer(),G.shader.set(G.vbo,G.vertices),G.vertices=null),G.shader[G.method](A,G.vbo,G.elements)}b._dc.cached=!0}}}i.flush();var S=document.getElementById("check_canvas");if(S&&"none"!=S.style.display){S.width==i.canvas.clientWidth&&S.height==i.canvas.clientHeight||(S.width=i.canvas.clientWidth,S.height=i.canvas.clientHeight);var M=S.getContext("2d");M.clearRect(0,0,this.hitcvs.width,this.hitcvs.height),M.drawImage(this.hitcvs,0,0,this.hitcvs.width,this.hitcvs.height),M.strokeStyle="red";var L=10,T=S.width-10,F=10,I=S.height-10;M.moveTo(L,F),M.lineTo(T,F),M.lineTo(T,I),M.lineTo(L,I),M.lineTo(L,F),M.stroke()}},this.getColor=e.getColor,this.rev=0},this.ColorShader=function(){var e=WRAP.Geo.WebGL;this.pg=e.setup(t,"attribute vec4 position;attribute vec2 offset;attribute vec4 color;uniform float scale;uniform float center_lat;uniform float center_lon;uniform mat4 projection;varying vec4 v_color;void main(){    float y = (position.y-center_lat)*scale;    float x = (position.x-center_lon)*scale;    vec4 p = vec4(x+offset.x, y+offset.y, 0.0, 1.0);    gl_Position = p * projection;    v_color = color;}","precision mediump float;\nvarying vec4 v_color;void main(){    gl_FragColor = v_color;}"),t.useProgram(this.pg);var r=t.getAttribLocation(this.pg,"offset"),a=t.getAttribLocation(this.pg,"position"),n=t.getAttribLocation(this.pg,"color"),o=t.getUniformLocation(this.pg,"projection"),s=t.getUniformLocation(this.pg,"center_lat"),l=t.getUniformLocation(this.pg,"center_lon"),h=t.getUniformLocation(this.pg,"scale");this.createBuffer=function(){return t.createBuffer()},this.deleteBuffer=function(e){t.deleteBuffer(e)},this.set=function(e,i){t.bindBuffer(t.ARRAY_BUFFER,e),t.bufferData(t.ARRAY_BUFFER,new Float32Array(i),t.DYNAMIC_DRAW)},this.draw=function(e,f,c,u){t.useProgram(this.pg),t.uniformMatrix4fv(o,!1,f),t.uniform1f(s,i.center.lat),t.uniform1f(l,i.center.lon),t.uniform1f(h,i.ppd);var d=4;t.bindBuffer(t.ARRAY_BUFFER,c),t.vertexAttribPointer(a,2,t.FLOAT,!1,9*d,0),t.enableVertexAttribArray(a),t.vertexAttribPointer(n,4,t.FLOAT,!1,9*d,2*d),t.enableVertexAttribArray(n),t.vertexAttribPointer(r,2,t.FLOAT,!1,9*d,7*d),t.enableVertexAttribArray(r);for(var v=0;v<u.length;v++){var g=u[v];t.drawArrays(e,g.index,g.num)}t.disableVertexAttribArray(a),t.disableVertexAttribArray(r),t.disableVertexAttribArray(n)},this.triangleStrip=function(e,i,r){this.draw(t.TRIANGLE_STRIP,e,i,r)},this.triangles=function(e,i,r){this.draw(t.TRIANGLES,e,i,r)},this.lineStrip=function(e,i,r){this.draw(t.LINE_STRIP,e,i,r)},this.lines=function(e,i,r){this.draw(t.LINES,e,i,r)}},this.TextureShader=function(){var e=WRAP.Geo.WebGL;this.pg=e.setup(t,"attribute vec4 position;attribute vec2 coordinate;attribute vec2 offset;attribute vec4 color;attribute float rotation;uniform float scale;uniform float center_lat;uniform float center_lon;uniform mat4 projection;varying vec4 v_color;varying vec2 v_coordinate;void main(){    float cosr = cos(-rotation);    float sinr = sin(-rotation);    float ox = offset.x*cosr - offset.y*sinr;    float oy = offset.x*sinr + offset.y*cosr;    float y = (position.y-center_lat)*scale+oy;    float x = (position.x-center_lon)*scale+ox;    vec4 p = vec4(x, y, 0.0, 1.0);    gl_Position = p * projection;    v_color = color;    v_coordinate = coordinate;}","precision mediump float;\nuniform sampler2D texture;varying vec4 v_color;varying vec2 v_coordinate;void main(){    vec4 color = texture2D(texture, v_coordinate);    gl_FragColor = v_color * color;}"),t.useProgram(this.pg);var r=t.getAttribLocation(this.pg,"coordinate"),a=t.getAttribLocation(this.pg,"offset"),n=t.getAttribLocation(this.pg,"position"),o=t.getAttribLocation(this.pg,"color"),s=t.getAttribLocation(this.pg,"rotation"),l=t.getUniformLocation(this.pg,"projection"),h=t.getUniformLocation(this.pg,"center_lat"),f=t.getUniformLocation(this.pg,"center_lon"),c=t.getUniformLocation(this.pg,"scale"),u=t.getUniformLocation(this.pg,"texture");this.createBuffer=function(){return t.createBuffer()},this.deleteBuffer=function(e){t.deleteBuffer(e)},this.set=function(e,i){t.bindBuffer(t.ARRAY_BUFFER,e),t.bufferData(t.ARRAY_BUFFER,new Float32Array(i),t.DYNAMIC_DRAW)},this.draw=function(e,d,v,g){t.useProgram(this.pg),t.uniformMatrix4fv(l,!1,d),t.uniform1f(h,i.center.lat),t.uniform1f(f,i.center.lon),t.uniform1f(c,i.ppd),t.uniform1i(u,0);var p=4;t.bindBuffer(t.ARRAY_BUFFER,v),t.vertexAttribPointer(n,2,t.FLOAT,!1,11*p,0),t.enableVertexAttribArray(n),t.vertexAttribPointer(a,2,t.FLOAT,!1,11*p,2*p),t.enableVertexAttribArray(a),t.vertexAttribPointer(r,2,t.FLOAT,!1,11*p,4*p),t.enableVertexAttribArray(r),t.vertexAttribPointer(o,4,t.FLOAT,!1,11*p,6*p),t.enableVertexAttribArray(o),t.vertexAttribPointer(s,1,t.FLOAT,!1,11*p,10*p),t.enableVertexAttribArray(s);for(var _=0;_<g.length;_++){var m=g[_];m.texture&&(t.bindTexture(t.TEXTURE_2D,m.texture),t.drawArrays(e,m.index,m.num))}t.bindTexture(t.TEXTURE_2D,null),t.disableVertexAttribArray(n),t.disableVertexAttribArray(a),t.disableVertexAttribArray(r),t.disableVertexAttribArray(o),t.disableVertexAttribArray(s)},this.triangleStrip=function(e,i,r){this.draw(t.TRIANGLE_STRIP,e,i,r)},this.triangles=function(e,i,r){this.draw(t.TRIANGLES,e,i,r)}},this.TileShader=function(){var e=WRAP.Geo.WebGL;this.pg=e.setup(t,"attribute vec4 position;attribute vec2 coordinate;uniform float scale;uniform float z_scale;uniform float center_lat;uniform float center_lon;uniform mat4 projection;varying vec2 v_coordinate;varying vec4 v_color;void main(){    float lon_d = position.x-center_lon;    float lat_d = position.y-center_lat;    float a = 1.0;    float y = lat_d*scale;    float x = lon_d*scale;    float z = 0.0;    vec4 p = vec4(x, y, z, 1.0);    gl_Position = p * projection;    v_color = vec4(1.0,1.0,1.0,a);    v_coordinate = coordinate;}","precision mediump float;\nuniform sampler2D texture;varying vec2 v_coordinate;varying vec4 v_color;void main(){    vec4 color = texture2D(texture, v_coordinate);    gl_FragColor = v_color * color;}"),t.useProgram(this.pg);var r=t.getAttribLocation(this.pg,"coordinate"),a=t.getAttribLocation(this.pg,"position"),n=t.getUniformLocation(this.pg,"projection"),o=t.getUniformLocation(this.pg,"center_lat"),s=t.getUniformLocation(this.pg,"center_lon"),l=t.getUniformLocation(this.pg,"scale"),h=t.getUniformLocation(this.pg,"z_scale"),f=t.getUniformLocation(this.pg,"texture");this.createBuffer=function(){return t.createBuffer()},this.deleteBuffer=function(e){t.deleteBuffer(e)},this.set=function(e,i){t.bindBuffer(t.ARRAY_BUFFER,e),t.bufferData(t.ARRAY_BUFFER,new Float32Array(i),t.DYNAMIC_DRAW)},this.draw=function(e,c,u,d){t.useProgram(this.pg),t.uniformMatrix4fv(n,!1,c),t.uniform1f(o,i.center.lat),t.uniform1f(s,i.center.lon),t.uniform1f(l,i.ppd),t.uniform1f(h,0),t.uniform1i(f,0);var v=4,g=5*v;t.bindBuffer(t.ARRAY_BUFFER,u),t.vertexAttribPointer(a,3,t.FLOAT,!1,g,0),t.enableVertexAttribArray(a),t.vertexAttribPointer(r,2,t.FLOAT,!1,g,3*v),t.enableVertexAttribArray(r);for(var p=0;p<d.length;p++){var _=d[p];_.texture&&(t.bindTexture(t.TEXTURE_2D,_.texture),t.drawArrays(e,_.index,_.num))}t.bindTexture(t.TEXTURE_2D,null),t.disableVertexAttribArray(a),t.disableVertexAttribArray(r)},this.triangleStrip=function(e,i,r){this.draw(t.TRIANGLE_STRIP,e,i,r)},this.triangles=function(e,i,r){this.draw(t.TRIANGLES,e,i,r)}},this.PointShader=function(){var e=WRAP.Geo.WebGL;this.pg=e.setup(t,"attribute vec4 position;attribute vec4 color;attribute float value;uniform float scale;uniform float center_lat;uniform float center_lon;uniform mat4 projection;varying vec4 v_color;void main(){    float y = (position.y-center_lat)*scale;    float x = (position.x-center_lon)*scale;    vec4 p = vec4(x, y, 0.0, 1.0);    gl_Position = p * projection;    gl_PointSize = value;    v_color = color;}","precision mediump float;\nvarying vec4 v_color;void main(){    float dist = distance(gl_PointCoord, vec2(0.5, 0.5));    if ( dist < 0.5 ) {        gl_FragColor = v_color;    } else {        discard;    }}"),t.useProgram(this.pg);var r=t.getAttribLocation(this.pg,"position"),a=t.getAttribLocation(this.pg,"color"),n=t.getAttribLocation(this.pg,"value"),o=t.getUniformLocation(this.pg,"projection"),s=t.getUniformLocation(this.pg,"center_lat"),l=t.getUniformLocation(this.pg,"center_lon"),h=t.getUniformLocation(this.pg,"scale");this.createBuffer=function(){return t.createBuffer()},this.deleteBuffer=function(e){t.deleteBuffer(e)},this.set=function(e,i){t.bindBuffer(t.ARRAY_BUFFER,e),t.bufferData(t.ARRAY_BUFFER,new Float32Array(i),t.DYNAMIC_DRAW)},this.draw=function(e,f,c,u){t.useProgram(this.pg),t.uniformMatrix4fv(o,!1,f),t.uniform1f(s,i.center.lat),t.uniform1f(l,i.center.lon),t.uniform1f(h,i.ppd);var d=4;t.bindBuffer(t.ARRAY_BUFFER,c),t.vertexAttribPointer(r,2,t.FLOAT,!1,7*d,0),t.enableVertexAttribArray(r),t.vertexAttribPointer(a,4,t.FLOAT,!1,7*d,2*d),t.enableVertexAttribArray(a),t.vertexAttribPointer(n,1,t.FLOAT,!1,7*d,6*d),t.enableVertexAttribArray(n);for(var v=0;v<u.length;v++){var g=u[v];t.drawArrays(e,g.index,g.num)}t.disableVertexAttribArray(r),t.disableVertexAttribArray(n),t.disableVertexAttribArray(a)},this.points=function(e,i,r){this.draw(t.POINTS,e,i,r)}},this.colorShader=new this.ColorShader,this.pointShader=new this.PointShader,this.textureShader=new this.TextureShader,this.tileShader=new this.TileShader},PolarStereographics:function(t,e,i){this.round_wrap=!1;var r=111319.49079327333;this.name="PolarStereographics";var a=WRAP.Geo.WebGL.Projection.Common,n=this,o={base_lon:i,lat_ts:e},s=new WRAP.Geo.Projection.PolarStereographics(o),l=s.akm1(),h=o.base_lon,f=o.lat_ts;this.orientation=e>=0?"North":"South",this.setSize=function(t,e){this.width=t,this.height=e},this.setZoom=function(t){t<2&&(t=2),t>8&&(t=8),this.zoom=t,this.ppd=256*Math.pow(2,t)/360,this.ppd/=r,this.dpp=1/this.ppd},this.setCenter=function(t){this.center=t},this.point=function(t){var e=t[0]*this.dpp,i=t[1]*this.dpp,r=s.forward([this.center.lon,this.center.lat]),a=r[1]-i,n=r[0]+e,o=s.inverse([n,a]);return[o[0],o[1]]},this.screenPoint=function(t){var e=s.forward([this.center.lon,this.center.lat]),i=s.forward([t[0],t[1]]),r=(-i[1]+e[1])*this.ppd,a=(i[0]-e[0])*this.ppd;return[a,r]},this.screenRotation=function(t,e){return s.rotation(t,e)},this.Context=function(t,e){this.projection=t,this.revision=0,this.tiles=[],this.setTileBand=a.setTileBand,this.lockTile=a.lockTile,this.clearLockedTile=a.clearLockedTile,this.findTile=a.findTile,this.addTile=a.addTile,this.tile=a.tile,this.drawImageData=a.drawImageData,this.drawImage=a.drawImage,this.hit=a.hit,this._drawLines=a._drawLines,this._addFragments=a._addFragments,this._fragmentPath=a._fragmentPath,this._normalizePath=a._normalizePath,this._normalizeLon=a._normalizeLon,this._gcPos=a._gcPos,this.drawPath=a.drawPath,this.drawArc=a.drawArc,this.drawPoint=a.drawPoint,this.drawLine=a.drawLine,this.drawText=a.drawText,this.drawTile=a.drawTile,this.begin=a.begin,this.setLayer=a.setLayer,this.end=function(){var i=WRAP.Geo.WebGL;e.clearColor(.8,.8,.9,1),e.clear(e.COLOR_BUFFER_BIT),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA);var r=t.width,a=t.height,n=i.orthogonalMatrix(-r/2,r/2,-a/2,a/2,-100,100);e.viewport(0,0,r,a);for(var o=0;o<this.layers.length;o++){var s=this.layers[o];if(s._dc&&s._dc.list){for(var l=s._dc.list,h=0;h<l.length;h++){var f=l[h];f.vbo||(f.vbo=f.shader.createBuffer(),f.shader.set(f.vbo,f.vertices),f.vertices=null),f.shader[f.method](n,f.vbo,f.elements)}s._dc.cached=!0}}e.flush()},this.getColor=a.getColor,this.rev=0},this.ColorShader=function(){var e=WRAP.Geo.WebGL;this.pg=e.setup(t,"attribute vec4 position;attribute vec2 offset;attribute vec4 color;uniform float scale;uniform float center_lat;uniform float center_lon;uniform mat4 projection;varying vec4 v_color;uniform float akm;uniform float base_lon;uniform float base_lat;const float PI = 3.14159265358979;const float HALFPI = 1.5707963267948966;const float e = 0.08181919084262149;const float SRS_WGS84_SEMIMAJOR = 6378137.0;float pj_tsfn(float phi, float sinphi) {    sinphi *= e;    return (tan(.5*(HALFPI-phi)) /            pow((1.-sinphi) / (1.+sinphi), .5*e));}vec2 forward(float lon, float lat) {    float lam = ((lon-base_lon)*PI)/180.0;    float phi = (lat*PI)/180.0;    float coslam = cos(lam);    float sinlam = sin(lam);    float sinphi = sin(phi);    if ( base_lat < 0.0  ) {        phi = -phi;        coslam = -coslam;        sinphi = -sinphi;    }    float x = akm * pj_tsfn(phi, sinphi);    float y = -x * coslam;    x = x * sinlam;    x *= SRS_WGS84_SEMIMAJOR;    y *= SRS_WGS84_SEMIMAJOR;    return vec2(x,y);}void main(){    vec2 c = forward(center_lon, center_lat);    vec2 t = forward(position.x, position.y);    float y = (t.y-c.y)*scale;    float x = (t.x-c.x)*scale;    vec4 p = vec4(x+offset.x, y+offset.y, 0.0, 1.0);    gl_Position = p * projection;    v_color = color;}","precision mediump float;\nvarying vec4 v_color;void main(){    gl_FragColor = v_color;}"),t.useProgram(this.pg);var i=t.getAttribLocation(this.pg,"offset"),r=t.getAttribLocation(this.pg,"position"),a=t.getAttribLocation(this.pg,"color"),o=t.getUniformLocation(this.pg,"projection"),s=t.getUniformLocation(this.pg,"center_lat"),c=t.getUniformLocation(this.pg,"center_lon"),u=t.getUniformLocation(this.pg,"scale"),d=t.getUniformLocation(this.pg,"akm"),v=t.getUniformLocation(this.pg,"base_lon"),g=t.getUniformLocation(this.pg,"base_lat");this.createBuffer=function(){return t.createBuffer()},this.deleteBuffer=function(e){t.deleteBuffer(e)},this.set=function(e,i){t.bindBuffer(t.ARRAY_BUFFER,e),t.bufferData(t.ARRAY_BUFFER,new Float32Array(i),t.DYNAMIC_DRAW)},this.draw=function(e,p,_,m){t.useProgram(this.pg),t.uniformMatrix4fv(o,!1,p),t.uniform1f(s,n.center.lat),t.uniform1f(c,n.center.lon),t.uniform1f(u,n.ppd),t.uniform1f(d,l),t.uniform1f(g,f),t.uniform1f(v,h);var x=4;t.bindBuffer(t.ARRAY_BUFFER,_),t.vertexAttribPointer(r,2,t.FLOAT,!1,9*x,0),t.enableVertexAttribArray(r),t.vertexAttribPointer(a,4,t.FLOAT,!1,9*x,2*x),t.enableVertexAttribArray(a),t.vertexAttribPointer(i,2,t.FLOAT,!1,9*x,7*x),t.enableVertexAttribArray(i);for(var A=0;A<m.length;A++){var P=m[A];t.drawArrays(e,P.index,P.num)}t.disableVertexAttribArray(r),t.disableVertexAttribArray(i),t.disableVertexAttribArray(a)},this.triangleStrip=function(e,i,r){this.draw(t.TRIANGLE_STRIP,e,i,r)},this.triangles=function(e,i,r){this.draw(t.TRIANGLES,e,i,r)},this.lineStrip=function(e,i,r){this.draw(t.LINE_STRIP,e,i,r)},this.lines=function(e,i,r){this.draw(t.LINES,e,i,r)}},this.TextureShader=function(){var e=WRAP.Geo.WebGL;this.pg=e.setup(t,"attribute vec4 position;attribute vec2 coordinate;attribute vec2 offset;attribute vec4 color;attribute float rotation;uniform float scale;uniform float center_lat;uniform float center_lon;uniform mat4 projection;varying vec4 v_color;varying vec2 v_coordinate;uniform float akm;uniform float base_lon;uniform float base_lat;const float PI = 3.14159265358979;const float HALFPI = 1.5707963267948966;const float e = 0.08181919084262149;const float SRS_WGS84_SEMIMAJOR = 6378137.0;float pj_tsfn(float phi, float sinphi) {    sinphi *= e;    return (tan(.5*(HALFPI-phi)) /            pow((1.-sinphi) / (1.+sinphi), .5*e));}vec2 forward(float lon, float lat) {    float lam = ((lon-base_lon)*PI)/180.0;    float phi = (lat*PI)/180.0;    float coslam = cos(lam);    float sinlam = sin(lam);    float sinphi = sin(phi);    if ( base_lat < 0.0  ) {        phi = -phi;        coslam = -coslam;        sinphi = -sinphi;    }    float x = akm * pj_tsfn(phi, sinphi);    float y = -x * coslam;    x = x * sinlam;    x *= SRS_WGS84_SEMIMAJOR;    y *= SRS_WGS84_SEMIMAJOR;    return vec2(x,y);}void main(){    float cosr = cos(-rotation);    float sinr = sin(-rotation);    float ox = offset.x*cosr - offset.y*sinr;    float oy = offset.x*sinr + offset.y*cosr;    vec2 c = forward(center_lon, center_lat);    vec2 t = forward(position.x, position.y);    float y = (t.y-c.y)*scale+oy;    float x = (t.x-c.x)*scale+ox;    vec4 p = vec4(x, y, 0.0, 1.0);    gl_Position = p * projection;    v_color = color;    v_coordinate = coordinate;}","precision mediump float;\nuniform sampler2D texture;varying vec4 v_color;varying vec2 v_coordinate;void main(){    vec4 color = texture2D(texture, v_coordinate);    gl_FragColor = v_color * color;}"),t.useProgram(this.pg);var i=t.getAttribLocation(this.pg,"coordinate"),r=t.getAttribLocation(this.pg,"offset"),a=t.getAttribLocation(this.pg,"position"),o=t.getAttribLocation(this.pg,"color"),s=t.getAttribLocation(this.pg,"rotation"),c=t.getUniformLocation(this.pg,"projection"),u=t.getUniformLocation(this.pg,"center_lat"),d=t.getUniformLocation(this.pg,"center_lon"),v=t.getUniformLocation(this.pg,"scale"),g=t.getUniformLocation(this.pg,"texture"),p=t.getUniformLocation(this.pg,"akm"),_=t.getUniformLocation(this.pg,"base_lon"),m=t.getUniformLocation(this.pg,"base_lat");
this.createBuffer=function(){return t.createBuffer()},this.deleteBuffer=function(e){t.deleteBuffer(e)},this.set=function(e,i){t.bindBuffer(t.ARRAY_BUFFER,e),t.bufferData(t.ARRAY_BUFFER,new Float32Array(i),t.DYNAMIC_DRAW)},this.draw=function(e,x,A,P){t.useProgram(this.pg),t.uniformMatrix4fv(c,!1,x),t.uniform1f(u,n.center.lat),t.uniform1f(d,n.center.lon),t.uniform1f(v,n.ppd),t.uniform1i(g,0),t.uniform1f(p,l),t.uniform1f(m,f),t.uniform1f(_,h);var y=4;t.bindBuffer(t.ARRAY_BUFFER,A),t.vertexAttribPointer(a,2,t.FLOAT,!1,11*y,0),t.enableVertexAttribArray(a),t.vertexAttribPointer(r,2,t.FLOAT,!1,11*y,2*y),t.enableVertexAttribArray(r),t.vertexAttribPointer(i,2,t.FLOAT,!1,11*y,4*y),t.enableVertexAttribArray(i),t.vertexAttribPointer(o,4,t.FLOAT,!1,11*y,6*y),t.enableVertexAttribArray(o),t.vertexAttribPointer(s,1,t.FLOAT,!1,11*y,10*y),t.enableVertexAttribArray(s);for(var w=0;w<P.length;w++){var b=P[w];b.texture&&(t.bindTexture(t.TEXTURE_2D,b.texture),t.drawArrays(e,b.index,b.num))}t.bindTexture(t.TEXTURE_2D,null),t.disableVertexAttribArray(a),t.disableVertexAttribArray(r),t.disableVertexAttribArray(i),t.disableVertexAttribArray(o),t.disableVertexAttribArray(s)},this.triangleStrip=function(e,i,r){this.draw(t.TRIANGLE_STRIP,e,i,r)},this.triangles=function(e,i,r){this.draw(t.TRIANGLES,e,i,r)}},this.TileShader=function(){var e=WRAP.Geo.WebGL;this.pg=e.setup(t,"attribute vec4 position;attribute vec2 coordinate;uniform float scale;uniform float center_lat;uniform float center_lon;uniform mat4 projection;varying vec2 v_coordinate;varying vec4 v_color;uniform float akm;uniform float base_lon;uniform float base_lat;const float PI = 3.14159265358979;const float HALFPI = 1.5707963267948966;const float e = 0.08181919084262149;const float SRS_WGS84_SEMIMAJOR = 6378137.0;float pj_tsfn(float phi, float sinphi) {    sinphi *= e;    return (tan(.5*(HALFPI-phi)) /            pow((1.-sinphi) / (1.+sinphi), .5*e));}vec2 forward(float lon, float lat) {    float lam = ((lon-base_lon)*PI)/180.0;    float phi = (lat*PI)/180.0;    float coslam = cos(lam);    float sinlam = sin(lam);    float sinphi = sin(phi);    if ( base_lat < 0.0  ) {        phi = -phi;        coslam = -coslam;        sinphi = -sinphi;    }    float x = akm * pj_tsfn(phi, sinphi);    float y = -x * coslam;    x = x * sinlam;    x *= SRS_WGS84_SEMIMAJOR;    y *= SRS_WGS84_SEMIMAJOR;    return vec2(x,y);}void main(){    float a = 1.0;    vec2 c = forward(center_lon, center_lat);    vec2 t = forward(position.x, position.y);    float y = (t.y-c.y)*scale;    float x = (t.x-c.x)*scale;    float z = 0.0;    vec4 p = vec4(x, y, z, 1.0);    gl_Position = p * projection;    v_color = vec4(1.0,1.0,1.0,1.0);    v_coordinate = coordinate;}","precision mediump float;\nuniform sampler2D texture;varying vec2 v_coordinate;varying vec4 v_color;void main(){    vec4 color = texture2D(texture, v_coordinate);    gl_FragColor = v_color * color;}"),t.useProgram(this.pg);var i=t.getAttribLocation(this.pg,"coordinate"),r=t.getAttribLocation(this.pg,"position"),a=t.getUniformLocation(this.pg,"projection"),o=t.getUniformLocation(this.pg,"center_lat"),s=t.getUniformLocation(this.pg,"center_lon"),c=t.getUniformLocation(this.pg,"scale"),u=t.getUniformLocation(this.pg,"texture"),d=t.getUniformLocation(this.pg,"akm"),v=t.getUniformLocation(this.pg,"base_lon"),g=t.getUniformLocation(this.pg,"base_lat");this.createBuffer=function(){return t.createBuffer()},this.deleteBuffer=function(e){t.deleteBuffer(e)},this.set=function(e,i){t.bindBuffer(t.ARRAY_BUFFER,e),t.bufferData(t.ARRAY_BUFFER,new Float32Array(i),t.DYNAMIC_DRAW)},this.draw=function(e,p,_,m){t.useProgram(this.pg),t.uniformMatrix4fv(a,!1,p),t.uniform1f(o,n.center.lat),t.uniform1f(s,n.center.lon),t.uniform1f(c,n.ppd),t.uniform1f(d,l),t.uniform1f(g,f),t.uniform1f(v,h),t.uniform1i(u,0);var x=4,A=5*x;t.bindBuffer(t.ARRAY_BUFFER,_),t.vertexAttribPointer(r,3,t.FLOAT,!1,A,0),t.enableVertexAttribArray(r),t.vertexAttribPointer(i,2,t.FLOAT,!1,A,3*x),t.enableVertexAttribArray(i);for(var P=0;P<m.length;P++){var y=m[P];y.texture&&(t.bindTexture(t.TEXTURE_2D,y.texture),t.drawArrays(e,y.index,y.num))}t.bindTexture(t.TEXTURE_2D,null),t.disableVertexAttribArray(r),t.disableVertexAttribArray(i)},this.triangleStrip=function(e,i,r){this.draw(t.TRIANGLE_STRIP,e,i,r)},this.triangles=function(e,i,r){this.draw(t.TRIANGLES,e,i,r)}},this.PointShader=function(){var e=WRAP.Geo.WebGL;this.pg=e.setup(t,"attribute vec4 position;attribute vec4 color;attribute float value;uniform float scale;uniform float center_lat;uniform float center_lon;uniform mat4 projection;varying vec4 v_color;uniform float akm;uniform float base_lon;uniform float base_lat;const float PI = 3.14159265358979;const float HALFPI = 1.5707963267948966;const float e = 0.08181919084262149;const float SRS_WGS84_SEMIMAJOR = 6378137.0;float pj_tsfn(float phi, float sinphi) {    sinphi *= e;    return (tan(.5*(HALFPI-phi)) /            pow((1.-sinphi) / (1.+sinphi), .5*e));}vec2 forward(float lon, float lat) {    if ( base_lat < 0.0  ) {        lat = -lat;        lon += 2.0*(180.0-base_lon);        if ( lon >= 180.0 )            lon -= 360.0;        lon = -lon;    }    float lam = ((lon-base_lon)*PI)/180.0;    float phi = (lat*PI)/180.0;    float coslam = cos(lam);    float sinlam = sin(lam);    float sinphi = sin(phi);    float x = akm * pj_tsfn(phi, sinphi);    float y = -x * coslam;    x = x * sinlam;    x *= SRS_WGS84_SEMIMAJOR;    y *= SRS_WGS84_SEMIMAJOR;    return vec2(x,y);}void main(){    vec2 c = forward(center_lon, center_lat);    vec2 t = forward(position.x, position.y);    float y = (t.y-c.y)*scale;    float x = (t.x-c.x)*scale;    vec4 p = vec4(x, y, 0.0, 1.0);    gl_Position = p * projection;    gl_PointSize = value;    v_color = color;}","precision mediump float;\nvarying vec4 v_color;void main(){    float dist = distance(gl_PointCoord, vec2(0.5, 0.5));    if ( dist < 0.5 ) {        gl_FragColor = v_color;    } else {        discard;    }}"),t.useProgram(this.pg);var i=t.getAttribLocation(this.pg,"position"),r=t.getAttribLocation(this.pg,"color"),a=t.getAttribLocation(this.pg,"value"),o=t.getUniformLocation(this.pg,"projection"),s=t.getUniformLocation(this.pg,"center_lat"),c=t.getUniformLocation(this.pg,"center_lon"),u=t.getUniformLocation(this.pg,"scale"),d=t.getUniformLocation(this.pg,"akm"),v=t.getUniformLocation(this.pg,"base_lon"),g=t.getUniformLocation(this.pg,"base_lat");this.createBuffer=function(){return t.createBuffer()},this.deleteBuffer=function(e){t.deleteBuffer(e)},this.set=function(e,i){t.bindBuffer(t.ARRAY_BUFFER,e),t.bufferData(t.ARRAY_BUFFER,new Float32Array(i),t.DYNAMIC_DRAW)},this.draw=function(e,p,_,m){t.useProgram(this.pg),t.uniformMatrix4fv(o,!1,p),t.uniform1f(s,n.center.lat),t.uniform1f(c,n.center.lon),t.uniform1f(u,n.ppd),t.uniform1f(d,l),t.uniform1f(g,f),t.uniform1f(v,h);var x=4;t.bindBuffer(t.ARRAY_BUFFER,_),t.vertexAttribPointer(i,2,t.FLOAT,!1,7*x,0),t.enableVertexAttribArray(i),t.vertexAttribPointer(r,4,t.FLOAT,!1,7*x,2*x),t.enableVertexAttribArray(r),t.vertexAttribPointer(a,1,t.FLOAT,!1,7*x,6*x),t.enableVertexAttribArray(a);for(var A=0;A<m.length;A++){var P=m[A];t.drawArrays(e,P.index,P.num)}t.disableVertexAttribArray(i),t.disableVertexAttribArray(a),t.disableVertexAttribArray(r)},this.points=function(e,i,r){this.draw(t.POINTS,e,i,r)}},this.colorShader=new this.ColorShader,this.tileShader=new this.TileShader,this.pointShader=new this.PointShader,this.textureShader=new this.TextureShader}},tessellate:function(t){var e,i=Module.cwrap("tessellate","void",["number","number","number","number","number","number"]);if(0===t.length)throw"Expected at least one loop";for(var r=[],a=[0],n=0;n<t.length;++n){var o=t[n];if(o.length%2!==0)throw"Expected even number of coordinates";r.push.apply(r,o),a.push(r.length)}var s=Module._malloc(8*r.length);for(e=0;e<r.length;++e)Module.setValue(s+8*e,r[e],"double");var l=Module._malloc(4*a.length);for(e=0;e<a.length;++e)Module.setValue(l+4*e,s+8*a[e],"i32");var h=Module._malloc(4),f=Module._malloc(4),c=Module._malloc(4),u=Module._malloc(4);i(h,c,f,u,l,l+4*a.length);var d=Module.getValue(h,"i32"),v=Module.getValue(f,"i32"),g=Module.getValue(c,"i32"),p=Module.getValue(u,"i32"),_=new Float64Array(2*g),m=new Int32Array(3*p);for(e=0;e<2*g;++e)_[e]=Module.getValue(d+8*e,"double");for(e=0;e<3*p;++e)m[e]=Module.getValue(v+4*e,"i32");return Module._free(c),Module._free(u),Module._free(h),Module._free(f),Module._free(d),Module._free(v),Module._free(s),Module._free(l),{vertices:_,triangles:m}}},WRAP.Geo.Renderer.Mesh=function(){var t=this;this.palette=null,this.palette_value_min=0,this.palette_value_max=0,this.palette_gradient=!0,this.palette_scale=10,this.palette_step=1,this.setPalette=function(e){if(!t.palette&&e.palette){t.palette=[],t.palette_gradient=e.palette_gradient,t.palette_step=e.palette_step||1,t.palette_scale=1/t.palette_step;for(var i=e.palette,r=[],a=0;a<i.length;a++){var n=[],o=i[a].value;0==a?(this.palette_value_min=o,this.palette_value_max=o):(this.palette_value_min>o&&(this.palette_value_min=o),this.palette_value_max<o&&(this.palette_value_max=o)),n.push(o);var s=WRAP.Geo.parseColor(i[a].color);n.push(s[0]),n.push(s[1]),n.push(s[2]),n.push(s[3]),r.push(n)}for(var l=0,h=t.palette_value_min;h<=t.palette_value_max+t.palette_step;h+=t.palette_step){for(;l<r.length-1&&h>=r[l+1][0];)l++;if(l==r.length-1)t.palette.push([parseInt(r[l][1]),parseInt(r[l][2]),parseInt(r[l][3]),parseInt(r[l][4])]);else{var f=r[l][1],c=r[l][2],u=r[l][3],d=r[l][4];if(t.palette_gradient){var v=(h-r[l][0])/(r[l+1][0]-r[l][0]),g=r[l+1][1],p=r[l+1][2],_=r[l+1][3],m=r[l+1][4];t.palette.push([parseInt(f+(g-f)*v),parseInt(c+(p-c)*v),parseInt(u+(_-u)*v),parseInt(d+(m-d)*v)])}else t.palette.push([parseInt(f),parseInt(c),parseInt(u),parseInt(d)])}}}},this.getColor=function(e){var i=Math.floor((e-t.palette_value_min)*t.palette_scale);return i<0?[0,0,0,0]:(i>=t.palette.length&&(i=t.palette.length-1),t.palette[i])},this.draw=function(e,i,r,a,n,o,s,l){if(!i)return void e.clear();var h=!0;if(this.context_revision!=s.context&&(h=!1),this.content_revision!=s.content&&(h=!1),this.conf_revision==s.conf&&this.style_revision==s.style||(t.palette=null,l.length=0,e.clear(),h=!1),!h){e.setStatus({status:"invalid",reason:"data load waiting."});var f=r.Attributes.data_scale||1,c=r.Attributes.data_offset||0,u=r.Attributes.style.default;if(!n&&r.Attributes.style_selector){if(!r.Attributes.style_selector.key||!r.Attributes.style_selector.styles)return console.error("style_selector formar error."),void e.setStatus({status:"error",reason:"style definition error."});for(var d=r.Attributes.style_selector.key,v=0;v<r.Attributes.style_selector.styles.length;v++){var g=r.Attributes.style_selector.styles[v].values;if(g.indexOf(i[d])>=0){n=r.Attributes.style_selector.styles[v].style;break}}}if(n&&r.Attributes.style[n]&&(u=r.Attributes.style[n]),!u)return void e.setStatus({status:"error",reason:"style definition error."});this.setPalette(u);for(var p="block"!=u.fill_type?"interpolate":"nearest",_=u.fill_type,m=u.contour,x=[],A=[],v=0;v<a.tiles.length;v++){for(var P=a.tiles[v],y=0;y<l.length;y++){var w=l[y];if(w.data&&w.data.tile&&w.data.tile.id==P.id&&w.data.revision==s.content){A.push(w),P=null;break}}P&&x.push(P)}for(var b=[],v=0;v<x.length;v++){var P=x[v];if(!(b[v]=o._handler().getTile(i,P.id,p)))return void o._handler().loadTile(i,P.id,p,P.z,P.y,P.x,P.cood,P.bounds,function(){WRAP.Geo.redraw(e)})}var R=[],W=e.getBlendLayer();if(W)for(var y=0;y<W.length;y++){var G=W[y];if(G.visible()){for(var S=[],v=0;v<x.length;v++){var P=x[v];if(!(S[v]=G._data._handler().getTile(i,P.id,p)))return void G._data._handler().loadTile(i,P.id,p,P.z,P.y,P.x,P.cood,P.bounds,function(){WRAP.Geo.redraw(e)})}R.push(S)}}var M=[];e.clear();for(var v=0;v<A.length;v++)e.addFeature(A[v]),M.push(A[v]);for(var v=0;v<b.length;v++){var L=b[v],u=null;L&&!L.empty&&(u=this.getData(i,L.data)),R.length&&u&&(u=u.concat());for(var y=0;y<R.length;y++){var T=R[y][v];if(T&&!T.empty){u||(u=new Array(65536));var F=this.getData(i,T.data);if(F)for(var I=0;I<65536;I++){var k=F[I];isNaN(k)||(u[I]=k)}}}if(u){var P=x[v],z=P.ctx.createImageData(256,256),D=z.data;if(_)for(var I=0;I<65536;I++){var E=u[I];if(!isNaN(E)){E=E*f+c;var C=this.getColor(E),B=4*I;D[B]=C[0],D[B+1]=C[1],D[B+2]=C[2],D[B+3]=C[3]}}var N=[];if(m){for(var U=0,j=0,B=0;B<65536;B++){var E=u[B];isNaN(E)||(0==B?U=j=E:(U>E&&(U=E),j<E&&(j=E)))}for(var y=0;y<m.length;y++)for(var V=m[y],C=WRAP.Geo.parseColor(V.strokeStyle),O=V.unit_label||"",X=void 0===V.fractional_digits?void 0:parseInt(V.fractional_digits),Y=V.interval/f,H=V.base,E=(V.base-c)/f,q=0;q<V.num;q++){if(U<=E&&E<=j){for(var Z=-1,J=0,Q=0,K=0,$=0;$<256;$++)for(var tt=0==$?0:-256,et=255==$?0:256,it=0;it<256;it++){var rt=0==it?0:-1,at=255==it?0:1,nt=u[K];try{if(nt>=E){var ot=u[K+tt],st=u[K+rt],lt=u[K+at],ht=u[K+et];if(ot<E||st<E||lt<E||ht<E){D[4*K]=C[0],D[4*K+1]=C[1],D[4*K+2]=C[2],D[4*K+3]=C[3],V.lineWidth>1&&(D[4*K+4]=C[0],D[4*K+5]=C[1],D[4*K+6]=C[2],D[4*K+7]=C[3],D[4*K+1024]=C[0],D[4*K+1024+1]=C[1],D[4*K+1024+2]=C[2],D[4*K+1024+3]=C[3]);var ft=Math.abs(it-128)+Math.abs($-128);(Z<0||ft<Z)&&(Z=ft,J=it,Q=$)}}}catch(t){}K++}if(20<J&&J<=236&&20<Q&&Q<=236){var ct=void 0===X?H:H.toFixed(X);N.push({x:J,y:Q,value:ct+O,color:V.textColor})}}H+=V.interval,E+=Y}}var ut=new WRAP.Geo.Feature.Tile({tile:P,imageData:z});e.addFeature(ut),M.push(ut);for(var dt=[],ft=0;ft<N.length;ft++){var vt=2*(256*N[ft].y+N[ft].x),gt=P.cood[vt],pt=P.cood[vt+1],_t=new WRAP.Geo.Feature.Text({point:[pt,gt],text:N[ft].value,fontSize:12,fillStyle:N[ft].color,offsetX:0,offsetY:0,align:"center"});dt.push(_t)}ut.data={tile:P,label:dt,length:N.length,revision:s.content}}}for(var I=0;I<M.length;I++){var w=M[I];if(w.data&&w.data.label)for(var N=w.data.label,ft=0;ft<N.length;ft++)e.addFeature(N[ft])}this.context_revision=s.context,this.content_revision=s.content,this.conf_revision=s.conf,this.style_revision=s.style,e.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}},WRAP.Geo.Renderer.Mesh.prototype.getData=function(t,e){if(!t.element||!Array.isArray(t.element))return e},WRAP.Geo.Renderer.Image=function(){this.draw=function(t,e,i,r,a,n,o,s){if(e){var l=!0;if(this.context_revision!=o.context&&(l=!1),this.content_revision!=o.content&&(l=!1),this.conf_revision!=o.conf&&(l=!1,s.length=0,this.palette=null),this.style_revision!=o.style&&(l=!1,s.length=0,this.palette=null),!l){var h=i.Attributes.style.default;if(a&&i.Attributes.style[a]&&(h=i.Attributes.style[a]),!h)return void t.setStatus({status:"error",reason:"style definition error."});t.setStatus({status:"invalid",reason:"data load waiting."});for(var f=null,c=[],u=[],d=0;d<r.tiles.length;d++){for(var v=r.tiles[d],g=0;g<s.length;g++){var p=s[g];if(p.data&&p.data.tile&&p.data.tile.id==v.id&&p.data.revision==o.content){u.push(p),v=null;break}}v&&c.push(v)}for(var _=[],d=0;d<c.length;d++){var v=c[d];if(!(_[d]=n._handler().getTile(e,v.id,f)))return void n._handler().loadTile(e,v.id,f,v.z,v.y,v.x,v.cood,v.bounds,function(){WRAP.Geo.redraw(t)})}t.clear();for(var d=0;d<u.length;d++)t.addFeature(u[d]);for(var d=0;d<_.length;d++){var m=_[d];if(m&&!m.empty&&m.data){var v=c[d];if(v.ctx){var x=v.ctx.createImageData(256,256),A=m.data,P=x.data,y=0;if("rgb_palette"==h.type&&h.palette)for(var w=h.palette,b=0;b<65536;b++){for(var R=A[y],W=A[y+1],G=A[y+2],S=A[y+3],g=0;g<w.length;g++){var M=w[g][0];if(R==M[0]&&W==M[1]&&G==M[2]){R=w[g][1][0],W=w[g][1][1],G=w[g][1][2],S=w[g][1][3];break}}P[y++]=R,P[y++]=W,P[y++]=G,P[y++]=S}else if("grayscale_palette"==h.type&&h.palette)for(var w=h.palette,g=0;g<65536;g++){var L=A[y],b=w[L];P[y++]=b[0],P[y++]=b[1],P[y++]=b[2],P[y++]=b[3]}else if("filter"==h.type)for(var T=parseInt(h.rgb_offset)||0,F=parseFloat(h.opacity)||1,g=0;g<65536;g++){var R=A[y]+T,W=A[y+1]+T,G=A[y+2]+T,S=A[y+3]*F;R<0?R=0:R>255&&(R=255),W<0?W=0:W>255&&(W=255),G<0?G=0:G>255&&(G=255),P[y++]=R,P[y++]=W,P[y++]=G,P[y++]=S}else x=m;var I=new WRAP.Geo.Feature.Tile({tile:v,imageData:x});I.data={tile:v,revision:o.content},t.addFeature(I)}else console.error("ctx error:"+v.id)}}this.context_revision=o.context,this.content_revision=o.content,this.conf_revision=o.conf,this.style_revision=o.style,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}},this.merge=function(t,e,i,r){var a=[256,256,256,256],n=i.Attributes.style.default;r&&i.Attributes.style[r]&&(n=i.Attributes.style[r]),n&&n.alternative_color&&4==n.alternative_color.length&&(a=n.alternative_color);for(var o=[],s=0;s<e.length;s++){var n=e[s].style();if(n.tile){for(var l=null,h=0;h<t.length;h++){var f=t[h].style();if(f.tile&&f.tile.id==n.tile.id){l=f;break}}if(l){if(n.imageData&&l.imageData)for(var c=n.imageData.data,u=l.imageData.data,d=0;d<65536;d++){var v=4*d;c[v]==a[0]&&c[v+1]==a[1]&&c[v+2]==a[2]&&c[v+3]==a[3]?0==u[v+3]&&(u[v]=a[0],u[v+1]=a[1],u[v+2]=a[2],u[v+3]=a[3]):c[v+3]&&(u[v]=c[v],u[v+1]=c[v+1],u[v+2]=c[v+2],u[v+3]=c[v+3])}}else{for(var g=n.tile.ctx.createImageData(256,256),c=n.imageData.data,u=g.data,d=0;d<65536;d++){var v=4*d;c[v]==a[0]&&c[v+1]==a[1]&&c[v+2]==a[2]&&c[v+3]==a[3]?(u[v]=a[0],u[v+1]=a[1],u[v+2]=a[2],u[v+3]=a[3]):(u[v]=c[v],u[v+1]=c[v+1],u[v+2]=c[v+2],u[v+3]=c[v+3])}o.push(new WRAP.Geo.Feature.Tile({tile:n.tile,imageData:g}))}}}for(var s=0;s<o.length;s++)t.push(o[s])},this.getValue=function(t,e,i,r){for(var a=0;a<e.tiles.length;a++){var n=e.tiles[a],o=n.bounds.north,s=n.bounds.south;if(!(r.lat>o||r.lat<s)){var l=n.bounds.east;l<-10800?l+=21600:l>=10800&&(l-=21600);var h=n.bounds.west;if(h<-10800?h+=21600:h>=10800&&(h-=21600),h<l){if(r.lon>l||r.lon<h)continue}else if(r.lon>l&&r.lon<h)continue;var f=i._handler().getTile(t,n.id);if(f){var c=r.latDegree(),u=r.lonDegree();u<0&&(u+=360);for(var a=0,d=0;d<256&&n.cood[a]>c;)d++,a+=512;for(var v=0;v<256;){var g=n.cood[a+1];if(g<0?g+=360:g>=180&&(g-=360),u<=g)break;v++,a+=2}var p=4*(256*d+v);return{data:[f.data[p],f.data[p+1],f.data[p+2],f.data[p+3]]}}break}}return null}},WRAP.Geo.Renderer.GridValue=function(){this.style_revision,this.context_revision,this.draw=function(t,e,i,r,a,n,o,s){if(WRAP.Geo.check(s),e&&this.context_revision!=o.context){this.style_revision!=o.style&&(this.style_revision=o.style);var l=i.Attributes.style.default;if(a&&i.Attributes.style[a]&&(l=i.Attributes.style[a]),!l)return void t.setStatus({status:"error",reason:"style definition error."});var h="value";t.setStatus({status:"invalid",reason:"data load waiting."});for(var f=[],c=0;c<r.tiles.length;c++){var u=r.tiles[c];if(!(f[c]=n._handler().getTile(e,u.id,h)))return void n._handler().loadTile(e,u.id,h,u.z,u.y,u.x,u.cood,u.bounds,function(){WRAP.Geo.redraw(t)})}var d=i.Attributes.data_scale||1,v=i.Attributes.data_offset||0,g=void 0===l.fractional_digits?1:parseInt(l.fractional_digits),p=l.offset_x||0,_=l.offset_y||0;t.clear();for(var c=0;c<f.length;c++)for(var n=f[c].data,m=0;m<n.length;m++){var x=n[m];if(x.value&&!isNaN(x.value)){var A,P=(x.value*d+v).toFixed(g);A=new WRAP.Geo.Feature.Text({point:[x.lon,x.lat],text:P,fontSize:14,fillStyle:l.color,offsetX:p,offsetY:_,align:"center"}),t.addFeature(A)}}this.context_revision=r.revision,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}},WRAP.Geo.Renderer.WindArrow=function(){this.style_revision,this.context_revision,this.image=null,this.arrow_step=0,this.image_width=32,this.image_height=64,this.draw=function(t,e,i,r,a,n,o){function s(t,e,i,r){for(var a=5;a<200;a+=5){i.clearRect(0,0,e.width,e.height);var n=1.5,o=4,s=24,l={x:e.width/2,y:e.height-1},h=a;for(h*=2,h/=10,h=Math.round(h),h*=10,h/=2,h>=50&&(s+=5*Math.floor(h/50)),h>0&&(i.beginPath(),i.moveTo(l.x,l.y),i.lineTo(l.x,l.y+(-s-(h<6?4:0))*n),i.stroke());h>=50;)i.beginPath(),i.moveTo(l.x,l.y+-s*n),i.lineTo(l.x+10*r*n,l.y+(-s+1.5)*n),i.lineTo(l.x,l.y+(-s+5)*n),i.lineTo(l.x,l.y+-s*n),i.stroke(),h-=50,s-=o+2.5;for(a>50&&(s-=2);h>=10;)i.moveTo(l.x,l.y+-s*n),i.lineTo(l.x+10*r*n,l.y+(-s-4)*n),h-=10,s-=o;h>=5&&(i.moveTo(l.x,l.y+-s*n),i.lineTo(l.x+7*r*n,l.y+(-s-3)*n),h-=5,s-=o),i.stroke(),t.push(i.getImageData(0,0,e.width,e.height))}}function l(t,e,i){i.clearRect(0,0,e.width,e.height);var r=1.5,a=24,n={x:e.width/2,y:e.height-1};i.beginPath(),i.moveTo(n.x,n.y),i.lineTo(n.x,n.y+(-a-4)*r),i.stroke(),t.push(i.getImageData(0,0,e.width,e.height))}function h(t,e,i){i.clearRect(0,0,e.width,e.height),i.lineWidth=1.5,i.beginPath(),i.arc(e.width/2,e.height-6,3,0,2*Math.PI,!0),i.closePath(),i.stroke(),i.fill(),t.push(i.getImageData(0,0,e.width,e.height))}if(e&&this.context_revision!=o.context){this.style_revision!=o.style&&(this.style_revision=o.style);var f=i.Attributes.style.default;if(a&&i.Attributes.style[a]&&(f=i.Attributes.style[a]),!f)return void t.setStatus({status:"error",reason:"style definition error."});if(!this.image){this.image=[];var c=document.createElement("canvas");c.width=this.image_width,c.height=this.image_height;var u=c.getContext("2d");u.strokeStyle=f.color,u.fillStyle=f.color,u.lineCap="round",u.lineWidth=1.5,s(this.image,c,u,1),this.arrow_step=this.image.length,s(this.image,c,u,-1),l(this.image,c,u),h(this.image,c,u)}var d="value";t.setStatus({status:"invalid",reason:"data load waiting."});for(var v=[],g=0;g<r.tiles.length;g++){var p=r.tiles[g];if(!(v[g]=n._handler().getTile(e,p.id,d)))return void n._handler().loadTile(e,p.id,d,p.z,p.y,p.x,p.cood,p.bounds,function(){WRAP.Geo.redraw(t)})}var _=i.Attributes.data_scale||1,m=i.Attributes.data_offset||0,x=i.Attributes.threshold||0;t.clear(0);for(var g=0;g<v.length;g++)for(var n=v[g].data,A=0;A<n.length;A++){var P=n[A];if(P.value&&2==P.value.length&&!isNaN(P.value[0])&&!isNaN(P.value[1])){var y=P.value[0]*_+m,w=P.value[1]*_+m,b=Math.sqrt(y*y+w*w)/.514;if(b>x){var R=b;b=Math.round(b);var W=0;b>0&&(W=Math.atan2(y,w)*(180/Math.PI),W-=180,W<0&&(W+=360));var G,S=Math.floor(b),M=Math.floor(W),M=S?M||360:0,L=S+"KT",T=S?("000"+M).slice(-3):"",F=.6*this.image_width,I=.6*this.image_height,k=Math.floor((b+2)/5)-1;k>=this.arrow_step&&(k=this.arrow_step-1);var z=W,D=-F/2,E=-I;k==-1?Math.floor(b)>0?k=this.image.length-2:(z=0,E+=5,k=this.image.length-1):P.lat<0&&(k+=this.arrow_step),z=WRAP.Geo.getScreenRotation(new WRAP.Geo.Point(60*P.lat,60*P.lon),z),G=new WRAP.Geo.Feature.Image({point:[P.lon,P.lat],image:this.image[k],width:F,height:I,offsetX:D,offsetY:E,rotation:z}),t.addFeature(G),G.geo={geometry:{type:"Point",coordinates:[P.lon,P.lat]},properties:{u:y,v:w,speed:R,direction:W,speed_text:L,direction_text:T}}}}}this.context_revision=r.revision,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}},WRAP.Geo.Renderer.GridArrow=function(){var t=this;this.style_revision,this.context_revision,this.palette=null,this.palette_value_min=0,this.palette_value_max=0,this.palette_gradient=!0,this.palette_scale=10,this.palette_step=1,this.color=null,this.setPalette=function(e){if(!t.color&&e.color&&(t.color=WRAP.Geo.parseColor(e.color)),!t.palette&&e.palette){t.palette=[],t.palette_gradient=e.palette_gradient,t.palette_step=e.palette_step||1,t.palette_scale=1/t.palette_step;for(var i=e.palette,r=[],a=0;a<i.length;a++){var n=[],o=i[a].value;0==a?(this.palette_value_min=o,this.palette_value_max=o):(this.palette_value_min>o&&(this.palette_value_min=o),this.palette_value_max<o&&(this.palette_value_max=o)),n.push(o);var s=WRAP.Geo.parseColor(i[a].color);n.push(s[0]),n.push(s[1]),n.push(s[2]),n.push(s[3]),r.push(n)}for(var l=0,h=t.palette_value_min;h<=t.palette_value_max;h+=t.palette_step){for(;l<r.length-1&&h>=r[l+1][0];)l++;if(l==r.length-1)t.palette.push([parseInt(r[l][1]),parseInt(r[l][2]),parseInt(r[l][3]),parseInt(r[l][4])]);else{var f=r[l][1],c=r[l][2],u=r[l][3],d=r[l][4];if(t.palette_gradient){var v=(h-r[l][0])/(r[l+1][0]-r[l][0]),g=r[l+1][1],p=r[l+1][2],_=r[l+1][3],m=r[l+1][4];t.palette.push([parseInt(f+(g-f)*v),parseInt(c+(p-c)*v),parseInt(u+(_-u)*v),parseInt(d+(m-d)*v)])}else t.palette.push([parseInt(f),parseInt(c),parseInt(u),parseInt(d)])}}}},this.getColor=function(e){if(t.color)return t.color;var i=Math.floor((e-t.palette_value_min)*t.palette_scale);return i<0?[0,0,0,0]:(i>=t.palette.length&&(i=t.palette.length-1),t.palette[i])},this.draw=function(t,e,i,r,a,n,o,s){if(e){var l=!0;if(this.context_revision!=o.context&&(l=!1),this.content_revision!=o.content&&(l=!1),this.conf_revision!=o.conf&&(l=!1,s.length=0,this.palette=null),this.style_revision!=o.style&&(l=!1,s.length=0,this.palette=null),!l){var h=i.Attributes.style.default;if(a&&i.Attributes.style[a]&&(h=i.Attributes.style[a]),!h)return void t.setStatus({status:"error",reason:"style definition error."});this.setPalette(h);var f="value";h.min_blocksize&&(f+=" "+h.min_blocksize),t.setStatus({status:"invalid",reason:"data load waiting."});for(var c=[],u=0;u<r.tiles.length;u++){var d=r.tiles[u];if(!(c[u]=n._handler().getTile(e,d.id,f)))return void n._handler().loadTile(e,d.id,f,d.z,d.y,d.x,d.cood,d.bounds,function(){WRAP.Geo.redraw(t)})}var v=[],g=t.getBlendLayer();if(g)for(var p=0;p<g.length;p++){var _=g[p];if(_.visible()){for(var m=[],u=0;u<r.tiles.length;u++){var d=r.tiles[u];if(!(m[u]=_._data._handler().getTile(e,d.id,f)))return void _._data._handler().loadTile(e,d.id,f,d.z,d.y,d.x,d.cood,d.bounds,function(){WRAP.Geo.redraw(t)})}v.push(m)}}var x=i.Attributes.data_scale||1,A=i.Attributes.data_offset||0,P=i.Attributes.type,y=i.Attributes.threshold||0,w=h.base_length||16,b=h.speed_length_racio||0;t.clear();for(var u=0;u<c.length;u++){var n=c[u].data;v.length&&n&&(n=n.concat());for(var p=0;p<v.length;p++){var R=v[p][u].data;if(R){n||(n=new Array);for(var W=0;W<R.length;W++){var G=R[W];if(void 0!==G.value&&!isNaN(G.value)){for(var S=0;S<n.length;S++){var M=n[S];if(M.lat==G.lat&&M.lon==G.lon){n.splice(S,1);break}}n.push(G)}}}}if(n)for(var p=0;p<n.length;p++){var L=n[p],T=0,F=0;if("SpeedDirection"==P){if(!L.value||2!=L.value.length||isNaN(L.value[0])||isNaN(L.value[1]))continue;T=L.value[0]*x+A,F=L.value[1]}else if("Direction"==P){if(void 0===L.value||isNaN(L.value))continue;T=-1,F=L.value*x+A}else{if(!L.value||2!=L.value.length||isNaN(L.value[0])||isNaN(L.value[1]))continue;var I=L.value[0],k=L.value[1];T=Math.sqrt(I*I+k*k)*x+A,T>0&&(F=Math.atan2(I,k)*(180/Math.PI),F+=180,F<0&&(F+=360))}if(T<0||T>=y){var z=this.getColor(T);F=WRAP.Geo.getScreenRotation(new WRAP.Geo.Point(60*L.lat,60*L.lon),F);var S=w+T*b,D=new WRAP.Geo.Feature.Line({point:[L.lon,L.lat],line:[[[0,0],[0,S]],[[2,S-4],[0,S],[-2,S-4]]],strokeStyle:"rgba("+z[0]+","+z[1]+","+z[2]+","+z[3]/255+")",rotation:F});t.addFeature(D)}}}this.context_revision=o.context,this.content_revision=o.content,this.conf_revision=r.conf,this.style_revision=o.style,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}}},WRAP.Geo.Renderer.DataJSON=function(){this.draw=function(t,e,i,r,a,n,o,s){function l(e,i){for(var r=null,a=0;a<d.length;a++){var n=d[a].selector;if(!n){r=d[a].style;break}if("key_value"==n.type&&e[n.key]==n.value){r=d[a].style;break}}var o=r&&r[c];if(o){var s=_[i];if(s){var l=s.geometry;if(l&&e.display_flag!==!1)if("Point"==l.type){var h=l.coordinates;if("image"==o.type){var f=new WRAP.Geo.Feature.Image({point:h,image:o.url,width:o.width,height:o.height,offsetX:o.offset_x,offsetY:o.offset_y,rotation:o.rotation});f.geo=s,f.data=e,t.addFeature(f)}else if("point"==o.type){var f=new WRAP.Geo.Feature.Point({point:h,strokeStyle:o.line_color,strokeWidth:o.line_width,fillStyle:o.point_color,pointSize:o.point_size,sensorSize:o.sensor_size,blink:o.blink});f.geo=s,f.data=e,t.addFeature(f)}}else if("MultiPoint"==l.type)for(var u=0;u<l.coordinates.length;u++){var h=l.coordinates[u];if("image"==o.type){var f=new WRAP.Geo.Feature.Image({point:h,image:o.url,width:o.width,height:o.height,offsetX:o.offset_x,offsetY:o.offset_y,rotation:o.rotation});f.geo=s,f.data=e,t.addFeature(f)}else if("point"==o.type){var f=new WRAP.Geo.Feature.Point({point:h,strokeStyle:o.line_color,strokeWidth:o.line_width,fillStyle:o.point_color,pointSize:o.point_size,sensorSize:o.sensor_size,blink:o.blink});f.geo=s,f.data=e,t.addFeature(f)}}else if("LineString"==l.type||"MultiLineString"==l.type){var v=l.coordinates;if(v){var f=new WRAP.Geo.Feature.GeoLine({path:v,lineWidth:o.line_width,strokeStyle:o.line_color});f.geo=s,f.data=e,t.addFeature(f)}}else if("Polygon"==l.type){var v=l.coordinates;if(v){var f=new WRAP.Geo.Feature.GeoLine({path:v,lineWidth:o.line_width,strokeStyle:o.line_color,fillStyle:o.fill_color,fillImage:o.fill_image});f.geo=s,f.data=e,t.addFeature(f)}}else if("MultiPolygon"==l.type)for(var g=0;g<l.coordinates.length;g++){var v=l.coordinates[g];if(v){var f=new WRAP.Geo.Feature.GeoLine({path:v,lineWidth:o.line_width,strokeStyle:o.line_color,fillStyle:o.fill_color,fillImage:o.fill_image});f.geo=s,f.data=e,t.addFeature(f)}}}}}WRAP.Geo.check(t,e,i,r,a,n,o,s);var h=!0;if(this.content_revision!=o.content&&(h=!1),this.conf_revision!=o.conf&&(h=!1),this.style_revision!=o.style&&(h=!1),this.data_revision!=o.data&&(h=!1),!h){t.setStatus({status:"invalid"});var f=n.query("data").value();if(!f||!f.position||!f.data)return void(n._handler()._error&&t.setStatus({status:"error",reason:n._handler()._error}));t.clear();var c="default",u=f.position.features;u||(u=[],"Feature"==f.position.type&&u.push(f.position));for(var d=i.Attributes.features,v=n._handler().conf,g=v.Attributes.DataStructure.geo_position_key||"position_id",p=v.Attributes.DataStructure.data_position_key||"position_id",_={},m=0,x=u.length,A=0;A<x;A++){var P=u[A],y=P.properties;if(y){var w=P.geometry;if(w){var b=y[g];_[b]&&m++,_[b]=P}}}var R=0;if(Array.isArray(f.data.data)){R=f.data.data.length;for(var A=0;A<R;A++){var P=f.data.data[A],b=P[p];l(P,b)}}else for(var W in f.data.data){var P=f.data.data[W];l(P,W),R++}this.content_revision=o.content,this.conf_revision=o.conf,this.style_revision=o.style,this.data_revision=o.data,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}},WRAP.Geo.Renderer.GeoJSON=function(){this.initialized=!1,this.draw=function(t,e,i,r,a,n,o,s){WRAP.Geo.check(t,e,i,r,a,n,o,s);var l=-1;r&&r.tiles.length&&(l=r.zoom);var h=n._handler().tiled();if(h){if(this.content_revision==o.content&&this.context_revision==o.context&&this.conf_revision==o.conf&&this.style_revision==o.style&&this.data_revision==o.data)return}else if(i.Attributes.min_zoom){if(this.last_zoom==l&&this.content_revision==o.content&&this.conf_revision==o.conf&&this.style_revision==o.style&&this.data_revision==o.data)return}else if(this.content_revision==o.content&&this.conf_revision==o.conf&&this.style_revision==o.style&&this.data_revision==o.data)return;t.setStatus({status:"invalid"});var f=n._handler().getData(e,r);if(!f)return n._handler()._error&&t.setStatus({status:"error",reason:n._handler()._error}),void n._handler().loadData(e,r,function(){WRAP.Geo.redraw(t)});for(var c=[],u=0;u<f.length;u++){var d=f[u].features;if(d)for(var v=0;v<d.length;v++)c.push(d[v]);else"Feature"==f[u].type&&c.push(f[u])}if(t.clear(),!i.Attributes.min_zoom||l>=i.Attributes.min_zoom)for(var g=a||"default",p=i.Attributes.features,_=c.length,u=0;u<_;u++){var m=c[u],x=m.geometry;if(x){var A=m.properties;if(!A||A.display_flag!==!1){for(var a=null,v=0;v<p.length;v++){var P=p[v].selector;if(!P){a=p[v].style;break}if("key_value"==P.type&&A[P.key]==P.value){a=p[v].style;break}}var y=a&&a[g];if(y){var w=void 0===y.geodesic||y.geodesic===!0;if("Point"==x.type){var b=x.coordinates;if("image"==y.type){var R=new WRAP.Geo.Feature.Image({point:b,image:y.url,width:y.width,height:y.height,offsetX:y.offset_x,offsetY:y.offset_y,rotation:y.rotation});R.geo=m,t.addFeature(R)}else if("point"==y.type){var R=new WRAP.Geo.Feature.Point({point:b,strokeStyle:y.line_color,strokeWidth:y.line_width,fillStyle:y.point_color,pointSize:y.point_size,sensorSize:y.sensor_size,blink:y.blink});R.geo=m,t.addFeature(R)}}else if("MultiPoint"==x.type)for(var W=0;W<x.coordinates.length;W++){var b=x.coordinates[W];if("image"==y.type){var R=new WRAP.Geo.Feature.Image({point:b,image:y.url,width:y.width,height:y.height,offsetX:y.offset_x,offsetY:y.offset_y,rotation:y.rotation});R.geo=m,t.addFeature(R)}else if("point"==y.type){var R=new WRAP.Geo.Feature.Point({point:b,strokeStyle:y.line_color,strokeWidth:y.line_width,fillStyle:y.point_color,pointSize:y.point_size,sensorSize:y.sensor_size,
blink:y.blink});R.geo=m,t.addFeature(R)}}else if("LineString"==x.type||"MultiLineString"==x.type){var G=x.coordinates;if(G){var R=new WRAP.Geo.Feature.GeoLine({path:G,lineWidth:y.line_width,strokeStyle:y.line_color,option:y.option,geodesic:w});R.geo=m,t.addFeature(R)}}else if("Polygon"==x.type){var G=x.coordinates;if(G){var R=new WRAP.Geo.Feature.GeoLine({path:G,lineWidth:y.line_width,strokeStyle:y.line_color,fillStyle:y.fill_color,fillImage:y.fill_image,option:y.option,geodesic:w});R.geo=m,t.addFeature(R)}}else if("MultiPolygon"==x.type)for(var S=0;S<x.coordinates.length;S++){var G=x.coordinates[S];if(G){var R=new WRAP.Geo.Feature.GeoLine({path:G,lineWidth:y.line_width,strokeStyle:y.line_color,fillStyle:y.fill_color,fillImage:y.fill_image,geodesic:w});R.geo=m,t.addFeature(R)}}}}}}this.content_revision=o.content,this.context_revision=o.context,this.conf_revision=o.conf,this.style_revision=o.style,this.data_revision=o.data,this.last_zoom=l,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}},WRAP.Geo.Renderer.Lightning=function(){this.draw=function(t,e,i,r,a,n,o,s){WRAP.Geo.check(e,r,a,s);var l=n.query("data").value();if(l){var h=!0;if(this.conf_revision!=o.conf&&(h=!1),this.data_revision!=o.data&&(h=!1),!h){t.setStatus({status:"invalid",reason:"data load waiting."});var a=i.Attributes.style.default,f=a.icon_width,c=a.icon_height,u=a.icon_offset_x,d=a.icon_offset_y,v=a.icon;t.clear();var g=l.features;g||(g=[],"Feature"==l.type&&g.push(l));for(var p=g.length,_=0;_<p;_++){var m=g[_],x=m.geometry;if(x&&"Point"==x.type){var A=m.properties;if(A&&A.display_flag===!1)continue;for(var P=WRAP.Core.currentTime(),y=new WRAP.Core.DateTime(A.obs_time),w=y.diff(P)/60,b=0;b<v.length;b++)if(parseInt(v[b].ge)<=w&&w<parseInt(v[b].lt)){var R=x.coordinates,W=new WRAP.Geo.Feature.Image({point:R,image:v[b].image,width:f,height:c,offsetX:u,offsetY:d});W.geo=m,t.addFeature(W);break}}}this.conf_revision=o.conf,this.style_data=o.data,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}}},WRAP.Geo.Renderer.SIGWX=function(){this.draw=function(t,e,i,r,a,n,o,s){function l(t){Array.isArray(t[0])&&(t=t[0]);var e=[],i=WRAP.Geo.getSize(),r=WRAP.Geo.getScreenLine(t);if(!r)return e;for(var a=0;a<r.length;a++){for(var n=r[a],o=9999,s=-9999,l=9999,h=-9999,f=0;f<n.length;f++){var c=n[f].x,u=n[f].y;u<0||i.height<=u||c<0||i.width<=c||(o>c&&(o=c),s<c&&(s=c),l>u&&(l=u),h<u&&(h=u))}if(s>0&&h>0){var c=(o+s)/2,u=(l+h)/2,d=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(c,u));e.push([d.lonDegree(),d.latDegree()])}}return e}function h(t){return t&&Math.round(t/30.48)||"XXX"}WRAP.Geo.check(s);var f=!0;if(this.content_revision!=o.content&&(f=!1),f=!1,this.conf_revision!=o.conf&&(f=!1),!f){t.setStatus({status:"invalid",reason:"data load waiting."});var c=n._handler().getData(e,r);if(!c)return void n._handler().loadData(e,r,function(){WRAP.Geo.redraw(t)});t.clear();for(var u=[],d=0;d<c.length;d++){var v=c[d].features;if(v)for(var g=0;g<v.length;g++)u.push(v[g]);else"Feature"==c[d].type&&u.push(c[d])}for(var p,a=i.Attributes,_=u.length,m="-99999",d=0;d<_;d++){var x=u[d],A=x.geometry;if(A){var P=x.properties;if("TURBULENCE"==P.contents_kind){var y,w,b;6==P.extended_degree?(y=a.turbulence_color_mod,w=[[[0,0],[0,0]],[[0,2],[1,2],[2,1],[3,2],[4,2]]],b=2):7==P.extended_degree?(y=a.turbulence_color_sev,w=[[[1,1],[2,0],[3,1]],[[0,2],[1,2],[2,1],[3,2],[4,2]]],b=2):(y=a.turbulence_color_mod_to_sev,w=[[[0,2],[1,2],[2,1],[3,2],[4,2]],[[6,1],[7,0],[8,1]],[[5,2],[6,2],[7,1],[8,2],[9,2]]],b=4.5);var R=A.coordinates;R&&(p=new WRAP.Geo.Feature.GeoLine({path:R,lineWidth:a.turbulence_line_width,strokeStyle:y,lineDash:[12,12]}),t.addFeature(p));var W=l(R);if(W&&W.length)for(var G=0;G<W.length;W++){var S=W[G],M=null,L=null;if(1==P.altitudes.length?M=P.altitudes[0]:2==P.altitudes.length&&(L=P.altitudes[0],M=P.altitudes[1]),p=new WRAP.Geo.Feature.Text({point:S,text:h(M),fontSize:11,fillStyle:a.turbulence_label_color,offsetX:0,offsetY:0,align:"center"}),t.addFeature(p),p=new WRAP.Geo.Feature.Text({point:S,text:h(L),fontSize:11,fillStyle:a.turbulence_label_color,offsetX:0,offsetY:12,align:"center"}),t.addFeature(p),w){for(var T=4,g=0;g<w.length;g++)for(var F=w[g],I=0;I<F.length;I++){var k=F[I];k[0]=k[0]*T-b*T,k[1]=k[1]*T-24}p=new WRAP.Geo.Feature.Line({point:S,line:w,lineWidth:1,strokeStyle:a.turbulence_label_color}),t.addFeature(p)}}}}}for(var z="counterclockwise"==a.cloud_line_orientation?"counter_cloud":"cloud",d=0;d<_;d++){var x=u[d],A=x.geometry;if(A){var P=x.properties;if("CLOUD"==P.contents_kind){var R=A.coordinates;R&&(p=new WRAP.Geo.Feature.GeoLine({path:R,lineWidth:a.cloud_line_width,strokeStyle:a.cloud_line_color,option:z}),t.addFeature(p));var W=l(R);if(W&&W.length)for(var G=0;G<W.length;W++){var S=W[G];if(P.cloud_distribution){for(var D=-36,E=P.cloud_distribution.split("/"),I=0;I<E.length;I++)p=new WRAP.Geo.Feature.Text({point:S,text:E[I],fontSize:11,fillStyle:a.turbulence_label_color,offsetX:0,offsetY:D+=12,align:"center"}),t.addFeature(p);p=new WRAP.Geo.Feature.Text({point:S,text:P.cloud_type,fontSize:11,fillStyle:a.turbulence_label_color,offsetX:0,offsetY:D+=12,align:"center"}),t.addFeature(p);var C="XXX",B="XXX";0<P.altitudes.length&&(C=h(P.altitudes[0])),1<P.altitudes.length&&(B=h(P.altitudes[1])),p=new WRAP.Geo.Feature.Text({point:S,text:C,fontSize:11,fillStyle:a.turbulence_label_color,offsetX:0,offsetY:D+=12,align:"center"}),t.addFeature(p),p=new WRAP.Geo.Feature.Text({point:S,text:B,fontSize:11,fillStyle:a.turbulence_label_color,offsetX:0,offsetY:D+=12,align:"center"}),t.addFeature(p)}else{if(P.extended_degree){var N="XXX",U="XXX";P.airframe_icing?3<P.altitudes.length&&(P.altitudes[0]!=m&&(U=h(P.altitudes[0])),P.altitudes[1]!=m&&(N=h(P.altitudes[1]))):1<P.altitudes.length&&(P.altitudes[0]!=m&&(U=h(P.altitudes[0])),P.altitudes[1]!=m&&(N=h(P.altitudes[1])));var j;2==P.extended_degree?j=a.cloud_turb_mod_icon:3==P.extended_degree&&(j=a.cloud_turb_sev_icon);var D=-26;j&&(p=new WRAP.Geo.Feature.Image({point:S,image:j,width:a.cloud_icon_width,height:a.cloud_icon_height,offsetX:-a.cloud_icon_width/2-6,offsetY:D+6}),t.addFeature(p)),p=new WRAP.Geo.Feature.Text({point:S,text:N,fontSize:11,fillStyle:a.turbulence_label_color,offsetX:14,offsetY:D+=12,align:"center"}),t.addFeature(p),p=new WRAP.Geo.Feature.Text({point:S,text:U,fontSize:11,fillStyle:a.turbulence_label_color,offsetX:14,offsetY:D+=12,align:"center"}),t.addFeature(p)}if(P.airframe_icing){var V="MOD",j=a.cloud_ice_mod_icon;0===P.airframe_icing.lastIndexOf("MOD",0)?V="MOD":0===P.airframe_icing.lastIndexOf("SEV",0)&&(V="SEV",j=a.cloud_ice_sev_icon);var N="XXX",U="XXX";P.extended_degree?3<P.altitudes.length&&(P.altitudes[2]!=m&&(U=h(P.altitudes[2])),P.altitudes[3]!=m&&(N=h(P.altitudes[3]))):1<P.altitudes.length&&(P.altitudes[0]!=m&&(U=h(P.altitudes[0])),P.altitudes[1]!=m&&(N=h(P.altitudes[1])));var D=-2;p=new WRAP.Geo.Feature.Image({point:S,image:j,width:a.cloud_icon_width,height:a.cloud_icon_height,offsetX:-a.cloud_icon_width/2-6,offsetY:D+6}),t.addFeature(p),p=new WRAP.Geo.Feature.Text({point:S,text:N,fontSize:11,fillStyle:a.turbulence_label_color,offsetX:14,offsetY:D+=12,align:"center"}),t.addFeature(p),p=new WRAP.Geo.Feature.Text({point:S,text:U,fontSize:11,fillStyle:a.turbulence_label_color,offsetX:14,offsetY:D+=12,align:"center"}),t.addFeature(p)}}}}}}for(var d=0;d<_;d++){var x=u[d],A=x.geometry;if(A){var P=x.properties;if("VOLCANO"==P.contents_kind)for(var I=0;I<A.coordinates.length;I++){var O=A.coordinates[I];p=new WRAP.Geo.Feature.Image({point:O,image:a.volcano_icon,width:a.volcano_icon_width,height:a.volcano_icon_height,offsetX:-a.volcano_icon_width/2,offsetY:-a.volcano_icon_height/2}),p.geo=x,t.addFeature(p),p=new WRAP.Geo.Feature.Text({point:O,text:P.feature_name,fontSize:11,fillStyle:a.volcano_label_color,offsetX:2,offsetY:22,align:"left"}),t.addFeature(p)}}}for(var X=12,Y=20,H=-3,q=-6,Z=20,J=4,Q=12,d=0;d<_;d++){var x=u[d],A=x.geometry;if(A){var P=x.properties;if("JET STREAM"==P.contents_kind)for(var R=A.coordinates,K=P.points,g=0;g<R.length;g++)for(var $=WRAP.Geo.getScreenLine(R[g]),tt=R[g][0][1]<0,et=0;et<$.length;et++){for(var F=$[et],it=R[g].concat(),rt=K.concat(),at=[],nt=0,I=0;I<F.length;I++){var O=it[I],ot=F[I],st=rt[I],lt=st[0]||0;lt&&(lt=Number(lt)/.514,lt=Math.round(lt)+2);var ht={knots:lt,arrow:null,changeBar:null};if(at.push(ht),I<F.length-1){var ft=F[I+1],ct=ft.x-ot.x,ut=ft.y-ot.y,dt=ct*ct+ut*ut;if(nt=180*Math.atan2(ft.y-ot.y,ft.x-ot.x)/Math.PI,lt>0){for(var vt="FL"+h(O[2]||0),gt=st[2]?h(st[2]):0,pt=st[4]?h(st[4]):0,_t=Math.floor(lt/50),mt=Math.floor(lt%50/10),xt=Math.floor(lt%10/5),At=mt+xt,Pt=(_t+At)*X+(_t-1)*H+(At-1)*q+(_t>0?q:H),yt=0;dt<=Pt*Pt;){yt++;var wt=I+1+yt;if(wt>F.length-1)break;var bt=F[wt],ct=bt.x-ot.x,ut=bt.y-ot.y;dt=ct*ct+ut*ut}if(dt>Pt*Pt){yt>0&&(F.splice(I+1,yt),it.splice(I+1,yt),rt.splice(I+1,yt),ft=F[I+1],ct=ft.x-ot.x,ut=ft.y-ot.y,dt=ct*ct+ut*ut,nt=180*Math.atan2(ft.y-ot.y,ft.x-ot.x)/Math.PI);for(var Rt=[],Wt=[],Gt=_t+mt+xt,St=tt?Y:-Y,Mt=0,Lt=0;Lt<Gt;Lt++){var Tt=q;Lt<_t?(0==Lt&&(Tt=H),Lt==_t-1&&(Tt=q),Rt.push([[Mt,0],[Mt+X,0],[Mt,St],[Mt,0]])):Lt<_t+mt?Wt.push([[Mt+X,0],[Mt,St]]):Wt.push([[Mt+X,0],[Mt+X/2,St/2]]),Mt+=X+Tt}for(var G=0;G<Rt.length;G++)p=new WRAP.Geo.Feature.Line({point:O,line:Rt[G],fillStyle:a.jetstream_line_color,rotation:nt}),t.addFeature(p);Wt.length&&(p=new WRAP.Geo.Feature.Line({point:O,line:Wt,lineWidth:1,strokeStyle:a.jetstream_line_color,rotation:nt}),t.addFeature(p));var Ft=2,It=12,kt=2,zt=24,yt=nt;tt?yt<-90||yt>90?(yt+=180,Ft-=30,kt-=30):(It=-4,zt=-16):(yt<-90||yt>90)&&(yt+=180,Ft-=30,kt-=30,It=-4,zt=-16),O[2]&&(p=new WRAP.Geo.Feature.Text({point:O,text:vt,fontSize:11,fillStyle:a.jetstream_label_color,offsetX:Ft,offsetY:It,align:"left",rotation:yt}),t.addFeature(p)),pt&&gt&&(p=new WRAP.Geo.Feature.Text({point:O,text:pt+"/"+gt,fontSize:11,fillStyle:a.jetstream_label_color,offsetX:kt,offsetY:zt,align:"left",rotation:yt}),t.addFeature(p)),ht.arrow=!0}else if(dt>J*J){var Dt=Z/2,Et=[];Et.push([[0,Dt],[0,-Dt]]),Et.push([[J,Dt],[J,-Dt]]),p=new WRAP.Geo.Feature.Line({point:O,line:Et,lineWidth:1,strokeStyle:a.jetstream_line_color,rotation:nt}),ht.changeBar=p}}var Ct=ft.x-ot.x,Bt=ft.y-ot.y;p=new WRAP.Geo.Feature.Line({point:O,line:[[0,0],[Ct,Bt]],lineWidth:a.jetstream_line_width,strokeStyle:a.jetstream_line_color}),t.addFeature(p)}else if(I>0){var Nt=[];Nt.push([[0,0],[Q,-Q/2],[Q,Q/2],[0,0]]),p=new WRAP.Geo.Feature.Line({point:O,line:Nt,fillStyle:a.jetstream_line_color,rotation:nt-180}),t.addFeature(p)}}for(var I=0;I<at.length;I++){var ht=at[I];if(ht.changeBar){for(var Ut=0,jt=0,Lt=I-1;Lt>=0;Lt--)if(at[Lt].arrow){Ut=at[Lt].knots;break}for(var Lt=I+1;Lt<at.length;Lt++)if(at[Lt].arrow){jt=at[Lt].knots;break}(Ut&&Math.abs(Ut-ht.knots)>=20||jt&&Math.abs(jt-ht.knots)>=20)&&t.addFeature(ht.changeBar)}}}}}for(var d=0;d<_;d++){var x=u[d],A=x.geometry;if(A){var P=x.properties;if("TROPOPAUSE"==P.contents_kind)for(var g=0;g<A.coordinates.length;g++){var O=A.coordinates[g];if(O&&O[2]){var Vt=h(O[2]);"MINIMUM"==P.significance?(p=new WRAP.Geo.Feature.Line({point:O,line:[[-13,-7],[13,-7],[13,12],[0,19],[-13,12],[-13,-7]],lineWidth:.5,strokeStyle:"#000000",fillStyle:"#ffffff"}),t.addFeature(p),p=new WRAP.Geo.Feature.Text({point:O,text:"L",fontSize:11,fillStyle:"#000",offsetX:0,offsetY:15,align:"center"}),t.addFeature(p)):"MAXIMUM"==P.significance?(p=new WRAP.Geo.Feature.Line({point:O,line:[[-13,-12],[0,-19],[13,-12],[13,7],[-13,7],[-13,-7]],lineWidth:.5,strokeStyle:"#000000",fillStyle:"#ffffff"}),t.addFeature(p),p=new WRAP.Geo.Feature.Text({point:O,text:"H",fontSize:11,fillStyle:"#000",offsetX:0,offsetY:-7,align:"center"}),t.addFeature(p)):(p=new WRAP.Geo.Feature.Line({point:O,line:[[-13,-7],[13,-7],[13,7],[-13,7],[-13,-7]],lineWidth:.5,strokeStyle:"#000000",fillStyle:"#ffffff"}),t.addFeature(p)),p=new WRAP.Geo.Feature.Text({point:O,text:""+Vt,fontSize:11,fillStyle:"#000",offsetX:0,offsetY:4,align:"center"}),t.addFeature(p)}}}}this.content_revision=o.content,this.context_revision=o.context,this.conf_revision=o.conf,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}},WRAP.Geo.Renderer.ASCScale=function(){this.draw=function(t,e,i,r,a,n,o,s){function l(t,e,i,r,a,n){var o=[e+.17*r,i+.72*a],s=[e+.23*r,i+.46*a],l=[e+.4*r,i+.35*a],h=[e+.5*r,i+.333*a],f=[e+.6*r,i+.35*a],c=[e+.77*r,i+.46*a],u=[e+.83*r,i+.72*a],d=i+.5*a,v=i+.2*a;1==n?(t.push([o,s,l,h,f,c,u]),t.push([[e+.5*r,d],[e+.5*r,v]])):4==n&&(t.push([o,s,l,h,f,c,u]),t.push([[e+.4*r,d],[e+.4*r,v]]),t.push([[e+.6*r,d],[e+.6*r,v]]))}function h(t,e,i,r,a,n){var o=e+.2*r,s=e+.35*r,l=e+.5*r,h=e+.65*r,f=e+.8*r,c=i+.2*a,u=i+.5*a,d=i+.8*a;7==n?(t.push([[o,c],[s,c],[l,u],[h,c],[f,c]]),t.push([[s,u],[l,d],[h,u]])):t.push([[o,c],[s,c],[l,d],[h,c],[f,c]])}var f=!0;if(this.context_revision!=o.context&&(f=!1),this.content_revision!=o.content&&(f=!1),this.conf_revision!=o.conf&&(f=!1,s.length=0),!f){var c=i.Attributes.style.default;if(a&&i.Attributes.style[a]&&(c=i.Attributes.style[a]),!c)return void t.setStatus({status:"error",reason:"style definition error."});t.setStatus({status:"invalid",reason:"data load waiting."});var u=n._handler().getGrid();if(u){var d=parseInt(u.Width),v=parseInt(u.Height),g="highest";if(c.min_blocksize&&(g+=" "+c.min_blocksize),e&&e.element&&e.level){var p=Array.isArray(e.element)?e.element:[e.element],_=Array.isArray(e.level)?e.level:[e.level],m={};for(var x in e)"element"!=x&&"level"!=x&&(m[x]=e[x]);for(var A=[],P=0;P<p.length;P++){A[P]=[];for(var y=0;y<_.length;y++)A[P][y]=[]}for(var w=0;w<r.tiles.length;w++)for(var b=r.tiles[w],P=0;P<p.length;P++){m.element=p[P];for(var y=0;y<_.length;y++){m.level=_[y];var R;if(!(R=n._handler().getTile(m,b.id,g)))return void n._handler().loadTile(m,b.id,g,b.z,b.y,b.x,b.cood,b.bounds,function(){WRAP.Geo.redraw(t)});A[P][y][w]=R}}t.clear();for(var W,G=new Uint8Array(d*v),S=[],M=["rgba(0,0,0,0)",c.icing_lgt_color,c.conv_lgt_color,c.turb_mod_color,c.icing_mod_color,c.conv_mod_color,c.turb_mod_to_sev_color,c.turb_sev_color],L=[-1,0,1,2,0,1,2,2],T=10,F=12,P=0;P<p.length;P++)for(var I=p[P],y=0;y<_.length;y++)for(var k=A[P][y],w=0;w<k.length;w++)for(var n=k[w].data,z=0;z<n.length;z++){var D=n[z];if(D.value&&!isNaN(D.value)&&D.step){var E=0;if("ICING"==I?1==D.value?E=1:2==D.value&&(E=4):"CONV"==I?1==D.value?E=2:2==D.value&&(E=5):"TURB"==I&&(3==D.value?E=3:4==D.value?E=6:5==D.value&&(E=7)),E){var C=D.y*d+D.x;(!G[C]||G[C]<E)&&(G[C]=E,S[C]={lat:D.lat,lon:D.lon},W=D.step)}}}if(W)for(var B=parseFloat(u.LonInterval)*W,N=parseFloat(u.LatInterval)*W,U=B/2,j=N/2,V=1;V<=7;V++)for(var O=L[V],w=0,X=0;X<v;X++)for(var c=w,Y=0;Y<d;Y++){var D=G[w];if(D==V){var H,q=M[D],Z=S[w],J=Z.lon-U,Q=Z.lon+U,K=Z.lat+j,$=Z.lat-U;K>85&&(K=85),$<-85&&($=-85);var tt,et,it,rt;if(0==O||2==O){tt=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*K,60*J)),et=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*$,60*Q));var at=Q-J;it=256*Math.pow(2,r.zoom)*(at/360),rt=Math.abs(tt.y-et.y);var nt=Math.floor(it/F),ot=Math.floor(rt/F);if(nt&&ot){for(var st=(Q-J)/nt,lt=(K-$)/ot,ht=[],ft=0;ft<ot;ft++)for(var ct=K-lt*(ft+.5),ut=ct-lt/2,dt=0;dt<nt;dt++){var vt=J+st*(dt+.5);if(!(J<0&&vt>0)){var gt=vt-st/2;0==O?l(ht,gt,ut,st,lt,V):h(ht,gt,ut,st,lt,V)}}t.addFeature(new WRAP.Geo.Feature.GeoLine({path:ht,strokeStyle:q,lineWidth:1.5}))}}var pt=w-d*W;if(pt>0&&G[pt]<D)if(0==O){var nt=Math.floor(it/T),ot=Math.floor(rt/T);if(nt&&ot)for(var st=(Q-J)/nt,lt=(K-$)/ot,_t=.3*st,mt=.2*lt,xt=0;xt<nt;xt++){var vt=J+st*(xt+.5);t.addFeature(new WRAP.Geo.Feature.GeoLine({path:[[vt-_t,K+mt],[vt,K-mt],[vt+_t,K+mt]],strokeStyle:q,lineWidth:1.5}))}}else 1==O?t.addFeature(new WRAP.Geo.Feature.GeoLine({path:[[Q,K],[J,K]],strokeStyle:q,lineWidth:2,option:"cloud"})):2==O&&t.addFeature(new WRAP.Geo.Feature.GeoLine({path:[[[Q,K],[Q+.33*(J-Q),K]],[[Q+.66*(J-Q),K],[J,K]]],strokeStyle:q,lineWidth:2}));var At=w+d*W;if(At<G.length&&G[At]<D)if(0==O){var nt=Math.floor(it/T),ot=Math.floor(rt/T);if(nt&&ot)for(var st=(Q-J)/nt,lt=(K-$)/ot,_t=.3*st,mt=.2*lt,xt=0;xt<nt;xt++){var vt=J+st*(xt+.5);t.addFeature(new WRAP.Geo.Feature.GeoLine({path:[[vt-_t,$+mt],[vt,$-mt],[vt+_t,$+mt]],strokeStyle:q,lineWidth:1.5}))}}else 1==O?t.addFeature(new WRAP.Geo.Feature.GeoLine({path:[[J,$],[Q,$]],strokeStyle:q,lineWidth:2,option:"cloud"})):2==O&&t.addFeature(new WRAP.Geo.Feature.GeoLine({path:[[[Q,$],[Q+.33*(J-Q),$]],[[Q+.66*(J-Q),$],[J,$]]],strokeStyle:q,lineWidth:2}));var y=c+(Y-W)%d;if(G[y]<D)if(0==O){var nt=Math.floor(it/T),ot=Math.floor(rt/T);if(nt&&ot)for(var st=(Q-J)/nt,lt=(K-$)/ot,_t=.3*st,mt=.2*lt,xt=0;xt<ot;xt++){var ct=K-lt*(xt+.5);t.addFeature(new WRAP.Geo.Feature.GeoLine({path:[[J-_t,ct+mt],[J,ct-mt],[J+_t,ct+mt]],strokeStyle:q,lineWidth:1.5}))}}else 1==O?t.addFeature(new WRAP.Geo.Feature.GeoLine({path:[[J,K],[J,$]],strokeStyle:q,lineWidth:2,option:"cloud"})):2==O&&t.addFeature(new WRAP.Geo.Feature.GeoLine({path:[[[J,K],[J,K+.33*($-K)]],[[J,K+.66*($-K)],[J,$]]],strokeStyle:q,lineWidth:2}));var Pt=c+(Y+W)%d;if(G[Pt]<D)if(0==O){var nt=Math.floor(it/T),ot=Math.floor(rt/T);if(nt&&ot)for(var st=(Q-J)/nt,lt=(K-$)/ot,_t=.3*st,mt=.2*lt,xt=0;xt<ot;xt++){var ct=K-lt*(xt+.5);t.addFeature(new WRAP.Geo.Feature.GeoLine({path:[[Q-_t,ct+mt],[Q,ct-mt],[Q+_t,ct+mt]],strokeStyle:q,lineWidth:1.5}))}}else 1==O?t.addFeature(new WRAP.Geo.Feature.GeoLine({path:[[Q,$],[Q,K]],strokeStyle:q,lineWidth:2,option:"cloud"})):2==O&&t.addFeature(new WRAP.Geo.Feature.GeoLine({path:[[[Q,K],[Q,K+.33*($-K)]],[[Q,K+.66*($-K)],[Q,$]]],strokeStyle:q,lineWidth:2}))}w++}var yt=!1;if(yt)for(var w=0,X=0;X<v;X++)for(var Y=0;Y<d;Y++){var D=G[w];if(D){var H,Z=S[w];H=new WRAP.Geo.Feature.Text({point:[Z.lon,Z.lat],text:D,fontSize:12,fillStyle:"#000",offsetX:0,offsetY:6,align:"center"}),t.addFeature(H)}w++}this.context_revision=o.context,this.content_revision=o.content,this.conf_revision=r.conf,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}}}},WRAP.Geo.Renderer.Isotach=function(){var t=this;this.palette=null,this.palette_value_min=0,this.palette_value_max=0,this.palette_gradient=!0,this.palette_scale=10,this.palette_step=1,this.setPalette=function(e){if(!t.palette&&e.palette){t.palette=[],t.palette_gradient=e.palette_gradient,t.palette_step=e.palette_step||1,t.palette_scale=1/t.palette_step;for(var i=e.palette,r=[],a=0;a<i.length;a++){var n=[],o=i[a].value;0==a?(this.palette_value_min=o,this.palette_value_max=o):(this.palette_value_min>o&&(this.palette_value_min=o),this.palette_value_max<o&&(this.palette_value_max=o)),n.push(o);var s=WRAP.Geo.parseColor(i[a].color);n.push(s[0]),n.push(s[1]),n.push(s[2]),n.push(s[3]),r.push(n)}for(var l=0,h=t.palette_value_min;h<=t.palette_value_max;h+=t.palette_step){for(;l<r.length-1&&h>=r[l+1][0];)l++;if(l==r.length-1)t.palette.push([parseInt(r[l][1]),parseInt(r[l][2]),parseInt(r[l][3]),parseInt(r[l][4])]);else{var f=r[l][1],c=r[l][2],u=r[l][3],d=r[l][4];if(t.palette_gradient){var v=(h-r[l][0])/(r[l+1][0]-r[l][0]),g=r[l+1][1],p=r[l+1][2],_=r[l+1][3],m=r[l+1][4];t.palette.push([parseInt(f+(g-f)*v),parseInt(c+(p-c)*v),parseInt(u+(_-u)*v),parseInt(d+(m-d)*v)])}else t.palette.push([parseInt(f),parseInt(c),parseInt(u),parseInt(d)])}}}},this.getColor=function(e){var i=Math.floor((e-t.palette_value_min)*t.palette_scale);return i<0||i>=t.palette.length?[0,0,0,0]:t.palette[i]},this.draw=function(t,e,i,r,a,n,o,s){if(WRAP.Geo.check(s),e){var l=!0;if(this.context_revision!=o.context&&(l=!1),this.content_revision!=o.content&&(l=!1),this.conf_revision!=o.conf&&(l=!1),this.style_revision!=o.style&&(l=!1,this.palette=null),!l){var h=i.Attributes.data_scale||1,f=i.Attributes.data_offset||0,c=i.Attributes.style.default;if(!a&&i.Attributes.style_selector){if(!i.Attributes.style_selector.key||!i.Attributes.style_selector.styles)return void console.error("style_selector formar error.");for(var u=i.Attributes.style_selector.key,d=0;d<i.Attributes.style_selector.styles.length;d++){var v=i.Attributes.style_selector.styles[d].values;if(v.indexOf(e[u])>=0){a=i.Attributes.style_selector.styles[d].style;break}}}if(a&&i.Attributes.style[a]&&(c=i.Attributes.style[a]),!c)return void t.setStatus({status:"error",reason:"style definition error."});this.setPalette(c);var g="block"!=c.fill_type?"interpolate":"nearest",p=c.fill_type,_=c.contour;t.setStatus({status:"invalid",reason:"data load waiting."});for(var m=[],d=0;d<r.tiles.length;d++){var x=r.tiles[d];if(!(m[d]=n._handler().getTile(e,x.id,g)))return void n._handler().loadTile(e,x.id,g,x.z,x.y,x.x,x.cood,x.bounds,function(){WRAP.Geo.redraw(t)})}t.clear();for(var d=0;d<m.length;d++){var A=m[d];if(A&&!A.empty){var x=r.tiles[d],P=x.ctx.createImageData(256,256),c=this.getData(e,A.data);if(c){var y=P.data;if(p)for(var w=0;w<65536;w++){var b=c[w];if(void 0!==b){b=b*h+f;var R=this.getColor(b),W=4*w;y[W]=R[0],y[W+1]=R[1],y[W+2]=R[2],y[W+3]=R[3]}}var G=[];if(_){for(var S=0,M=0,W=0;W<65536;W++){var b=c[W];void 0!==b&&(0==W?S=M=b:(S>b&&(S=b),M<b&&(M=b)))}for(var L=0;L<_.length;L++)for(var T=_[L],R=WRAP.Geo.parseColor(T.strokeStyle),F=T.unit_label||"",I=void 0===T.fractional_digits?void 0:parseInt(T.fractional_digits),k=T.interval/h,z=T.base,b=(T.base-f)/h,D=0;D<T.num;D++){if(S<=b&&b<=M){for(var E=-1,C=0,B=0,N=0,U=0;U<256;U++)for(var j=0==U?0:-256,V=255==U?0:256,O=0;O<256;O++){var X=0==O?0:-1,Y=255==O?0:1,H=c[N];if(H>=b){var q=c[N+j],Z=c[N+X],J=c[N+Y],Q=c[N+V];if(q<b||Z<b||J<b||Q<b){y[4*N]=R[0],y[4*N+1]=R[1],y[4*N+2]=R[2],y[4*N+3]=R[3],T.lineWidth>1&&(y[4*N+4]=R[0],y[4*N+5]=R[1],y[4*N+6]=R[2],y[4*N+7]=R[3],y[4*N+1024]=R[0],y[4*N+1024+1]=R[1],y[4*N+1024+2]=R[2],y[4*N+1024+3]=R[3]);var K=Math.abs(O-128)+Math.abs(U-128);(E<0||K<E)&&(E=K,C=O,B=U)}}N++}if(20<C&&C<=236&&20<B&&B<=236){var $=void 0===I?z:z.toFixed(I);G.push({x:C,y:B,value:$+F,color:T.textColor})}}z+=T.interval,b+=k}}var tt=new WRAP.Geo.Feature.Tile({tile:x,imageData:P});t.addFeature(tt);for(var K=0;K<G.length;K++){var tt,et=65792,it=x.cood[et],rt=x.cood[et+1];tt=new WRAP.Geo.Feature.Text({point:[rt,it],text:G[K].value,fontSize:12,fillStyle:G[K].color,offsetX:G[K].x-128,offsetY:G[K].y-128,align:"center"}),t.addFeature(tt)}}}}this.context_revision=o.context,this.content_revision=o.content,this.conf_revision=r.conf,this.style_revision=o.style,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}}},WRAP.Geo.Renderer.Isotach.prototype.getData=function(t,e){if(t.element&&Array.isArray(t.element)){for(var i=e[0],r=e[1],a=[],n=0;n<65536;n++){var o=i[n],s=r[n];isNaN(o)||isNaN(s)||(a[n]=Math.sqrt(o*o+s*s)/.514)}return a}},WRAP.Geo.Renderer.IcingProbavility=function(){this.style_revision,this.context_revision,this.draw=function(t,e,i,r,a,n,o,s){if(WRAP.Geo.check(s),e&&this.context_revision!=o.context){this.style_revision!=o.style&&(this.style_revision=o.style);var l=i.Attributes.style.default;if(a&&i.Attributes.style[a]&&(l=i.Attributes.style[a]),!l)return void t.setStatus({status:"error",reason:"style definition error."});var h="value";l.min_blocksize&&(h+=" "+l.min_blocksize),t.setStatus({status:"invalid",reason:"data load waiting."});for(var f=[],c=0;c<r.tiles.length;c++){var u=r.tiles[c];if(!(f[c]=n._handler().getTile(e,u.id,h)))return void n._handler().loadTile(e,u.id,h,u.z,u.y,u.x,u.cood,u.bounds,function(){WRAP.Geo.redraw(t)})}t.clear();for(var c=0;c<f.length;c++)for(var n=f[c].data,d=0;d<n.length;d++){var v=n[d];if(v.value&&2==v.value.length){var g=v.value[0];if(!isNaN(g)){var p=v.value[1];if(!isNaN(p)&&(g-=273.15,-15<=g&&g<=0&&p>=90)){var _,m="";_=new WRAP.Geo.Feature.Text({point:[v.lon,v.lat],text:m,fontSize:14,fillStyle:l.icon_color,offsetX:0,offsetY:-7,align:"center"}),t.addFeature(_)}}}}this.context_revision=r.revision,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}},WRAP.Geo.Renderer.GridLine=function(){this.draw=function(t,e,i,r,a,n,o){function s(t){if(0==G)return!1;var e=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(90*G*60,0)),i=WRAP.Geo.getScreenPoint(t);return Math.abs(e.x-i.x)<200&&Math.abs(e.y-i.y)<200}n=null,e=null,r=null;var l=i.Attributes.style.default;if(a&&i.Attributes.style[a]&&(l=i.Attributes.style[a]),!l)return void t.setStatus({status:"error",reason:"style definition error."});t.setStatus({status:"invalid",reason:"drawing."}),t.clear();var h,f,c,u,d,v=l.grid_interval||10,g=l.line_width||1,p=l.line_color,_=l.font_size||14,m=l.text_color||"black",x=l.text_edge_color;l.position&&(h=l.position.indexOf("top")>=0,f=l.position.indexOf("bottom")>=0,c=l.position.indexOf("left")>=0,u=l.position.indexOf("right")>=0,d=l.position.indexOf("equator")>=0);var A=90,P=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(5100,0)),y=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(5100,180)),w=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(-5100,0)),b=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(-5100,180)),R=Math.abs(P.x-y.x),W=Math.abs(w.x-b.x),G=0;Math.abs(R-W)>100&&(G=R<W?1:-1,A=80);for(var S=[],M=[],L=0;L<=180;)0==L||180==L?M.push({lon:L,text:L}):(M.push({lon:L,text:"E"+L}),M.push({lon:-L,text:"W"+L})),L+=v;for(var T=0;T<=A;)0==T?S.push({lat:T,text:T}):(S.push({lat:T,text:"N"+T}),S.push({lat:-T,text:"S"+T})),T+=v;for(L=0;L<M.length;L++){var F=M[L].lon;t.addFeature(new WRAP.Geo.Feature.GeoLine({path:[[F,A],[F,-A]],lineWidth:g,strokeStyle:p,geodesic:!1}));var I=4;for(T=0;T<S.length;T++){for(var k=S[T].lat,z=[[F,k]],D=0;D<I;D++)z.push([F+(D+1)*(v/I),k]);t.addFeature(new WRAP.Geo.Feature.GeoLine({path:z,lineWidth:g,strokeStyle:p,geodesic:!1}))}}for(var E=WRAP.Geo.getSize(),F=10;F<E.width-10;F++){if(h){var C=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(F,0)),B=C.lonDegree();for(L=0;L<M.length;L++){var N=M[L],U=N.lon,j=Math.abs(U-B);(!N.top||N.top.d>j)&&(N.top={d:j,point:C})}}if(f){var C=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(F,E.height)),B=C.lonDegree();for(L=0;L<M.length;L++){var N=M[L],U=N.lon,j=Math.abs(U-B);(!N.bottom||N.bottom.d>j)&&(N.bottom={d:j,point:C})}}}for(var k=20;k<E.height-20;k++){if(c){var C=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(0,k)),B=C.latDegree();for(T=0;T<S.length;T++){var N=S[T],U=N.lat,j=Math.abs(U-B);(!N.left||N.left.d>j)&&(N.left={d:j,point:C})}}if(u){var C=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(E.width,k)),B=C.latDegree();for(T=0;T<S.length;T++){var N=S[T],U=N.lat,j=Math.abs(U-B);(!N.right||N.right.d>j)&&(N.right={d:j,point:C})}}}for(L=0;L<M.length;L++){var N;if((N=M[L].top)&&N.d<4){if(s(N.point))continue;t.addFeature(new WRAP.Geo.Feature.Text({point:[N.point.lonDegree(),N.point.latDegree()],text:M[L].text,fontSize:_,strokeStyle:x,fillStyle:m,offsetX:0,offsetY:_+2,align:"center"}))}if((N=M[L].bottom)&&N.d<4){if(s(N.point))continue;t.addFeature(new WRAP.Geo.Feature.Text({point:[N.point.lonDegree(),N.point.latDegree()],text:M[L].text,fontSize:_,strokeStyle:x,fillStyle:m,offsetX:0,offsetY:-4,align:"center"}))}}for(T=0;T<S.length;T++){if((N=S[T].left)&&N.d<4){if(s(N.point))continue;t.addFeature(new WRAP.Geo.Feature.Text({point:[N.point.lonDegree(),N.point.latDegree()],text:S[T].text,fontSize:_,strokeStyle:x,fillStyle:m,offsetX:2,offsetY:_/2,align:"left"}))}if((N=S[T].right)&&N.d<4){if(s(N.point))continue;t.addFeature(new WRAP.Geo.Feature.Text({point:[N.point.lonDegree(),N.point.latDegree()],text:S[T].text,fontSize:_,strokeStyle:x,fillStyle:m,offsetX:-3,offsetY:_/2,align:"right"}))}}if(d){var E=WRAP.Geo.getSize(),V=G>=0?10:-10;for(L=0;L<M.length;L++){var O=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(0,60*M[L].lon));if(!(O.x<20||O.y<20||O.x>E[0]-20||O.y>E[1]-20)){var X=WRAP.Geo.getScreenPoint(new WRAP.Geo.Point(60*V,60*M[L].lon)),Y=X.x-O.x,H=X.y-O.y,q=16/Math.sqrt(Y*Y+H*H),Z=Y*q,J=H*q;t.addFeature(new WRAP.Geo.Feature.Text({point:[M[L].lon,0],text:M[L].text,fontSize:_,strokeStyle:x,fillStyle:m,offsetX:Z,offsetY:J+_/2,align:"center"}))}}}this.context_revision=o.context,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}},WRAP.Geo.Renderer.TropicalStorm=function(){this.draw=function(t,e,i,r,a,n,o,s){function l(e,i,r,a,n,o){if(i||r){var s=WRAP.Geo.getGCPoint(e,i,a),l=WRAP.Geo.getGCPoint(e,r,a),h=new WRAP.Geo.Feature.GeoLine({path:[[s.lonDegree(),s.latDegree()],[l.lonDegree(),l.latDegree()]],strokeStyle:n,lineWidth:o});t.addFeature(h)}}function h(e,i){var r=1852,a=i.stmrds_gale_1||0,n=i.stmrds_gale_2||0,o=i.stmrds_gale_3||0,s=i.stmrds_gale_4||0,h=i.stmrds_storm_1||0,f=i.stmrds_storm_2||0,c=i.stmrds_storm_3||0,d=i.stmrds_storm_4||0,v=i.stmrds_hurricane_1||0,g=i.stmrds_hurricane_2||0,p=i.stmrds_hurricane_3||0,_=i.stmrds_hurricane_4||0,m=i.stmrda_gale_1||0,x=i.stmrda_gale_2||0,A=i.stmrda_gale_3||0,P=i.stmrda_gale_4||0,y=i.stmrda_storm_1||0,w=i.stmrda_storm_2||0,b=i.stmrda_storm_3||0,R=i.stmrda_storm_4||0,W=i.stmrda_hurricane_1||0,G=i.stmrda_hurricane_2||0,S=i.stmrda_hurricane_3||0,M=i.stmrda_hurricane_4||0,L=u.wind_line_color_gale,T=u.wind_line_color_storm,F=u.wind_line_color_hurricane,I=u.wind_fill_color_gale,k=u.wind_fill_color_storm,z=u.wind_fill_color_hurricane,D=a*r,E=n*r,C=o*r,B=s*r,N=h*r,U=f*r,j=c*r,V=d*r,O=v*r,X=g*r,Y=p*r,H=_*r;if(D){var q=new WRAP.Geo.Feature.GeoArc({point:e,radius:D,start:m,end:x,strokeStyle:L,lineWidth:u.wind_line_width,fillStyle:I});t.addFeature(q)}if(E){var q=new WRAP.Geo.Feature.GeoArc({point:e,radius:E,start:x,end:A,strokeStyle:L,lineWidth:u.wind_line_width,fillStyle:I});t.addFeature(q)}if(C){var q=new WRAP.Geo.Feature.GeoArc({point:e,radius:C,start:A,end:P,strokeStyle:L,lineWidth:u.wind_line_width,fillStyle:I});t.addFeature(q)}if(B){var q=new WRAP.Geo.Feature.GeoArc({point:e,radius:B,start:P,end:m+360,strokeStyle:L,lineWidth:u.wind_line_width,fillStyle:I});t.addFeature(q)}var Z=new WRAP.Geo.Point(60*e[1],60*e[0]);if(l(Z,D,B,m,L,u.wind_line_width),l(Z,D,E,x,L,u.wind_line_width),l(Z,E,C,A,L,u.wind_line_width),l(Z,C,B,P,L,u.wind_line_width),N){var q=new WRAP.Geo.Feature.GeoArc({point:e,radius:N,start:y,end:w,strokeStyle:T,lineWidth:u.wind_line_width,fillStyle:k});t.addFeature(q)}if(U){var q=new WRAP.Geo.Feature.GeoArc({point:e,radius:U,start:w,end:b,strokeStyle:T,lineWidth:u.wind_line_width,fillStyle:k});t.addFeature(q)}if(j){var q=new WRAP.Geo.Feature.GeoArc({point:e,radius:j,start:b,end:R,strokeStyle:T,lineWidth:u.wind_line_width,fillStyle:k});t.addFeature(q)}if(V){var q=new WRAP.Geo.Feature.GeoArc({point:e,radius:V,start:R,end:y+360,strokeStyle:T,lineWidth:u.wind_line_width,fillStyle:k});t.addFeature(q)}if(l(Z,N,V,y,T,u.wind_line_width),l(Z,N,U,w,T,u.wind_line_width),l(Z,U,j,b,T,u.wind_line_width),l(Z,j,V,R,T,u.wind_line_width),O){var q=new WRAP.Geo.Feature.GeoArc({point:e,radius:O,start:W,end:G,strokeStyle:F,lineWidth:u.wind_line_width,fillStyle:z});t.addFeature(q)}if(X){var q=new WRAP.Geo.Feature.GeoArc({point:e,radius:X,start:G,end:S,strokeStyle:F,lineWidth:u.wind_line_width,fillStyle:z});t.addFeature(q)}if(Y){var q=new WRAP.Geo.Feature.GeoArc({point:e,radius:Y,start:S,end:M,strokeStyle:F,lineWidth:u.wind_line_width,fillStyle:z});t.addFeature(q)}if(H){var q=new WRAP.Geo.Feature.GeoArc({point:e,radius:H,start:M,end:W+360,strokeStyle:F,lineWidth:u.wind_line_width,fillStyle:z});t.addFeature(q)}l(Z,O,H,W,F,u.wind_line_width),l(Z,O,X,G,F,u.wind_line_width),l(Z,X,Y,S,F,u.wind_line_width),l(Z,Y,H,M,F,u.wind_line_width)}WRAP.Geo.check(t,e,i,r,a,n,o,s);var f=!0;if(this.conf_revision!=o.conf&&(f=!1),this.style_revision!=o.style&&(f=!1),this.data_revision!=o.data&&(f=!1),!f){t.setStatus({status:"invalid",reason:"data load waiting."});var c=n.query("data").value();if(c){var u=i.Attributes;void 0!==u.show_forcast_track&&(u.show_forecast_track=u.show_forcast_track),void 0!==u.show_forcast_wind_radii&&(u.show_forecast_wind_radii=u.show_forcast_wind_radii),t.clear();for(var d in c){var v=c[d];if(v.features&&v.display_flag!==!1){for(var g=[],p=[],_=0;_<v.features.length;_++){var m=v.features[_],x=m.properties,A=x.wrap_feature_type,P=m.geometry.coordinates;"track"==A?g.push(P):"forecast"==A&&p.push(P)}for(var _=0;_<v.features.length;_++){var m=v.features[_],x=m.properties,A=x.wrap_feature_type,P=m.geometry.coordinates;"analysis"==A&&(g.push(P),p.unshift(P))}var y=["analysis"];if(void 0===u.show_track_history||u.show_track_history===!0){y.push("track");var w=new WRAP.Geo.Feature.GeoLine({path:g,strokeStyle:u.track_history_line_color,lineWidth:u.track_history_line_width});t.addFeature(w)}if(void 0===u.show_forecast_track||u.show_forecast_track===!0){y.push("forecast");var w=new WRAP.Geo.Feature.GeoLine({
path:p,strokeStyle:u.forecst_track_line_color,lineWidth:u.forecst_track_line_width});t.addFeature(w)}if(void 0===u.show_analysis_wind_radii||u.show_analysis_wind_radii===!0)for(var _=0;_<v.features.length;_++){var m=v.features[_],x=m.properties;if("analysis"==x.wrap_feature_type){var P=m.geometry.coordinates;h(P,x)}}if(!(void 0!==u.show_forecast_track&&u.show_forecast_track!==!0||void 0!==u.show_forecast_wind_radii&&u.show_forecast_wind_radii!==!0))for(var _=0;_<v.features.length;_++){var m=v.features[_],x=m.properties;if("forecast"==x.wrap_feature_type){var P=m.geometry.coordinates;h(P,x)}}var b=null;if(u.track_circle_time){for(var _=0;_<v.features.length;_++){var m=v.features[_],x=m.properties;if("track"==x.wrap_feature_type&&x.valid&&x.valid==u.track_circle_time){b=m;break}}if(b){var P=b.geometry.coordinates,x=b.properties;h(P,x)}}if(void 0===u.show_datetime||u.show_datetime===!0)for(var _=0;_<v.features.length;_++){var m=v.features[_],x=m.properties;if(b){if(m!=b)continue}else{if("track"==x.wrap_feature_type)continue;if(y.indexOf(x.wrap_feature_type)<0)continue}var R=x.valid;if(R&&R.length>=11){var W="",G=u.date_format;if(G){var S=0,M=0,L=0,T=0,F=0,I=0;S=parseInt(R.substr(0,4)),M=parseInt(R.substr(4,2)),L=parseInt(R.substr(6,2)),T=parseInt(R.substr(9,2)),F=parseInt(R.substr(11,2)),R.length>=13&&(I=parseInt(R.substr(13,2))),W=WRAP.Geo.formatTime(G,S,M,L,T,F,I)}else W=R.substr(6,2),W+=" / ",W+=R.substr(9,2),W+="Z";var k=u.label_font_size||12,P=m.geometry.coordinates,w=new WRAP.Geo.Feature.Text({text:W,point:P,strokeStyle:u.label_edge_color,fillStyle:u.label_text_color,offsetX:u.label_offset_x,offsetY:u.label_offset_y,align:"left",fontSize:k});w.geo=m,t.addFeature(w)}}for(var _=0;_<v.features.length;_++){var m=v.features[_],x=m.properties;if(!(y.indexOf(x.wrap_feature_type)<0||"analysis"==x.wrap_feature_type&&1==y.length)){var A=x.class,P=m.geometry.coordinates,z=u.icon[A];if(P[1]<0&&u.icon_south&&u.icon_south[A]&&(z=u.icon_south[A]),u.custom_icon_time&&u.custom_icon&&("analysis"==x.wrap_feature_type&&u.custom_icon_time==x.wrap_feature_type||x.valid==u.custom_icon_time)&&(z=u.custom_icon),z){var w=new WRAP.Geo.Feature.Image({image:z,point:P,width:u.icon_width,height:u.icon_height,offsetX:u.icon_offset_x,offsetY:u.icon_offset_y});w.geo=m,t.addFeature(w)}}}}}this.conf_revision=o.conf,this.style_revision=o.style,this.data_revision=o.data,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}}},WRAP.Geo.Renderer.Typhoon=function(){this.draw=function(t,e,i,r,a,n,o,s){function l(t){return"N"==t?0:"NE"==t?45:"E"==t?90:"SE"==t?135:"S"==t?180:"SW"==t?225:"W"==t?270:"NW"==t?315:-1}function h(t,e,i,r){var a=i[0]-t[0];a<-180?a+=360:a>=180&&(a-=360);var n=i[1]-t[1],o=r-e,s=a*a+n*n;if(0==s||s<o*o)return[];var l=Math.sqrt(s-o*o),h=(l*a-n*o)/s,f=(-l*n-a*o)/s,c=f>=0?Math.acos(h):-Math.acos(h),u=(-l*a-n*o)/s,d=(l*n-a*o)/s,v=d>=0?Math.acos(u):-Math.acos(u);return[180*c/Math.PI,180*v/Math.PI]}function f(t,e,i){i||(i=1e-4);var r=WRAP.Geo.getGCPoint(new WRAP.Geo.Point(60*t[1],60*t[0]),1e3*i,e),a=r.latDegree()-t[1],n=r.lonDegree()-t[0];return n<-180&&(n+=360),n>=180&&(n-=360),Math.sqrt(a*a+n*n)}function c(t,e,i,r){if(e){e*=1e3;var a,n=new WRAP.Geo.Point(60*t.c[1],60*t.c[0]);i&&(t.llcd=i[0],a=WRAP.Geo.getGCPoint(n,e,t.llcd),t.llcp=[a.lonDegree(),a.latDegree()],t.rlcd=i[1],a=WRAP.Geo.getGCPoint(n,e,t.rlcd),t.rlcp=[a.lonDegree(),a.latDegree()]),r&&(t.lncd=r[0],a=WRAP.Geo.getGCPoint(n,e,t.lncd),t.lncp=[a.lonDegree(),a.latDegree()],t.rncd=r[1],a=WRAP.Geo.getGCPoint(n,e,t.rncd),t.rncp=[a.lonDegree(),a.latDegree()])}else t.llcd=t.lncd=0,t.llcp=t.lncp=t.p,t.rlcd=t.rncd=0,t.rlcp=t.rncp=t.p}function u(t,e){if(t<0&&(t+=360),e<0&&(e+=360),e<t){var i=t;t=e,e=i}if(e-t>=180){t+=360;var i=t;t=e,e=i}return[t,e]}function d(t,e){var i=t[0],r=t[1],a=e[0],n=e[1],o=0,s=!1,l=[],h=[];if(a<i){s=!0;var f;f=i,i=a,a=f}var c=i;i=0,a-=c,r*=Math.PI/180,i*=Math.PI/180,n*=Math.PI/180,a*=Math.PI/180,l[0]=Math.cos(r)*Math.cos(i),l[1]=Math.cos(r)*Math.sin(i),l[2]=Math.sin(r),h[0]=Math.cos(n)*Math.cos(a),h[1]=Math.cos(n)*Math.sin(a),h[2]=Math.sin(n);var u=Math.acos(l[0]*h[0]+l[1]*h[1]+l[2]*h[2]),d=Math.sin(u),v=Math.cos(r)*d;if(Math.abs(v)>.001){var t=(Math.sin(n)-Math.sin(r)*Math.cos(u))/v;t<-1&&(t=-1),t>1&&(t=1),o=Math.acos(t);for(var g=a-i;g<-Math.PI;)g+=2*Math.PI;for(;g>Math.PI;)g-=2*Math.PI;g<0&&(o=2*Math.PI-o)}else o=0;return s&&(o=-o),o*(180/Math.PI)}function v(t,e,i){var r=d(e,t),a=d(e,i),n=r-a;return n>=180&&(n-=360),n<-180&&(n+=360),n}WRAP.Geo.check(t,e,i,r,a,n,o,s);var g=!0;if(this.conf_revision!=o.conf&&(g=!1),this.style_revision!=o.style&&(g=!1),this.data_revision!=o.data&&(g=!1),!g){t.setStatus({status:"invalid",reason:"data load waiting."});var p=n.query("data").value();if(p){var _=i.Attributes;void 0!==_.show_forcast_track&&(_.show_forecast_track=_.show_forcast_track),void 0!==_.show_forcast_wind_radii&&(_.show_forecast_wind_radii=_.show_forcast_wind_radii);var m=_.show_forecast_circle!==!1,x=_.show_forecast_track!==!1,A=_.show_track!==!1&&_.show_track_history!==!1,P=_.show_estimate!==!1,y=_.show_analysis_wind_radii!==!1,w=_.show_swca!==!1||_.show_forecast_wind_radii!==!1,b=_.show_td_low!==!1,R=_.show_datetime!==!1,W=_.show_number!==!1,G=_.track_circle_time,S=_.custom_icon_time,M=_.contact_angle_threshold;void 0===M&&(M=20);var L=[];b||(L=["LOW","TD"]);var T=_.date_format,F=_.label_font_size||12,I=_.number_label,k=_.number_label_offset_x||0,z=_.number_label_offset_y||0,D=_.number_label_text_color||"black",E=_.number_label_edge_color||"white",C=_.number_label_font_size||F;m||x||A||y||w||(R=!1,W=!1),t.clear();for(var B in p){var N=p[B];if(N.features&&N.display_flag!==!1){var U=null;if(N.tc_number==B){N=JSON.parse(JSON.stringify(N));for(var j=0;j<N.features.length;j++){var V=N.features[j];V.original_data=JSON.parse(JSON.stringify(V));var O=V.properties;O.wrap_feature_type="track",O.analyzed_date=new WRAP.Core.DateTime(O.analysis_date).text(),O.specification={class:O.class};var X=O.storm,Y=O.gale;O.storm={wide_direction:X.wide_direction,area:{narrow:1.852*X.narrow_radius,wide:1.852*X.wide_radius}},O.gale={wide_direction:Y.wide_direction,area:{narrow:1.852*Y.narrow_radius,wide:1.852*Y.wide_radius}}}}for(var H=null,q=null,j=0;j<N.features.length;j++){var V=N.features[j];if(V.geometry){var O=V.properties;if(!O||O.display_flag!==!1){var Z=O.wrap_feature_type;if("estimate"==Z){if(!P)continue;H=V,q=new WRAP.Core.DateTime(O.wrap_estimated_date),q.add(10800);break}}}}for(var J=null,Q=[],K=[],j=0;j<N.features.length;j++){var V=N.features[j];if(V.geometry){var O=V.properties;if(!O||O.display_flag!==!1){var Z=V.properties.wrap_feature_type;if("track"==Z){if(Q.push(V),j<N.features.length-1){var $=N.features[j+1].properties;V.properties.next_time=$.analyzed_date||$.wrap_estimated_date||$.wrap_forecst_date}if(!A)continue}else if("analysis"==Z){if(J=V,H&&(Z="track",!A))continue}else if("estimate"==Z){if(!H)continue}else if("forecast"==Z&&q){var tt=new WRAP.Core.DateTime(O.wrap_forecast_date);if(q.diff(tt)<0)continue}K.push({feature:V,type:Z})}}}var et=H||J;U=et;for(var it=[],rt=[],at=[],nt={},ot=[],st=-1,lt=!0,ht=[],j=0;j<K.length;j++){var V=K[j].feature,O=V.properties,ft=V.geometry.coordinates,ct=O.specification.class,ut=L.indexOf(ct)>=0&&"track"==O.wrap_feature_type;if(lt&&(ut?ht=[]:(ht.push(ft),1==ht.length&&it.push(ht))),V==et&&(lt=!1,ht=[]),!lt&&x&&(ht.push(ft),1==ht.length&&rt.push(ht)),V==et){if(O.gale.area){var dt=O.gale.area.narrow,vt=O.gale.area.wide;if(!isNaN(dt)&&!isNaN(vt)&&(dt>0||vt>0)){var gt=(dt+vt)/2;nt.p=ft,nt.r=gt,nt.c=ft;var pt=l(O.gale.wide_direction);if(pt>=0){var _t=vt-gt,mt=WRAP.Geo.getGCPoint(new WRAP.Geo.Point(60*ft[1],60*ft[0]),1e3*_t,pt);nt.c=[mt.lonDegree(),mt.latDegree()]}}}if(O.storm.area){var dt=O.storm.area.narrow,vt=O.storm.area.wide;if(!isNaN(dt)&&!isNaN(vt)&&(dt>0||vt>0)){st=0;var gt=(dt+vt)/2,xt={p:ft};xt.f=0,xt.r=gt,xt.c=ft;var pt=l(O.storm.wide_direction);if(pt>=0){var _t=vt-gt,mt=WRAP.Geo.getGCPoint(new WRAP.Geo.Point(60*ft[1],60*ft[0]),1e3*_t,pt);xt.c=[mt.lonDegree(),mt.latDegree()]}ot.push(xt)}}at.push({p:ft,c:ft})}else if(!lt&&!ut){if(O.forecast_circle){var xt={p:ft,c:ft};isNaN(xt.a=O.forecast_circle.radius)||at.push(xt)}if(O.swca&&O.swca.area){var xt={p:ft},dt=O.swca.area.narrow,vt=O.swca.area.wide;if(!isNaN(dt)&&!isNaN(vt)&&(dt>0||vt>0)){var gt=(dt+vt)/2;xt.r=gt,xt.c=ft;var pt=l(O.swca.direction);if(pt>=0){var _t=vt-gt,mt=WRAP.Geo.getGCPoint(new WRAP.Geo.Point(60*ft[1],60*ft[0]),1e3*_t,pt);xt.c=[mt.lonDegree(),mt.latDegree()]}ot.push(xt)}}}}for(var j=0;j<at.length;j++){var xt=at[j],At=null,Pt=null;if(j>0){var yt=at[j-1],wt=Math.abs(xt.p[0]-yt.p[0]),bt=Math.abs(xt.p[1]-yt.p[1]),Rt=wt/(wt+bt),Wt=90*Rt,Gt=f(xt.p,Wt,xt.a),St=f(yt.p,Wt,yt.a),Mt=h(yt.p,St,xt.p,Gt);Mt&&2==Mt.length&&(At=Mt)}if(j<at.length-1){var $=at[j+1],wt=Math.abs(xt.p[0]-$.p[0]),bt=Math.abs(xt.p[1]-$.p[1]),Rt=wt/(wt+bt),Wt=90*Rt,Gt=f(xt.p,Wt,xt.a),Lt=f($.p,Wt,$.a),Mt=h(xt.p,Gt,$.p,Lt);Mt&&2==Mt.length&&(Pt=Mt)}c(xt,xt.a,At,Pt)}for(var j=0;j<ot.length;j++){var Wt=90,xt=ot[j],At=null,Pt=null;if(j>0){var yt=ot[j-1],wt=Math.abs(xt.p[0]-yt.p[0]),bt=Math.abs(xt.p[1]-yt.p[1]),Rt=wt/(wt+bt),Wt=90*Rt,Gt=f(xt.p,Wt,xt.r),St=f(yt.p,Wt,yt.r),Mt=h(yt.p,St,xt.p,Gt);Mt&&2==Mt.length&&(At=Mt)}if(j<ot.length-1){var $=ot[j+1],wt=Math.abs(xt.p[0]-$.p[0]),bt=Math.abs(xt.p[1]-$.p[1]),Rt=wt/(wt+bt),Wt=90*Rt,Gt=f(xt.p,Wt,xt.r),Lt=f($.p,Wt,$.r),Mt=h(xt.p,Gt,$.p,Lt);Mt&&2==Mt.length&&(Pt=Mt)}c(xt,xt.r,At,Pt)}if(A){var Tt=new WRAP.Geo.Feature.GeoLine({path:it,strokeStyle:_.track_history_line_color,lineWidth:_.track_history_line_width,lineDash:_.track_history_line_dash});t.addFeature(Tt)}var Tt=new WRAP.Geo.Feature.GeoLine({path:rt,strokeStyle:_.forecst_track_line_color,lineWidth:_.forecst_track_line_width,lineDash:_.forecst_track_line_dash});if(t.addFeature(Tt),G)for(var Ft=new WRAP.Core.DateTime(G),j=Q.length-1;j>=0;j--){var V=Q[j],O=V.properties,It=O.analyzed_date;if(It&&It.length>=11&&0==Ft.diff(new WRAP.Core.DateTime(It))){var ft=V.geometry.coordinates;if(O.gale.area){var dt=O.gale.area.narrow,vt=O.gale.area.wide;if(!isNaN(dt)&&!isNaN(vt)&&(dt>0||vt>0)){var gt=(dt+vt)/2,nt={};nt.p=ft,nt.r=gt,nt.c=ft;var pt=l(O.gale.wide_direction);if(pt>=0){var _t=vt-gt,mt=WRAP.Geo.getGCPoint(new WRAP.Geo.Point(60*ft[1],60*ft[0]),1e3*_t,pt);nt.c=[mt.lonDegree(),mt.latDegree()]}var Tt=new WRAP.Geo.Feature.GeoArc({point:nt.c,radius:1e3*nt.r,start:0,end:360,strokeStyle:_.wind_line_color_gale,fillStyle:_.wind_fill_color_gale,lineWidth:_.wind_line_width,lineDash:_.wind_line_dash});t.addFeature(Tt)}}if(O.storm.area){var dt=O.storm.area.narrow,vt=O.storm.area.wide;if(!isNaN(dt)&&!isNaN(vt)&&(dt>0||vt>0)){var gt=(dt+vt)/2,xt={p:ft};xt.f=0,xt.r=gt,xt.c=ft;var pt=l(O.storm.wide_direction);if(pt>=0){var _t=vt-gt,mt=WRAP.Geo.getGCPoint(new WRAP.Geo.Point(60*ft[1],60*ft[0]),1e3*_t,pt);xt.c=[mt.lonDegree(),mt.latDegree()]}var Tt=new WRAP.Geo.Feature.GeoArc({point:xt.c,radius:1e3*xt.r,start:0,end:360,strokeStyle:_.wind_line_color_storm,lineWidth:_.wind_line_width,lineDash:_.wind_line_dash,fillStyle:_.wind_fill_color_storm});t.addFeature(Tt)}}break}}if(m){for(var j=0;j<at.length;j++){var xt=at[j];if(xt.a){var Tt=new WRAP.Geo.Feature.GeoArc({point:xt.p,radius:1e3*xt.a,start:0,end:360,strokeStyle:_.forecst_circle_line_color,lineWidth:_.forecst_circle_line_width,lineDash:_.forecst_circle_line_dash});t.addFeature(Tt)}}for(var j=1;j<at.length;j++){var yt=at[j-1],xt=at[j],kt=!1,zt=!1;if(yt.lncp&&xt.llcp&&yt.rncp&&xt.rlcp){var Dt=v(xt.llcp,yt.lncp,yt.p),Et=v(yt.lncp,xt.llcp,xt.p),St=v(xt.rlcp,yt.rncp,yt.p),Gt=v(yt.rncp,xt.rlcp,xt.p),Ct=Math.abs(Math.abs(Dt)-90),Bt=Math.abs(Math.abs(Et)-90),Nt=Math.abs(Math.abs(St)-90),Ut=Math.abs(Math.abs(Gt)-90);if(yt.a||(Ct=Nt=0),!M||Ct<M&&Bt<M){kt=!0;var Tt=new WRAP.Geo.Feature.GeoLine({path:[[yt.lncp,xt.llcp]],strokeStyle:_.forecst_area_line_color,lineWidth:_.forecst_area_line_width,lineDash:_.forecst_area_line_dash,geodesic:!0});t.addFeature(Tt)}if(!M||Nt<M&&Ut<M){zt=!0;var Tt=new WRAP.Geo.Feature.GeoLine({path:[[yt.rncp,xt.rlcp]],strokeStyle:_.forecst_area_line_color,lineWidth:_.forecst_area_line_width,lineDash:_.forecst_area_line_dash,geodesic:!0});t.addFeature(Tt)}t.addFeature(Tt)}if(kt&&xt.llcd!=xt.lncd&&!isNaN(xt.llcd)&&!isNaN(xt.lncd)){var jt=xt.llcd,Vt=xt.lncd,Ot=Vt-jt;if(Ot<-180?Ot+=360:Ot>=180&&(Ot-=360),Ot>0){var pt=u(jt,Vt),Tt=new WRAP.Geo.Feature.GeoArc({point:xt.p,radius:1e3*xt.a,start:pt[0],end:pt[1],strokeStyle:_.forecst_area_line_color,lineWidth:_.forecst_area_line_width,lineDash:_.forecst_area_line_dash});t.addFeature(Tt)}}if(zt&&xt.rlcd!=xt.rncd&&!isNaN(xt.rlcd)&&!isNaN(xt.rncd)){var jt=xt.rncd,Vt=xt.rlcd,Ot=Vt-jt;if(Ot<-180?Ot+=360:Ot>=180&&(Ot-=360),Ot>0){var pt=u(jt,Vt),Tt=new WRAP.Geo.Feature.GeoArc({point:xt.p,radius:1e3*xt.a,start:pt[0],end:pt[1],strokeStyle:_.forecst_area_line_color,lineWidth:_.forecst_area_line_width,lineDash:_.forecst_area_line_dash});t.addFeature(Tt)}}}}if(y||w){if(nt&&nt.c&&nt.r){var Tt=new WRAP.Geo.Feature.GeoArc({point:nt.c,radius:1e3*nt.r,start:0,end:360,strokeStyle:_.wind_line_color_gale,fillStyle:_.wind_fill_color_gale,lineWidth:_.wind_line_width,lineDash:_.wind_line_dash});t.addFeature(Tt)}if(0==st&&ot&&ot.length&&ot[0].c&&ot[0].r){var xt=ot[0],Tt=new WRAP.Geo.Feature.GeoArc({point:xt.c,radius:1e3*xt.r,start:0,end:360,strokeStyle:_.wind_line_color_storm,lineWidth:_.wind_line_width,lineDash:_.wind_line_dash,fillStyle:_.wind_fill_color_storm});t.addFeature(Tt)}}if(w)for(var j=st+1;j<ot.length;j++){var xt=ot[j],Tt=new WRAP.Geo.Feature.GeoArc({point:xt.c,radius:1e3*xt.r,start:0,end:360,strokeStyle:_.wind_line_color_storm,lineWidth:_.wind_line_width,lineDash:_.wind_line_dash,fillStyle:_.wind_fill_color_storm});if(t.addFeature(Tt),j>0){var yt=ot[j-1],Tt=new WRAP.Geo.Feature.GeoLine({path:[[yt.lncp,xt.llcp],[yt.rncp,xt.rlcp]],strokeStyle:_.wind_line_color_storm,lineWidth:_.wind_line_width,lineDash:_.wind_line_dash});t.addFeature(Tt)}}if(R)for(var j=0;j<K.length;j++){var V=K[j].feature,O=V.properties,It=O.wrap_forecast_date||O.wrap_estimated_date||O.analyzed_date;if(It&&It.length>=11){var Z=K[j].type;if(G){if(It!=G)continue}else{if("track"==Z)continue;if("forecast"==Z&&!x)continue}var Xt="";if(T){var Yt=0,Ht=0,qt=0,Zt=0,Jt=0,Qt=0;Yt=parseInt(It.substr(0,4)),Ht=parseInt(It.substr(4,2)),qt=parseInt(It.substr(6,2)),Zt=parseInt(It.substr(9,2)),Jt=parseInt(It.substr(11,2)),It.length>=13&&(Qt=parseInt(It.substr(13,2))),Xt=WRAP.Geo.formatTime(T,Yt,Ht,qt,Zt,Jt,Qt)}else Xt=It.substr(6,2),Xt+=" / ",Xt+=It.substr(9,2),Xt+="Z";var ft=V.geometry.coordinates,Tt=new WRAP.Geo.Feature.Text({text:Xt,point:ft,strokeStyle:_.label_edge_color,fillStyle:_.label_text_color,offsetX:_.label_offset_x,offsetY:_.label_offset_y,align:"left",fontSize:F});Tt.geo=V.original_data||V,t.addFeature(Tt)}}for(var j=0;j<K.length;j++){var V=K[j].feature,Z=K[j].type,O=V.properties,ct=O.specification.class;if(!("track"==Z&&L.indexOf(ct)>=0)&&("forecast"!=Z||x)&&("analysis"!=Z&&"estimate"!=Z||A||x)){var ft=V.geometry.coordinates,Kt=null;if(_.icon[Z]&&((Kt=_.icon[Z].icon)||(Kt=_.icon[Z].class_icon&&_.icon[Z].class_icon[ct])),ft[1]<0&&_.icon_south&&_.icon_south[Z]){var $t=null;($t=_.icon[Z].icon)||($t=_.icon[Z].class_icon&&_.icon[Z].class_icon[ct]),$t&&(Kt=$t)}if(S&&_.icon.custom_icon)if("analysis"!=Z&&"estimate"!=Z||S!=Z){var It=O.wrap_forecast_date||O.wrap_estimated_date||O.analyzed_date;It==S&&(Kt=null)}else Kt=null;if(Kt){var Tt=new WRAP.Geo.Feature.Image({image:Kt,point:ft,width:_.icon_width,height:_.icon_height,offsetX:_.icon_offset_x,offsetY:_.icon_offset_y});Tt.geo=V.original_data||V,t.addFeature(Tt)}}}for(var j=0;j<K.length;j++){var V=K[j].feature,Z=K[j].type,O=V.properties,Kt=null;if(S&&_.icon.custom_icon&&("analysis"!=Z&&"estimate"!=Z||S!=Z?A&&S==O.analyzed_date?Kt=_.icon.custom_icon:!x||S!=O.wrap_estimated_date&&S!=O.wrap_forecast_date||(Kt=_.icon.custom_icon):(A||x)&&(Kt=_.icon.custom_icon)),Kt){U=V;var ft=V.geometry.coordinates,Tt=new WRAP.Geo.Feature.Image({image:Kt,point:ft,width:_.icon_width,height:_.icon_height,offsetX:_.icon_offset_x,offsetY:_.icon_offset_y});Tt.geo=V.original_data||V,t.addFeature(Tt)}}if(W&&I&&U&&N.index&&N.index.no){var Xt=""+N.index.no;Xt.length>2&&(Xt=Xt.slice(-2)),Xt=I.replace("%d%",Xt);var ft=U.geometry.coordinates,Tt=new WRAP.Geo.Feature.Text({text:Xt,point:ft,strokeStyle:E,fillStyle:D,fontSize:C,offsetX:k,offsetY:z,align:"left"});t.addFeature(Tt)}}}this.conf_revision=o.conf,this.style_revision=o.style,this.data_revision=o.data,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}}},WRAP.Geo.Renderer.GASSScale=function(){var t=this;this.draw=function(e,i,r,a,n,o,s,l){if(WRAP.Geo.check(n),i){var h=!0;if(this.context_revision!=s.context&&(h=!1),this.content_revision!=s.content&&(h=!1),this.conf_revision!=s.conf&&(t.palette=null,l.length=0,e.clear(),h=!1),this.style_revision!=s.style&&(h=!1,this.palette=null),!h){e.setStatus({status:"invalid",reason:"data load waiting."});for(var f="nearest",c=[],u=[],d=0;d<a.tiles.length;d++){for(var v=a.tiles[d],g=0;g<l.length;g++){var p=l[g];if(p.data&&p.data.tile&&p.data.tile.id==v.id&&p.data.revision==s.content){u.push(p),v=null;break}}v&&c.push(v)}for(var _=[],d=0;d<c.length;d++){var v=c[d];if(!(_[d]=o._handler().getTile(i,v.id,f)))return void o._handler().loadTile(i,v.id,f,v.z,v.y,v.x,v.cood,v.bounds,function(){WRAP.Geo.redraw(e)})}e.clear();for(var d=0;d<u.length;d++)e.addFeature(u[d]);for(var m=r.Attributes.vis2,x=r.Attributes.vis3,A=r.Attributes.cig2,P=r.Attributes.cig3,y=WRAP.Geo.parseColor(r.Attributes.color1),w=WRAP.Geo.parseColor(r.Attributes.color2),b=WRAP.Geo.parseColor(r.Attributes.color3),d=0;d<_.length;d++){var R=_[d],W=null;if(R&&!R.empty&&(W=this.getData(i,R.data)),W){for(var v=c[d],G=v.ctx.createImageData(256,256),S=G.data,M=W[0],L=W[1],T=99999999,F=99999999,I=0;I<65536;I++){var k=M[I];if(!isNaN(k)){var z=L[I];if(!isNaN(z)&&(T>k&&(T=k),F>z&&(F=z),0!=k||0!=z)){var D=y;k<=x||z<=P?D=b:(k<=m||z<=A)&&(D=w);var E=4*I;S[E]=D[0],S[E+1]=D[1],S[E+2]=D[2],S[E+3]=D[3]}}}var C=new WRAP.Geo.Feature.Tile({tile:v,imageData:G});e.addFeature(C)}}this.context_revision=s.context,this.content_revision=s.content,this.conf_revision=s.conf,this.style_revision=s.style,e.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}}},WRAP.Geo.Renderer.GASSScale.prototype.getData=function(t,e){return t.element&&Array.isArray(t.element)?e:null},WRAP.Geo.Renderer.HiLo=function(){this.style_revision,this.context_revision,this.draw=function(t,e,i,r,a,n,o,s){function l(t,e){if(!(e<0||e>=m.length)){if(S)t<0&&(t+=x.length),t>=x.length&&(t-=x.length);else if(t<0||t>=x.length)return;var i=e*x.length+t,r=L[i].v;return r&&!isNaN(r.value)?r.value:void 0}}function h(t,e){if(e<0||e>=m.length)return null;if(S)t<0&&(t+=x.length),t>=x.length&&(t-=x.length);else if(t<0||t>=x.length)return null;return L[e*x.length+t]}if(WRAP.Geo.check(s),e&&this.context_revision!=o.context){this.style_revision!=o.style&&(this.style_revision=o.style);var f=i.Attributes.style.default;if(a&&i.Attributes.style[a]&&(f=i.Attributes.style[a]),!f)return void t.setStatus({status:"error",reason:"style definition error."});var c="value 1";t.setStatus({status:"invalid",reason:"data load waiting."});for(var u=[],d=0;d<r.tiles.length;d++){var v=r.tiles[d];if(!(u[d]=n._handler().getTile(e,v.id,c)))return void n._handler().loadTile(e,v.id,c,v.z,v.y,v.x,v.cood,v.bounds,function(){WRAP.Geo.redraw(t)})}var g=i.Attributes.data_scale||1,p=i.Attributes.data_offset||0,_=void 0===f.fractional_digits?1:parseInt(f.fractional_digits);t.clear();for(var m=[],x=[],d=0;d<u.length;d++)for(var n=u[d].data,A=0;A<n.length;A++){var P=n[A];m.indexOf(P.lat)<0&&m.push(P.lat),x.indexOf(P.lon)<0&&x.push(P.lon)}if(m.sort(function(t,e){return t>e?-1:t<e?1:0}),x.sort(function(t,e){return t<e?-1:t>e?1:0}),x.length>1){for(var y=360,d=0;d<x.length-1;d++){var w=x[d+1]-x[d];y>w&&(y=w)}var b=1.5*y,R=x[x.length-1],W=x[0];if(W+360-R<b){x.push(x.shift());for(var G=0;x[0]-x[x.length-1]<b&&(x.push(x.shift()),!(++G>=x.length)););}}for(var S=360/x.length==y,M=m.length*x.length,L=[],d=0;d<M;d++)L[d]={v:null};for(var d=0;d<u.length;d++)for(var n=u[d].data,A=0;A<n.length;A++){var P=n[A],T=m.indexOf(P.lat),F=x.indexOf(P.lon),I=T*x.length+F;0<=I&&I<M&&(L[I].v=P)}for(var T=0;T<m.length;T++)for(var F=0;F<x.length;F++){var I=T*x.length+F,P=L[I].v;if(P&&!(isNaN(P.lat)||P.lat>80||P.lat<-70||P.lat<=4&&P.lat>=-4||isNaN(P.value))){for(var k,z,D=0;;){if(k=l(F+D,T+D),z=l(F+D+1,T+D+1),k&&z&&z<k)break;if(k=l(F+D,T),z=l(F+D+1,T),k&&z&&z<k)break;if(k=l(F+D,T-D),z=l(F+D+1,T-D-1),k&&z&&z<k)break;if(k=l(F,T-D),z=l(F,T-D-1),k&&z&&z<k)break;if(k=l(F-D,T-D),z=l(F-D-1,T-D-1),k&&z&&z<k)break;if(k=l(F-D,T),z=l(F-D-1,T),k&&z&&z<k)break;if(k=l(F-D,T+D),z=l(F-D-1,T+D+1),k&&z&&z<k)break;if(k=l(F,T+D),z=l(F,T+D+1),k&&z&&z<k)break;if(3<=++D){L[I].lo=!0;break}}for(D=0;;){if(k=l(F+D,T+D),z=l(F+D+1,T+D+1),k&&z&&z>k)break;if(k=l(F+D,T),z=l(F+D+1,T),k&&z&&z>k)break;if(k=l(F+D,T-D),z=l(F+D+1,T-D-1),k&&z&&z>k)break;if(k=l(F,T-D),z=l(F,T-D-1),k&&z&&z>k)break;if(k=l(F-D,T-D),z=l(F-D-1,T-D-1),k&&z&&z>k)break;if(k=l(F-D,T),z=l(F-D-1,T),k&&z&&z>k)break;if(k=l(F-D,T+D),z=l(F-D-1,T+D+1),k&&z&&z>k)break;if(k=l(F,T+D),z=l(F,T+D+1),k&&z&&z>k)break;if(3<=++D){L[I].hi=!0;break}}}}for(var T=0;T<m.length;T++)for(var F=0;F<x.length;F++){var I=T*x.length+F,E=L[I];if(E.lo){var C;C=h(F+1,T+1),C&&C.lo&&(C.lo=!1),C=h(F+1,T),C&&C.lo&&(C.lo=!1),C=h(F+1,T-1),C&&C.lo&&(C.lo=!1),C=h(F,T+1),C&&C.lo&&(C.lo=!1),C=h(F,T-1),C&&C.lo&&(C.lo=!1),C=h(F-1,T+1),C&&C.lo&&(C.lo=!1),C=h(F-1,T),C&&C.lo&&(C.lo=!1),C=h(F-1,T-1),C&&C.lo&&(C.lo=!1)}if(E.hi){var C;C=h(F+1,T+1),C&&C.hi&&(C.hi=!1),C=h(F+1,T),C&&C.hi&&(C.hi=!1),C=h(F+1,T-1),C&&C.hi&&(C.hi=!1),C=h(F,T+1),C&&C.hi&&(C.hi=!1),C=h(F,T-1),C&&C.hi&&(C.hi=!1),C=h(F-1,T+1),C&&C.hi&&(C.hi=!1),C=h(F-1,T),C&&C.hi&&(C.hi=!1),C=h(F-1,T-1),C&&C.hi&&(C.hi=!1)}}for(var d=0;d<L.length;d++){var E=L[d];if(E.lo){var B=(E.v.value*g+p).toFixed(_);f.unit_label&&(B+=f.unit_label);var N;N=new WRAP.Geo.Feature.Point({point:[E.v.lon,E.v.lat],fillStyle:f.lo_point_color,strokeStyle:f.lo_point_edge_color,strokeWidth:2,pointSize:f.point_size}),t.addFeature(N),N=new WRAP.Geo.Feature.Text({point:[E.v.lon,E.v.lat],text:B,fontSize:f.text_font_size,fillStyle:f.lo_text_color,strokeStyle:f.lo_text_edge_color,offsetX:f.text_offset_x,offsetY:f.text_offset_y,align:"center"}),t.addFeature(N),N=new WRAP.Geo.Feature.Text({point:[E.v.lon,E.v.lat],text:f.lo_mark,fontSize:f.mark_font_size,fillStyle:f.lo_mark_color,strokeStyle:f.lo_mark_edge_color,offsetX:f.mark_offset_x,offsetY:f.mark_offset_y,align:"center"}),t.addFeature(N)}else if(E.hi){var B=(E.v.value*g+p).toFixed(_);f.unit_label&&(B+=f.unit_label);var N;N=new WRAP.Geo.Feature.Point({point:[E.v.lon,E.v.lat],fillStyle:f.hi_point_color,strokeStyle:f.hi_point_edge_color,strokeWidth:2,pointSize:f.point_size}),t.addFeature(N),N=new WRAP.Geo.Feature.Text({point:[E.v.lon,E.v.lat],text:B,fontSize:f.text_font_size,fillStyle:f.hi_text_color,strokeStyle:f.hi_text_edge_color,offsetX:f.text_offset_x,offsetY:f.text_offset_y,align:"center"}),t.addFeature(N),N=new WRAP.Geo.Feature.Text({point:[E.v.lon,E.v.lat],text:f.hi_mark,fontSize:f.mark_font_size,fillStyle:f.hi_mark_color,strokeStyle:f.hi_mark_edge_color,offsetX:f.mark_offset_x,offsetY:f.mark_offset_y,align:"center"}),t.addFeature(N)}}this.context_revision=o.context,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}},WRAP.Geo.Renderer.Front=function(){this.draw=function(t,e,i,r,a,n,o,s){function l(t,e){var i,r=e[0]-t[0];i=r>=180?r-360:r<-180?r+360:r;var a=e[1]-t[1];return Math.sqrt(i*i+a*a)}function h(t,e){var i,r=e[0]-t[0];i=r>=180?r-360:r<-180?r+360:r;var a=e[1]-t[1],n=Math.atan2(a,i),o=180*n/Math.PI;return o+90}function f(t,e,i,r,a,n){if(r<i&&(r+=360),r-i>200)return 0;for(;i<=r;){var o=Math.PI*i/180,s=e*Math.sin(o),l=-e*Math.cos(o),h=[];if(h[0]=t[0]+s,h[1]=t[1]+l,n.push(h),i==r)break;i+=a,r<i&&(i=r)}}function c(t,e,i,r){var a,n,o=t[0],s=e[0];(t[0]>=0&&e[0]<0||e[0]>=0&&t[0]<0)&&(t[0]<=-90&&(o=t[0]+360),e[0]<=-90&&(s=e[0]+360)),a=o<s?(s-o)/r:-((o-s)/r),n=t[1]<e[1]?(e[1]-t[1])/r:-((t[1]-e[1])/r);for(var l=1;l<=r;l++){var h=[];t[0]+a*l>180?(h[0]=t[0]+a*l-360,h[1]=t[1]+n*l):t[0]+a*l<=-180?(h[0]=360+t[0]+a*l,h[1]=t[1]+n*l):(h[0]=t[0]+a*l,h[1]=t[1]+n*l),i.push(h)}}function u(t,e,i,r,n){"WFRONT"==t?d(1,e,i,r,a.warm_color):"CFRONT"==t?v(1,e,i,r,a.cold_color):"OFRONT"==t?n%2?d(1,e,i,r,a.occluded_color):v(1,e,i,r,a.occluded_color):"SFRONT"==t&&(n%2?d(0,e,i,r,a.warm_color):v(1,e,i,r,a.cold_color))}function d(e,i,r,a,n){var o=h(r,i),s=h(r,a),l=[],c=m*A;if(e?f(r,c,s,o,10,l):f(r,c,o,s,10,l),l.length){l.unshift(r),l.push(r);var u=new WRAP.Geo.Feature.GeoLine({path:l,fillStyle:n});t.addFeature(u)}}function v(e,i,r,a,n){var o=h(a,i);e?o-=90:o+=90;var s=x*A,l=Math.PI*o/180,f=s*Math.sin(l),c=-s*Math.cos(l),u=Math.PI/2,d=s*Math.sin(l-u),v=-s*Math.cos(l-u),g=s*Math.sin(l+u),p=-s*Math.cos(l+u),_=r[0]+f,m=r[1]+c,P=r[0]+d,y=r[1]+v,w=r[0]+g,b=r[1]+p,R=new WRAP.Geo.Feature.GeoLine({path:[[P,y],[_,m],[w,b],[P,y]],fillStyle:n});t.addFeature(R)}WRAP.Geo.check(t,e,i,r,a,n,o,s);var g=-1;if(r&&r.tiles.length&&(g=r.zoom),i.Attributes.min_zoom){if(this.last_zoom==g&&this.content_revision==o.content&&this.context_revision==o.context&&this.conf_revision==o.conf&&this.style_revision==o.style&&this.data_revision==o.data)return}else if(this.content_revision==o.content&&this.context_revision==o.context&&this.conf_revision==o.conf&&this.style_revision==o.style&&this.data_revision==o.data)return;t.setStatus({status:"invalid",reason:"data load waiting."});var p=n._handler().getData(e,r);if(!p)return void n._handler().loadData(e,r,function(){WRAP.Geo.redraw(t)});var a=i.Attributes,_=.05,m=1.5,x=2,A=360/(256*Math.pow(2,r.zoom));A*=a.size_factor;var P=Math.ceil(a.interval_factor*A);P<3&&(P=3);var y=Math.ceil(P/3);if(t.clear(),!a.min_zoom||g>=a.min_zoom){for(var w=[],b=0;b<p.length;b++){var R=p[b].features;if(R)for(var W=0;W<R.length;W++)w.push(R[W]);else"Feature"==p[b].type&&w.push(p[b])}for(var G=w.length,b=0;b<G;b++){var S=w[b],M=S.geometry;if(M){var L=S.properties,T=M.coordinates;if(T&&T.length){var F=[],I=T[0];F.push(I);for(var W=1;W<T.length;W++){var k=T[W],z=l(I,k),D=Math.floor(z/_);D>=1&&(c(I,k,F,D),I=k),F.push(k)}var E=new WRAP.Geo.Feature.GeoLine({path:F,lineWidth:a.line_width,strokeStyle:a.line_color});t.addFeature(E)}}}for(var b=0;b<G;b++){var S=w[b],M=S.geometry;if(M){var L=S.properties,T=M.coordinates;if(T&&T.length){var F=[],C=0,I=T[0];F.push(I);for(var W=1;W<T.length;W++){var k=T[W],z=l(I,k),D=Math.floor(z/_);for(D>=1&&(c(I,k,F,D),I=k);C*y*5+4*y<F.length;){var B=C*y*5;u(L.type,F[B],F[B+1*y],F[B+2*y],C+1),C++}F.push(k)}}}}}this.content_revision=o.content,this.context_revision=o.context,this.conf_revision=o.conf,this.style_revision=o.style,this.data_revision=o.data,this.last_zoom=g,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}},WRAP.Geo.Renderer.ScreenGridValue=function(){this.draw=function(t,e,i,r,a,n,o,s){if(WRAP.Geo.check(t,e,i,r,a,n,o,s),e&&n&&n._handler()){var l=!0;if(this.context_revision!=o.context&&(l=!1),this.content_revision!=o.content&&(l=!1),this.conf_revision!=o.conf&&(l=!1,s.length=0),!l){t.setStatus({status:"invalid",reason:"data load waiting."});for(var h=null,f=[],c=[],u=0;u<r.tiles.length;u++){for(var d=r.tiles[u],v=0;v<s.length;v++){var g=s[v];if(g.data&&g.data.tile&&g.data.tile.id==d.id&&g.data.revision==o.content){c.push(g),d=null;break}}d&&f.push(d)}for(var p=[],u=0;u<f.length;u++){var d=f[u];if(!(p[u]=n._handler().getTile(e,d.id,h)))return void n._handler().loadTile(e,d.id,h,d.z,d.y,d.x,d.cood,d.bounds,function(){WRAP.Geo.redraw(t)})}var _=i.Attributes&&i.Attributes.value_table;if(!_||256!=_.length)return void t.setStatus({status:"error",reason:"value_table definition error."});var m=i.Attributes.grid_size||16,x=i.Attributes.font_size||10,A=i.Attributes.color||"black",P=i.Attributes.offset_x||0,y=i.Attributes.offset_y||0,w=i.Attributes.align||"center";t.clear();for(var b=WRAP.Geo.getSize(),R=0;R<b.height;R+=m)for(var W=0;W<b.width;W+=m){var G=WRAP.Geo.getPoint(new WRAP.Geo.ScreenPoint(W,R)),S=this.getValue(e,r,n,G);if(S&&S.data){var M=_[S.data[0]];if(M&&M.length>0){var L=new WRAP.Geo.Feature.Text({point:[G.lonDegree(),G.latDegree()],text:M,fontSize:x,fillStyle:A,offsetX:P,offsetY:y,align:w});t.addFeature(L)}}}this.context_revision=o.context,this.content_revision=o.content,this.conf_revision=r.conf,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}},this.getValue=function(t,e,i,r){for(var a=0;a<e.tiles.length;a++){var n=e.tiles[a],o=n.bounds.north,s=n.bounds.south;if(!(r.lat>o||r.lat<s)){var l=n.bounds.east;l<-10800?l+=21600:l>=10800&&(l-=21600);var h=n.bounds.west;if(h<-10800?h+=21600:h>=10800&&(h-=21600),h<l){if(r.lon>l||r.lon<h)continue}else if(r.lon>l&&r.lon<h)continue;var f=i._handler().getTile(t,n.id);if(f){var c=r.latDegree(),u=r.lonDegree();u<0&&(u+=360);for(var a=0,d=0;d<256&&n.cood[a]>c;)d++,a+=512;d>255&&(d=255),a=512*d;for(var v=0;v<256;){var g=n.cood[a+1];if(g<0?g+=360:g>=180&&(g-=360),u<=g)break;v++,a+=2}v>255&&(v=255);var p=4*(256*d+v);return{data:[f.data[p],f.data[p+1],f.data[p+2],f.data[p+3]]}}break}}return null}},WRAP.Geo.Renderer.ACOS=function(){var t=this;this.current_content={},this.draw=function(e,i,r,a,n,o,s,l){WRAP.Geo.check(e,i,r,a,n,o,s,l);var h=-1;if(a&&a.tiles.length&&(h=a.zoom),r.Attributes.min_zoom){if(this.last_zoom==h&&this.content_revision==s.content&&this.conf_revision==s.conf&&this.style_revision==s.style&&this.data_revision==s.data)return}else if(this.content_revision==s.content&&this.conf_revision==s.conf&&this.style_revision==s.style&&this.data_revision==s.data)return;var n=r.Attributes;if(e.clear(),e.setStatus({status:"invalid",reason:"data load waiting."}),i)for(var f=0;f<i.length;f++){var c=i[f];c.id&&(t.current_content[c.id]=c)}var u=o.query("index").value();if(u)for(var d in t.current_content)u[d]||delete t.current_content[d];else u={},t.current_content={};if(i&&(!n.min_zoom||h>=n.min_zoom))for(var d in t.current_content){var v=t.current_content[d],g=null,p=u[v.id];if(p)for(var _=0;_<p.length;_++)if(p[_].erupted_date==v.basetime){g=p[_];break}if(g&&v.level&&v.ft)for(var _=0;_<v.ft.length;_++){var m=new WRAP.Core.DateTime(v.basetime),x=parseFloat(v.ft[v.ft.length-1-_]);m.add(3600*x);var A=g.floating_ash_flag,P=g.validtime;if(P)for(var y=0;y<P.length;y++){var w=new WRAP.Core.DateTime(P[y]);if(m.diff(w)<=0){var b=v.basetime,R=w.text(),W=v.level,G=o._handler().getContour(d,b,R,W);if(!G)return void o._handler().loadData(d,b,R,W,function(){WRAP.Geo.redraw(e)});if(G.length){var S="rgba(255,255,255,0.5)",M="rgba(255,255,255,1.0)",L=1,T=n[x];T&&(S=T.fill_color,M=T.line_color,L=T.line_width);var F=null;if(A){var I=document.createElement("canvas");I.width=16,I.height=16;var k=I.getContext("2d");k.strokeStyle=M,k.lineWidth=L;for(var y=0;y<48;y+=8)k.moveTo(-16,y),k.lineTo(32,y-48);k.stroke();var z=I.toDataURL("image/png");F=new WRAP.Geo.Feature.GeoLine({path:G,fillImage:z,strokeStyle:M,lineWidth:L,geodesic:!1}),e.addFeature(F)}else F=new WRAP.Geo.Feature.GeoLine({path:G,fillStyle:S,strokeStyle:M,lineWidth:L,geodesic:!1}),e.addFeature(F);F&&(F.geo={geometry:{type:"Polygon",coordinates:G},properties:{id:d,ft:x,fl:v.level,basetime:v.basetime,validtime:w.text()}})}break}}}}this.content_revision=s.content,this.conf_revision=s.conf,this.style_revision=s.style,this.data_revision=s.data,this.last_zoom=h,e.setStatus({status:"valid"}),WRAP.Geo.invalidate()}},WRAP.Geo.Renderer.ElevationMap=function(){this.draw=function(t,e,i,r,a,n,o,s){function l(t,e,i){var a=Math.pow(2,i);if(e<0||e>=a/2)return null;t<0?t+=a:t>=a&&(t-=a);for(var n=0;n<r.tiles.length;n++){var o=r.tiles[n];if(o.x==t&&o.y==e&&o.z==i)return m[n]}return null}if(n&&n._handler){var h=!0;if(this.context_revision!=o.context&&(h=!1),this.conf_revision!=o.conf&&(h=!1,s.length=0,this.palette=null),this.style_revision!=o.style&&(h=!1,s.length=0,this.palette=null),!h){var f=i.Attributes.style.default;if(a&&i.Attributes.style[a]&&(f=i.Attributes.style[a]),!f)return void t.setStatus({status:"error",reason:"style definition error."});t.setStatus({status:"invalid",reason:"data load waiting."});var c=3,u=null,d=0,v=0,g=[];
e={map:"BlueMarble"};for(var p=0;p<r.tiles.length;p++){var _=r.tiles[p];if(g[p]=n._handler().getTile(e,_.id,u))d++;else if(n._handler().loadTile(e,_.id,u,_.z,_.y,_.x,_.cood,null,function(){WRAP.Geo.redraw(t)}),--c<=0)break}var m=[];e={map:"Elevation"};for(var p=0;p<r.tiles.length;p++){var _=r.tiles[p];if(m[p]=n._handler().getTile(e,_.id,u))v++;else if(n._handler().loadTile(e,_.id,u,_.z,_.y,_.x,_.cood,_.bounds,function(){WRAP.Geo.redraw(t)}),--c<=0)break}t.clear();for(var p=0;p<g.length;p++){var _=r.tiles[p];if(_){var x=g[p];if(x&&!x.empty&&x.data){var A=m[p];A&&(A.around=[l(_.x-1,_.y-1,_.z),l(_.x,_.y-1,_.z),l(_.x+1,_.y-1,_.z),l(_.x+1,_.y,_.z),l(_.x+1,_.y+1,_.z),l(_.x,_.y+1,_.z),l(_.x-1,_.y+1,_.z),l(_.x-1,_.y,_.z)]);var P=new WRAP.Geo.Feature.Tile({tile:_,imageData:x,elevationData:A});P.data={tile:_,revision:o.content},t.addFeature(P)}}}for(var p=0;p<r.tiles.length;p++){var P,_=r.tiles[p],y=_.cood,w=65792,b=_.cood[w],R=_.cood[w+1];P=new WRAP.Geo.Feature.Text({point:[R,b,2e3],text:_.id,fontSize:14,fillStyle:"rgb(255,0,0)",offsetX:0,offsetY:0,align:"center"});var W=[y[1],y[0]],G=[y[511],y[510]],S=[y[130561],y[130560]],M=[y[131071],y[131070]];P=new WRAP.Geo.Feature.GeoLine({path:[W,G,M,S,W],lineWidth:1,strokeStyle:"rgb(40,40,200)",geodesic:!1})}var P;P=new WRAP.Geo.Feature.GeoArc({point:[145,45],radius:3e5,start:0,end:360,lineWidth:1,strokeStyle:"blue"}),this.context_revision=o.context,this.conf_revision=r.conf,this.style_revision=o.style,t.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}}},WRAP.Geo.Renderer.WindFlow=function(){function t(t){var e,i,r,a,n=[[0,1013.2],[1e3,977.2],[2e3,942.1],[3e3,908.1],[4e3,875.1],[5e3,843.1],[6e3,812],[7e3,781.8],[8e3,752.6],[9e3,724.3],[1e4,696.8],[11e3,670.2],[12e3,644.4],[13e3,619.4],[14e3,596.2],[15e3,571.8],[16e3,549.2],[17e3,527.2],[18e3,506],[19e3,485.5],[2e4,465.6],[21e3,446.4],[22e3,427.9],[23e3,410],[24e3,392.7],[25e3,376],[26e3,359.9],[27e3,344.3],[28e3,329.3],[29e3,314.8],[3e4,300.9],[31e3,287.4],[32e3,274.5],[33e3,262],[34e3,250],[35e3,238.4],[36e3,227.3],[37e3,216.6],[38e3,206.5],[39e3,196.8],[4e4,187.5],[41e3,178.7],[42e3,170.4],[43e3,162.4],[44e3,154.7],[45e3,147.5],[46e3,140.6],[47e3,134],[48e3,127.7],[49e3,121.7],[5e4,116],[51e3,110.5],[52e3,105.3],[53e3,100.4]],o=n[0],s=0;for(s=1;s<n.length;s++){var l=n[s];if(t>=l[1])return i=o[1]-l[1],r=(o[1]-t)/i,a=(t-l[1])/i,e=l[0]*r+o[0]*a;o=l}return s==n.length?(i=n[s-2][1]-n[s-1][1],r=(n[s-2][1]-t)/i,a=(t-n[s-1][1])/i,e=n[s-1][0]*r+n[s-2][0]*a):-1}var e=this;this.mask={n:[],width:360,height:180,clear:function(){for(var t=0;t<64800;t++)this.n[t]=0},activeLL:function(t,e){var i=Math.floor(e),r=Math.floor(90-t);return this.n[this.index(i,r)]},index:function(t,e){return e*this.width+t},setPixelValidX:function(t,e){e<0||this.height<=e||(this.n[this.index(t,e)]=1)},setPixelValidY:function(t,e){t<0||this.width<=t||(this.n[this.index(t,e)]=1)},lineLL:function(t,e,i,r,a){var n=Math.floor(e),o=Math.floor(r),s=Math.floor(90-t),l=Math.floor(90-i);n==o&&s==l&&(o+=1);var h=o-n;h>180?this.line(n,s,o-360,l,a):h<-180?this.line(n,s,o+360,l,a):this.line(n,s,o,l,a)},line1:function(t,e,i,r){var a=this.width,n=this.height;if(!(t<0&&i<0||a<=t&&a<=i||e<0&&r<0||n<=e&&n<=r)){var o=i-t,s=r-e;if(0!=o){if(0!=s)if(Math.abs(o)>Math.abs(s)){var l=s/o;if(t<i)for(var h=t<0?0:t,f=a<=i?a-1:i,c=h;c<=f;c+=1){var u=Math.floor(l*(c-t+.5)+e);this.setPixelValidX(c,u)}else for(var h=i<0?0:i,f=a<=t?a-1:t,c=f;c>=h;c-=1){var u=Math.floor(l*(c-t+.5)+e);this.setPixelValidX(c,u)}}else{var l=o/s;if(e<r)for(var h=e<0?0:e,f=n<=r?n-1:r,u=h;u<=f;u+=1){var c=Math.floor(l*(u-e+.5)+t);this.setPixelValidY(c,u)}else for(var h=r<0?0:r,f=n<=e?n-1:e,u=f;u>=h;u-=1){var c=Math.floor(l*(u-e+.5)+t);this.setPixelValidY(c,u)}}else if(t<i){t<0&&(t=0),a<=i&&(i=a);for(var d=this.index(t,e),c=t;c<i;c++)this.n[d++]=1}else if(i<t){i<0&&(i=0),a<=t&&(t=a);for(var d=this.index(i,r),c=i;c<t;c++)this.n[d++]=1}}else if(e<r){e<0&&(e=0),n<=r&&(r=n);for(var d=this.index(t,e),u=e;u<r;u++)this.n[d]=1,d+=a}else if(r<e){r<0&&(r=0),n<=e&&(e=n);for(var d=this.index(i,r),u=r;u<e;u++)this.n[d]=1,d+=a}}},line:function(t,e,i,r,a){var n=a/2;this.line1(t,e,i,r);for(var o=1;o<=n;o++)this.line1(t,e-o,i,r-o),this.line1(t,e+o,i,r+o),this.line1(t-o,e,i-o,r),this.line1(t+o,e,i+o,r)},count:function(){for(var t=0,e=0;e<64800;e++)this.n[e]&&t++;return t}},this.palette=null,this.palette_value_min=0,this.palette_value_max=0,this.palette_gradient=!0,this.palette_scale=10,this.palette_step=1,this.color=null,this.setPalette=function(t){if(!e.color&&t.color&&(e.color=WRAP.Geo.parseColor(t.color)),!e.palette&&t.palette){e.palette=[],e.palette_gradient=t.palette_gradient,e.palette_step=t.palette_step||1,e.palette_scale=1/e.palette_step;for(var i=t.palette,r=[],a=0;a<i.length;a++){var n=[],o=i[a].value;0==a?(this.palette_value_min=o,this.palette_value_max=o):(this.palette_value_min>o&&(this.palette_value_min=o),this.palette_value_max<o&&(this.palette_value_max=o)),n.push(o);var s=WRAP.Geo.parseColor(i[a].color);n.push(s[0]),n.push(s[1]),n.push(s[2]),n.push(s[3]),r.push(n)}for(var l=0,h=e.palette_value_min;h<=e.palette_value_max;h+=e.palette_step){for(;l<r.length-1&&h>=r[l+1][0];)l++;if(l==r.length-1)e.palette.push([parseInt(r[l][1]),parseInt(r[l][2]),parseInt(r[l][3]),parseInt(r[l][4])]);else{var f=r[l][1],c=r[l][2],u=r[l][3],d=r[l][4];if(e.palette_gradient){var v=(h-r[l][0])/(r[l+1][0]-r[l][0]),g=r[l+1][1],p=r[l+1][2],_=r[l+1][3],m=r[l+1][4];e.palette.push([parseInt(f+(g-f)*v),parseInt(c+(p-c)*v),parseInt(u+(_-u)*v),parseInt(d+(m-d)*v)])}else e.palette.push([parseInt(f),parseInt(c),parseInt(u),parseInt(d)])}}}},this.getColor=function(t){if(!e.palette)return[1,1,1,.5];var i=Math.floor((t-e.palette_value_min)*e.palette_scale);if(i<0)return[0,0,0,0];i>=e.palette.length&&(i=e.palette.length-1);var r=e.palette[i];return[r[0]/255,r[1]/255,r[2]/255,r[3]/255]},this.draw=function(i,r,a,n,o,s,l,h){function f(t,e,i,r,a){var n={basetime:t,validtime:e,element:i,level:r};_.loadGPV(n,this.bounds,0,a)}function c(t,e,i,r,a){for(var n=i.length*r.length,o={},s=0;s<i.length;s++){var l=i[s];o[l]={};for(var h=0;h<r.length;h++){var c=r[h];f(t,e,l,c,function(t,e){o[t.element][t.level]=e,0==--n&&a(o)})}}}if(WRAP.Geo.check(n,o,h),r){var u=!0;if(this.content_revision!=l.content&&(e.vws_cache=null,u=!1),this.conf_revision!=l.conf&&(this.mask_cache=null,this.palette=null,u=!1),this.style_revision!=l.style&&(this.palette=null),!u){var d=a.Attributes.style&&a.Attributes.style.default;if(o&&a.Attributes.style[o]&&(d=a.Attributes.style[o]),!d)return void i.setStatus({status:"error",reason:"style definition error."});this.setPalette(d);var v=0,g=0;a.Attributes.view_depth&&2==a.Attributes.view_depth.length&&(v=a.Attributes.view_depth[1],g=a.Attributes.view_depth[0]);var p=a.Attributes.route;i.setStatus({status:"invalid",reason:"data load waiting."});var _=s._handler(),a=_&&_.getConf(),m=a&&a.DataGrid,x=a&&a.Level;return m&&x?void c(r.basetime,r.validtime,["UGRD","VGRD"],x,function(r){function a(t,e,i,r){r=(m.LatBase-r)/m.LatInterval;var a=Math.floor(r);if(a<0||a>=m.Height-1)return null;var n=a+1;i=(i-m.LonBase)/m.LonInterval;var o=Math.floor(i);o<0&&(o+=m.Width),o>=m.Width&&(o-=m.Width);var s=o+1;s<0&&(s+=m.Width),s>=m.Width&&(s-=m.Width);var l=a*m.Width+o,h=a*m.Width+s,f=n*m.Width+o,c=n*m.Width+s,u=t[l],d=e[l],v=t[h],g=e[h],p=t[f],_=e[f],x=t[c],A=e[c],P=(i-o)/1,y=1-P,w=(r-a)/1,b=1-w,R=y*b,W=P*b,G=y*w,S=P*w,M=u*R+v*W+p*G+x*S,L=d*R+g*W+_*G+A*S;return{u:M,v:L,s:Math.sqrt(M*M+L*L)}}var n=null,o=15;if(p&&(n=e.mask_cache,!n)){n=e.mask,n.clear();for(var s=0;s<p.length-1;s++){var h=p[s],f=p[s+1];n.lineLL(h[1],h[2],f[1],f[2],o),n.lineLL(h[1],h[2]+360,f[1],f[2]+360,o)}}i.clear();for(var c=0,u=1,d=120,_=6,s=0;s<x.length-1;s++)for(var A=r.UGRD[x[s]],P=r.VGRD[x[s]],y=.3048*t(x[s]),w=0,b=0;b<m.Height;b++)for(var R=m.LatBase-b*m.LatInterval,W=R-m.LatInterval,G=0;G<m.Width;G++){var S=m.LonBase+G*m.LonInterval,M=S+m.LonInterval;if(n&&n.activeLL(R,S))for(var f=0;f<u;f++)if(!(Math.random()<.95)){var L=[],T=5*Math.random(),F=S+Math.random()*(M-S),I=R+Math.random()*(W-R),k=a(A,P,F,I);if(!k||!k.s)break;for(var z=1.94384*k.s,D=0;D<d&&(k&&!(z<2));D++){var E=e.getColor(z);L.length||L.push([F,I,y,0,0,0,0,0]),F+=.005*k.u,I+=.005*k.v;var C=1;z<10&&(C=(z-2)/8);var B=L.length;B<_?C=B/_:d-B<_&&(C=(d-B)/_),C*=.5;var N=T+B/d*3;L.push([F,I,y,N,E[0],E[1],E[2],E[3]*C]),k=a(A,P,F,I)}if(L.length>1){L.push([F,I,y,0,0,0,0,0]);var U=new WRAP.Geo.Feature.GeoLine({path:L,lineWidth:1,strokeStyle:"flow",geodesic:!1,option:"depth,"+g+","+v});i.addFeature(U),c++}}w++}console.log("windflow="+c),e.content_revision=l.content,e.conf_revision=l.conf,e.style_revision=l.style,i.setStatus({status:"valid"}),WRAP.Geo.invalidate()}):void i.setStatus({status:"error",reason:"VWS Invalid Data Configuration."})}}}},WRAP.Geo.Renderer.VerticalWindShear=function(){function t(t){var e,i,r,a,n=[[0,1013.2],[1e3,977.2],[2e3,942.1],[3e3,908.1],[4e3,875.1],[5e3,843.1],[6e3,812],[7e3,781.8],[8e3,752.6],[9e3,724.3],[1e4,696.8],[11e3,670.2],[12e3,644.4],[13e3,619.4],[14e3,596.2],[15e3,571.8],[16e3,549.2],[17e3,527.2],[18e3,506],[19e3,485.5],[2e4,465.6],[21e3,446.4],[22e3,427.9],[23e3,410],[24e3,392.7],[25e3,376],[26e3,359.9],[27e3,344.3],[28e3,329.3],[29e3,314.8],[3e4,300.9],[31e3,287.4],[32e3,274.5],[33e3,262],[34e3,250],[35e3,238.4],[36e3,227.3],[37e3,216.6],[38e3,206.5],[39e3,196.8],[4e4,187.5],[41e3,178.7],[42e3,170.4],[43e3,162.4],[44e3,154.7],[45e3,147.5],[46e3,140.6],[47e3,134],[48e3,127.7],[49e3,121.7],[5e4,116],[51e3,110.5],[52e3,105.3],[53e3,100.4]],o=n[0],s=0;for(s=1;s<n.length;s++){var l=n[s];if(t>=l[1])return i=o[1]-l[1],r=(o[1]-t)/i,a=(t-l[1])/i,e=l[0]*r+o[0]*a;o=l}return s==n.length?(i=n[s-2][1]-n[s-1][1],r=(n[s-2][1]-t)/i,a=(t-n[s-1][1])/i,e=n[s-1][0]*r+n[s-2][0]*a):-1}var e=this;this.mask={n:[],width:360,height:180,clear:function(){for(var t=0;t<64800;t++)this.n[t]=0},activeLL:function(t,e){var i=Math.floor(e),r=Math.floor(90-t);return this.n[this.index(i,r)]},index:function(t,e){return e*this.width+t},setPixelValidX:function(t,e){e<0||this.height<=e||(this.n[this.index(t,e)]=1)},setPixelValidY:function(t,e){t<0||this.width<=t||(this.n[this.index(t,e)]=1)},lineLL:function(t,e,i,r,a){var n=Math.floor(e),o=Math.floor(r),s=Math.floor(90-t),l=Math.floor(90-i);n==o&&s==l&&(o+=1);var h=o-n;h>180?this.line(n,s,o-360,l,a):h<-180?this.line(n,s,o+360,l,a):this.line(n,s,o,l,a)},line1:function(t,e,i,r){var a=this.width,n=this.height;if(!(t<0&&i<0||a<=t&&a<=i||e<0&&r<0||n<=e&&n<=r)){var o=i-t,s=r-e;if(0!=o){if(0!=s)if(Math.abs(o)>Math.abs(s)){var l=s/o;if(t<i)for(var h=t<0?0:t,f=a<=i?a-1:i,c=h;c<=f;c+=1){var u=Math.floor(l*(c-t+.5)+e);this.setPixelValidX(c,u)}else for(var h=i<0?0:i,f=a<=t?a-1:t,c=f;c>=h;c-=1){var u=Math.floor(l*(c-t+.5)+e);this.setPixelValidX(c,u)}}else{var l=o/s;if(e<r)for(var h=e<0?0:e,f=n<=r?n-1:r,u=h;u<=f;u+=1){var c=Math.floor(l*(u-e+.5)+t);this.setPixelValidY(c,u)}else for(var h=r<0?0:r,f=n<=e?n-1:e,u=f;u>=h;u-=1){var c=Math.floor(l*(u-e+.5)+t);this.setPixelValidY(c,u)}}else if(t<i){t<0&&(t=0),a<=i&&(i=a);for(var d=this.index(t,e),c=t;c<i;c++)this.n[d++]=1}else if(i<t){i<0&&(i=0),a<=t&&(t=a);for(var d=this.index(i,r),c=i;c<t;c++)this.n[d++]=1}}else if(e<r){e<0&&(e=0),n<=r&&(r=n);for(var d=this.index(t,e),u=e;u<r;u++)this.n[d]=1,d+=a}else if(r<e){r<0&&(r=0),n<=e&&(e=n);for(var d=this.index(i,r),u=r;u<e;u++)this.n[d]=1,d+=a}}},line:function(t,e,i,r,a){var n=a/2;this.line1(t,e,i,r);for(var o=1;o<=n;o++)this.line1(t,e-o,i,r-o),this.line1(t,e+o,i,r+o),this.line1(t-o,e,i-o,r),this.line1(t+o,e,i+o,r)},count:function(){for(var t=0,e=0;e<64800;e++)this.n[e]&&t++;return t}},this.draw=function(i,r,a,n,o,s,l,h){function f(t,e,i,r,a){var n={basetime:t,validtime:e,element:i,level:r};P.loadGPV(n,this.bounds,0,a)}function c(t,e,i,r,a){for(var n=i.length*r.length,o={},s=0;s<i.length;s++){var l=i[s];o[l]={};for(var h=0;h<r.length;h++){var c=r[h];f(t,e,l,c,function(t,e){o[t.element][t.level]=e,0==--n&&a(o)})}}}function u(t,e,i,r,a){var n=e[r],o=e[a],s=i[r],l=i[a];if(t==n&&t==o)return null;if(n<=t&&t<o||o<=t&&t<n){var h=(t-n)/(o-n),i=[s[0]+h*(l[0]-s[0]),s[1]+h*(l[1]-s[1]),s[2]+h*(l[2]-s[2])];return i}return null}function d(t,e,i,r){e[i]&&e[r]&&t.push([e[i],e[r]])}function v(t,e,i,r,a,n,o,s){d(t.triangles,e,i,r),d(t.triangles,e,a,i),d(t.triangles,e,r,a),d(t.triangles,e,i,n),d(t.triangles,e,s,i),d(t.triangles,e,n,s),d(t.triangles,e,r,o),d(t.triangles,e,n,r),d(t.triangles,e,o,n),d(t.triangles,e,a,s),d(t.triangles,e,o,a),d(t.triangles,e,s,o)}function g(t,e,i){var r={contour:[],triangles:[]},a=[];return a[0]=u(t,e,i,0,1),a[1]=u(t,e,i,1,2),a[2]=u(t,e,i,2,3),a[3]=u(t,e,i,3,0),a[4]=u(t,e,i,0,4),a[5]=u(t,e,i,1,5),a[6]=u(t,e,i,2,6),a[7]=u(t,e,i,3,7),a[8]=u(t,e,i,4,5),a[9]=u(t,e,i,5,6),a[10]=u(t,e,i,6,7),a[11]=u(t,e,i,7,4),a[12]=u(t,e,i,0,2),a[13]=u(t,e,i,0,5),a[14]=u(t,e,i,1,6),a[15]=u(t,e,i,6,3),a[16]=u(t,e,i,0,7),a[17]=u(t,e,i,6,4),a[18]=u(t,e,i,0,6),v(r,a,0,13,18,5,9,14),v(r,a,12,0,18,1,14,6),v(r,a,3,12,18,2,6,15),v(r,a,4,16,18,11,10,17),v(r,a,13,4,18,8,17,9),v(r,a,16,3,18,7,15,10),r}if(WRAP.Geo.check(n,o,h),r){var p=!0;if(this.content_revision!=l.content&&(e.vws_cache=null,p=!1),this.conf_revision!=l.conf&&(this.mask_cache=null,p=!1),this.style_revision!=l.style&&(e.processed_content_revision=-1,this.palette=null),!p){var _=a.Attributes.contour,m=0,x=0;a.Attributes.view_depth&&2==a.Attributes.view_depth.length&&(m=a.Attributes.view_depth[1],x=a.Attributes.view_depth[0]);var A=a.Attributes.route;i.setStatus({status:"invalid",reason:"data load waiting."});var P=s._handler(),a=P&&P.getConf(),y=a&&a.DataGrid,w=a&&a.Level;return y&&w?void c(r.basetime,r.validtime,["UGRD","VGRD","HGT"],w,function(r){var a=y.Width*y.Height,n=a*w.length,o=e.vws_cache;if(!o){o=new Float32Array(n);for(var s=0;s<w.length-1;s++)for(var h=s*a,f=r.UGRD[w[s]],c=r.UGRD[w[s+1]],u=r.VGRD[w[s]],d=r.VGRD[w[s+1]],v=r.HGT[w[s]],p=r.HGT[w[s+1]],P=0;P<f.length;P++){var b=f[P],R=c[P],W=u[P],G=d[P],S=v[P],M=p[P];if(isNaN(b)||isNaN(W)||isNaN(R)||isNaN(G)||isNaN(S)||isNaN(M))o[h]=0;else{var L=Math.sqrt(Math.pow(b-R,2)+Math.pow(W-G,2))/Math.abs(S-M);L=1e3*L/3.281,o[h]=L}h++}e.vws_cache=o}var T=null;if(A&&(T=e.mask_cache,!T)){T=e.mask,T.clear();for(var s=0;s<A.length-1;s++){var F=A[s],I=A[s+1];T.lineLL(F[1],F[2],I[1],I[2],5),T.lineLL(F[1],F[2]+360,I[1],I[2]+360,5)}}i.clear();for(var k=[],s=0;s<w.length-1;s++){var z=.3048*t(w[s]),D=.3048*t(w[s+1]),E=(z+D)/2;k.push(E)}for(var C=0,s=0;s<k.length-1;s++)for(var z=k[s],D=k[s+1],h=s*a,B=0;B<y.Height;B++)for(var N=y.LatBase-B*y.LatInterval,U=N-y.LatInterval,j=0;j<y.Width;j++){var V=y.LonBase+j*y.LonInterval,O=V+y.LonInterval;if(T&&T.activeLL(N,V))for(var P=_.length-1;P>=0;P--){var X=_[P].value/1.943844;if(j<y.Width-1){var Y=h,H=h+a,q=[o[Y],o[Y+1],o[Y+y.Width+1],o[Y+y.Width],o[H],o[H+1],o[H+y.Width+1],o[H+y.Width]],F=[[V,N,z],[O,N,z],[O,U,z],[V,U,z],[V,N,D],[O,N,D],[O,U,D],[V,U,D]],Z=g(X,q,F),J=Z.triangles;if(J.length){for(var Q=[],K=0;K<J.length;K++){for(var $=J[K][0][0],tt=J[K][0][1],et=J[K][0][2],it=J[K][1][0],rt=J[K][1][1],at=J[K][1][2],nt=!1,ot=0;ot<Q.length;ot++){if($==Q[ot][0][0]&&tt==Q[ot][0][1]&&et==Q[ot][0][2]&&it==Q[ot][1][0]&&rt==Q[ot][1][1]&&at==Q[ot][1][2]){nt=!0;break}if($==Q[ot][1][0]&&tt==Q[ot][1][1]&&et==Q[ot][1][2]&&it==Q[ot][0][0]&&rt==Q[ot][0][1]&&at==Q[ot][0][2]){nt=!0;break}}nt||Q.push(J[K])}var st=new WRAP.Geo.Feature.GeoLine({path:Q,lineWidth:1,strokeStyle:_[P].color,geodesic:!1,option:"depth,"+x+","+m});i.addFeature(st)}}}h++}console.log("vws="+C),e.processed_content_revision=l.content,i._test_dc_count=C,e.content_revision=l.content,e.conf_revision=l.conf,e.style_revision=l.style,i.setStatus({status:"valid"}),WRAP.Geo.invalidate()}):void i.setStatus({status:"error",reason:"VWS Invalid Data Configuration."})}}}},WRAP.Geo.Renderer.LiveCamera=function(){function t(t,i,r){i.img=null;var a=new Image;a.onload=function(){i.img=[];for(var r=document.createElement("canvas"),n=r.getContext("2d"),o=0;o<e;o++){var s=o*(360/e)*Math.PI/180;r.width=32,r.height=32;var l=r.width/2,h=r.height/2;n.save(),n.translate(l,h),n.rotate(s),n.translate(-l,-h),n.drawImage(a,0,0,32,32),n.restore();var f=r.toDataURL("image/png");i.img.push(f)}WRAP.Geo.redraw(t)},a.onerror=function(){i.img=[];for(var t=0;t<e;t++)i.img.push(r)},a.src=i.url}var e=16,i={t:{},s:{},a:{}};this.draw=function(r,a,n,o,s,l,h,f){WRAP.Geo.check(a,o,f);var c=l.query("data").value();if(c){var s=n.Attributes.style.default,u=s.icon_width,d=s.icon_height,v=s.icon_offset_x,g=s.icon_offset_y,p=s.icon_nondir,_=s.icon_t,m=s.icon_s,x=s.icon_a;if(p&&_&&m&&x){if(i.a.url!=x&&(i.a.url=x,t(r,i.a,p)),i.s.url!=m&&(i.s.url=m,t(r,i.s,m)),i.t.url!=_&&(i.t.url=_,t(r,i.t,p)),!i.a.img||!i.s.img||!i.t.img)return r.setStatus({status:"invalid",reason:"icon data load waiting."}),void setTimeout(function(){WRAP.Geo.redraw(r)},500);var A=!0;if(this.content_revision!=h.content&&(A=!1,this.content_revision=h.content),!A){r.clear();for(var P in c){var y=c[P];if(y.lat&&y.lon){var w;if(y.dir){var b=Math.floor((y.dir+360/(2*e))/(360/e));b%=e,w=i.s.img[b]}else w=p;var R=new WRAP.Geo.Feature.Image({point:[y.lon/60,y.lat/60],image:w,width:u,height:d,offsetX:v,offsetY:g});R.set(r,l.query("data."+P)),r.addFeature(R)}}r.setStatus({status:"valid"}),WRAP.Geo.invalidate()}}}}};
//# sourceMappingURL=../build/js/WRAP.Geo-1.3.1.5-min.js.map